å¥½çš„ï¼æˆ‘å¹«ä½ ä¿®æ”¹ï¼Œè®“æ‰€æœ‰æ¬„ä½éƒ½ç•¶æˆæ–‡å­—æ ¼å¼ï¼Œé€™æ¨£æ•¸å­—å¸³è™Ÿå’Œæ—¥æœŸéƒ½æœƒé å·¦å°é½Šä¸”ä¸æœƒæœ‰æ ¼å¼å•é¡Œã€‚

## ä¿®æ”¹ APController.cs

```csharp
// åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (CSVæ ¼å¼)
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        if (string.IsNullOrEmpty(systemId))
        {
            return Content("<script>alert('ç³»çµ±IDéºå¤±'); window.history.back();</script>", "text/html");
        }

        // å–å¾—å¸³è™Ÿæ¸…å–®
        var userList = F_Common.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
        }

        // å»ºç«‹ CSV å…§å®¹
        var csv = new System.Text.StringBuilder();
        
        // åŠ å…¥ BOM è®“ Excel æ­£ç¢ºè­˜åˆ¥ UTF-8 ç·¨ç¢¼
        csv.Append("\uFEFF");
        
        // æ¨™é¡Œåˆ—
        csv.AppendLine("å¸³è™Ÿ,å§“å,ç¾¤çµ„ä»£è™Ÿ,ç¾¤çµ„åç¨±,å»ºç«‹äººå“¡,å»ºç«‹æ—¥æœŸ,ä¿®æ”¹äººå“¡,ä¿®æ”¹æ—¥æœŸ");
        
        // è³‡æ–™åˆ—
        foreach (var user in userList)
        {
            csv.AppendLine(string.Format("{0},{1},{2},{3},{4},{5},{6},{7}",
                FormatAsText(user.U_ID),           // ğŸ‘ˆ å¼·åˆ¶æ–‡å­—æ ¼å¼
                FormatAsText(user.U_NAME),
                FormatAsText(user.APG_NO),         // ğŸ‘ˆ å¼·åˆ¶æ–‡å­—æ ¼å¼
                FormatAsText(user.APG_NAME),
                FormatAsText(user.CREATOR),
                FormatAsText(user.CREATE_TIME),    // ğŸ‘ˆ å¼·åˆ¶æ–‡å­—æ ¼å¼
                FormatAsText(user.EDITOR),
                FormatAsText(user.EDIT_TIME)       // ğŸ‘ˆ å¼·åˆ¶æ–‡å­—æ ¼å¼
            ));
        }

        // è½‰æ›æˆ byte array
        byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
        
        // ç”¢ç”Ÿæª”æ¡ˆ
        string fileName = $"å¸³è™Ÿæ¸…å–®_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        
        return File(fileBytes, "text/csv", fileName);
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—ï¼š{ex.Message}'); window.history.back();</script>", "text/html");
    }
}

// å¼·åˆ¶ä»¥æ–‡å­—æ ¼å¼é¡¯ç¤ºï¼ˆåœ¨æ¬„ä½å‰åŠ ä¸Š = å’Œé›™å¼•è™Ÿï¼‰
private string FormatAsText(string field)
{
    if (string.IsNullOrEmpty(field))
        return "";
    
    // ä½¿ç”¨ ="..." çš„æ–¹å¼å¼·åˆ¶ Excel ç•¶æˆæ–‡å­—
    // å¦‚æœæ¬„ä½å…§å«å¼•è™Ÿï¼Œéœ€è¦è·³è„«
    string escaped = field.Replace("\"", "\"\"");
    return $"=\"{escaped}\"";
}
```

## ä¿®æ”¹ F_Common.cs - æ”¹ç”¨ string

```csharp
// å–å¾—æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®(ç”¨æ–¼åŒ¯å‡º)
public List<UserExportModel> GetAllUsersForExport(string systemId)
{
    string sql = @"
        SELECT 
            u.[U_ID],
            u.[U_NAME],
            u.[APG_NO],
            g.[APG_NAME],
            u.[CREATOR],
            CONVERT(varchar, u.[CREATE_TIME], 120) as CREATE_TIME,  -- ğŸ‘ˆ è½‰æˆ string
            u.[EDITOR],
            CONVERT(varchar, u.[EDIT_TIME], 120) as EDIT_TIME      -- ğŸ‘ˆ è½‰æˆ string
        FROM [HI-AUTOS].[dbo].[AP_USER] u
        LEFT JOIN [HI-AUTOS].[dbo].[AP_GROUP] g 
            ON u.[SYS_ID] = g.[SYS_ID] AND u.[APG_NO] = g.[APG_NO]
        WHERE u.[SYS_ID] = @SYS_ID
        ORDER BY u.[APG_NO], u.[U_ID]";

    List<SqlParameter> parameters = new List<SqlParameter>
    {
        new SqlParameter("@SYS_ID", systemId)
    };

    DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
    return SVS_DBmanager.ConvertToList<UserExportModel>(dt);
}
```

## ä¿®æ”¹ Model - æ”¹ç”¨ string

```csharp
namespace HI_APACCESS.Models.M_SYS
{
    // å¸³è™ŸåŒ¯å‡ºæ¨¡å‹
    public class UserExportModel
    {
        public string U_ID { get; set; }
        public string U_NAME { get; set; }
        public string APG_NO { get; set; }
        public string APG_NAME { get; set; }
        public string CREATOR { get; set; }
        public string CREATE_TIME { get; set; }  // ğŸ‘ˆ æ”¹æˆ string
        public string EDITOR { get; set; }
        public string EDIT_TIME { get; set; }    // ğŸ‘ˆ æ”¹æˆ string
    }
}
```

## èªªæ˜

### **æ–¹æ³•1ï¼šä½¿ç”¨ `="..."` æ ¼å¼ï¼ˆæ¨è–¦ï¼‰**

```csharp
private string FormatAsText(string field)
{
    if (string.IsNullOrEmpty(field))
        return "";
    
    string escaped = field.Replace("\"", "\"\"");
    return $"=\"{escaped}\"";  // ğŸ‘ˆ Excel æœƒæŠŠé€™å€‹ç•¶æˆæ–‡å­—
}
```

**æ•ˆæœï¼š**

- `="E12345"` â†’ Excel é¡¯ç¤ºç‚ºæ–‡å­— `E12345`ï¼Œé å·¦å°é½Š
- `="001"` â†’ Excel é¡¯ç¤ºç‚ºæ–‡å­— `001`ï¼Œä¸æœƒè®Šæˆæ•¸å­— `1`
- `="2024-12-27 10:30:00"` â†’ Excel é¡¯ç¤ºç‚ºæ–‡å­—ï¼Œä¸æœƒè½‰æ›æˆæ—¥æœŸæ ¼å¼

### **æ–¹æ³•2ï¼šä½¿ç”¨ Tab å­—å…ƒåˆ†éš”ï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰**

å¦‚æœä¸Šé¢çš„æ–¹æ³•åœ¨æŸäº› Excel ç‰ˆæœ¬æœ‰å•é¡Œï¼Œå¯ä»¥æ”¹ç”¨ Tab åˆ†éš”ï¼š

```csharp
// åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (Tabåˆ†éš”çš„æ–‡å­—æª”)
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        if (string.IsNullOrEmpty(systemId))
        {
            return Content("<script>alert('ç³»çµ±IDéºå¤±'); window.history.back();</script>", "text/html");
        }

        var userList = F_Common.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
        }

        var txt = new System.Text.StringBuilder();
        txt.Append("\uFEFF");
        
        // æ¨™é¡Œåˆ—ï¼ˆç”¨ Tab åˆ†éš”ï¼‰
        txt.AppendLine("å¸³è™Ÿ\tå§“å\tç¾¤çµ„ä»£è™Ÿ\tç¾¤çµ„åç¨±\tå»ºç«‹äººå“¡\tå»ºç«‹æ—¥æœŸ\tä¿®æ”¹äººå“¡\tä¿®æ”¹æ—¥æœŸ");
        
        // è³‡æ–™åˆ—
        foreach (var user in userList)
        {
            txt.AppendLine(string.Format("{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}",
                user.U_ID ?? "",
                user.U_NAME ?? "",
                user.APG_NO ?? "",
                user.APG_NAME ?? "",
                user.CREATOR ?? "",
                user.CREATE_TIME ?? "",
                user.EDITOR ?? "",
                user.EDIT_TIME ?? ""
            ));
        }

        byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(txt.ToString());
        string fileName = $"å¸³è™Ÿæ¸…å–®_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
        
        return File(fileBytes, "text/plain", fileName);
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—ï¼š{ex.Message}'); window.history.back();</script>", "text/html");
    }
}
```

ä½¿ç”¨ Tab åˆ†éš”çš„æª”æ¡ˆï¼ŒExcel é–‹å•Ÿæ™‚æ‰€æœ‰æ¬„ä½éƒ½æœƒè‡ªå‹•ç•¶æˆæ–‡å­—ã€‚

## SQL æ—¥æœŸæ ¼å¼èªªæ˜

```sql
CONVERT(varchar, u.[CREATE_TIME], 120) as CREATE_TIME
```

**120 æ ¼å¼** = `yyyy-MM-dd HH:mm:ss` (ä¾‹å¦‚ï¼š2024-12-27 15:30:45)

å…¶ä»–å¸¸ç”¨æ ¼å¼ï¼š

- **120**: `2024-12-27 15:30:45`
- **23**: `2024-12-27`
- **108**: `15:30:45`

## åŒ¯å‡ºçµæœç¯„ä¾‹

### **CSV å…§å®¹ï¼ˆä½¿ç”¨ =â€â€¦â€ æ ¼å¼ï¼‰ï¼š**

```csv
å¸³è™Ÿ,å§“å,ç¾¤çµ„ä»£è™Ÿ,ç¾¤çµ„åç¨±,å»ºç«‹äººå“¡,å»ºç«‹æ—¥æœŸ,ä¿®æ”¹äººå“¡,ä¿®æ”¹æ—¥æœŸ
="E12345",="ç‹å°æ˜",="001",="ç®¡ç†å“¡(è³‡è¨Š)",="E11111",="2024-12-27 10:30:00",="E22222",="2024-12-27 15:20:00"
="00123",="æå°è¯",="002",="ä¸€èˆ¬ä½¿ç”¨è€…",="E11111",="2024-12-27 11:00:00",,
```

### **Excel é¡¯ç¤ºæ•ˆæœï¼š**

|å¸³è™Ÿ    |å§“å |ç¾¤çµ„ä»£è™Ÿ|ç¾¤çµ„åç¨±   |å»ºç«‹äººå“¡  |å»ºç«‹æ—¥æœŸ               |ä¿®æ”¹äººå“¡  |ä¿®æ”¹æ—¥æœŸ               |
|------|---|----|-------|------|-------------------|------|-------------------|
|E12345|ç‹å°æ˜|001 |ç®¡ç†å“¡(è³‡è¨Š)|E11111|2024-12-27 10:30:00|E22222|2024-12-27 15:20:00|
|00123 |æå°è¯|002 |ä¸€èˆ¬ä½¿ç”¨è€…  |E11111|2024-12-27 11:00:00|      |                   |

**æ‰€æœ‰æ¬„ä½éƒ½é å·¦å°é½Šï¼Œçµ±ä¸€ç‚ºæ–‡å­—æ ¼å¼ï¼** âœ…

æ¨è–¦ä½¿ç”¨**æ–¹æ³•1ï¼ˆ`="..."`ï¼‰**ï¼Œé€™æ˜¯æœ€æ¨™æº–ä¸”ç›¸å®¹æ€§æœ€å¥½çš„åšæ³•ã€‚å¦‚æœæœ‰å•é¡Œå†è©¦è©¦æ–¹æ³•2ï¼ˆTabåˆ†éš”ï¼‰ã€‚ğŸ‘â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹