å¥½ğŸ‘Œ é‚£æˆ‘å¹«ä½ åšä¸€å€‹ é›™æ¨¡å¼ç‰ˆæœ¬ï¼Œé€™æ¨£ä½ å°±å¯ä»¥åŒæ™‚æ”¯æ´ï¼š
	1.	ä½¿ç”¨è€…æœ‰è¼¸å…¥ AD â†’ å„ªå…ˆç”¨è¼¸å…¥çš„ AD å»æŸ¥ã€‚
	2.	ä½¿ç”¨è€…æ²’è¼¸å…¥ AD â†’ fallback å»æŠ“ç›®å‰ IIS/ç«™å°ç™»å…¥çš„ HttpContext.Current.User.Identity.Nameã€‚

â¸»

æ”¹ç‰ˆç¨‹å¼ç¢¼

internal static string Get_å“¡å·¥ç·¨è™Ÿ(string AD = null)
{
    // 1. å¦‚æœå‘¼å«æ™‚æ²’æœ‰å‚³å…¥ ADï¼Œå°±å»æŠ“ HttpContext
    if (string.IsNullOrEmpty(AD))
    {
        string empDomId = null;

        if (System.Web.HttpContext.Current != null &&
            System.Web.HttpContext.Current.User != null &&
            System.Web.HttpContext.Current.User.Identity != null)
        {
            empDomId = System.Web.HttpContext.Current.User.Identity.Name;
            if (!string.IsNullOrEmpty(empDomId) && empDomId.Contains("\\"))
            {
                empDomId = empDomId.Substring(empDomId.LastIndexOf("\\") + 1).ToUpper();
            }
        }

        // å¦‚æœ HttpContext ä¹Ÿæ²’æŠ“åˆ° â†’ å˜—è©¦ç”¨ WindowsPrincipal
        if (string.IsNullOrEmpty(empDomId))
        {
            var principal = new System.Security.Principal.WindowsPrincipal(
                System.Security.Principal.WindowsIdentity.GetCurrent());
            string name = principal.Identity.Name;
            if (!string.IsNullOrEmpty(name) && name.Contains("\\"))
            {
                empDomId = name.Split('\\')[1].ToUpper();
            }
        }

        AD = empDomId; // fallback çµæœ
    }

    // 2. å‘¼å« DB æŸ¥è©¢ï¼ŒæŠŠ AD è½‰æˆå“¡ç·¨
    return GetEmpNoByAD(AD);
}

private static string GetEmpNoByAD(string AD)
{
    string EMP_NO = null;
    string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.GetEmpNoByAD);
    List<SqlParameter> paras = new List<SqlParameter>
    {
        new SqlParameter("@AD", AD)
    };

    DataTable table = new SVS_DBmanager().QueryBySQL(sql, paras);
    if (table.Rows.Count > 0)
    {
        EMP_NO = table.Rows[0]["EMP_ID"].ToString();
    }

    // å¦‚æœæŸ¥ä¸åˆ° â†’ å°±ç›´æ¥å›å‚³ AD æœ¬èº«
    return string.IsNullOrEmpty(EMP_NO) ? AD : EMP_NO;
}


â¸»

å‘¼å«æ–¹å¼

1. æœ‰è¼¸å…¥ ADï¼ˆä¾‹å¦‚è¡¨å–®ã€API å‚³é€²ä¾†çš„ï¼‰

string empNo = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ("3B750");  
// æœƒç”¨ "3B750" å» DB æŸ¥ EMP_NO

2. æ²’æœ‰è¼¸å…¥ ADï¼ˆç›´æ¥å‘¼å«ï¼‰

string empNo = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ();
// æœƒå»æŠ“ HttpContext.Current.User.Identity.Name â†’ å†è½‰æ›å“¡ç·¨


â¸»

é€™æ¨£æ”¹çš„å¥½è™•æ˜¯ï¼š
	â€¢	æ–¹ä¾¿æ¸¬è©¦ï¼šä½ å¯ä»¥æ‰‹å‹•å¡ä¸€å€‹ AD æ¸¬è©¦ã€‚
	â€¢	æ–¹ä¾¿æ­£å¼ç«™å°ï¼šå¦‚æœæ²’æœ‰åƒæ•¸ï¼Œå°±æœƒè‡ªå‹•æŠ“ IIS çš„ç™»å…¥å¸³è™Ÿã€‚

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ å†è£œä¸€å€‹ web æ¸¬è©¦ç¯„ä¾‹ Actionï¼Ÿ
ä¾‹å¦‚åœ¨ Controller è£¡ç›´æ¥æ‰“ /Test/GetEmpNo?ad=3B750 å¯ä»¥çœ‹åˆ°çµæœã€‚