明白了！調整權限邏輯如下：

## 調整後的權限規則：

1. **001群組使用者** → 可以操作所有群組（包括001）
1. **非001群組使用者** → 不可以操作001群組，但可以操作其他所有群組

## 修改後的程式碼：

```csharp
/// <summary>
/// 檢查使用者是否有權限操作指定群組（批次匯入專用）
/// 規則：
/// 1. 001群組成員可以操作所有群組
/// 2. 非001群組成員不能操作001群組
/// 3. 非001群組成員可以操作其他所有群組
/// </summary>
private bool HasGroupPermissionViaSP(SVS_DBmanager dbManager, string sysId, string targetApgNo, string userId)
{
    try
    {
        var parameters = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.NVarChar, 50) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.NVarChar, 50) { Value = targetApgNo },
            new SqlParameter("@U_ID", SqlDbType.NVarChar, 50) { Value = userId }
        };

        string permissionCheckSql = @"
            SELECT 
                CASE 
                    -- 規則1：使用者在001群組，可以操作所有群組（包括001）
                    WHEN EXISTS (
                        SELECT 1 FROM AP_USER 
                        WHERE SYS_ID = @SYS_ID AND APG_NO = '001' AND U_ID = @U_ID
                    ) THEN 1
                    
                    -- 規則2：目標群組是001，但使用者不在001群組 → 拒絕
                    WHEN @APG_NO = '001' THEN 0
                    
                    -- 規則3：目標群組不是001 → 允許（不限制）
                    ELSE 1
                END AS HasPermission";

        var result = dbManager.QueryBySQL(permissionCheckSql, parameters);
        
        return result.Rows.Count > 0 && Convert.ToInt32(result.Rows[0]["HasPermission"]) == 1;
    }
    catch (Exception ex)
    {
        // Log error
        return false;
    }
}
```

## 如果要使用 Stored Procedure 方式：

```sql
CREATE PROCEDURE [dbo].[USP_CheckGroupPermissionForImport]
    @SYS_ID NVARCHAR(50),
    @APG_NO NVARCHAR(50),
    @U_ID NVARCHAR(50)
AS
BEGIN
    SELECT 
        CASE 
            -- 規則1：使用者在001群組，可以操作所有群組
            WHEN EXISTS (
                SELECT 1 FROM AP_USER 
                WHERE SYS_ID = @SYS_ID AND APG_NO = '001' AND U_ID = @U_ID
            ) THEN 1
            
            -- 規則2：目標群組是001，但使用者不在001群組 → 拒絕
            WHEN @APG_NO = '001' THEN 0
            
            -- 規則3：目標群組不是001 → 允許
            ELSE 1
        END AS HasPermission
END
```

## 完整的 ImportUsersFromExcel 方法：

```csharp
public ImportResult ImportUsersFromExcel(string filePath, string sysId, string apgNo, string creator)
{
    ImportResult result = new ImportResult()
    {
        ErrorMessages = new List<ImportError>()
    };

    try
    {
        var dbManager = new SVS_DBmanager();
        
        // **1. 驗證權限（批次匯入專用規則）**
        if (!HasGroupPermissionViaSP(dbManager, sysId, apgNo, creator))
        {
            result.IsSuccess = false;
            result.ErrorMessage = apgNo == "001" 
                ? "僅001群組成員可以操作001群組的批次匯入" 
                : "無權限操作此群組";
            return result;
        }

        // **2. 驗證群組存在**
        var validateParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.NVarChar, 50) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.NVarChar, 50) { Value = apgNo }
        };
        
        string validateGroupSql = "SELECT COUNT(1) FROM AP_GROUP WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO";
        var validateResult = dbManager.QueryBySQL(validateGroupSql, validateParams);
        
        if (validateResult.Rows.Count == 0 || Convert.ToInt32(validateResult.Rows[0][0]) == 0)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "群組不存在";
            return result;
        }

        // **3. 讀取 Excel**
        var rows = ReadExcelData(filePath, result);
        if (!result.IsSuccess || rows == null) return result;

        // **4. 批次處理每筆資料**
        int successCount = 0;
        foreach (var row in rows)
        {
            if (ProcessUserRow(dbManager, row, sysId, apgNo, creator, result))
            {
                successCount++;
            }
        }

        result.SuccessCount = successCount;
        result.IsSuccess = true;
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = "處理 Excel 匯入時發生錯誤：" + ex.Message;
    }

    return result;
}

/// <summary>
/// 讀取 Excel 資料
/// </summary>
private List<(int RowNumber, string EmpNo)> ReadExcelData(string filePath, ImportResult result)
{
    var rows = new List<(int RowNumber, string EmpNo)>();
    
    try
    {
        using (var stream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.Read))
        using (var reader = ExcelReaderFactory.CreateReader(stream))
        {
            int rowIndex = 0;
            while (reader.Read())
            {
                rowIndex++;

                // 檢查表頭
                if (rowIndex == 1)
                {
                    string header = reader.GetString(0)?.Trim();
                    if (string.IsNullOrEmpty(header) || header != "員工編號")
                    {
                        result.IsSuccess = false;
                        result.ErrorMessage = "Excel 格式錯誤：第一列第一欄必須是「員工編號」";
                        return null;
                    }
                    continue;
                }

                string empNo = reader.GetValue(0)?.ToString().Trim();
                if (!string.IsNullOrEmpty(empNo))
                {
                    rows.Add((rowIndex, empNo));
                }
            }
        }

        if (rows.Count == 0)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "Excel 無任何員工資料";
            return null;
        }

        return rows;
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = "讀取 Excel 時發生錯誤：" + ex.Message;
        return null;
    }
}

/// <summary>
/// 處理單筆員工資料
/// </summary>
private bool ProcessUserRow(SVS_DBmanager dbManager, (int RowNumber, string EmpNo) row, 
                            string sysId, string apgNo, string creator, ImportResult result)
{
    try
    {
        // 1. 檢查員工是否存在
        var empParams = new List<SqlParameter>
        {
            new SqlParameter("@EMP_NO", SqlDbType.NVarChar, 50) { Value = row.EmpNo }
        };
        
        string checkEmpSql = "SELECT EMP_NAME FROM [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST] WHERE EMP_NO=@EMP_NO";
        var empResult = dbManager.QueryBySQL(checkEmpSql, empParams);
        
        if (empResult.Rows.Count == 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "查無此員工"
            });
            return false;
        }
        
        string empName = empResult.Rows[0]["EMP_NAME"].ToString();

        // 2. 檢查是否已存在於同一個群組
        var checkUserParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.NVarChar, 50) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.NVarChar, 50) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.NVarChar, 50) { Value = row.EmpNo }
        };
        
        string checkUserSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID";
        var userResult = dbManager.QueryBySQL(checkUserSql, checkUserParams);
        
        if (Convert.ToInt32(userResult.Rows[0][0]) > 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "此群組已存在該員工"
            });
            return false;
        }

        // 3. 檢查是否已存在於該系統的其他群組
        var checkSystemParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.NVarChar, 50) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.NVarChar, 50) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.NVarChar, 50) { Value = row.EmpNo }
        };
        
        string checkSystemSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO<>@APG_NO AND U_ID=@U_ID";
        var systemResult = dbManager.QueryBySQL(checkSystemSql, checkSystemParams);
        
        if (Convert.ToInt32(systemResult.Rows[0][0]) > 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "此系統其他群組已存在該員工"
            });
            return false;
        }

        // 4. 寫入 AP_USER
        var insertParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.NVarChar, 50) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.NVarChar, 50) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.NVarChar, 50) { Value = row.EmpNo },
            new SqlParameter("@U_NAME", SqlDbType.NVarChar, 100) { Value = empName },
            new SqlParameter("@CREATOR", SqlDbType.NVarChar, 50) { Value = creator }
        };

        string insertSql = @"
            INSERT INTO AP_USER(SYS_ID, APG_NO, U_ID, U_NAME, CREATOR, CREATE_TIME)
            VALUES(@SYS_ID, @APG_NO, @U_ID, @U_NAME, @CREATOR, GETDATE())";

        dbManager.ExecuteSQL(insertSql, insertParams);
        return true;
    }
    catch (Exception exRow)
    {
        result.ErrorMessages.Add(new ImportError
        {
            RowNumber = row.RowNumber,
            EmpNo = row.EmpNo,
            Message = "寫入錯誤：" + exRow.Message
        });
        return false;
    }
}
```

## 權限測試案例：

|使用者群組|目標群組  |結果  |
|-----|------|----|
|001  |001   |✅ 允許|
|001  |002   |✅ 允許|
|001  |任何群組  |✅ 允許|
|002  |001   |❌ 拒絕|
|002  |002   |✅ 允許|
|002  |003   |✅ 允許|
|003  |001   |❌ 拒絕|
|003  |任何非001|✅ 允許|

這樣的調整符合您的需求嗎？​​​​​​​​​​​​​​​​