ğŸ‘Œ æˆ‘ä¾†å¹«ä½ æ‹†è§£ä¸€ä¸‹ï¼Œä½ ç¾åœ¨çš„ç¨‹å¼å…¶å¯¦å·²ç¶“èƒ½é©—è­‰ JWT tokenï¼Œä½†å®ƒæœ‰å¹¾å€‹å•é¡Œï¼š
	1.	ç›®å‰åšæ³•ï¼š
	â€¢	å¦‚æœæ²’æœ‰ token â†’ å›å‚³ 401 Missing token
	â€¢	å¦‚æœ token éæœŸ / é©—è­‰å¤±æ•— â†’ å›å‚³ 401 Invalid or expired token
	â€¢	é©—è­‰æˆåŠŸ â†’ æŠŠ ClaimsPrincipal è¨­åˆ° HttpContext.User

ğŸ‘‰ å•é¡Œæ˜¯ï¼šé€™æ¨£å¯«åªæœƒçµ¦ HTTP ç‹€æ…‹ç¢¼ (401)ï¼Œç€è¦½å™¨ç•«é¢ä¸æœƒè‡ªå‹•é¡¯ç¤ºã€ŒTOKEN å·²å¤±æ•ˆã€å°è©±æ¡†ã€‚

â¸»

âœ… ä½ è¦çš„æ•ˆæœ
	â€¢	å¦‚æœ token éæœŸ / é©—è­‰å¤±æ•— â†’ é é¢ç›´æ¥è·³å‡º alert(TOKEN å·²å¤±æ•ˆ)ï¼Œç„¶å¾Œå°å›ç™»å…¥é ï¼ˆæˆ–é¦–é ï¼‰ã€‚

â¸»

ğŸ”§ ä¿®æ”¹æ–¹å‘

Step 1ï¼šæ”¹ TokenAuthorizeAttribute

æŠŠç¾åœ¨çš„ HttpStatusCodeResult æ›æˆ ContentResultï¼Œå›å‚³ä¸€æ®µ JavaScriptã€‚

using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using System;
using System.Web.Mvc;

namespace HI_APACCESS.Service.Validation
{
    public class TokenAuthorizeAttribute : ActionFilterAttribute
    {
        private static readonly string SecretKey = "NpzedRHDaT8uSc10ntMJ+ohvUJ/VJYdHs1LyK3KP+Q0=";

        public override void OnActionExecuting(ActionExecutingContext filterContext)
        {
            var token = filterContext.HttpContext.Request.QueryString["token"];
            if (string.IsNullOrEmpty(token))
            {
                RedirectWithError(filterContext, "ç¼ºå°‘ Tokenï¼Œè«‹é‡æ–°ç™»å…¥");
                return;
            }

            var principal = ValidateToken(token);
            if (principal == null)
            {
                RedirectWithError(filterContext, "TOKEN å·²å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥");
                return;
            }

            filterContext.HttpContext.User = principal;
            base.OnActionExecuting(filterContext);
        }

        private void RedirectWithError(ActionExecutingContext filterContext, string message)
        {
            filterContext.Result = new ContentResult
            {
                Content = $@"<script>
                                alert('{message}');
                                window.location.href='/Home/Login';
                             </script>",
                ContentType = "text/html"
            };
        }

        public static ClaimsPrincipal ValidateToken(string token)
        {
            var tokenHandler = new JwtSecurityTokenHandler();
            var key = Encoding.UTF8.GetBytes(SecretKey);

            var parameters = new TokenValidationParameters
            {
                ValidateIssuer = true,
                ValidateAudience = true,
                ValidIssuer = "hi_ap_access_dll",
                ValidAudience = "hi_ap_access_web",
                ValidateLifetime = true,
                IssuerSigningKey = new SymmetricSecurityKey(key),
                ClockSkew = TimeSpan.Zero
            };

            try
            {
                var principal = tokenHandler.ValidateToken(token, parameters, out SecurityToken validatedToken);
                return principal;
            }
            catch
            {
                return null;
            }
        }
    }
}


â¸»

Step 2ï¼šåœ¨ HomeController ä½¿ç”¨

[HttpGet]
[TokenAuthorize]
public ActionResult TokenEntry()
{
    var systemId = ((ClaimsPrincipal)User).FindFirst("systemId")?.Value;
    var empNo = ((ClaimsPrincipal)User).FindFirst("empNo")?.Value;

    Session["CurrentSystemId"] = systemId;
    Session["CurrentEmpNo"] = empNo;

    return RedirectToAction("GroupManagement", "AP", new { systemId = systemId });
}

[HttpGet]
[TokenAuthorize]
public ActionResult TokenEntry_FUNC()
{
    var systemId = ((ClaimsPrincipal)User).FindFirst("systemId")?.Value;
    var empNo = ((ClaimsPrincipal)User).FindFirst("empNo")?.Value;

    Session["CurrentSystemId"] = systemId;
    Session["CurrentEmpNo"] = empNo;

    return RedirectToAction("PageManagement", "AP", new { systemId = systemId });
}


â¸»

ğŸ“Œ æ¸¬è©¦æµç¨‹
	1.	ç”¨ DLL ç”¢ç”Ÿä¸€å€‹æ­£ç¢ºçš„ Token â†’ å¸¶åˆ° URL

http://localhost/Home/TokenEntry?token=xxxxx

é é¢æ‡‰è©²æ­£ç¢ºé€²åˆ° GroupManagementã€‚

	2.	æŠŠ Token æ”¹æˆéŒ¯èª¤çš„ / éæœŸçš„ â†’
é é¢æ‡‰è©²å½ˆå‡º ã€ŒTOKEN å·²å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥ã€ï¼Œç„¶å¾Œè·³è½‰åˆ° /Home/Loginã€‚

â¸»

ğŸ¯ ç¸½çµ
	â€¢	ä½ åŸæœ¬çš„ç¨‹å¼ã€Œåªä¸Ÿ 401ã€ï¼Œç€è¦½å™¨ä¸æœƒ alertã€‚
	â€¢	æˆ‘å¹«ä½ æ”¹æˆã€Œå›å‚³ä¸€æ®µ scriptã€ï¼Œç›´æ¥ alert å¾Œå°å›ç™»å…¥é ã€‚
	â€¢	é€™æ¨£å°±å®Œå…¨ç¬¦åˆä½ è¦çš„ã€ŒTOKEN å¤±æ•ˆæç¤ºã€æ•ˆæœã€‚

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ TokenAuthorize æŠ½å‡ºæˆ Filters/TokenAuthorize.cs å…±ç”¨ classï¼Œç„¶å¾Œåœ¨ FilterConfig.cs è¨»å†Šï¼Œè®“æ‰€æœ‰éœ€è¦é©—è­‰çš„ Controller éƒ½èƒ½å¥—ç”¨ï¼Ÿ