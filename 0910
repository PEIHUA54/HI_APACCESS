æ–°å¢-åŒ¯å‡ºå¸³è™Ÿæ¸…å–®-åŠŸèƒ½
æª”å-å¸³è™Ÿæ¸…å–®_yyyyMMdd_HHmmss
8å€‹æ¬„ä½
UserModel
å¸³è™ŸU_ID
å§“åU_NAME
ç¾¤çµ„ä»£è™ŸAPG_NO
ç¾¤çµ„åç¨±APG_NAME	
å»ºç«‹æ—¥æœŸCREATOR	
å»ºç«‹äººå“¡CREATE_TIME	
ä¿®æ”¹æ—¥æœŸEDITOR	
ä¿®æ”¹äººå“¡EDIT_TIME

ç•¶ç„¶å¯ä»¥ï¼ä¸å®‰è£å¥—ä»¶çš„è©±ï¼Œå¯ä»¥ç”¨ **CSV æ ¼å¼**åŒ¯å‡ºï¼Œé€™æ˜¯æœ€ç°¡å–®çš„æ–¹å¼ï¼Œä¸éœ€è¦ä»»ä½•é¡å¤–å¥—ä»¶ã€‚

## æ–¹æ¡ˆï¼šåŒ¯å‡º CSV æ ¼å¼

### ä¿®æ”¹ APController.cs - åŒ¯å‡º CSV

```csharp
// åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (CSVæ ¼å¼)
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        if (string.IsNullOrEmpty(systemId))
        {
            return Content("<script>alert('ç³»çµ±IDéºå¤±'); window.history.back();</script>", "text/html");
        }

        // å–å¾—å¸³è™Ÿæ¸…å–®
        var userList = F_Common.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
        }

        // å»ºç«‹ CSV å…§å®¹
        var csv = new System.Text.StringBuilder();
        
        // åŠ å…¥ BOM è®“ Excel æ­£ç¢ºè­˜åˆ¥ UTF-8 ç·¨ç¢¼
        csv.Append("\uFEFF");
        
        // æ¨™é¡Œåˆ—
        csv.AppendLine("å¸³è™Ÿ,å§“å,ç¾¤çµ„ä»£è™Ÿ,ç¾¤çµ„åç¨±,å»ºç«‹äººå“¡,å»ºç«‹æ—¥æœŸ,ä¿®æ”¹äººå“¡,ä¿®æ”¹æ—¥æœŸ");
        
        // è³‡æ–™åˆ—
        foreach (var user in userList)
        {
            csv.AppendLine(string.Format("{0},{1},{2},{3},{4},{5},{6},{7}",
                EscapeCsvField(user.U_ID),
                EscapeCsvField(user.U_NAME),
                EscapeCsvField(user.APG_NO),
                EscapeCsvField(user.APG_NAME),
                EscapeCsvField(user.CREATOR),
                user.CREATE_TIME?.ToString("yyyy-MM-dd HH:mm:ss") ?? "",
                EscapeCsvField(user.EDITOR),
                user.EDIT_TIME?.ToString("yyyy-MM-dd HH:mm:ss") ?? ""
            ));
        }

        // è½‰æ›æˆ byte array
        byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
        
        // ç”¢ç”Ÿæª”æ¡ˆ
        string fileName = $"å¸³è™Ÿæ¸…å–®_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        
        return File(fileBytes, "text/csv", fileName);
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—ï¼š{ex.Message}'); window.history.back();</script>", "text/html");
    }
}

// CSV æ¬„ä½è™•ç†ï¼šè™•ç†é€—è™Ÿã€å¼•è™Ÿã€æ›è¡Œ
private string EscapeCsvField(string field)
{
    if (string.IsNullOrEmpty(field))
        return "";
    
    // å¦‚æœåŒ…å«é€—è™Ÿã€å¼•è™Ÿæˆ–æ›è¡Œï¼Œéœ€è¦ç”¨é›™å¼•è™ŸåŒ…èµ·ä¾†ï¼Œä¸¦ä¸”å°‡å…§éƒ¨çš„å¼•è™Ÿè®Šæˆå…©å€‹å¼•è™Ÿ
    if (field.Contains(",") || field.Contains("\"") || field.Contains("\n") || field.Contains("\r"))
    {
        return "\"" + field.Replace("\"", "\"\"") + "\"";
    }
    
    return field;
}
```

## F_Common.cs çš„æ–¹æ³•ï¼ˆèˆ‡ä¹‹å‰ç›¸åŒï¼‰

```csharp
// å–å¾—æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®(ç”¨æ–¼åŒ¯å‡º)
public List<UserExportModel> GetAllUsersForExport(string systemId)
{
    string sql = @"
        SELECT 
            u.[U_ID],
            u.[U_NAME],
            u.[APG_NO],
            g.[APG_NAME],
            u.[CREATOR],
            u.[CREATE_TIME],
            u.[EDITOR],
            u.[EDIT_TIME]
        FROM [HI-AUTOS].[dbo].[AP_USER] u
        LEFT JOIN [HI-AUTOS].[dbo].[AP_GROUP] g 
            ON u.[SYS_ID] = g.[SYS_ID] AND u.[APG_NO] = g.[APG_NO]
        WHERE u.[SYS_ID] = @SYS_ID
        ORDER BY u.[APG_NO], u.[U_ID]";

    List<SqlParameter> parameters = new List<SqlParameter>
    {
        new SqlParameter("@SYS_ID", systemId)
    };

    DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
    return SVS_DBmanager.ConvertToList<UserExportModel>(dt);
}
```

## Model å®šç¾©ï¼ˆèˆ‡ä¹‹å‰ç›¸åŒï¼‰

```csharp
namespace HI_APACCESS.Models.M_SYS
{
    // å¸³è™ŸåŒ¯å‡ºæ¨¡å‹
    public class UserExportModel
    {
        public string U_ID { get; set; }
        public string U_NAME { get; set; }
        public string APG_NO { get; set; }
        public string APG_NAME { get; set; }
        public string CREATOR { get; set; }
        public DateTime? CREATE_TIME { get; set; }
        public string EDITOR { get; set; }
        public DateTime? EDIT_TIME { get; set; }
    }
}
```

## GroupManagement.cshtml æŒ‰éˆ•ï¼ˆèˆ‡ä¹‹å‰ç›¸åŒï¼‰

```html
@if (showSwitchButton)
{
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-info" id="btnSwitchSystem">
                <i class="fas fa-exchange-alt"></i> åˆ‡æ›ç³»çµ±
            </button>
            <button type="button" class="btn btn-success" id="btnExportUsers">
                <i class="fas fa-file-download"></i> åŒ¯å‡ºå¸³è™Ÿæ¸…å–®
            </button>
        </div>
    </div>
}

@section Scripts {
    <script>
        @if (showSwitchButton)
        {
            <text>
            // åˆ‡æ›ç³»çµ±æŒ‰éˆ•äº‹ä»¶
            $('#btnSwitchSystem').click(function() {
                if (confirm('ç¢ºå®šè¦åˆ‡æ›ç³»çµ±å—ï¼Ÿ')) {
                    window.location.href = '@Url.Action("SYS_PERMISSION_SET", "SYS")';
                }
            });

            // åŒ¯å‡ºå¸³è™Ÿæ¸…å–®æŒ‰éˆ•äº‹ä»¶
            $('#btnExportUsers').click(function() {
                window.location.href = '@Url.Action("ExportUserList", "AP")';
            });
            </text>
        }
    </script>
}
```

## CSV æ ¼å¼çš„å„ªé»

âœ… **ä¸éœ€è¦å®‰è£ä»»ä½•å¥—ä»¶** - ç´” C# å…§å»ºåŠŸèƒ½  
âœ… **æª”æ¡ˆå°** - CSV æ¯” Excel æª”æ¡ˆå°å¾ˆå¤š  
âœ… **ç›¸å®¹æ€§å¥½** - Excelã€Google Sheetsã€è¨˜äº‹æœ¬éƒ½èƒ½é–‹å•Ÿ  
âœ… **ç°¡å–®å¯é ** - ä¸æœƒæœ‰å¥—ä»¶ç‰ˆæœ¬æˆ–æˆæ¬Šå•é¡Œ  
âœ… **UTF-8 ç·¨ç¢¼** - ä¸­æ–‡é¡¯ç¤ºæ­£å¸¸ï¼ˆåŠ äº† BOMï¼‰

## åŒ¯å‡ºæª”æ¡ˆç¯„ä¾‹

**æª”åï¼š** `å¸³è™Ÿæ¸…å–®_20241227_153045.csv`

**å…§å®¹ï¼š**

```csv
å¸³è™Ÿ,å§“å,ç¾¤çµ„ä»£è™Ÿ,ç¾¤çµ„åç¨±,å»ºç«‹äººå“¡,å»ºç«‹æ—¥æœŸ,ä¿®æ”¹äººå“¡,ä¿®æ”¹æ—¥æœŸ
E12345,ç‹å°æ˜,001,ç®¡ç†å“¡(è³‡è¨Š),E11111,2024-12-27 10:30:00,E22222,2024-12-27 15:20:00
E67890,æå°è¯,002,ä¸€èˆ¬ä½¿ç”¨è€…,E11111,2024-12-27 11:00:00,,
```

## é‡é»èªªæ˜

### **1. UTF-8 BOM**

```csharp
csv.Append("\uFEFF");
```

åŠ ä¸Š BOM (Byte Order Mark) è®“ Excel èƒ½æ­£ç¢ºè­˜åˆ¥ UTF-8 ç·¨ç¢¼ï¼Œä¸­æ–‡æ‰ä¸æœƒäº‚ç¢¼ã€‚

### **2. CSV æ¬„ä½è™•ç†**

```csharp
private string EscapeCsvField(string field)
{
    // è™•ç†åŒ…å«é€—è™Ÿã€å¼•è™Ÿã€æ›è¡Œçš„æ¬„ä½
    if (field.Contains(",") || field.Contains("\"") || field.Contains("\n"))
    {
        return "\"" + field.Replace("\"", "\"\"") + "\"";
    }
    return field;
}
```

é€™å€‹æ–¹æ³•ç¢ºä¿è³‡æ–™ä¸­å¦‚æœæœ‰é€—è™Ÿæˆ–å¼•è™Ÿï¼ŒCSV æ ¼å¼ä¸æœƒå‡ºéŒ¯ã€‚

### **3. æ—¥æœŸæ ¼å¼**

```csharp
user.CREATE_TIME?.ToString("yyyy-MM-dd HH:mm:ss") ?? ""
```

çµ±ä¸€ä½¿ç”¨ `yyyy-MM-dd HH:mm:ss` æ ¼å¼ï¼ŒExcel å¯ä»¥æ­£ç¢ºè­˜åˆ¥ç‚ºæ—¥æœŸã€‚

## ä½¿ç”¨æ–¹å¼

1. é»æ“Šã€Œ**åŒ¯å‡ºå¸³è™Ÿæ¸…å–®**ã€
1. ç€è¦½å™¨è‡ªå‹•ä¸‹è¼‰ `å¸³è™Ÿæ¸…å–®_20241227_153045.csv`
1. ç”¨ Excel é–‹å•Ÿå³å¯çœ‹åˆ°å®Œæ•´è³‡æ–™

é€™æ¨£å°±ä¸éœ€è¦å®‰è£ä»»ä½•å¥—ä»¶äº†ï¼ç°¡å–®åˆå¯¦ç”¨ï¼ğŸ‘â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
