éå¸¸æ£’ï¼Œä½ æ•´å€‹æ¶æ§‹é‚è¼¯æˆ‘å®Œå…¨çœ‹æ‡‚äº† ğŸ‘
ä½ ç¾åœ¨çš„ç³»çµ±å…¶å¯¦æœ‰ å…©ç¨®å…¥å£ é€²å…¥ã€Œç¾¤çµ„æ¬Šé™è¨­å®šï¼ˆGroupManagementï¼‰ã€é é¢ï¼š

â¸»

ğŸ§­ ç›®å‰å…©ç¨®å…¥å£é‚è¼¯æ¦‚æ³

ä¾†æº	èªªæ˜	æ¬Šé™ä¾†æº	ç¶²å€æ˜¯å¦å¸¶åƒæ•¸	Session æ˜¯å¦è¨­å®š
âœ… 1ï¸âƒ£ Tokenï¼ˆå¾ DLL é€²ä¾†ï¼‰	å¤–éƒ¨ç³»çµ±æŒ‰ã€Œæ¬Šé™è¨­å®šã€å°å…¥	ç”± Token é©—è­‰ systemIdã€groupId	âŒ ä¸å¸¶åƒæ•¸	âœ… TokenEntry å¯«å…¥ Session
âœ… 2ï¸âƒ£ SYS_PERMISSION_SETï¼ˆå¾ç«™å°å…§é€²ï¼‰	æ¬Šé™ç®¡ç†ä¸»æ§å°ã€Œç³»çµ±ä¸‹æ‹‰é¸æ“‡ã€é€²å…¥	å…§éƒ¨ç®¡ç†å“¡ï¼ˆ001 ç¾¤çµ„ï¼‰	âœ… å¸¶åƒæ•¸ï¼ˆsysIdã€groupId=001ï¼‰	âœ… RedirectToGroupManagement å¯«å…¥ Session


â¸»

ğŸš¨ å•é¡Œé»

ä½ æ“”å¿ƒçš„æ²’éŒ¯ï¼š

ã€Œå¾ç«™å°å…§é€²ã€çš„ goToGroupManagement() ç›®å‰æ˜¯ç›´æ¥çµ„ URL å¸¶åƒæ•¸ã€‚
é€™è¡¨ç¤ºä»»ä½•äººéƒ½å¯ä»¥æ‰‹å‹•æ”¹ç¶²å€é€²åˆ°åˆ¥çš„ sysId æˆ– groupIdã€‚

â¸»

âœ… å»ºè­°æœ€ä½³æ¶æ§‹ï¼ˆç°¡æ½” + å®‰å…¨ï¼‰

è®“å…©ç¨®æƒ…æ³éƒ½çµ±ä¸€åˆ°åŒæ¨£çš„é‚è¼¯ï¼š
	â€¢	éƒ½ä¸å¸¶åƒæ•¸é€² /AP/GroupManagement
	â€¢	éƒ½é€é Session é©—è­‰ ä¾†è¾¨è­˜é€²å…¥ä¾†æº

â¸»

ğŸ§© Step 1ï¼šä¿®æ”¹ RedirectToGroupManagement

é€™å€‹ Action ä¸ç”¨è®“å‰ç«¯è‡ªå·±çµ„ URLï¼Œ
ç”±å¾Œç«¯ç›´æ¥ Redirectï¼ˆæˆ–å›å‚³çµ±ä¸€ URLï¼Œä¸å¸¶åƒæ•¸ï¼‰ã€‚

[HttpPost]
public JsonResult RedirectToGroupManagement(string sysId)
{
    try
    {
        if (string.IsNullOrWhiteSpace(sysId))
            return Json(new { success = false, message = "è«‹é¸æ“‡ç³»çµ±" });

        if (!IsValidSystemId(sysId))
            return Json(new { success = false, message = "ç„¡æ•ˆçš„ç³»çµ±IDæ ¼å¼" });

        // å¯« Session
        Session["CurrentSystemId"] = sysId;
        Session["CurrentGroupId"] = "001";       // ç³»çµ±ç®¡ç†å“¡å›ºå®šç¾¤çµ„
        Session["FromInternalSite"] = true;

        return Json(new { success = true });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "å°å‘å¤±æ•—ï¼š" + ex.Message });
    }
}


â¸»

ğŸ§© Step 2ï¼šä¿®æ”¹å‰ç«¯ goToGroupManagement()

ä¸å†è‡ªå·±çµ„ URLï¼Œåªè¦æˆåŠŸå°±å°å‘å›ºå®šçš„é é¢ /AP/GroupManagementï¼š

function goToGroupManagement() {
    var sysId = $('#systemSelect').val();
    if (!sysId) {
        alert('è«‹é¸æ“‡ç³»çµ±');
        return;
    }

    $.ajax({
        url: '@Url.Action("RedirectToGroupManagement", "SYS")',
        type: 'POST',
        data: { sysId: sysId },
        dataType: 'json',
        success: function (response) {
            if (response.success) {
                window.location.href = '@Url.Action("GroupManagement", "AP")';
            } else {
                alert(response.message || 'å°å‘å¤±æ•—');
            }
        },
        error: function () {
            alert('å°å‘æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    });
}


â¸»

ğŸ§© Step 3ï¼šAPController.GroupManagement çµ±ä¸€åªè®€ Session

[TokenAuthorize]
public ActionResult GroupManagement()
{
    var systemId = Session["CurrentSystemId"] as string;
    var groupId  = Session["CurrentGroupId"]  as string;

    if (string.IsNullOrEmpty(systemId) || string.IsNullOrEmpty(groupId))
        return Content("æœªæˆæ¬Šæˆ– Session å·²å¤±æ•ˆ");

    bool isFromInternalSite = Session["FromInternalSite"] != null && (bool)Session["FromInternalSite"];

    ViewBag.SystemId = systemId;
    ViewBag.GroupId = groupId;
    ViewBag.Title = "ç¾¤çµ„æ¬Šé™ç®¡ç† - " + systemId;
    ViewBag.ShowSwitchButton = isFromInternalSite; // å¾ç«™å°é€²ä¾†æ‰é¡¯ç¤ºåˆ‡æ›æŒ‰éˆ•

    return View();
}


â¸»

ğŸ§© Step 4ï¼šè®“ View åˆ¤æ–·é¡¯ç¤ºæŒ‰éˆ•

åœ¨ GroupManagement.cshtmlï¼š

@if (ViewBag.ShowSwitchButton)
{
    <button class="btn btn-secondary" onclick="location.href='@Url.Action("SYS_PERMISSION_SET","SYS")'">è¿”å›ç³»çµ±é¸æ“‡</button>
}


â¸»

âœ… å¯¦éš›æ•ˆæœæ¯”è¼ƒ

ä¾†æº	æ˜¯å¦å¸¶åƒæ•¸	Session å¯«å…¥ä½ç½®	æ¬Šé™æ§åˆ¶	çµæœ
Token å…¥å£	âŒ ä¸å¸¶	TokenEntry	JWT é©—è­‰	å®‰å…¨
SYS å…¥å£	âŒ ä¸å¸¶	RedirectToGroupManagement	å›ºå®šç¾¤çµ„ 001	å®‰å…¨
æƒ¡æ„æ‰‹æ”¹ç¶²å€	âŒ ä¸ç”Ÿæ•ˆ	ç„¡åˆæ³• Session	è¢«æ“‹	âœ… ç„¡æ³•è¶Šæ¬Š


â¸»

âœ… å»¶ä¼¸å»ºè­°

ä½ ä¹Ÿå¯ä»¥åœ¨ TokenAuthorize åŠ å¼·å®‰å…¨æ€§ï¼š
è‹¥æ˜¯ FromInternalSite = true å‰‡å…è¨±ç¾¤çµ„ 001ï¼Œ
å¦å‰‡å¿…é ˆé€šé Tokenã€‚

ä¾‹å¦‚ï¼š

protected override bool AuthorizeCore(HttpContextBase httpContext)
{
    var sys = httpContext.Session["CurrentSystemId"] as string;
    var grp = httpContext.Session["CurrentGroupId"]  as string;
    var internalSite = (bool?)httpContext.Session["FromInternalSite"] ?? false;

    if (internalSite && grp == "001") return true;  // ç«™å°å…§é€²ä¾†å¯ç”¨
    return !(string.IsNullOrEmpty(sys) || string.IsNullOrEmpty(grp));
}


â¸»

âœ… ç¸½çµ

ä½ çš„è¨­è¨ˆé‚è¼¯æ˜¯å°çš„ï¼Œåªè¦åŠ é€™ä¸‰é»å°±å®Œç¾å®‰å…¨ï¼š
	1.	å…©ç¨®å…¥å£éƒ½çµ±ä¸€é€²å…¥ /AP/GroupManagementï¼Œä¸å¸¶ä»»ä½•åƒæ•¸ã€‚
	2.	Session æ§åˆ¶ä¾†æºï¼ˆTokenEntry æˆ–ç«™å°å…§éƒ¨ï¼‰ï¼Œè¦–æƒ…æ³è¨­ GroupId / Flagã€‚
	3.	å¾Œç«¯å…¨ç¨‹ç”¨ Session é©—è­‰ï¼Œä¸ä¿¡ä»»ç¶²å€æˆ–å‰ç«¯è¼¸å…¥ã€‚

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ é †ä¾¿æŠŠ [TokenAuthorize] åŠ ä¸Šé€™å€‹ã€Œç«™å°ä¾†æºç™½åå–®ã€çš„å®Œæ•´ç‰ˆæœ¬ï¼Ÿ
é€™æ¨£ä½ ä¹‹å¾Œæ‰€æœ‰å¾å…§éƒ¨é–‹å•Ÿçš„é é¢ä¹Ÿä¸ç”¨é‡å¯«åˆ¤æ–·ã€‚