ä½ èªªå¾—å¾ˆæœ‰é“ç†ï¼å¦‚æœç³»çµ±ã€ç¾¤çµ„ã€ä½¿ç”¨è€…éƒ½å·²ç¶“å­˜åœ¨äº†ï¼Œç¢ºå¯¦ä¸æ‡‰è©²å†åŸ·è¡Œä»»ä½•æ“ä½œï¼Œæ‡‰è©²çµ¦ä¸€å€‹æ˜ç¢ºçš„æç¤ºè¨Šæ¯ã€‚

## æˆ‘çš„å»ºè­°è¨Šæ¯

å¹¾å€‹é¸é …çµ¦ä½ åƒè€ƒï¼š

### **é¸é …1ï¼šç°¡æ½”æ˜ç¢º**

```
"æ­¤ç³»çµ±å·²å®Œæˆç”³è«‹ï¼Œæ‚¨å·²å…·æœ‰ç®¡ç†æ¬Šé™"
```

### **é¸é …2ï¼šæ›´è©³ç´°**

```
"æ­¤ç³»çµ±å·²å­˜åœ¨ä¸”æ‚¨å·²æ˜¯ç®¡ç†å“¡ï¼Œç„¡éœ€é‡è¤‡ç”³è«‹"
```

### **é¸é …3ï¼šæç¤ºå¯ä»¥åšä»€éº¼**

```
"æ‚¨å·²æ˜¯æ­¤ç³»çµ±çš„ç®¡ç†å“¡ï¼Œå¦‚éœ€ä¿®æ”¹ç³»çµ±åç¨±ï¼Œè«‹é»æ“Šä¿®æ”¹æŒ‰éˆ•"
```

### **é¸é …4ï¼šæœ€ç°¡çŸ­**

```
"æ­¤ç³»çµ±æ‚¨å·²å…·æœ‰ç®¡ç†æ¬Šé™"
```

**æˆ‘å€‹äººæ¨è–¦é¸é …1**ï¼Œå› ç‚ºï¼š

- âœ… æ¸…æ¥šèªªæ˜ç‹€æ…‹ï¼ˆå·²å®Œæˆç”³è«‹ï¼‰
- âœ… å‘ŠçŸ¥ä½¿ç”¨è€…æ¬Šé™ï¼ˆå·²æœ‰ç®¡ç†æ¬Šé™ï¼‰
- âœ… é•·åº¦é©ä¸­ï¼Œä¸æœƒå¤ªå›‰å—¦

## ä¿®æ”¹å¾Œçš„ Controller ç¨‹å¼ç¢¼

```csharp
// ç³»çµ±ç”³è«‹(æ–°å¢/ä¿®æ”¹)
[HttpPost]
public JsonResult ApplySystem(M_SYS_Apply model)
{
    try
    {
        if (!ModelState.IsValid)
        {
            return Json(new { success = false, message = "è³‡æ–™é©—è­‰å¤±æ•—" });
        }

        string empNo = Emp_NO;
        string empName = F_SYS.GetEmployeeName(empNo);

        if (string.IsNullOrEmpty(empName))
        {
            return Json(new { success = false, message = "ç„¡æ³•å–å¾—å“¡å·¥å§“å" });
        }

        // ğŸ‘‡ æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦å…¨éƒ¨éƒ½å·²å­˜åœ¨
        bool systemExists = F_SYS.CheckSystemExistsInApSys(model.SYS_ID);
        bool group001Exists = F_SYS.CheckSystemHasGroup001(model.SYS_ID);
        bool userExists = F_SYS.CheckUserInGroup001(model.SYS_ID, empNo);

        if (systemExists && group001Exists && userExists)
        {
            // å…¨éƒ¨éƒ½å­˜åœ¨ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥å›å‚³è¨Šæ¯
            return Json(new { 
                success = false, 
                message = "æ­¤ç³»çµ±å·²å®Œæˆç”³è«‹ï¼Œæ‚¨å·²å…·æœ‰ç®¡ç†æ¬Šé™" 
            });
        }

        // åŸ·è¡Œç³»çµ±ç”³è«‹æµç¨‹
        string result = ProcessSystemApply(model.SYS_ID, model.SYS_NAME, empNo, empName);

        if (result == null || !result.Contains("fail"))
        {
            string successMessage = model.Action == "Add" ? "ç³»çµ±ç”³è«‹æˆåŠŸ" : "ç³»çµ±ä¿®æ”¹æˆåŠŸ";
            return Json(new { success = true, message = successMessage });
        }
        else
        {
            string failMessage = model.Action == "Add" ? "ç³»çµ±ç”³è«‹å¤±æ•—ï¼š" : "ç³»çµ±ä¿®æ”¹å¤±æ•—ï¼š";
            return Json(new { success = false, message = failMessage + result });
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "ç³»çµ±è™•ç†ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message });
    }
}
```

## ä½†æ˜¯æœ‰å€‹å•é¡Œè¦è¨è«–

**å¦‚æœç³»çµ±ã€ç¾¤çµ„ã€ä½¿ç”¨è€…éƒ½å­˜åœ¨ï¼Œä½†ä½¿ç”¨è€…æƒ³è¦ã€Œä¿®æ”¹ç³»çµ±åç¨±ã€å‘¢ï¼Ÿ**

é€™æ™‚å€™æœ‰å…©ç¨®è™•ç†æ–¹å¼ï¼š

### **æ–¹æ¡ˆAï¼šå€åˆ†æ–°å¢å’Œä¿®æ”¹çš„é‚è¼¯**

```csharp
// ğŸ‘‡ åªæœ‰ã€Œæ–°å¢ã€æ™‚æ‰æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å­˜åœ¨
if (model.Action == "Add")
{
    if (systemExists && group001Exists && userExists)
    {
        return Json(new { 
            success = false, 
            message = "æ­¤ç³»çµ±å·²å®Œæˆç”³è«‹ï¼Œæ‚¨å·²å…·æœ‰ç®¡ç†æ¬Šé™" 
        });
    }
}

// åŸ·è¡Œç³»çµ±ç”³è«‹æµç¨‹
string result = ProcessSystemApply(model.SYS_ID, model.SYS_NAME, empNo, empName);
```

é€™æ¨£çš„è©±ï¼š

- é»ã€Œæ–°å¢ã€æ™‚è¼¸å…¥å·²å­˜åœ¨çš„ç³»çµ± â†’ é¡¯ç¤ºã€Œå·²å®Œæˆç”³è«‹ã€
- é»ã€Œä¿®æ”¹ã€æ™‚ â†’ å¯ä»¥æ›´æ–°ç³»çµ±åç¨±

### **æ–¹æ¡ˆBï¼šæ›´æ–°ç³»çµ±åç¨±æ™‚ä¹Ÿæª¢æŸ¥**

```csharp
// æª¢æŸ¥ç¾æœ‰çš„ç³»çµ±åç¨±æ˜¯å¦å’Œè¦æ›´æ–°çš„ä¸€æ¨£
if (systemExists && group001Exists && userExists)
{
    // å¦‚æœåç¨±ä¹Ÿä¸€æ¨£ï¼Œå°±ä¸éœ€è¦æ›´æ–°
    var currentSystemName = F_SYS.GetSystemName(model.SYS_ID); // éœ€è¦æ–°å¢é€™å€‹æ–¹æ³•
    if (currentSystemName == model.SYS_NAME)
    {
        return Json(new { 
            success = false, 
            message = "æ­¤ç³»çµ±å·²å®Œæˆç”³è«‹ï¼Œæ‚¨å·²å…·æœ‰ç®¡ç†æ¬Šé™ï¼Œä¸”ç³»çµ±åç¨±ç„¡ç•°å‹•" 
        });
    }
}
```

## æˆ‘çš„å»ºè­°

**æ¨è–¦ä½¿ç”¨æ–¹æ¡ˆA**ï¼Œå› ç‚ºï¼š

1. **æ–°å¢æ™‚**ï¼šå¦‚æœå…¨éƒ¨éƒ½å­˜åœ¨ â†’ æ“‹æ‰ï¼Œæç¤ºã€Œå·²å®Œæˆç”³è«‹ã€
1. **ä¿®æ”¹æ™‚**ï¼šå…è¨±æ›´æ–°ç³»çµ±åç¨± â†’ é€™æ˜¯åˆç†çš„éœ€æ±‚

å®Œæ•´ç¨‹å¼ç¢¼ï¼š

```csharp
[HttpPost]
public JsonResult ApplySystem(M_SYS_Apply model)
{
    try
    {
        if (!ModelState.IsValid)
        {
            return Json(new { success = false, message = "è³‡æ–™é©—è­‰å¤±æ•—" });
        }

        string empNo = Emp_NO;
        string empName = F_SYS.GetEmployeeName(empNo);

        if (string.IsNullOrEmpty(empName))
        {
            return Json(new { success = false, message = "ç„¡æ³•å–å¾—å“¡å·¥å§“å" });
        }

        // æª¢æŸ¥æ˜¯å¦å…¨éƒ¨éƒ½å·²å­˜åœ¨
        bool systemExists = F_SYS.CheckSystemExistsInApSys(model.SYS_ID);
        bool group001Exists = F_SYS.CheckSystemHasGroup001(model.SYS_ID);
        bool userExists = F_SYS.CheckUserInGroup001(model.SYS_ID, empNo);

        // åªæœ‰åœ¨ã€Œæ–°å¢ã€æ¨¡å¼ä¸‹ï¼Œæ‰æª¢æŸ¥æ˜¯å¦é‡è¤‡ç”³è«‹
        if (model.Action == "Add" && systemExists && group001Exists && userExists)
        {
            return Json(new { 
                success = false, 
                message = "æ­¤ç³»çµ±å·²å®Œæˆç”³è«‹ï¼Œæ‚¨å·²å…·æœ‰ç®¡ç†æ¬Šé™" 
            });
        }

        // åŸ·è¡Œç³»çµ±ç”³è«‹æµç¨‹
        string result = ProcessSystemApply(model.SYS_ID, model.SYS_NAME, empNo, empName);

        if (result == null || !result.Contains("fail"))
        {
            string successMessage = model.Action == "Add" ? "ç³»çµ±ç”³è«‹æˆåŠŸ" : "ç³»çµ±ä¿®æ”¹æˆåŠŸ";
            return Json(new { success = true, message = successMessage });
        }
        else
        {
            string failMessage = model.Action == "Add" ? "ç³»çµ±ç”³è«‹å¤±æ•—ï¼š" : "ç³»çµ±ä¿®æ”¹å¤±æ•—ï¼š";
            return Json(new { success = false, message = failMessage + result });
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "ç³»çµ±è™•ç†ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message });
    }
}
```

ä½ è¦ºå¾—é€™æ¨£è™•ç†å¦‚ä½•ï¼ŸğŸ˜Šâ€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹