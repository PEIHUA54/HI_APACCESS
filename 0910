å•é¡Œæ‰¾åˆ°äº†ï¼æ‚¨çš„ VIEW ä¸­æœ‰ **å…©å€‹ `id="errorTable"`**ï¼Œå°è‡´ jQuery ç„¡æ³•æ­£ç¢ºå¡«å…¥å¤±æ•—è³‡æ–™ï¼

## ğŸ› å•é¡Œåˆ†æ

```html
<!-- å¤±æ•—é¡¯ç¤º -->
<div id="errorSection" class="mt-4 d-none">
    <table class="table table-bordered table-striped" id="errorTable">  <!-- âŒ ç¬¬ä¸€å€‹ -->
        ...
    </table>
</div>

<!-- éƒ¨åˆ†æˆåŠŸé¡¯ç¤º -->
<div id="partialSection" class="mt-4 d-none">
    <table class="table table-bordered table-striped" id="errorTable">  <!-- âŒ ç¬¬äºŒå€‹ï¼Œé‡è¤‡äº†ï¼ -->
        ...
    </table>
</div>
```

ç•¶ JS åŸ·è¡Œ `$("#errorTable tbody")` æ™‚ï¼Œåªæœƒé¸åˆ°**ç¬¬ä¸€å€‹**ï¼Œå°è‡´éƒ¨åˆ†æˆåŠŸæ™‚ç„¡æ³•é¡¯ç¤ºéŒ¯èª¤åˆ—è¡¨ã€‚

-----

## âœ… è§£æ±ºæ–¹æ¡ˆ 1ï¼šä¿®æ”¹ VIEWï¼ˆæ¨è–¦ï¼‰

çµ¦å…©å€‹è¡¨æ ¼ä¸åŒçš„ IDï¼š

```html
<!-- åŒ¯å…¥ Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <!-- ä¸Šå‚³å€ -->
                <div id="uploadFormSection">
                    <form id="importForm" enctype="multipart/form-data" method="post">
                        <input type="hidden" name="apgNo" id="importGroupNo" />
                        <input type="hidden" name="sysID" id="importSysID" value="@Session["CurrentSystemId"]" />
                        <div class="mb-3">
                            <input type="file" class="form-control" name="file" accept=".xls,.xlsx" required />
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">åŒ¯å…¥</button>
                            <button type="button" class="btn btn-success" onclick="downloadTemplate()">
                                <i class="fas fa-download"></i> ä¸‹è¼‰ç¯„æœ¬
                            </button>
                        </div>
                    </form>

                    <!-- åŒ¯å…¥é€²åº¦ -->
                    <div id="uploadProgress" class="progress mt-3 d-none">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- æˆåŠŸé¡¯ç¤º -->
                <div id="successSection" class="mt-4 d-none">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong id="successMessage"></strong>
                    </div>
                </div>

                <!-- å¤±æ•—é¡¯ç¤º -->
                <div id="errorSection" class="mt-4 d-none">
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i>
                        <strong id="errorMessage"></strong>
                    </div>
                    <div class="table-responsive mt-2">
                        <table class="table table-bordered table-striped table-sm" id="failErrorTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 80px;">è¡Œè™Ÿ</th>
                                    <th style="width: 120px;">å“¡å·¥ç·¨è™Ÿ</th>
                                    <th>éŒ¯èª¤è¨Šæ¯</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-warning btn-retry-upload">
                            <i class="fas fa-redo"></i> é‡æ–°ä¸Šå‚³
                        </button>
                    </div>
                </div>

                <!-- éƒ¨åˆ†æˆåŠŸé¡¯ç¤º -->
                <div id="partialSection" class="mt-4 d-none">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong id="partialMessage"></strong>
                    </div>
                    <div class="table-responsive mt-2">
                        <table class="table table-bordered table-striped table-sm" id="partialErrorTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 80px;">è¡Œè™Ÿ</th>
                                    <th style="width: 120px;">å“¡å·¥ç·¨è™Ÿ</th>
                                    <th>éŒ¯èª¤è¨Šæ¯</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-warning btn-retry-upload">
                            <i class="fas fa-redo"></i> é‡æ–°ä¸Šå‚³
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>
```

-----

## âœ… è§£æ±ºæ–¹æ¡ˆ 2ï¼šä¿®æ”¹ JS

```javascript
// æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…MODAL
function openImportModal() {
    $('#importGroupNo').val($('#groupSelect').val());
    $('#importSysID').val(currentSysID);
    
    // æ¸…ç©ºæ‰€æœ‰å€å¡Š
    $("#errorSection, #successSection, #partialSection, #uploadFormSection").addClass("d-none");
    $("#uploadProgress").addClass("d-none");
    $(".progress-bar").css("width", "0%");
    $("#failErrorTable tbody, #partialErrorTable tbody").empty();
    
    // é¡¯ç¤ºä¸Šå‚³è¡¨å–®
    $("#uploadFormSection").removeClass("d-none");
    
    $('#importModal').modal('show');
}

// åŒ¯å…¥è¡¨å–®é€å‡º
$("#importForm").off("submit").on("submit", function (e) {
    e.preventDefault();

    var formData = new FormData(this);

    if (!formData.has('sysID')) formData.append('sysID', currentSysID);
    if (!formData.has('apgNo')) formData.append('apgNo', $('#groupSelect').val() || currentGroup);

    // é¡¯ç¤ºé€²åº¦æ¢
    $("#uploadProgress").removeClass("d-none");
    $(".progress-bar").css("width", "50%");

    $.ajax({
        url: '@Url.Action("ImportUsers", "AP")',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        dataType: 'json',
        success: function (res) {
            console.log('[ImportUsers][Response]=', res);

            // éš±è—é€²åº¦æ¢
            $("#uploadProgress").addClass("d-none");
            $(".progress-bar").css("width", "0%");

            // æ¸…ç©ºæ‰€æœ‰èˆŠè¨Šæ¯
            $("#successSection, #errorSection, #partialSection").addClass("d-none");
            $("#failErrorTable tbody, #partialErrorTable tbody").empty();

            // è§£æå›æ‡‰
            const status = (res.status || res.Status || '').toString().toLowerCase();
            const message = res.message || res.Message || '';
            const rawErrs = res.errors || res.ErrorMessages || res.errorMessages || [];

            const errors = (Array.isArray(rawErrs) ? rawErrs : []).map((e, i) => ({
                RowNumber: e.RowNumber ?? e.row ?? e.Row ?? (i + 2), // +2 å› ç‚ºç¬¬1åˆ—æ˜¯è¡¨é ­
                EmpNo: e.EmpNo ?? e.empNo ?? e.EMP_NO ?? '',
                Message: e.Message ?? e.message ?? e.Error ?? e.error ?? 'æœªçŸ¥éŒ¯èª¤'
            }));

            console.log('[Parsed Errors]=', errors);

            // === å…¨éƒ¨æˆåŠŸ ===
            if (status === 'success') {
                $("#successMessage").text(message || 'å·²å…¨éƒ¨æˆåŠŸåŒ¯å…¥ï¼');
                $("#successSection").removeClass("d-none");
                $("#uploadFormSection").addClass("d-none"); // éš±è—ä¸Šå‚³è¡¨å–®
                loadUsers(); // é‡æ–°è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
                return;
            }

            // === å…¨éƒ¨å¤±æ•— ===
            if (status === 'fail') {
                $("#errorMessage").text(message || 'åŒ¯å…¥å¤±æ•—');
                
                if (errors.length === 0) {
                    $("#failErrorTable tbody").append(
                        `<tr><td colspan="3" class="text-center text-muted">ç„¡è©³ç´°éŒ¯èª¤è³‡è¨Š</td></tr>`
                    );
                } else {
                    errors.forEach(err => {
                        $("#failErrorTable tbody").append(
                            `<tr>
                                <td class="text-center">${err.RowNumber}</td>
                                <td>${$('<div>').text(err.EmpNo).html()}</td>
                                <td>${$('<div>').text(err.Message).html()}</td>
                            </tr>`
                        );
                    });
                }
                
                $("#errorSection").removeClass("d-none");
                $("#uploadFormSection").addClass("d-none");
                return;
            }

            // === éƒ¨åˆ†æˆåŠŸ ===
            if (status === 'partial') {
                $("#partialMessage").text(message || 'éƒ¨åˆ†æˆåŠŸã€éƒ¨åˆ†å¤±æ•—');
                
                if (errors.length === 0) {
                    $("#partialErrorTable tbody").append(
                        `<tr><td colspan="3" class="text-center text-muted">ç„¡è©³ç´°éŒ¯èª¤è³‡è¨Š</td></tr>`
                    );
                } else {
                    errors.forEach(err => {
                        $("#partialErrorTable tbody").append(
                            `<tr>
                                <td class="text-center">${err.RowNumber}</td>
                                <td>${$('<div>').text(err.EmpNo).html()}</td>
                                <td>${$('<div>').text(err.Message).html()}</td>
                            </tr>`
                        );
                    });
                }
                
                $("#partialSection").removeClass("d-none");
                $("#uploadFormSection").addClass("d-none");
                loadUsers(); // é‡æ–°è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
                return;
            }

            // === æœªçŸ¥ç‹€æ…‹ ===
            $("#errorMessage").text(message || 'æœªçŸ¥çš„å›æ‡‰ç‹€æ…‹ï¼Œè«‹æª¢æŸ¥ Console');
            $("#failErrorTable tbody").append(
                `<tr><td colspan="3" class="text-center text-danger">è«‹æª¢æŸ¥å¾Œç«¯å›å‚³æ ¼å¼</td></tr>`
            );
            $("#errorSection").removeClass("d-none");
            $("#uploadFormSection").addClass("d-none");
        },
        error: function (xhr, status, error) {
            console.error('[ImportUsers][Error]=', xhr, status, error);
            
            $("#uploadProgress").addClass("d-none");
            $(".progress-bar").css("width", "0%");
            
            $("#errorMessage").text('ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤ï¼š' + (xhr.responseText || error));
            $("#failErrorTable tbody").append(
                `<tr><td colspan="3" class="text-center text-danger">è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«ç³»çµ±ç®¡ç†å“¡</td></tr>`
            );
            $("#errorSection").removeClass("d-none");
            $("#uploadFormSection").addClass("d-none");
        }
    });
});

// é‡æ–°ä¸Šå‚³æŒ‰éˆ•
$(document).on('click', '.btn-retry-upload', function() {
    // æ¸…ç©ºæ‰€æœ‰å€å¡Š
    $("#errorSection, #successSection, #partialSection").addClass("d-none");
    $("#failErrorTable tbody, #partialErrorTable tbody").empty();
    
    // é¡¯ç¤ºä¸Šå‚³è¡¨å–®
    $("#uploadFormSection").removeClass("d-none");
    
    // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
    $("#importForm")[0].reset();
});
```

-----

## ğŸ” Debug é‡é»

### 1. æª¢æŸ¥å¾Œç«¯å›å‚³æ ¼å¼

åœ¨ Controller çš„ `ImportUsers` ç¢ºä¿å›å‚³æ ¼å¼æ­£ç¢ºï¼š

```csharp
// å…¨éƒ¨æˆåŠŸ
return Json(new
{
    status = "success",
    message = $"åŒ¯å…¥æˆåŠŸï¼šå…± {importResult.SuccessCount} ç­†"
});

// å…¨éƒ¨å¤±æ•—
return Json(new
{
    status = "fail",
    message = "åŒ¯å…¥å¤±æ•—ï¼šè«‹é‡æ–°ä¸Šå‚³",
    errors = importResult.ErrorMessages  // â­ ç¢ºä¿é€™è£¡æœ‰è³‡æ–™
});

// éƒ¨åˆ†æˆåŠŸ
return Json(new
{
    status = "partial",
    message = $"åŒ¯å…¥éƒ¨åˆ†æˆåŠŸï¼šæˆåŠŸ {importResult.SuccessCount} ç­†ï¼Œå¤±æ•— {importResult.ErrorMessages.Count} ç­†",
    errors = importResult.ErrorMessages  // â­ ç¢ºä¿é€™è£¡æœ‰è³‡æ–™
});
```

### 2. ç¢ºèª ImportError é¡åˆ¥å®šç¾©

```csharp
public class ImportError
{
    public int RowNumber { get; set; }
    public string EmpNo { get; set; }
    public string Message { get; set; }
}
```

### 3. åœ¨ç€è¦½å™¨ Console æª¢æŸ¥

æ‰“é–‹ç€è¦½å™¨ F12ï¼ŒæŸ¥çœ‹ï¼š

```javascript
console.log('[ImportUsers][Response]=', res);
console.log('[Parsed Errors]=', errors);
```

-----

## ğŸ“Š æ¸¬è©¦æ­¥é©Ÿ

1. **å…¨éƒ¨æˆåŠŸ**ï¼šä¸Šå‚³ä¸€å€‹éƒ½æ˜¯æ­£ç¢ºçš„ Excel

- æ‡‰è©²é¡¯ç¤ºç¶ è‰²æˆåŠŸè¨Šæ¯
- ä¸é¡¯ç¤ºéŒ¯èª¤è¡¨æ ¼

1. **å…¨éƒ¨å¤±æ•—**ï¼šä¸Šå‚³ä¸€å€‹éƒ½æ˜¯éŒ¯èª¤çš„ Excelï¼ˆä¾‹å¦‚ä¸å­˜åœ¨çš„å“¡å·¥ç·¨è™Ÿï¼‰

- æ‡‰è©²é¡¯ç¤ºç´…è‰²å¤±æ•—è¨Šæ¯
- é¡¯ç¤º `failErrorTable` éŒ¯èª¤åˆ—è¡¨

1. **éƒ¨åˆ†æˆåŠŸ**ï¼šä¸Šå‚³ä¸€å€‹æœ‰å°æœ‰éŒ¯çš„ Excel

- æ‡‰è©²é¡¯ç¤ºé»ƒè‰²è­¦å‘Šè¨Šæ¯
- é¡¯ç¤º `partialErrorTable` éŒ¯èª¤åˆ—è¡¨
- æˆåŠŸçš„è³‡æ–™æ‡‰è©²å‡ºç¾åœ¨ä½¿ç”¨è€…åˆ—è¡¨ä¸­

-----

é€™æ¨£ä¿®æ”¹å¾Œæ‡‰è©²å°±å¯ä»¥æ­£å¸¸é¡¯ç¤ºéŒ¯èª¤è³‡æ–™äº†ï¼å¦‚æœé‚„æœ‰å•é¡Œï¼Œè«‹è²¼ä¸Šç€è¦½å™¨ Console çš„è¼¸å‡ºï¼Œæˆ‘å†å¹«æ‚¨æª¢æŸ¥ã€‚â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹