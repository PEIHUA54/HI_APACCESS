   // 批次匯入使用者
   [HttpPost]
   public ActionResult ImportUsers(HttpPostedFileBase file, string apgNo, string sysID)
   {
       if (file == null || file.ContentLength == 0)
           return Json(new { success = false, message = "請選擇要匯入的Excel檔案" });

       if (string.IsNullOrWhiteSpace(apgNo))
           return Json(new { success = false, message = "請先選擇群組" });

       // 副檔名限制
       var ext = Path.GetExtension(file.FileName).ToLower();
       if (ext != ".xls" && ext != ".xlsx")
           return Json(new { success = false, message = "請上傳Excel檔案（.xls 或 .xlsx）" });

       // 上傳暫存
       var uploadDir = Server.MapPath("~/Upload");
       if (!Directory.Exists(uploadDir)) Directory.CreateDirectory(uploadDir);

       var safeName = $"Import_{apgNo}_{DateTime.Now:yyyyMMddHHmmss}{ext}";
       var uploadPath = PathValidator.GetSafePath(uploadDir, safeName);

       try
       {
           file.SaveAs(uploadPath);

           var service = GetAPService();
           var importResult = service.ImportUsersFromExcel(uploadPath, CurrentSystemId , apgNo, this.Emp_NO);

           if (importResult.SuccessCount > 0 && importResult.ErrorMessages.Count == 0)
           {
               // 全部成功
               return Json(new
               {
                   status = "success",
                   message = $"匯入成功：共 {importResult.SuccessCount} 筆"
               });
           }
           else if (importResult.SuccessCount == 0 && importResult.ErrorMessages.Count > 0)
           {
               // 全部失敗
               return Json(new
               {
                   status = "fail",
                   message = "匯入失敗：請重新上傳",
                   errors = importResult.ErrorMessages
               });
           }
           else
           {
               // 部分成功
               return Json(new
               {
                   status = "partial",
                   message = $"匯入部分成功：成功 {importResult.SuccessCount} 筆，失敗 {importResult.ErrorMessages.Count} 筆",
                   errors = importResult.ErrorMessages
               });
           }
       }
       catch (Exception ex)
       {
           return Json(new { success = false, message = "匯入過程發生錯誤：" + ex.Message });
       }
       finally
       {
           if (System.IO.File.Exists(uploadPath))
           {
               var fc = new F_Common();
               fc.SafeDeleteFile(uploadDir, safeName);
           }
       }
   }
