å¥½ ğŸ‘ æˆ‘ç¹¼çºŒå¹«ä½ æŠŠæ­¥é©Ÿè£œå®Œæ•´ï¼Œé‡å° AD â†’ å“¡ç·¨æ¬é€² DLL èˆ‡ æ›¿æ›æ‰èˆŠçš„ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ï¼Œæ•´ç†æˆå…·é«”æ“ä½œã€‚

â¸»

A. æŠŠã€ŒADâ†’å“¡ç·¨ã€æ¬é€² HI_APACCESS

1. å»ºç«‹å…±ç”¨ Factoryï¼šFIdentity.cs

æ”¾åœ¨ HI_APACCESS_DLL_FRAMEWORK/Factory ä¸‹ã€‚

using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Data;
using HI_APACCESS_DLL_FRAMEWORK.Common;

namespace HI_APACCESS_DLL_FRAMEWORK.Factory
{
    internal class FIdentity
    {
        /// <summary>
        /// å°‡ AD è½‰æ›ç‚ºå“¡ç·¨
        /// </summary>
        internal static string GetEmpNoByAD(string ad, string environment)
        {
            if (string.IsNullOrEmpty(ad)) return null;

            string empNo = null;
            string sql = @"
                SELECT EMP_ID 
                FROM [HILIFE_MTS].[HI_APUSER].dbo.[NT_EMP] 
                WHERE EMP_ID != EMP_DOM_ID
                  AND LTRIM(RTRIM(EMP_DOM_ID)) != '' 
                  AND EMP_ID IN (
                        SELECT EMP_NO 
                        FROM [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST] 
                        WHERE END_DT IS NULL
                  ) 
                  AND EMP_DOM_ID = @AD";

            using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))
            using (SqlCommand cmd = new SqlCommand(sql, conn))
            {
                cmd.Parameters.AddWithValue("@AD", ad);
                conn.Open();
                var result = cmd.ExecuteScalar();
                if (result != null)
                {
                    empNo = result.ToString();
                }
            }

            // å¦‚æœæŸ¥ä¸åˆ°ï¼Œå°±ç›´æ¥å›å‚³ AD
            return string.IsNullOrEmpty(empNo) ? ad : empNo;
        }
    }
}


â¸»

2. ä¿®æ”¹åŠŸèƒ½ 1 Factoryï¼šFGetUserNameAndGroup

åŸæœ¬çš„æµç¨‹æ˜¯ç›´æ¥æ‹¿ UserAD å»æŸ¥ AP_USER â†’ æ”¹æˆï¼š
	â€¢	Step 1: å‘¼å« FIdentity.GetEmpNoByAD(UserAD, environment)
	â€¢	Step 2: æŠŠå¾—åˆ°çš„ å“¡ç·¨ (EMP_NO) å†å»æŸ¥ AP_USER / AP_GROUP

// æŠŠå‚³é€²ä¾†çš„ UserAD è½‰æ›ç‚º EMP_NO
string empNo = FIdentity.GetEmpNoByAD(userAd, environment);

// SQL æ”¹æˆç”¨ empNo
WHERE A.SYS_ID = @SYS_ID AND B.U_ID = @EMP_NO

é€™æ¨£ä»¥å¾Œæ‰€æœ‰æŸ¥è©¢çµ±ä¸€ç”¨å“¡ç·¨ï¼Œä¸æœƒæœ‰äººå†ç›´æ¥ç”¨ AD å»æ’è³‡æ–™ã€‚

â¸»

3. æä¾›å°å¤–çµ±ä¸€çš„æ¥å£ï¼ˆé¸æ“‡æ€§ï¼‰

åœ¨ APACCESS ä¸»é¡åˆ¥åŠ ä¸€å€‹æ–¹æ³•ï¼š

public string ResolveEmpNoByAD(string requestJson)
{
    var req = JsonConvert.DeserializeObject<CommonModels.ResolveEmpNoRequest>(requestJson);
    var empNo = FIdentity.GetEmpNoByAD(req.AD, req.Environment);

    var res = new CommonModels.ResolveEmpNoResponse
    {
        Result_code = Codes.SUCCESS,
        Msg = "æˆåŠŸ",
        EmpNo = empNo
    };

    return JsonConvert.SerializeObject(res);
}

æ–¹ä¾¿æœªä¾†å¦‚æœåˆ¥çš„å°ˆæ¡ˆåªæƒ³å–®ç´”åšã€ŒADâ†’å“¡ç·¨ã€æŸ¥è©¢ï¼Œå¯ä»¥ç›´æ¥å‘¼å«ã€‚

â¸»

B. æ›¿æ›æ‰èˆŠçš„ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™

ç¾åœ¨å¾ˆå¤šåœ°æ–¹é‚„å¯«æ­»é€™æ¨£ï¼š

string empNo = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ();

è¦æ”¹çš„æ–¹å‘
	1.	ä¸å†å‘¼å« SVS_DBmanager æŸ¥å“¡ç·¨
â†’ æ”¹æˆå‘¼å« DLL GetUserNameAndGroupï¼ŒæŠŠ AD ä¸Ÿé€²å»ï¼Œç›´æ¥å¾—åˆ° UserID (å·²ç¶“æ˜¯å“¡ç·¨)ã€‚
	2.	èˆŠçš„ Get_å“¡å·¥ç·¨è™Ÿ

string EMP_NO = string.IsNullOrEmpty(AD) ? Get_å“¡å·¥AD() : AD;
EMP_NO = GetEmpNoByAD(EMP_NO);

â†’ æ”¹æˆï¼š

var req = new GetUserNameAndGroupRequestModel
{
    SysID = "HI_POSIMG",
    UserAD = string.IsNullOrEmpty(AD) ? Get_å“¡å·¥AD() : AD,
    Environment = "TEST"
};

string jsonInput = JsonConvert.SerializeObject(req);
string response = new APACCESS().GetUserNameAndGroup(jsonInput);
var res = JsonConvert.DeserializeObject<GetUserNameAndGroupResponseModel>(response);
string EMP_NO = res.Result.UserID;  // âœ… å·²ç¶“æ˜¯å“¡ç·¨


	3.	èˆŠçš„ Get_å“¡å·¥åŸºæœ¬è³‡æ–™ã€Get_Treeã€Get_è³‡æ–™é¢æœ€é«˜æ¬Šé™
	â€¢	å…¨éƒ¨ SQL éƒ½ä¸è¦è‡ªå·±æ‰“ â†’ æ”¹ç”¨ DLL åŠŸèƒ½ 1~5
	â€¢	èˆ‰ä¾‹ï¼š
	â€¢	Get_Tree â†’ æ”¹å‘¼å« DLL åŠŸèƒ½ 3 (GetTree)
	â€¢	Get_è³‡æ–™é¢æœ€é«˜æ¬Šé™ â†’ æ”¹å‘¼å« DLL åŠŸèƒ½ 5 (CheckBtnEnabled)ï¼Œå‚³æŒ‡å®šåƒæ•¸

â¸»

C. æ­¥é©Ÿç¸½çµï¼ˆä½ æ€éº¼æ”¹ï¼‰
	1.	åœ¨ DLL æ–°å¢ FIdentity.cs â†’ å°ˆè²¬ ADâ†’å“¡ç·¨è½‰æ›
	2.	ä¿®æ”¹åŠŸèƒ½ 1 (FGetUserNameAndGroup) â†’ å‚³é€²ä¾†æ˜¯ ADï¼Œè½‰æˆå“¡ç·¨å†æŸ¥
	3.	ï¼ˆå¯é¸ï¼‰APACCESS å°å¤–å…¬é–‹ ResolveEmpNoByAD
	4.	Web å°ˆæ¡ˆï¼š
	â€¢	æŠŠæ‰€æœ‰ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ() æ”¹æ‰
	â€¢	æ”¹æˆå‘¼å« DLL â†’ åŠŸèƒ½ 1ï¼Œç›´æ¥æ‹¿å“¡ç·¨
	â€¢	æŠŠ Get_å“¡å·¥åŸºæœ¬è³‡æ–™ / Get_Tree / Get_è³‡æ–™é¢æœ€é«˜æ¬Šé™ ä¹Ÿæ”¹æ‰ï¼Œç›´æ¥å°æ‡‰ DLL åŠŸèƒ½ 1~5

â¸»

âš¡ é€™æ¨£æ”¹çš„å¥½è™•ï¼š
	â€¢	DLL çµ±ä¸€ç®¡ç†æ¬Šé™ã€å“¡å·¥è³‡æ–™ï¼Œé¿å…å„ç³»çµ±é‡è¤‡å¯« SQL
	â€¢	Web å°ˆæ¡ˆä¹¾æ·¨ï¼Œåªæœ‰å‘¼å« DLLï¼Œä¸å†è‡ªå·±æ‰“ DB
	â€¢	ä»¥å¾Œåªè¦ DLL æ”¹ä¸€å€‹åœ°æ–¹ï¼Œæ‰€æœ‰ç³»çµ±å°±ä¸€èµ·æ›´æ–°

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ åŠŸèƒ½ 1 (GetUserNameAndGroup) çš„ Factory å¯¦ä½œï¼Œç›´æ¥æ”¹å¥½æ”¯æ´ ADâ†’å“¡ç·¨çš„ç‰ˆæœ¬çµ¦ä½ ï¼Ÿ

å¥½å•é¡Œ ğŸ‘Œ æˆ‘å¹«ä½ æŠŠ SVS_å®¢è£½åŒ–å…ƒä»¶ çš„è™•ç†æ–¹å¼ä¹Ÿæ‹†çµ¦ä½ ï¼Œå› ç‚ºé€™å€‹é¡åˆ¥å°±æ˜¯ Button æ¬Šé™æª¢æŸ¥ / å»ºç«‹ HTMLï¼Œè€Œé€™éƒ¨åˆ†åœ¨æˆ‘å€‘çš„ DLL è£¡ï¼Œå°æ‡‰åˆ°çš„å°±æ˜¯ åŠŸèƒ½ 4ï¼ˆGetFuncBtnï¼‰è·ŸåŠŸèƒ½ 5ï¼ˆCheckBtnEnabledï¼‰ã€‚

â¸»

ğŸ” èˆŠçš„ SVS_å®¢è£½åŒ–å…ƒä»¶ åšäº†ä»€éº¼
	1.	Hi_Btn() â†’ ç”¨ä¾†ç”¢ç”Ÿä¸€å€‹ HTML <button>ï¼Œæœƒå…ˆæª¢æŸ¥æ˜¯å¦æœ‰æŒ‰éˆ•æ¬Šé™ï¼Œæ²’æ¬Šé™å°±ä¸é¡¯ç¤ºã€‚
	â€¢	èˆŠç¨‹å¼ï¼š
	â€¢	æŸ¥ AP_RFUNC æ‰¾åˆ° BTNSEQ
	â€¢	å†æŸ¥ AP_USER_RFUNC_CONFIG åˆ¤æ–·ç¾¤çµ„æœ‰æ²’æœ‰è©² BTNSEQ
	â€¢	å®Œå…¨å°±æ˜¯åŠŸèƒ½ 4 + åŠŸèƒ½ 5 çš„äº‹ã€‚
	2.	IfBtnAuth_Positive() â†’ æ¬Šé™åˆ¤æ–·æ ¸å¿ƒ
	â€¢	å¦‚æœç¾¤çµ„æœ‰é‚£å€‹æŒ‰éˆ• â†’ trueï¼Œå¦å‰‡ falseã€‚
	â€¢	é€™æ®µ SQL ä¹Ÿå°±æ˜¯åŠŸèƒ½ 5 CheckBtnEnabledã€‚

â¸»

âœ… æ–°çš„åšæ³•ï¼ˆå–ä»£ SVS_å®¢è£½åŒ–å…ƒä»¶ï¼‰
	1.	æŒ‰éˆ•æ¸…å–® â†’ åŠŸèƒ½ 4ï¼ˆGetFuncBtnï¼‰
	â€¢	å¯ä»¥ä¸€æ¬¡æ‹¿åˆ°æŸå€‹ç¾¤çµ„åœ¨æŸå€‹é é¢ï¼ˆFUNC_IDï¼‰åº•ä¸‹æœ‰æ¬Šé™çš„æŒ‰éˆ•æ¸…å–®ï¼ˆBtnID, BtnName, Onclickâ€¦ï¼‰ã€‚
	2.	å–®é¡†æŒ‰éˆ•æª¢æŸ¥ â†’ åŠŸèƒ½ 5ï¼ˆCheckBtnEnabledï¼‰
	â€¢	å‚³å…¥ SysID + GroupID + FuncID + BtnIDï¼Œå›å‚³ true/falseã€‚
	â€¢	ç”¨ä¾†å–ä»£èˆŠçš„ IfBtnAuth_Positive()ã€‚

â¸»

ğŸ”§ é‡æ§‹æ–¹å¼

1. é‡å¯« Hi_Btn

ç›´æ¥å‘¼å« DLL åŠŸèƒ½ 5 ä¾†åˆ¤æ–·æ¬Šé™ã€‚

public static MvcHtmlString Hi_Btn(
    this HtmlHelper helper,
    string FUNC_ID,
    string GroupID,
    string ButtonID,
    string ButtonText,
    string ButtonType,
    object HtmlAttributes)
{
    // å‘¼å« DLL åŠŸèƒ½ 5
    var req = new POSFILE_APPLY.Models.M_AP.CheckBtnEnabledRequestModel
    {
        SysID = "HI_POSIMG",
        GroupID = GroupID,
        FuncID = FUNC_ID,
        BtnID = ButtonID,
        Environment = "TEST"
    };

    string jsonInput = JsonConvert.SerializeObject(req);
    string response = new HI_APACCESS_DLL_FRAMEWORK.APACCESS().CheckBtnEnabled(jsonInput);
    var res = JsonConvert.DeserializeObject<POSFILE_APPLY.Models.M_AP.CheckBtnEnabledResponseModel>(response);

    if (res.Result) // âœ… æœ‰æ¬Šé™æ‰ç”¢ç”Ÿ button
    {
        TagBuilder tb = new TagBuilder("button");
        if (!string.IsNullOrWhiteSpace(ButtonText)) tb.InnerHtml = ButtonText;
        if (!string.IsNullOrWhiteSpace(ButtonID)) tb.Attributes.Add("id", ButtonID);
        if (!string.IsNullOrWhiteSpace(ButtonType)) tb.Attributes.Add("type", ButtonType);

        if (HtmlAttributes != null)
        {
            IDictionary<string, string> htmlAttributes_Dictionary =
                JsonConvert.DeserializeObject<Dictionary<string, string>>(
                    JsonConvert.SerializeObject(HtmlAttributes));
            foreach (var dict in htmlAttributes_Dictionary)
            {
                string dictKey = dict.Key.Contains("_") ? dict.Key.Replace("_", "-") : dict.Key;
                if (tb.Attributes.ContainsKey(dictKey))
                    tb.Attributes[dictKey] = dict.Value;
                else
                    tb.Attributes.Add(dictKey, dict.Value);
            }
        }
        return MvcHtmlString.Create(tb.ToString());
    }
    else
    {
        return null; // âŒ æ²’æœ‰æ¬Šé™å°±ä¸é¡¯ç¤º
    }
}


â¸»

2. å–ä»£ IfBtnAuth_Positive

é€™å€‹ä¸ç”¨è‡ªå·±æŸ¥ SQL äº†ï¼Œç›´æ¥ç”¨ DLL åŠŸèƒ½ 5ã€‚

private static bool IfBtnAuth_Positive(string FUNC_ID, string GroupID, string ButtonID)
{
    var req = new POSFILE_APPLY.Models.M_AP.CheckBtnEnabledRequestModel
    {
        SysID = "HI_POSIMG",
        GroupID = GroupID,
        FuncID = FUNC_ID,
        BtnID = ButtonID,
        Environment = "TEST"
    };

    string jsonInput = JsonConvert.SerializeObject(req);
    string response = new HI_APACCESS_DLL_FRAMEWORK.APACCESS().CheckBtnEnabled(jsonInput);
    var res = JsonConvert.DeserializeObject<POSFILE_APPLY.Models.M_AP.CheckBtnEnabledResponseModel>(response);

    return res.Result;
}


â¸»

ğŸ¯ æ”¹å®Œçš„å¥½è™•
	1.	Web å°ˆæ¡ˆä¸å†è‡ªå·±æ‰“ SQL â†’ å…¨éƒ¨äº¤çµ¦ DLL åŠŸèƒ½ 4 & 5ã€‚
	2.	é‚è¼¯é›†ä¸­ â†’ æ¬Šé™æª¢æŸ¥çµ±ä¸€ç”± DLL æ§ç®¡ã€‚
	3.	å‰ç«¯å‘¼å«å¾ˆä¹¾æ·¨ï¼š
	â€¢	è¦ç•«é é¢ä¸Šçš„æŒ‰éˆ• â†’ ç”¨ Hi_Btn()
	â€¢	è¦æª¢æŸ¥å–®é¡†æŒ‰éˆ• â†’ ç”¨ CheckBtnEnabled

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ POSFILE_APPLY.Models.M_AP è£¡çš„åŠŸèƒ½ 4 & 5 Request/Response Model ä¹Ÿå¯«å¥½ï¼Ÿé€™æ¨£ä½  Web å¯ä»¥ç›´æ¥å‘¼å«ï¼Œä¸ç”¨è‡ªå·±å° JSONã€‚

å¥½ï¼Œæˆ‘é€ä¸€å¹«ä½ é‡æ¸… ğŸ‘‡

â¸»

1ï¸âƒ£ ç‚ºä»€éº¼ã€ŒGet_è³‡æ–™é¢æœ€é«˜æ¬Šé™ã€ä¸æ˜¯åŠŸèƒ½ 5

ä½ èªªå¾—å°ï¼Œæˆ‘å†ä»”ç´°æ¯”å°ä½ çµ¦çš„ SQLï¼š

SELECT COUNT(*) AS SUP_NUM 
FROM MRSUPPER 
WHERE SUP_ID=@Emp_NO 
  AND CONVERT(CHAR(10),GETDATE(),102)>=EFF_DATE
  AND CONVERT(CHAR(10),GETDATE(),102)<=END_DATE

é€™å€‹é‚è¼¯å®Œå…¨æ˜¯ã€Œåˆ¤æ–·æŸå“¡å·¥æ˜¯ä¸æ˜¯åœ¨ MRSUPPER è¡¨è£¡ã€ï¼Œè·ŸåŠŸèƒ½ 5ï¼ˆæŒ‰éˆ•æ¬Šé™æª¢æŸ¥ï¼‰ç„¡é—œã€‚
	â€¢	åŠŸèƒ½ 5ï¼šCheckBtnEnabled â†’ æ˜¯æª¢æŸ¥ã€ŒæŸç¾¤çµ„å°æŸé é¢æŸæŒ‰éˆ•æ˜¯å¦æœ‰æ¬Šé™ã€ã€‚
	â€¢	Get_è³‡æ–™é¢æœ€é«˜æ¬Šé™ â†’ æ˜¯ã€Œè³‡æ–™å±¤ç´šæ¬Šé™åˆ¤æ–·ã€ï¼Œæª¢æŸ¥æŸå€‹å“¡ç·¨æ˜¯ä¸æ˜¯å±¬æ–¼ç‰¹å®š SUP åˆ—è¡¨ã€‚

ğŸ‘‰ æ‰€ä»¥é€™å€‹åŠŸèƒ½ä»¥å¾Œæ‡‰è©²æœƒå¦å¤–åšæˆ åŠŸèƒ½ 7 æˆ–è£œå…… APIï¼Œä¸æ‡‰è©²ç¡¬å°æ‡‰åŠŸèƒ½ 5ã€‚

â¸»

2ï¸âƒ£ Hi_Btn ä»¥å¾Œæ€éº¼å¯«ï¼Ÿé‚è¼¯æ˜¯ä»€éº¼ï¼Ÿ

åŸæœ¬é‚è¼¯
	1.	å‰ç«¯ Razor æƒ³ç•«ä¸€å€‹æŒ‰éˆ•
	2.	å‘¼å« @Html.Hi_Btn("FUNC_ID", "APG_NO", "å–®é¡†", "BtnID", "æ–‡å­—", "button", new { â€¦ })
	3.	å…§éƒ¨æœƒå…ˆæŸ¥ DB åˆ¤æ–·ç¾¤çµ„æœ‰æ²’æœ‰æ¬Šé™
	â€¢	æœ‰ â†’ å›å‚³ <button>
	â€¢	æ²’æœ‰ â†’ å›å‚³ null

æ–°é‚è¼¯ï¼ˆæ”¹ç”¨ DLLï¼‰
	1.	å‘¼å« DLL åŠŸèƒ½ 5 CheckBtnEnabled
	â€¢	åƒæ•¸ï¼šSysID + GroupID + FuncID + BtnID
	â€¢	å›å‚³ï¼štrue / false
	2.	å¦‚æœ true â†’ ç”¢ <button>ï¼Œå¦å‰‡å›å‚³ nullã€‚

public static MvcHtmlString Hi_Btn(
    this HtmlHelper helper,
    string funcId,
    string groupId,
    string buttonId,
    string buttonText,
    string buttonType,
    object htmlAttributes)
{
    var req = new M_AP.CheckBtnEnabledRequestModel
    {
        SysID = "HI_POSIMG",
        GroupID = groupId,
        FuncID = funcId,
        BtnID = buttonId,
        Environment = "TEST"
    };

    string jsonInput = JsonConvert.SerializeObject(req);
    string response = new HI_APACCESS_DLL_FRAMEWORK.APACCESS().CheckBtnEnabled(jsonInput);
    var res = JsonConvert.DeserializeObject<M_AP.CheckBtnEnabledResponseModel>(response);

    if (res.Result)
    {
        TagBuilder tb = new TagBuilder("button");
        tb.InnerHtml = buttonText;
        tb.Attributes["id"] = buttonId;
        tb.Attributes["type"] = buttonType;

        if (htmlAttributes != null)
        {
            IDictionary<string, string> htmlAttributesDict =
                JsonConvert.DeserializeObject<Dictionary<string, string>>(
                    JsonConvert.SerializeObject(htmlAttributes));
            foreach (var kv in htmlAttributesDict)
            {
                tb.Attributes[kv.Key.Replace("_", "-")] = kv.Value;
            }
        }
        return MvcHtmlString.Create(tb.ToString());
    }
    return null;
}

é‚è¼¯ï¼š
	â€¢	ã€Œæ˜¯å¦è¦é¡¯ç¤ºé€™å€‹æŒ‰éˆ•ã€= ã€Œç¾¤çµ„æ˜¯å¦å°é€™å€‹é é¢é€™å€‹æŒ‰éˆ•æœ‰æ¬Šé™ã€ã€‚
	â€¢	ä¸å†æŸ¥ DBï¼Œçµ±ä¸€ç”± DLL æä¾›çµæœã€‚

â¸»

3ï¸âƒ£ åŠŸèƒ½ 1ï¼ˆGetUserNameAndGroupï¼‰å®Œæ•´å¯¦ä½œ

DLL ç«¯ (APACCESS.cs)

// åŠŸèƒ½1 å–å¾—ä½¿ç”¨è€…ç¾¤çµ„èˆ‡åç¨±
public string GetUserNameAndGroup(string requestJson)
{
    var response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse();
    try
    {
        var request = JsonConvert.DeserializeObject<GetUserNameAndGroupModel.GetUserNameAndGroupRequest>(requestJson);

        FGetUserNameAndGroup func = new FGetUserNameAndGroup();
        response = func.Execute(request.SysID, request.UserAD, request.Environment);
    }
    catch (Exception ex)
    {
        response.Result_code = Codes.SYSTEM_ERROR;
        response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
    }
    return JsonConvert.SerializeObject(response);
}


â¸»

DLL ç«¯ (Factory/FGetUserNameAndGroup.cs)

internal class FGetUserNameAndGroup
{
    internal GetUserNameAndGroupModel.GetUserNameAndGroupResponse Execute(string sysId, string userAd, string environment)
    {
        var response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse();
        try
        {
            // æŠŠ AD è½‰æˆå“¡ç·¨
            string empNo = FIdentity.GetEmpNoByAD(userAd, environment);

            using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))
            {
                conn.Open();
                string sql = @"
                SELECT TOP 1
                       B.U_ID AS UserID,
                       B.U_NAME AS UserName,
                       A.APG_NO AS GroupID,
                       A.APG_NAME AS GroupName,
                       A.PARENT_APG_NO,
                       A.SENSITIVE_DATA_ACCESS,
                       M.ORGAN_CAP AS OrganName,
                       M.POST_NAME AS PostName
                FROM [HI_TMMAIN].[dbo].[AP_GROUP] A
                LEFT JOIN [AP_USER] B ON A.APG_NO = B.APG_NO
                LEFT JOIN [DB_SHARE].[dbo].[M1EMP_MAST] M ON B.U_ID = M.EMP_NO
                WHERE A.SYS_ID=@SysID AND B.U_ID=@EmpNo";

                using (SqlCommand cmd = new SqlCommand(sql, conn))
                {
                    cmd.Parameters.AddWithValue("@SysID", sysId);
                    cmd.Parameters.AddWithValue("@EmpNo", empNo);

                    using (var reader = cmd.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            response.Result_code = Codes.SUCCESS;
                            response.Msg = "æˆåŠŸ";
                            response.Result = new GetUserNameAndGroupModel.ResultData
                            {
                                UserID = reader["UserID"].ToString(),
                                UserName = reader["UserName"].ToString(),
                                GroupID = reader["GroupID"].ToString(),
                                GroupName = reader["GroupName"].ToString(),
                                SensitiveDataAccess = Convert.ToBoolean(reader["SENSITIVE_DATA_ACCESS"]),
                                OrganName = reader["OrganName"].ToString(),
                                PostName = reader["PostName"].ToString(),
                                ParentGroupID = new List<string> { reader["PARENT_APG_NO"].ToString() }
                            };
                        }
                        else
                        {
                            response.Result_code = Codes.NO_PERMISSION;
                            response.Msg = "æŸ¥ç„¡æ¬Šé™";
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            response.Result_code = Codes.SYSTEM_ERROR;
            response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
        }
        return response;
    }
}


â¸»

Web å°ˆæ¡ˆ Request/Response Model (M_AP.cs)

public class GetUserNameAndGroupRequestModel
{
    public string SysID { get; set; }
    public string UserAD { get; set; }
    public string Environment { get; set; }
}

public class GetUserNameAndGroupResponseModel
{
    public string Result_code { get; set; }
    public string Msg { get; set; }
    public ResultData Result { get; set; }

    public class ResultData
    {
        public string UserID { get; set; }
        public string UserName { get; set; }
        public string GroupID { get; set; }
        public string GroupName { get; set; }
        public List<string> ParentGroupID { get; set; }
        public List<string> ChildGroupID { get; set; }
        public bool SensitiveDataAccess { get; set; }
        public string OrganName { get; set; }
        public string PostName { get; set; }
    }
}


â¸»

Web å°ˆæ¡ˆæ¸¬è©¦ Controller

public ActionResult Test_GetUserNameAndGroup()
{
    var req = new POSFILE_APPLY.Models.M_AP.GetUserNameAndGroupRequestModel
    {
        SysID = "HI_POSIMG",
        UserAD = "3A001",   // æ¸¬è©¦ç”¨ AD
        Environment = "TEST"
    };

    string jsonInput = JsonConvert.SerializeObject(req);
    string response = new HI_APACCESS_DLL_FRAMEWORK.APACCESS().GetUserNameAndGroup(jsonInput);
    var res = JsonConvert.DeserializeObject<POSFILE_APPLY.Models.M_AP.GetUserNameAndGroupResponseModel>(response);

    return Content($"<pre>{JsonConvert.SerializeObject(res, Formatting.Indented)}</pre>", "text/html");
}


â¸»

âœ… é€™æ¨£åŠŸèƒ½ 1 çš„ DLL + Factory + Web æ¸¬è©¦å°±å…¨å¥—è·‘å¾—èµ·ä¾†ã€‚

â¸»

è¦ä¸è¦æˆ‘æ¥ä¸‹ä¾†å¹«ä½ æŠŠ Get_è³‡æ–™é¢æœ€é«˜æ¬Šé™ æ‹‰å‡ºä¾†è¦åŠƒæˆã€ŒåŠŸèƒ½ 7ã€çš„ DLL APIï¼ˆè·Ÿ 1~5 åˆ†é–‹ï¼‰ï¼Œé€™æ¨£å°±ä¸æœƒèª¤æœƒå®ƒè·ŸåŠŸèƒ½ 5 æœ‰é—œï¼Ÿ