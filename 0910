å¥½ğŸ‘Œ æˆ‘å¹«ä½ æŠŠ åŠŸèƒ½ 4ï¼šGetFuncBtn (å–å¾—åŠŸèƒ½é æœ‰æ¬Šé™ä¹‹æŒ‰éˆ•) å¯«å®Œæ•´ï¼Œç…§è‘—åŠŸèƒ½ 1~3 çš„é¢¨æ ¼ï¼š

â¸»

ğŸ“Œ Modelï¼šGetFuncBtnModel.cs

using Newtonsoft.Json;
using System.Collections.Generic;
using System.ComponentModel;

namespace HI_APACCESS_DLL_FRAMEWORK.Models
{
    internal class GetFuncBtnModel
    {
        // ===== è«‹æ±‚åƒæ•¸ =====
        internal class GetFuncBtnRequest
        {
            [JsonProperty]
            [DisplayName("ç³»çµ±ID")]
            internal string SysID { get; set; }

            [JsonProperty]
            [DisplayName("ç¾¤çµ„ID")]
            internal string GroupID { get; set; }

            [JsonProperty]
            [DisplayName("åŠŸèƒ½ID")]
            internal string FuncID { get; set; }

            [JsonProperty]
            [DisplayName("ç’°å¢ƒ")]
            internal string Environment { get; set; }
        }

        // ===== å›æ‡‰çµæœ =====
        internal class GetFuncBtnResponse
        {
            [JsonProperty]
            [DisplayName("å›è¦†ä»£ç¢¼")]
            internal string Result_code { get; set; }

            [JsonProperty]
            [DisplayName("è¨Šæ¯")]
            internal string Msg { get; set; }

            [JsonProperty]
            [DisplayName("å›æ‡‰å…§å®¹")]
            internal List<ResultData> Result { get; set; }
        }

        internal class ResultData
        {
            [JsonProperty]
            [DisplayName("æŒ‰éˆ•ID")]
            internal string BtnID { get; set; }

            [JsonProperty]
            [DisplayName("æŒ‰éˆ•åç¨±")]
            internal string BtnName { get; set; }

            [JsonProperty]
            [DisplayName("æ§åˆ¶å™¨")]
            internal string Controller { get; set; }

            [JsonProperty]
            [DisplayName("å‹•ä½œ")]
            internal string Action { get; set; }

            [JsonProperty]
            [DisplayName("æŒ‰éˆ•ä½ç½®")]
            internal string BtnLocation { get; set; }

            [JsonProperty]
            [DisplayName("æŒ‰éˆ•äº‹ä»¶")]
            internal string BtnOnclick { get; set; }
        }
    }
}


â¸»

ğŸ“Œ Factoryï¼šFGetFuncBtn.cs

using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using HI_APACCESS_DLL_FRAMEWORK.Models;
using HI_APACCESS_DLL_FRAMEWORK.Common;

namespace HI_APACCESS_DLL_FRAMEWORK.Factory
{
    internal class FGetFuncBtn
    {
        internal GetFuncBtnModel.GetFuncBtnResponse Execute(string sysId, string groupId, string funcId, string environment)
        {
            var response = new GetFuncBtnModel.GetFuncBtnResponse();

            try
            {
                // 1. ç’°å¢ƒæª¢æŸ¥
                if (environment != "TEST" && environment != "PROD")
                {
                    response.Result_code = ErrorCodes.ENV_ERROR;
                    response.Msg = "ç’°å¢ƒéŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD";
                    return response;
                }

                // 2. ç³»çµ±æˆæ¬Šæª¢æŸ¥
                var authorizedSystems = FCommon.GetAuthorizedSystemsList(environment);
                if (!authorizedSystems.Contains(sysId))
                {
                    response.Result_code = ErrorCodes.SYS_UNAUTHORIZED;
                    response.Msg = "ç³»çµ±æœªæˆæ¬Š";
                    return response;
                }

                var resultList = new List<GetFuncBtnModel.ResultData>();

                using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))
                {
                    conn.Open();

                    // 3. æŸ¥è©¢æŒ‰éˆ•æ¸…å–®
                    string sql = @"
SELECT DISTINCT
    a.BTNID,
    a.BTN_NAME,
    a.CONTROLLER,
    a.ACTION,
    a.LOC AS BtnLocation,
    a.ONCLICK AS BtnOnclick
FROM [HI_TMMAIN].[dbo].[AP_RFUNC] a
LEFT JOIN [HI_TMMAIN].[dbo].[AP_USER_RFUNC_CONFIG] b 
    ON a.FUNC_ID = b.FUNC_ID
WHERE a.SYS_ID=@SysID 
  AND b.APG_NO=@GroupID
  AND a.FUNC_ID=@FuncID
ORDER BY a.BTNID";

                    using (SqlCommand cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@GroupID", groupId);
                        cmd.Parameters.AddWithValue("@FuncID", funcId);

                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                resultList.Add(new GetFuncBtnModel.ResultData
                                {
                                    BtnID = reader["BTNID"].ToString(),
                                    BtnName = reader["BTN_NAME"].ToString(),
                                    Controller = reader["CONTROLLER"].ToString(),
                                    Action = reader["ACTION"].ToString(),
                                    BtnLocation = reader["BtnLocation"].ToString(),
                                    BtnOnclick = reader["BtnOnclick"].ToString()
                                });
                            }
                        }
                    }
                }

                // 4. çµæœåˆ¤æ–·
                if (resultList.Count == 0)
                {
                    response.Result_code = ErrorCodes.NO_PERMISSION;
                    response.Msg = "æŸ¥ç„¡æ¬Šé™";
                }
                else
                {
                    response.Result_code = ErrorCodes.SUCCESS;
                    response.Msg = "æˆåŠŸ";
                    response.Result = resultList;
                }
            }
            catch (Exception ex)
            {
                response.Result_code = ErrorCodes.SYSTEM_ERROR;
                response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
            }

            return response;
        }
    }
}


â¸»

ğŸ“Œ ä¸»é¡åˆ¥ï¼šAPACCESS.csï¼ˆæ–°å¢åŠŸèƒ½ 4ï¼‰

// åŠŸèƒ½4ï¼šå–å¾—åŠŸèƒ½é æœ‰æ¬Šé™ä¹‹æŒ‰éˆ•
public string GetFuncBtn(string requestJson)
{
    var response = new GetFuncBtnModel.GetFuncBtnResponse();

    try
    {
        var request = JsonConvert.DeserializeObject<GetFuncBtnModel.GetFuncBtnRequest>(requestJson);
        FGetFuncBtn func = new FGetFuncBtn();
        response = func.Execute(request.SysID, request.GroupID, request.FuncID, request.Environment);
    }
    catch (Exception ex)
    {
        response = new GetFuncBtnModel.GetFuncBtnResponse
        {
            Result_code = ErrorCodes.SYSTEM_ERROR,
            Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message
        };
    }

    return JsonConvert.SerializeObject(response);
}


â¸»

âœ… åŠŸèƒ½ 4 å®Œæˆ
	â€¢	Requestï¼šSysID, GroupID, FuncID, Environment
	â€¢	Responseï¼šæŒ‰éˆ•æ¸…å–® (BtnID, BtnName, Controller, Action, BtnLocation, BtnOnclick)
	â€¢	éŒ¯èª¤è™•ç†ï¼šç’°å¢ƒéŒ¯èª¤ã€ç³»çµ±æœªæˆæ¬Šã€æŸ¥ç„¡æ¬Šé™ã€ç³»çµ±éŒ¯èª¤

â¸»

è¦ä¸è¦æˆ‘ç›´æ¥å¹«ä½ æ¥è‘—åš åŠŸèƒ½ 5ï¼šCheckBtnEnabled (ç¢ºèªæ˜¯å¦æ“æœ‰æŒ‰éˆ•æ¬Šé™)ï¼Ÿ


å¥½ğŸ‘Œ æˆ‘å¹«ä½ æŠŠ åŠŸèƒ½ 5ï¼šCheckBtnEnabled (ç¢ºèªæ˜¯å¦æ“æœ‰æŒ‰éˆ•æ¬Šé™) å®Œæ•´å¯«å‡ºä¾†ï¼Œçµæ§‹è·Ÿå‰é¢ä¿æŒä¸€è‡´ã€‚

â¸»

ğŸ“Œ Modelï¼šCheckBtnEnabledModel.cs

using Newtonsoft.Json;
using System.ComponentModel;

namespace HI_APACCESS_DLL_FRAMEWORK.Models
{
    internal class CheckBtnEnabledModel
    {
        // ===== è«‹æ±‚åƒæ•¸ =====
        internal class CheckBtnEnabledRequest
        {
            [JsonProperty]
            [DisplayName("ç³»çµ±ID")]
            internal string SysID { get; set; }

            [JsonProperty]
            [DisplayName("ç¾¤çµ„ID")]
            internal string GroupID { get; set; }

            [JsonProperty]
            [DisplayName("åŠŸèƒ½ID")]
            internal string FuncID { get; set; }

            [JsonProperty]
            [DisplayName("æŒ‰éˆ•ID")]
            internal string BtnID { get; set; }

            [JsonProperty]
            [DisplayName("ç’°å¢ƒ")]
            internal string Environment { get; set; }
        }

        // ===== å›æ‡‰çµæœ =====
        internal class CheckBtnEnabledResponse
        {
            [JsonProperty]
            [DisplayName("çµæœ")]
            internal bool Result { get; set; }
        }
    }
}


â¸»

ğŸ“Œ Factoryï¼šFCheckBtnEnabled.cs

using System;
using System.Data.SqlClient;
using HI_APACCESS_DLL_FRAMEWORK.Models;
using HI_APACCESS_DLL_FRAMEWORK.Common;

namespace HI_APACCESS_DLL_FRAMEWORK.Factory
{
    internal class FCheckBtnEnabled
    {
        internal CheckBtnEnabledModel.CheckBtnEnabledResponse Execute(string sysId, string groupId, string funcId, string btnId, string environment)
        {
            var response = new CheckBtnEnabledModel.CheckBtnEnabledResponse();

            try
            {
                // 1. ç’°å¢ƒæª¢æŸ¥
                if (environment != "TEST" && environment != "PROD")
                {
                    response.Result = false;
                    return response;
                }

                // 2. ç³»çµ±æˆæ¬Šæª¢æŸ¥
                var authorizedSystems = FCommon.GetAuthorizedSystemsList(environment);
                if (!authorizedSystems.Contains(sysId))
                {
                    response.Result = false;
                    return response;
                }

                using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))
                {
                    conn.Open();

                    // 3. æª¢æŸ¥æ˜¯å¦æ“æœ‰æŒ‰éˆ•æ¬Šé™
                    string sql = @"
SELECT COUNT(*) AS Cnt
FROM [HI_TMMAIN].[dbo].[AP_USER_RFUNC_CONFIG] a
LEFT JOIN [HI_TMMAIN].[dbo].[AP_RFUNC] b 
    ON a.FUNC_ID = b.FUNC_ID
WHERE a.SYS_ID=@SysID
  AND a.APG_NO=@GroupID
  AND a.FUNC_ID=@FuncID
  AND b.BTNID=@BtnID";

                    using (SqlCommand cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@GroupID", groupId);
                        cmd.Parameters.AddWithValue("@FuncID", funcId);
                        cmd.Parameters.AddWithValue("@BtnID", btnId);

                        int count = (int)cmd.ExecuteScalar();
                        response.Result = count > 0;
                    }
                }
            }
            catch
            {
                response.Result = false; // ç³»çµ±éŒ¯èª¤ä¹Ÿç›´æ¥å› false
            }

            return response;
        }
    }
}


â¸»

ğŸ“Œ ä¸»é¡åˆ¥ï¼šAPACCESS.csï¼ˆæ–°å¢åŠŸèƒ½ 5ï¼‰

// åŠŸèƒ½5ï¼šç¢ºèªæ˜¯å¦æ“æœ‰æŒ‰éˆ•æ¬Šé™
public string CheckBtnEnabled(string requestJson)
{
    var response = new CheckBtnEnabledModel.CheckBtnEnabledResponse();

    try
    {
        var request = JsonConvert.DeserializeObject<CheckBtnEnabledModel.CheckBtnEnabledRequest>(requestJson);
        FCheckBtnEnabled func = new FCheckBtnEnabled();
        response = func.Execute(request.SysID, request.GroupID, request.FuncID, request.BtnID, request.Environment);
    }
    catch
    {
        response.Result = false;
    }

    return JsonConvert.SerializeObject(response);
}


â¸»

âœ… åŠŸèƒ½ 5 å®Œæˆ
	â€¢	Requestï¼šSysID, GroupID, FuncID, BtnID, Environment
	â€¢	Responseï¼š{ "Result": true } æˆ– { "Result": false }
	â€¢	é‚è¼¯ï¼š
	â€¢	ç’°å¢ƒéŒ¯èª¤ â†’ false
	â€¢	ç³»çµ±æœªæˆæ¬Š â†’ false
	â€¢	æŸ¥ä¸åˆ°æŒ‰éˆ• â†’ false
	â€¢	æœ‰æ¬Šé™ â†’ true
	â€¢	ç³»çµ±éŒ¯èª¤ â†’ false

â¸»

è¦ä¸è¦æˆ‘æœ€å¾Œå¹«ä½ æŠŠ åŠŸèƒ½ 1~6 çš„ Request/Response JSON ç¯„ä¾‹ å…¨æ•´ç†ä¸€æ¬¡ï¼Œæ–¹ä¾¿ä½ ä¹‹å¾Œåšæ¸¬è©¦ç¨‹å¼ï¼Ÿ


