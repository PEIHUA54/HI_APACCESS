幫我檢查JS部分
在001群的時候也不可以出現變更群組跟刪除按鈕
還有管理頁面權限的顏色區分不見了 父頁面為淺藍色、頁面類型1為淺綠色 2為淺橘色

@section Scripts {
    <script>
        let currentGroup = '';
        let isEditMode = false;
        let allFunctions = [];
        let groupPermissions = {};
        let hasUnsavedChanges = false;
        const currentSysID = '@Session["CurrentSystemId"]';
        const currentGroupID = '@Session["CurrentGroupId"]';
        const isAdmin = (currentGroupID === '001');

        // 頁面載入時允許搜尋
        $(document).ready(function () {
            loadGroups();
            loadAllFunctions();
            applyRoleGate();

            // 支援 Enter 鍵搜尋
            $('#searchUserId').on('keypress', function (e) {
                if (e.which === 13) {
                    searchUserPermissions();
                }
            });
        });

        // 非 001 僅能管理使用者與查詢
        function applyRoleGate() {
            if (!isAdmin) {
                // 隱藏「群組維護/權限儲存/批次匯入」相關按鈕
                $('#editGroupBtn, #deleteGroupBtn, #saveAllBtn, #importUserBtn, #insGroupBtn').hide();

                // 將權限操作 API 導向 no-op，避免誤觸
                window.togglePagePermissionByClick = function () { };
                window.togglePagePermission = function () { };
                window.selectAllButtons = function () { };
                window.clearAllButtons = function () { };
                window.toggleButtonPermissionByClick = function () { };
                window.toggleButtonPermission = function () { };
            }
        }

        // 顯示/隱藏 儲存提醒
        function showSaveReminder() {
            $('#saveReminder').show();
            hasUnsavedChanges = true;
        }

        function hideSaveReminder() {
            $('#saveReminder').hide();
            hasUnsavedChanges = false;
        }

       //  載入群組下拉選單 loadGroups 函數支援 callback
        function loadGroups(callback) {
            $.get('@Url.Action("GetGroupSelectList", "AP")', { sysID: currentSysID }, function (response) {
                let options = '<option value="">– 請選擇群組 –</option>';

                if (Array.isArray(response)) {
                    response.forEach(function (group) {
                        options += `<option value="${group.value}">${group.text}</option>`;
                    });
                } else {
                    console.log('群組資料格式錯誤:', response);
                    options += '<option value="">-- 載入失敗 --</option>';
                }

                $('#groupSelect').html(options);

                if (callback) callback();

            }).fail(function (xhr, status, error) {
                console.log('載入群組失敗:', error);
                $('#groupSelect').html('<option value="">-- 載入失敗 --</option>');
            });
        }

        // 載入所有頁面
        function loadAllFunctions() {
            $.get('@Url.Action("GetAllFunctions", "AP")', { sysID: currentSysID } , function (response) {
                if (response.success) {
                    allFunctions = response.data || [];
                    //console.log('後端返回的數據順序:');
                    allFunctions.forEach((f, index) => {
                        console.log(`${index}: ${f.FUNC_ID} - ${f.FUNC_NA} (Parent: ${f.PARENT_ID}, Sort: ${f.SORT_NO})`);
                    });
                } else {
                    allFunctions = [];
                }
            });
        }

        // 載入群組資料 loadGroupData 函數，啟用/停用刪除按鈕
        function loadGroupData() {
            const newGroup = $('#groupSelect').val();

            if (hasUnsavedChanges && currentGroup !== newGroup && currentGroup !== '') {
                if (!confirm('有未儲存的變更，切換群組將遺失這些變更。確定要繼續嗎？')) {
                    $('#groupSelect').val(currentGroup);
                    return;
                }
            }

            currentGroup = newGroup;
            hideSaveReminder();

            if (!currentGroup) {
                resetAllSections();
                return;
            }

            //  非 001  → 選到 001 群時不得新增/匯入；選到其它群可新增/匯入
            if (!isAdmin) {
                if (currentGroup === '001') {
                    $('#addUserBtn, #importUserBtn').hide();   // 不能在 001 群新增或批次新增
                } else {
                    $('#addUserBtn, #importUserBtn').show();   // 其它群可新增/批次新增
                }
            }

            // 啟用所有按鈕
            $('#editGroupBtn, #addUserBtn, #saveAllBtn, #deleteGroupBtn, #importUserBtn').prop('disabled', false);

            // 鎖定 001
            const isLockedGroup = (currentGroup === '001');
            if (isLockedGroup) {
                $('#deleteGroupBtn').prop('disabled', true);
            } else {
                $('#editGroupBtn, #deleteGroupBtn').removeAttr('title');
            }

            loadUsers();
            loadPagePermissions();
        }

        // 重設所有區塊 resetAllSections 函數
        function resetAllSections() {
            // 停用所有按鈕
            $('#editGroupBtn, #addUserBtn, #saveAllBtn, #deleteGroupBtn, #importUserBtn').prop('disabled', true);
            $('#userList').html('<div class="no-data">請先選擇群組</div>');
            $('#pageList').html('<div class="no-data">請先選擇群組</div>');
            $('#buttonList').html('<div class="no-data">請先選擇群組</div>');
            hideSaveReminder();
        }

        // 載入使用者列表
        function loadUsers() {
            $.get('@Url.Action("GetUsersByGroup", "AP")', { apg_no: currentGroup, sysID: currentSysID }, function (response) {
                if (response.success) {
                    let html = '';
                    if (response.data.length > 0) {
                        response.data.forEach(function (user) {
                            html += `
                                <div class="user-item">
                                    <div>
                                        <strong>${user.U_ID}</strong><br>
                                        <small>${user.U_NAME}</small><br>
                                        <div class="extra-info">
                                              建立人員:${user.CREATOR || ''}
                                              建立日期:${user.CREATE_TIME || ''}<br>
                                              修改人員:${user.EDITOR || ''}
                                              修改日期:${user.EDIT_TIME || ''}
                                        </div>
                                    </div>
                                    <div>
                                        <button type="button"
                                                class="btn btn-sm btn-warning btn-small" id="changeGroupBtn"
                                                onclick="openChangeGroupModal('${user.U_ID}', '${user.U_NAME}', '${currentGroup}')">
                                            變更群組
                                        </button>
                                        <button type="button" 
                                                class="btn btn-sm btn-danger btn-small"  id="deleteUserBtn"
                                                onclick="deleteUser('${user.U_ID}', '${user.U_NAME}')">
                                            刪除
                                        </button>
                                    </div>
                                </div>`;
                        });
                    } else {
                        html = '<div class="no-data">此群組暫無使用者</div>';
                    }
                    $('#userList').html(html);
                }
            });
        }

        // 載入頁面權限
        function loadPagePermissions() {
            $.get('@Url.Action("GetGroupPermissions", "AP")', { apg_no: currentGroup, sysID: currentSysID }, function (response) {
                if (response.success) {
                    groupPermissions = {};
                    response.data.forEach(function (item) {
                        if (!groupPermissions[item.FUNC_ID]) {
                            groupPermissions[item.FUNC_ID] = {
                                hasPagePermission: item.HasPagePermission,
                                buttons: {}
                            };
                        }
                        item.ButtonPermissions.forEach(function (btn) {
                            groupPermissions[item.FUNC_ID].buttons[btn.BTNSEQ] = btn.HasPermission;
                        });
                    });
                    renderPageListHierarchical();
                    updateButtonListHierarchical(); // 這會顯示所有頁面的按鈕
                }
            });
        }

        // 輔助函數
        function getFuncId(func) {
            return func.FUNC_ID || func.value || func.func_id;
        }

        function getParentId(func) {
        return func.PARENT_ID || func.parent_id || func.parentId;
        }

        function getFuncName(func) {
        return func.FUNC_NA || func.text || func.func_na;
        }

        // 變更使用者群組Modal
        function openChangeGroupModal(userId, userName, currentGroup) {
            $('#changeGroupModal').remove(); // 先移除舊的（避免重覆）

            const modalHtml = `
                <div class="modal fade" id="changeGroupModal" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">變更使用者群組</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                      </div>
                      <div class="modal-body">
                        <div class="alert alert-info">
                          <strong>使用者：</strong> ${userName} (${userId})<br>
                          <strong>目前群組：</strong> ${currentGroup}
                        </div>
                        <form id="changeGroupForm">
                          <input type="hidden" id="changeUserId" value="${userId}">
                          <input type="hidden" id="changeCurrentGroup" value="${currentGroup}">
                          <div class="form-group">
                            <label for="newGroupSelect">選擇新群組 <span class="text-danger">*</span></label>
                            <select class="form-control" id="newGroupSelect" required>
                              <option value="">-- 請選擇新群組 --</option>
                            </select>
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="confirmChangeGroup()">確認變更</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                      </div>
                    </div>
                  </div>
                </div>`;

            $('body').append(modalHtml);

            // 載入群組下拉
            $.get('@Url.Action("GetGroupSelectList", "AP")', { sysID: currentSysID }, function (response) {
                let options = '<option value="">-- 請選擇新群組 --</option>';
                if (Array.isArray(response)) {
                    response.forEach(function (group) {
                        // 非 001 身分 → 目的群不可是 001；排除目前群組
                        if (group.value !== currentGroup && (isAdmin || group.value !== '001')) {
                            options += `<option value="${group.value}">${group.text}</option>`;
                        }
                        //if (group.value !== currentGroup) { // 排除目前群組
                        //    options += `<option value="${group.value}">${group.text}</option>`;
                        //}
                    });
                }
                $('#newGroupSelect').html(options);
            });

            $('#changeGroupModal').modal('show');
        }

        // 變更使用者群組
        function confirmChangeGroup() {
            const userId = $('#changeUserId').val();
            const currentGroup = $('#changeCurrentGroup').val();
            const newGroup = $('#newGroupSelect').val();

            if (!isAdmin && newGroup === '001') {
                alert('無法將使用者變更至 001 群組。');
                return;
            }
            if (!newGroup) {
                alert('請選擇新群組');
                return;
            }
            if (newGroup === currentGroup) {
                alert('新群組與目前群組相同');
                return;
            }

            if (confirm(`確定要將使用者 ${userId} 從群組 ${currentGroup} 變更到 ${newGroup} 嗎？`)) {
                $.post('@Url.Action("ChangeUserGroup", "AP")', {
                    u_id: userId,
                    old_apg_no: currentGroup,
                    new_apg_no: newGroup,
                    sysID: currentSysID
                }, function (response) {
                    if (response.success) {
                        alert(response.message || '使用者群組變更成功');
                        $('#changeGroupModal').modal('hide');
                        loadUsers(); // 重新載入清單
                    } else {
                        alert(response.message || '群組變更失敗');
                    }
                }).fail(function (xhr) {
                    alert('群組變更失敗：' + (xhr.responseText || '系統錯誤'));
                });
            }
        }

        // 檢查是否為父層頁面 (PARENT_ID=HOME 或無父級且有子頁面)
        function isParentPage(func) {
            const funcId = getFuncId(func);
            const parentId = getParentId(func);

            // 檢查是否為 HOME 層級的頁面
            if (parentId === 'HOME' || !parentId || parentId === '') {
                return true;
            }

            // 檢查是否有子頁面
            return allFunctions.some(f => getParentId(f) === funcId);
        }

        // 階層式渲染頁面列表
        function renderPageListHierarchical() {
            let html = '';
            if (allFunctions.length === 0) {
                html = '<div class="no-data">無可用頁面</div>';
            } else {
                // 只取顯示的頁面 (IS_SHOW = 'Y')
                const visibleFunctions = allFunctions.filter(f => f.IS_SHOW === 'Y');

                const parentPages = visibleFunctions.filter(f => !getParentId(f) || !visibleFunctions.some(p => getFuncId(p) === getParentId(f)));
                const childPages = visibleFunctions.filter(f => getParentId(f) && visibleFunctions.some(p => getFuncId(p) === getParentId(f)));

                parentPages.forEach(function (parentFunc) {
                    html += renderPageItem(parentFunc, false);
                    const children = childPages.filter(c => getParentId(c) === getFuncId(parentFunc));
                    children.forEach(function (childFunc) {
                        html += renderPageItem(childFunc, true);
                    });
                });
            }
            $('#pageList').html(html);
        }

        // 頁面項目渲染 - 一列顯示
        function renderPageItem(func, isChild) {
            const funcId = getFuncId(func);
            const funcName = getFuncName(func);

            const hasPermission = groupPermissions[funcId] && groupPermissions[funcId].hasPagePermission;
            const checkedAttr = hasPermission ? 'checked' : '';

            // 非 001  → 不顯示 checkbox、不可點擊
            const checkboxHtml = isAdmin ? `<input type="checkbox" class="permission-checkbox" ${checkedAttr}>` : '';
            const clickAttr = isAdmin ? `onclick="togglePagePermissionByClick('${funcId}')" style="cursor:pointer;"` : '';

            //
            return `
  <div class="page-item ${hasPermission ? 'has-permission' : ''} ${isChild ? 'child-page-item' : ''}"
       data-func-id="${funcId}" ${clickAttr}>
    <div class="permission-content">
      ${checkboxHtml}
      <span class="permission-title">${funcName}</span>
      <span class="permission-info">頁面ID: ${funcId}</span>
    </div>
  </div>`;

            // 判斷是否為父層頁面並添加相應樣式
            const isParent = isParentPage(func);
            let itemClass = hasPermission ? 'page-item has-permission' : 'page-item';
            if (isParent) {
                itemClass += ' parent-page';
            }

            const childClass = isChild ? 'child-page-item' : '';

            let bgStyle = '';
            if (func.FUNC_TYPE === '1') {
                bgStyle = 'background-color:#e8f5e8;';
            } else if (func.FUNC_TYPE === '2') {
                bgStyle = 'background-color:#fdf7e8;';
            }

            return `
    <div class="${itemClass} ${childClass}" data-func-id="${funcId}" style="${bgStyle}" onclick="togglePagePermissionByClick('${funcId}')">
        <div class="permission-content">
            <input type="checkbox" class="permission-checkbox" ${checkedAttr}>
            <span class="permission-title">${funcName}</span>
            <span class="permission-info">頁面ID: ${funcId}</span>
        </div>
    </div>`;

        }

        // 點擊切換頁面權限
        function togglePagePermissionByClick(funcId) {
            const checkbox = $(`.page-item[data-func-id="${funcId}"] input[type="checkbox"]`);
            const isChecked = checkbox.prop('checked');
            checkbox.prop('checked', !isChecked);
            togglePagePermission(funcId, !isChecked);
        }

        // 切換頁面權限
        function togglePagePermission(funcId, hasPermission) {
            if (!groupPermissions[funcId]) {
                groupPermissions[funcId] = { buttons: {} };
            }
            groupPermissions[funcId].hasPagePermission = hasPermission;

            showSaveReminder();

            if (hasPermission) {
                // 勾選頁面時，自動全勾該頁面的所有按鈕
                $.get('@Url.Action("GetButtonsByFuncId", "AP")', {
                    func_id: funcId,
                    sysID: currentSysID
                }, function (btnResponse) {
                    if (btnResponse.success && btnResponse.data) {
                        if (!groupPermissions[funcId]) {
                            groupPermissions[funcId] = { buttons: {} };
                        }
                        btnResponse.data.forEach(function (btn) {
                            groupPermissions[funcId].buttons[btn.BTNSEQ] = true;
                        });
                        refreshButtonsDisplay(funcId);   // 只刷新這個頁面的按鈕顯示
                        showSaveReminder();
                    }
                });

                if (isParentPage(allFunctions.find(f => getFuncId(f) === funcId))) {
                    const childPages = allFunctions.filter(f => getParentId(f) === funcId);
                    childPages.forEach(function (childFunc) {
                        const childId = getFuncId(childFunc);
                        if (!groupPermissions[childId]) {
                            groupPermissions[childId] = { buttons: {} };
                        }
                        groupPermissions[childId].hasPagePermission = true;
                        $(`.page-item[data-func-id="${childId}"] input[type="checkbox"]`).prop('checked', true);
                        $(`.page-item[data-func-id="${childId}"]`).addClass('has-permission');

                        // 自動勾選該子頁面的所有按鈕權限
                        $.get('@Url.Action("GetButtonsByFuncId", "AP")', {
                            func_id: childId,
                            sysID: currentSysID
                        }, function (btnResponse) {
                            if (btnResponse.success && btnResponse.data) {
                                btnResponse.data.forEach(function (btn) {
                                    groupPermissions[childId].buttons[btn.BTNSEQ] = true;
                                });
                            }
                        });
                    });
                }

                const currentPage = allFunctions.find(f => getFuncId(f) === funcId);
                if (currentPage && getParentId(currentPage)) {
                    const parentExists = allFunctions.some(f => getFuncId(f) === getParentId(currentPage));
                    if (parentExists) {
                        const parentId = getParentId(currentPage);
                        if (!groupPermissions[parentId]) {
                            groupPermissions[parentId] = { buttons: {} };
                        }
                        if (!groupPermissions[parentId].hasPagePermission) {
                            groupPermissions[parentId].hasPagePermission = true;
                            $(`.page-item[data-func-id="${parentId}"] input[type="checkbox"]`).prop('checked', true);
                            $(`.page-item[data-func-id="${parentId}"]`).addClass('has-permission');
                            alert(`已自動勾選上層頁面權限：${parentId}`);
                        }
                    }
                }
            } else {
                const childPages = allFunctions.filter(f => getParentId(f) === funcId);
                const hasChildWithPermission = childPages.some(child =>
                    groupPermissions[getFuncId(child)] && groupPermissions[getFuncId(child)].hasPagePermission
                );

                if (hasChildWithPermission) {
                    const childNames = childPages
                        .filter(child => groupPermissions[getFuncId(child)] && groupPermissions[getFuncId(child)].hasPagePermission)
                        .map(child => getFuncName(child))
                        .join('、');

                    if (!confirm(`取消此頁面權限將同時取消子頁面權限：${childNames}\n\n確定要繼續嗎？`)) {
                        $(`.page-item[data-func-id="${funcId}"] input[type="checkbox"]`).prop('checked', true);
                        return;
                    } else {
                        childPages.forEach(child => {
                            const childId = getFuncId(child);
                            if (groupPermissions[childId] && groupPermissions[childId].hasPagePermission) {
                                groupPermissions[childId].hasPagePermission = false;
                                groupPermissions[childId].buttons = {};
                                $(`.page-item[data-func-id="${childId}"] input[type="checkbox"]`).prop('checked', false);
                                $(`.page-item[data-func-id="${childId}"]`).removeClass('has-permission');
                            }
                        });
                    }
                }

                groupPermissions[funcId].buttons = {};
            }

            const pageItem = $(`.page-item[data-func-id="${funcId}"]`);
            if (hasPermission) {
                pageItem.addClass('has-permission');
            } else {
                pageItem.removeClass('has-permission');
            }

            updateButtonListHierarchical();
        }

        // 全勾選按鈕權限
        function selectAllButtons(funcId) {
            if (!groupPermissions[funcId]) {
                groupPermissions[funcId] = { buttons: {} };
            }

            $.get('@Url.Action("GetButtonsByFuncId", "AP")', {
                func_id: funcId,
                sysID: currentSysID
            }, function (response) {
                if (response.success && response.data) {
                    response.data.forEach(function (btn) {
                        groupPermissions[funcId].buttons[btn.BTNSEQ] = true;
                    });
                    // 只更新該頁面的按鈕顯示狀態，不重新排序
                    refreshButtonsDisplay(funcId);
                    showSaveReminder();
                }
            });
        }

        // 全取消按鈕權限
        function clearAllButtons(funcId) {
            if (!groupPermissions[funcId]) {
                groupPermissions[funcId] = { buttons: {} };
            }

            $.get('@Url.Action("GetButtonsByFuncId", "AP")', {
                func_id: funcId,
                sysID: currentSysID
            }, function (response) {
                if (response.success && response.data) {
                    response.data.forEach(function (btn) {
                        groupPermissions[funcId].buttons[btn.BTNSEQ] = false;
                    });
                    // 只更新該頁面的按鈕顯示狀態，不重新排序
                    refreshButtonsDisplay(funcId);
                    showSaveReminder();
                }
            });
        }

        // 階層式更新按鈕列表
        function updateButtonListHierarchical() {
            if (allFunctions.length === 0) {
                $('#buttonList').html('<div class="no-data">無可用頁面</div>');
                return;
            }

            // 建立父子關係映射
            const parentChildMap = {};
            const parentPages = [];

            // 分離父頁面和子頁面，並過濾隱藏的子頁面
            allFunctions.forEach(func => {
                const funcId = getFuncId(func);
                const parentId = getParentId(func);

                if (!parentId || parentId === '' || parentId === 'HOME') {
                    // 父頁面
                    parentPages.push(func);
                    if (!parentChildMap[funcId]) {
                        parentChildMap[funcId] = [];
                    }
                } else {
                    // 子頁面 - 只要顯示的子頁面
                    if (func.IS_SHOW === 'Y') {
                        if (!parentChildMap[parentId]) {
                            parentChildMap[parentId] = [];
                        }
                        parentChildMap[parentId].push(func);
                    }
                }
            });

            // 父頁面按SORT_NO排序
            parentPages.sort((a, b) => {
                const aSort = parseInt(a.SORT_NO) || 999;
                const bSort = parseInt(b.SORT_NO) || 999;
                return aSort - bSort;
            });

            // 每個父頁面的子頁面按SORT_NO排序
            Object.keys(parentChildMap).forEach(parentId => {
                parentChildMap[parentId].sort((a, b) => {
                    const aSort = parseInt(a.SORT_NO) || 999;
                    const bSort = parseInt(b.SORT_NO) || 999;
                    return aSort - bSort;
                });
            });

            let html = '';

            // 按父頁面順序顯示
            parentPages.forEach(parentFunc => {
                const parentId = getFuncId(parentFunc);
                const parentName = getFuncName(parentFunc);
                const children = parentChildMap[parentId] || [];

                // 父頁面標題
                html += `
        <div class="parent-page-header" id="parent-header-${parentId}">
            <i class="fas fa-folder"></i> ${parentName}
            <small class="text-muted" style="font-weight: normal; margin-left: 10px;">(${parentId})</small>
        </div>`;

                // 父頁面區塊（包含父頁面本身的按鈕）
                const parentHasPagePermission = groupPermissions[parentId] && groupPermissions[parentId].hasPagePermission;
                const parentSectionStyle = parentHasPagePermission
                    ? 'margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 6px; background: #f8f9fa; margin-left: 20px;'
                    : 'margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 6px; background: #f5f5f5; opacity: 0.6; margin-left: 20px;';

                html += `
        <div class="page-section parent-section" id="page-section-${parentId}" style="${parentSectionStyle}">
            <div class="page-header" style="background: #e9ecef; padding: 10px 15px; border-bottom: 1px solid #dee2e6; font-weight: bold; color: #495057; display: flex; justify-content: space-between; align-items: center;">
                <span>
                    <i class="fas fa-folder-open"></i> ${parentName}
                    <small class="text-muted" style="font-weight: normal; margin-left: 10px;">(${parentId})</small>
                </span>
                <div style="display: flex; gap: 5px;">
                 ${ isAdmin ? `
                    <button type="button" class="btn btn-sm btn-primary" onclick="selectAllButtons('${parentId}')" style="font-size: 11px; padding: 2px 8px;" ${!parentHasPagePermission ? 'disabled' : ''}>
                        <i class="fas fa-check-square"></i> 全勾選
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllButtons('${parentId}')" style="font-size: 11px; padding: 2px 8px;" ${!parentHasPagePermission ? 'disabled' : ''}>
                        <i class="fas fa-square"></i> 全取消
                    </button>
                    ` : '' }
                </div>
            </div>
            <div class="buttons-container" id="buttons-${parentId}" style="padding: 10px;">
                <div class="no-data"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>
            </div>`;

                // 如果有子頁面，在父層區塊內加入分隔線，然後繼續在同一個區塊內顯示子頁面
                if (children.length > 0) {
                    html += `
            <div style="margin: 10px 15px; border-top: 2px solid #6c757d; position: relative;">
                <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #f8f9fa; padding: 0 10px; color: #6c757d; font-size: 12px; font-weight: bold;">

                </div>
            </div>`;

                    // 在同一個父層區塊內顯示子頁面
                    children.forEach(childFunc => {
                        const funcId = getFuncId(childFunc);
                        const funcName = getFuncName(childFunc);
                        const hasPagePermission = groupPermissions[funcId] && groupPermissions[funcId].hasPagePermission;

                        html += `
                <div class="child-page-section" style="margin: 10px; border: 1px solid #ccc; border-radius: 4px; background: ${hasPagePermission ? '#fff' : '#f5f5f5'}; ${!hasPagePermission ? 'opacity: 0.6;' : ''}">
                    <div class="page-header" style="background: #f1f3f4; padding: 8px 12px; border-bottom: 1px solid #ccc; font-weight: bold; color: #495057; display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                        <span>
                            <i class="fas fa-file-alt"></i> ${funcName}
                            <small class="text-muted" style="font-weight: normal; margin-left: 10px;">(${funcId})</small>
                        </span>
                        <div style="display: flex; gap: 5px;">
                        ${ isAdmin ? `
                            <button type="button" class="btn btn-sm btn-primary" onclick="selectAllButtons('${funcId}')" style="font-size: 10px; padding: 1px 6px;" ${!hasPagePermission ? 'disabled' : ''}>
                                <i class="fas fa-check-square"></i> 全勾選
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllButtons('${funcId}')" style="font-size: 10px; padding: 1px 6px;" ${!hasPagePermission ? 'disabled' : ''}>
                                <i class="fas fa-square"></i> 全取消
                            </button>
                            ` : '' }
                        </div>
                    </div>
                    <div class="buttons-container" id="buttons-${funcId}" style="padding: 8px;">
                        <div class="no-data"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>
                    </div>
                </div>`;
                    });
                }

                // 結束父頁面區塊
                html += `</div>`;
            });

            $('#buttonList').html(html);

            // 現在載入每個頁面的按鈕
            parentPages.forEach(parentFunc => {
                const parentId = getFuncId(parentFunc);
                const children = parentChildMap[parentId] || [];

                // 載入父頁面的按鈕
                loadButtonsForPage(parentId);

                // 載入子頁面的按鈕
                children.forEach(childFunc => {
                    loadButtonsForPage(getFuncId(childFunc));
                });
            });
        }

        // updateButtonListHierarchical：渲染頁面按鈕區塊
        function renderPageButtonSection(func, isChild) {
            const funcId = getFuncId(func);
            const funcName = getFuncName(func);
            const hasPagePermission = groupPermissions[funcId] && groupPermissions[funcId].hasPagePermission;

            // 頁面區塊樣式
            const sectionStyle = hasPagePermission
                ? 'margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 6px; background: #f8f9fa;' + (isChild ? ' margin-left: 20px;' : '')
                : 'margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 6px; background: #f5f5f5; opacity: 0.6;' + (isChild ? ' margin-left: 20px;' : '');

            return `
        <div class="page-section ${isChild ? 'child-section' : 'parent-section'}" id="page-section-${funcId}" style="${sectionStyle}">
            <div class="page-header" style="background: #e9ecef; padding: 10px 15px; border-bottom: 1px solid #dee2e6; font-weight: bold; color: #495057; display: flex; justify-content: space-between; align-items: center;">
                <span>
                    <i class="fas fa-file-alt"></i> ${funcName}
                    <small class="text-muted" style="font-weight: normal; margin-left: 10px;">(${funcId})</small>
                </span>
                <div style="display: flex; gap: 5px;">
                ${ isAdmin ? `
                    <button type="button" class="btn btn-sm btn-primary" onclick="selectAllButtons('${funcId}')" style="font-size: 11px; padding: 2px 8px;" ${!hasPagePermission ? 'disabled' : ''}>
                        <i class="fas fa-check-square"></i> 全勾選
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllButtons('${funcId}')" style="font-size: 11px; padding: 2px 8px;" ${!hasPagePermission ? 'disabled' : ''}>
                        <i class="fas fa-square"></i> 全取消
                    </button>
               ` : '' }
                </div>
            </div>
            <div class="buttons-container" id="buttons-${funcId}" style="padding: 10px;">
                <div class="no-data"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>
            </div>
        </div>`;
        }

        function loadButtonsForPage(funcId) {
            const hasPagePermission = groupPermissions[funcId] && groupPermissions[funcId].hasPagePermission;

            $.get('@Url.Action("GetButtonsByFuncId", "AP")', {
                func_id: funcId,
                sysID: currentSysID
            }, function (response) {
                let buttonHtml = '';

                if (response.success && response.data && response.data.length > 0) {
                    response.data.forEach(function (btn) {
                        const hasPermission = (groupPermissions[funcId] && groupPermissions[funcId].hasPagePermission && groupPermissions[funcId].buttons[btn.BTNSEQ]) || false;

                        if (isAdmin) {
                            // 可編輯版（原樣）
                            buttonHtml += `
              <div class="btn-item ${hasPermission ? 'has-permission' : ''}"
                   onclick="toggleButtonPermissionByClick('${funcId}', '${btn.BTNSEQ}')">
                <div class="permission-content">
                  <input type="checkbox" class="permission-checkbox" ${hasPermission ? 'checked' : ''}>
                  <span class="permission-title">${btn.BTN_NAME}</span>
                  <span class="permission-info">ID: ${btn.BTNID}</span>
                </div>
              </div>`;
                        } else {
                            // [新增] 唯讀版（無 checkbox、無 onclick）
                            buttonHtml += `
              <div class="btn-item ${hasPermission ? 'has-permission' : ''}" style="pointer-events:none;">
                <div class="permission-content">
                  <span class="permission-title">${btn.BTN_NAME}</span>
                  <span class="permission-info">ID: ${btn.BTNID}</span>
                </div>
              </div>`;
                        }
                    });

                    $(`#buttons-${funcId}`).html(buttonHtml).css({ 'padding': '10px', 'min-height': 'auto' });
                } else {
                    // 沒有按鈕時，使用緊湊樣式
                    buttonHtml = '<div class="no-data-compact" style="padding: 8px; text-align: center; color: #6c757d; font-size: 12px;">此頁面無按鈕</div>';

                    // 更新該頁面的按鈕容器 - 緊湊高度
                    $(`#buttons-${funcId}`).html(buttonHtml).css({
                        'padding': '0',
                        'min-height': '30px'
                    });
                }
            }).fail(function () {
                // 載入失敗時也使用緊湊樣式
                const errorHtml = '<div class="no-data-compact" style="padding: 8px; text-align: center; color: #dc3545; font-size: 12px;">載入失敗</div>';
                $(`#buttons-${funcId}`).html(errorHtml).css({
                    'padding': '0',
                    'min-height': '30px'
                });
            });
        }

        // 點擊切換按鈕權限
        function toggleButtonPermissionByClick(funcId, btnSeq) {
            const checkbox = $(`.btn-item`).filter(function () {
                return $(this).attr('onclick') && $(this).attr('onclick').includes(`'${funcId}', '${btnSeq}'`);
            }).find('input[type="checkbox"]');

            const isChecked = checkbox.prop('checked');
            checkbox.prop('checked', !isChecked);
            toggleButtonPermission(funcId, btnSeq, !isChecked);

        }

        // 切換按鈕權限
        function toggleButtonPermission(funcId, btnSeq, hasPermission) {
            groupPermissions[funcId].buttons[btnSeq] = hasPermission;
            showSaveReminder();

            const btnItem = $(`.btn-item`).filter(function () {
                return $(this).attr('onclick') && $(this).attr('onclick').includes(`'${funcId}', '${btnSeq}'`);
            });

            if (hasPermission) {
                btnItem.addClass('has-permission');
            } else {
                btnItem.removeClass('has-permission');
            }
        }

        // 刷新指定頁面的按鈕顯示狀態
        function refreshButtonsDisplay(funcId) {
            $(`.page-section`).each(function () {
                const pageHeader = $(this).find('.page-header');
                if (pageHeader.text().includes(`(${funcId})`)) {
                    const buttonsContainer = $(this).find('.buttons-container');
                    buttonsContainer.find('.btn-item').each(function () {
                        const btnElement = $(this);
                        const onclick = btnElement.attr('onclick');
                        if (onclick && onclick.includes(`'${funcId}',`)) {
                            const btnSeqMatch = onclick.match(/'([^']+)', '([^']+)'/);
                            if (btnSeqMatch && btnSeqMatch.length >= 3) {
                                const btnSeq = btnSeqMatch[2];
                                const hasPermission = groupPermissions[funcId].buttons[btnSeq] || false;
                                const checkbox = btnElement.find('input[type="checkbox"]');
                                checkbox.prop('checked', hasPermission);

                                if (hasPermission) {
                                    btnElement.addClass('has-permission');
                                } else {
                                    btnElement.removeClass('has-permission');
                                }
                            }
                        }
                    });
                }
            });
        }

        // 儲存所有權限
        function saveAllPermissions() {
            const funcIds = [];
            const buttonPermissions = [];
            Object.keys(groupPermissions).forEach(function (funcId) {
                if (groupPermissions[funcId].hasPagePermission) {
                    funcIds.push(funcId);

                    Object.keys(groupPermissions[funcId].buttons).forEach(function (btnSeq) {
                        if (groupPermissions[funcId].buttons[btnSeq]) {
                            buttonPermissions.push(`${funcId}|${btnSeq}`);
                        }
                    });
                }
            });

            $.post('@Url.Action("BatchSetPermissions", "AP")', {
                apg_no: currentGroup,
                funcIds: funcIds,
                buttonPermissions: buttonPermissions,
                sysID: currentSysID
            }, function (response) {
                if (response.success) {
                    alert('權限設定儲存成功！');
                    hideSaveReminder();
                } else {
                    alert('儲存失敗：' + response.message);
                }
            });
        }

        // 群組管理函數
        function openGroupModal() {
            isEditMode = false;
            $('#groupModalTitle').text('新增群組');
            $('#groupForm')[0].reset();

            $.get('@Url.Action("GetNextGroupNo", "AP")', { sysID: currentSysID } ,function (response) {
                if (response.success) {
                    $('#groupNo').val(response.data);
                }
            });

            loadParentGroupOptions();

            $('#groupModal').modal('show');
        }

        function editGroup() {
            if (!currentGroup) return;

            // 001 群組可編輯主管群組，名稱鎖住
            const isLockedGroup = (currentGroup === '001');

            isEditMode = true;
            $('#groupModalTitle').text('修改群組');

            // 載入主管群組選項
            loadParentGroupOptions(() => {
                // 載入群組資料
                $.get('@Url.Action("GetGroup", "AP")', { apg_no: currentGroup, sysID: currentSysID }, function (response) {
                    if (response.success) {
                        $('#groupNo').val(response.data.APG_NO);
                        $('#groupName').val(response.data.APG_NAME);

                        if (isLockedGroup) {
                            $('#groupName').prop('readonly', true)
                                .css('background-color', '#f3f3f3')
                                .attr('title', '此為系統最高權限，名稱不可修改');
                        } else {
                            $('#groupName').prop('readonly', false)
                                .css('background-color', '#ffffff')
                                .removeAttr('title');
                        }

                        if (response.data.PARENT_APG_NO) {
                            const parentGroups = response.data.PARENT_APG_NO.split(',');
                            parentGroups.forEach(function (parentApgNo) {
                                const trimmedApgNo = parentApgNo.trim();
                                if (trimmedApgNo) {
                                    $(`input[name="parentGroups"][value="${trimmedApgNo}"]`).prop('checked', true);
                                }
                            });
                        }

                        $('#groupModal').modal('show');
                    }
                });
            });
        }

        // 主管群組選項
        function loadParentGroupOptions(callback) {
            $.get('@Url.Action("GetParentGroupSelectList", "AP")', { sysID: currentSysID }, function (response) {
                let html = '';

                if (Array.isArray(response)) {
                    response.forEach(function (group) {
                        // 允許選擇自己群組
                        html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="parentGroups"
                               value="${group.value}" id="parent_${group.value}">
                        <label class="form-check-label" for="parent_${group.value}">
                            ${group.text}
                        </label>
                    </div>`;
                    });
                }

                if (html === '') {
                    html = '<div class="text-muted">無可選擇的群組</div>';
                }

                $('#parentGroupList').html(html);

                if (callback) callback();
            }).fail(function () {
                $('#parentGroupList').html('<div class="text-danger">載入失敗</div>');
            });
        }

        // 儲存群組設定
        function saveGroup() {
            const groupNo = $('#groupNo').val();
            const groupName = $('#groupName').val();

            if (!groupName.trim()) {
                alert('請輸入群組名稱');
                return;
            }

            const selectedParentGroups = [];
            $('input[name="parentGroups"]:checked').each(function () {
                selectedParentGroups.push($(this).val());
            });

            const url = isEditMode ? '@Url.Action("UpdateGroup", "AP")' : '@Url.Action("AddGroup", "AP")';

            const postData = {
                APG_NO: groupNo,
                APG_NAME: groupName
            };

            selectedParentGroups.forEach(function (parentApgNo, index) {
                postData[`parentApgNos[${index}]`] = parentApgNo;
            });

            $.post(url, postData, function (response) {
                if (response.success) {
                    alert(response.message);
                    $('#groupModal').modal('hide');
                    if (isEditMode) {
                        // 修改模式：只更新群組下拉選單，不重新載入其他區塊
                        loadGroups(() => {
                            $('#groupSelect').val(currentGroup);
                        });
                    } else {
                        // 新增模式：需要選中新群組並載入所有資料
                        loadGroups(() => {
                            $('#groupSelect').val(groupNo);
                            currentGroup = groupNo;
                            loadGroupData();
                        });
                    }
                } else {
                    alert(response.message);
                }
            }).fail(function () {
                alert('儲存失敗，請稍後再試');
            });
        }

        // 刪除群組
        function deleteGroup() {
            if (!currentGroup) return;

            // 001 不可刪除
            if (currentGroup === '001') {
                alert('「001 管理員（資訊）」為系統最高權限，無法刪除。');
                return;
            }

            const groupName = $('#groupSelect option:selected').text();

            if (confirm(`確定要刪除群組「${groupName}」嗎？\n\n注意：這將同時刪除該群組的所有使用者和權限設定，且無法復原！`)) {
                $.post('@Url.Action("DeleteGroup", "AP")',
                    {
                        apg_no: currentGroup,
                        sysID: currentSysID
                    },
                    function (response) {
                        if (response.success) {
                            alert('群組刪除成功！');
                            // 重新載入群組清單並重置所有區塊
                            loadGroups();
                            currentGroup = '';
                            resetAllSections();
                        } else {
                            alert('刪除失敗：' + response.message);
                        }
                    }).fail(function () {
                        alert('刪除失敗，請稍後再試');
                    });
            }
        }

        // 使用者管理函數
        function openUserModal() {
            $('#userForm')[0].reset();
            $('#empList').empty();

            //  一進去就撈全部清單
            $.get('@Url.Action("GetEmployeeList", "AP")', { sysID: currentSysID }, function (res) {
                if (res.success && Array.isArray(res.data)) {
                    const options = res.data.map(emp =>
                        `<option value="${emp.EMP_NO}">${emp.EMP_NO} - ${emp.EMP_NAME} (${emp.ORGAN_CAP || ''})</option>`
                    ).join('');
                    $('#empList').html(options);
                }
            });

            // 綁定選擇事件（自動帶姓名/部門/職稱）
            $('#userIdInput').off('change blur').on('change blur', function () {
                const empNo = this.value.trim();
                if (!empNo) return;
                $.get('@Url.Action("GetEmployeeInfo", "AP")', { emp_no: empNo, sysID: currentSysID }, function (r) {
                    if (r.success && r.data) {
                        const emp = r.data;
                        $('#userName').val(emp.EMP_NAME || '');
                        $('#userDept').val(emp.ORGAN_CAP || '');
                        $('#userPost').val(emp.POST_NAME || '');
                    } else {
                        $('#userName,#userDept,#userPost').val('');
                    }
                });
            });

            $('#userModal').modal('show');
        }

        function saveUser() {
            const formData = {
                APG_NO: currentGroup,
                U_ID: ($('#userIdInput').val() || '').trim(),
                U_NAME: ($('#userName').val() || '').trim()
            };
            if (!isAdmin && currentGroup === '001') {
                alert('無法在 001 群組新增使用者。');
                return;
            }
            if (!formData.U_ID || !formData.U_NAME) {
                alert('請選擇有效員工編號，並確認姓名已帶出');
                return;
            }
            $.post('@Url.Action("AddUser", "AP")', formData, function (res) {
                if (res.success) {
                    alert(res.message || '新增成功');
                    $('#userModal').modal('hide');
                    loadUsers();
                } else { alert(res.message || '新增失敗'); }
            });
        }

        function deleteUser(userId, userName) {
            if (!isAdmin && currentGroup === '001') {
                alert('無法在 001 群組刪除使用者。');
                return;
            }
            if (confirm(`確定要將 "${userName}" 從群組中移除嗎？`)) {
                $.post('@Url.Action("DeleteUser", "AP")', {
                    apg_no: currentGroup,
                    u_id: userId,
                    sysID: currentSysID
                }, function (response) {
                    if (response.success) {
                        alert(response.message);
                        loadUsers();
                    } else {
                        alert(response.message);
                    }
                });
            }
        }

        // 查詢人員權限
        function searchUserPermissions() {
            const userId = $('#searchUserId').val().trim();
            if (!userId) { alert('請輸入員工編號'); return; }

            $.get('@Url.Action("SearchUserPermissions", "AP")', { u_id: userId, sysID: currentSysID }, function (response) {
                if (response.success) {
                    displaySearchResult(response.data);
                    $('#searchResult').show();

                    const apgNo = response.data?.UserInfo?.APG_NO || '';
                    if (apgNo) {
                        $('#groupSelect').val(apgNo);
                        loadGroupData();
                    }
                } else {
                    alert(response.message || '查無資料');
                    $('#searchResult').hide();
                }
            }).fail(function () {
                alert('查詢失敗，請稍後再試');
                $('#searchResult').hide();
            });
        }

        // 顯示查詢結果
        function displaySearchResult(data) {
            const u = data.UserInfo || {};
            const html = `
    <div class="d-flex flex-wrap align-items-center small" style="gap:14px; line-height:1.6;">
      <span><strong>員工編號</strong>：${u.U_ID || ''}</span>
      <span><strong>員工姓名</strong>：${u.U_NAME || ''}</span>
      <span><strong>所屬群組</strong>：${u.APG_NAME || ''}${u.APG_NO ? ` (${u.APG_NO})` : ''}</span>
      <span><strong>員工部門</strong>：${u.ORGAN_CAP || ''}</span>
      <span><strong>員工職稱</strong>：${u.POST_NAME || ''}</span>
    </div>`;
            $('#searchResultContent').html(html);
        }

        // 載入使用者群組
        function loadUserGroup(apgNo) {
            $('#groupSelect').val(apgNo);
            loadGroupData();
            clearSearch();
        }

        // 清除查詢
        function clearSearch() {
            $('#searchUserId').val('');
            //$('#groupSelect').val('');
            $('#searchResult').hide();
            //resetAllSections();
        }

        // 初始化員工下拉選單（支援搜尋）
        function initEmployeeSelect() {
            $('#userIdSelect').select2({
                ajax: {
                    url: '@Url.Action("GetEmployeeList", "AP")',
                    dataType: 'json',
                    delay: 300,
                    data: function (params) {
                        return {
                            keyword: params.term || '',
                            sysID: currentSysID
                        };
                    },
                    processResults: function (data) {
                        if (data.success) {
                            return {
                                results: data.data.map(function (emp) {
                                    return {
                                        id: emp.EMP_NO,
                                        text: `${emp.EMP_NO} - ${emp.EMP_NAME} (${emp.ORGAN_CAP})`,
                                        empData: emp
                                    };
                                })
                            };
                        }
                        return { results: [] };
                    },
                    cache: true
                },
                placeholder: '請輸入員工編號或姓名搜尋',
                allowClear: true,
                minimumInputLength: 0,
                language: {
                    noResults: function () {
                        return "查無相關員工資料";
                    },
                    searching: function () {
                        return "搜尋中...";
                    }
                }
            });

            // 監聽選擇事件
            $('#userIdSelect').on('select2:select', function (e) {
                onEmployeeSelect();
            });

            // 監聽清除事件
            $('#userIdSelect').on('select2:clear', function (e) {
                $('#userName, #userDept, #userPost').val('');
            });
        }

        // 員工選擇事件
        function onEmployeeSelect() {
            const empNo = $('#userIdSelect').val();
            if (empNo) {
                $.get('@Url.Action("GetEmployeeInfo", "AP")', { emp_no: empNo, sysID: currentSysID }, function (response) {
                    if (response.success) {
                        const emp = response.data;
                        $('#userName').val(emp.EMP_NAME || '');
                        $('#userDept').val(emp.ORGAN_CAP || '');
                        $('#userPost').val(emp.POST_NAME || '');
                    } else {
                        alert('取得員工資訊失敗：' + response.message);
                    }
                }).fail(function () {
                    alert('取得員工資訊失敗，請稍後再試');
                });
            } else {
                $('#userName, #userDept, #userPost').val('');
            }
        }

        // debounce 工具
        const debounce = (fn, wait = 300) => {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), wait); };
        };

        // 使用者 Modal：綁定 datalist
        function bindUserIdTypeahead() {
            $('#userIdInput').off('input').on('input', debounce(function () {
                const kw = this.value.trim();
                if (kw.length < 3) return;

                $.get('@Url.Action("GetEmployeeList", "AP")', { keyword: kw, sysID: currentSysID }, function (res) {
                    if (res.success && Array.isArray(res.data)) {
                        const rows = res.data.slice(0, 20);
                        const options = rows.map(emp =>
                            `<option value="${emp.EMP_NO}">${emp.EMP_NO} - ${emp.EMP_NAME} (${emp.ORGAN_CAP || ''})</option>`
                        ).join('');
                        $('#empList').html(options);
                    }
                });
            }, 250));

            $('#userIdInput').off('change blur').on('change blur', function () {
                const empNo = this.value.trim();
                if (!empNo) return;
                $.get('@Url.Action("GetEmployeeInfo", "AP")', { emp_no: empNo, sysID: currentSysID }, function (r) {
                    if (r.success && r.data) {
                        const emp = r.data;
                        $('#userName').val(emp.EMP_NAME || '');
                        $('#userDept').val(emp.ORGAN_CAP || '');
                        $('#userPost').val(emp.POST_NAME || '');
                    } else {
                        $('#userName,#userDept,#userPost').val('');
                    }
                });
            });
        }

        // 清除員工編號
        function clearUserIdInput() {
            $('#userIdInput').val('');
            $('#userName, #userDept, #userPost').val('');
        }

        // 批次匯入使用者MODAL
        function openImportModal() {
            $('#importGroupNo').val($('#groupSelect').val()); // 帶目前群組
            $('#importResult').empty();
            $("#errorSection").addClass("d-none");
            $("#successSection").addClass("d-none");
            $("#uploadProgress").addClass("d-none");
            $(".progress-bar").css("width", "0%");
            $('#importModal').modal('show');
        }

        // 下載匯入範例
        function downloadTemplate() {
            var sysID = currentSysID;
            window.location.href = '@Url.Action("DownloadImportTemplate","AP")' + "?sysID=" + encodeURIComponent(sysID);
        }

        // 匯入表單送出
        $("#importForm").submit(function (e) {
            e.preventDefault();
            var formData = new FormData(this);

            $("#uploadProgress").removeClass("d-none");
            $(".progress-bar").css("width", "50%");

            $.ajax({
                url: '@Url.Action("ImportUsers", "AP")',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (res) {
                    $("#uploadProgress").addClass("d-none");
                    $(".progress-bar").css("width", "0%");

                    // 清空舊的訊息區塊
                    $("#successSection, #errorSection, #partialSection").addClass("d-none");
                    $("#errorTable tbody").empty();

                    if (res.status === "success") {
                        // 全部成功
                        $("#successMessage").text(res.message);
                        $("#successSection").removeClass("d-none");
                        loadUsers();
                    }
                    else if (res.status === "fail") {
                        // 全部失敗
                        $("#errorMessage").text(res.message);
                        $("#errorSection").removeClass("d-none");

                        if (res.errors && res.errors.length > 0) {
                            res.errors.forEach(err => {
                                $("#errorTable tbody").append(
                                    `<tr>
                                        <td>${err.RowNumber}</td>
                                        <td>${err.EmpNo}</td>
                                        <td>${err.Message}</td>
                                    </tr>`
                                );
                            });
                        }
                    }
                    else if (res.status === "partial") {
                        // 部分成功
                        $("#partialMessage").text(res.message);
                        $("#partialSection").removeClass("d-none");

                        if (res.errors && res.errors.length > 0) {
                            res.errors.forEach(err => {
                                $("#errorTable tbody").append(
                                    `<tr>
                                <td>${err.RowNumber}</td>
                                <td>${err.EmpNo}</td>
                                <td>${err.Message}</td>
                            </tr>`
                                );
                            });
                        }

                        loadUsers();
                    }
                },
                error: function () {
                    $("#uploadProgress").addClass("d-none");
                    $(".progress-bar").css("width", "0%");
                    alert("伺服器發生錯誤，請稍後再試。");
                }
            });
        });

        // 重新上傳按鈕
        $(document).on("click", ".btn-retry-upload", function () {
            $("#errorSection").addClass("d-none");
            $("#partialSection").addClass("d-none");
            $("#successSection").addClass("d-none");
            $("#importForm")[0].reset();
            $("#errorTable tbody").empty();
        });

         @if (showSwitchButton)
        {
            <text>
            // 切換系統按鈕事件
            $('#btnSwitchSystem').click(function() {
                window.location.href = '@Url.Action("SYS_PERMISSION_SET", "SYS")';
            });
            </text>
        }


        // 匯出帳號清單按鈕事件
        $('#btnExportUsers').click(function () {
            window.location.href = '@Url.Action("ExportUserList", "AP")';
        });

    </script>
}
