å¾ˆå¥½ ğŸ‘ ä½ ç¾åœ¨çš„ç¨‹å¼å·²ç¶“å¯ä»¥åšåŸºæœ¬çš„ Excel åŒ¯å…¥äº†ã€‚
æˆ‘å¹«ä½ åŠ ä¸Š å…©å€‹æ–°çš„éœ€æ±‚ï¼š
	1.	åŒå€‹ç¾¤çµ„ä¸èƒ½é‡è¤‡ âœ…ï¼ˆä½ å·²ç¶“æœ‰äº†ï¼Œæˆ‘ä¿ç•™ï¼‰
	2.	è©²ç³»çµ±çš„å…¶ä»–ç¾¤çµ„ä¹Ÿä¸èƒ½é‡è¤‡ âœ…ï¼ˆæ–°å¢æª¢æŸ¥æ¢ä»¶ï¼‰

ä¸¦ä¸”æˆ‘ä¿ç•™äº†ä½ åŸæœ¬ ä¸€ç­†ç­†æ’å…¥ çš„å¯«æ³•ï¼ˆå› ç‚ºä½ èªªæ•¸é‡ä¸å¤§ï¼Œä¸ç”¨ BulkInsertï¼‰ã€‚

â¸»

ä¿®æ”¹å¾Œç¨‹å¼ç¢¼

Controller (ä¸ç”¨å‹•ï¼Œä¿æŒä½ ç¾åœ¨çš„)

// æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…
[HttpPost]
public ActionResult ImportUsers(HttpPostedFileBase file, string apgNo)
{
    if (file == null || file.ContentLength == 0)
        return Json(new { success = false, message = "è«‹é¸æ“‡è¦åŒ¯å…¥çš„Excelæª”æ¡ˆ" });

    if (string.IsNullOrWhiteSpace(apgNo))
        return Json(new { success = false, message = "è«‹å…ˆé¸æ“‡ç¾¤çµ„" });

    var ext = Path.GetExtension(file.FileName).ToLower();
    if (ext != ".xls" && ext != ".xlsx")
        return Json(new { success = false, message = "è«‹ä¸Šå‚³Excelæª”æ¡ˆï¼ˆ.xls æˆ– .xlsxï¼‰" });

    var uploadDir = Server.MapPath("~/Upload");
    if (!Directory.Exists(uploadDir)) Directory.CreateDirectory(uploadDir);

    var safeName = $"Import_{apgNo}_{DateTime.Now:yyyyMMddHHmmss}{ext}";
    var uploadPath = PathValidator.GetSafePath(uploadDir, safeName);

    try
    {
        file.SaveAs(uploadPath);

        var service = GetAPService();
        var importResult = service.ImportUsersFromExcel(uploadPath, CurrentSystemId, apgNo, this.Emp_NO);

        if (importResult.IsSuccess)
        {
            return Json(new { success = true, message = $"æˆåŠŸåŒ¯å…¥ {importResult.SuccessCount} ç­†è³‡æ–™ï¼" });
        }
        else
        {
            return Json(new
            {
                success = false,
                message = importResult.ErrorMessage,
                errors = importResult.ErrorMessages.Select(e => new
                {
                    RowNumber = e.RowNumber,
                    EmpNo = e.EmpNo,
                    Message = e.Message
                })
            });
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "åŒ¯å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message });
    }
    finally
    {
        if (System.IO.File.Exists(uploadPath))
        {
            var fc = new F_Common();
            fc.SafeDeleteFile(uploadDir, safeName);
        }
    }
}


â¸»

F_AP (ImportUsersFromExcel æ–¹æ³•ä¿®æ”¹é‡é»ï¼šå¢åŠ ã€Œå…¶ä»–ç¾¤çµ„æª¢æŸ¥ã€)

// æ‰¹æ¬¡åŒ¯å…¥äººå“¡
public ImportResult ImportUsersFromExcel(string filePath, string sysId, string apgNo, string creator)
{
    ImportResult result = new ImportResult() { ErrorMessages = new List<ImportError>() };

    try
    {
        var rows = new List<(int RowNumber, string EmpNo)>();

        // è®€ Excel
        using (var stream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.Read))
        using (var reader = ExcelReaderFactory.CreateReader(stream))
        {
            int rowIndex = 0;
            while (reader.Read())
            {
                rowIndex++;
                if (rowIndex == 1)
                {
                    string header = reader.GetString(0)?.Trim();
                    if (string.IsNullOrEmpty(header) || header != "å“¡å·¥ç·¨è™Ÿ")
                    {
                        result.IsSuccess = false;
                        result.ErrorMessage = "Excel æ ¼å¼éŒ¯èª¤ï¼šç¬¬ä¸€åˆ—ç¬¬ä¸€æ¬„å¿…é ˆæ˜¯ã€Œå“¡å·¥ç·¨è™Ÿã€";
                        return result;
                    }
                    continue;
                }

                string empNo = reader.GetValue(0)?.ToString().Trim();
                if (!string.IsNullOrEmpty(empNo))
                    rows.Add((rowIndex, empNo));
            }
        }

        if (rows.Count == 0)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "Excel ç„¡ä»»ä½•å“¡å·¥è³‡æ–™";
            return result;
        }

        int successCount = 0;

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["ConnDB_TFS_HI_TMMAIN"].ConnectionString))
        {
            con.Open();

            foreach (var row in rows)
            {
                try
                {
                    // ğŸ”¹ 1. æª¢æŸ¥å“¡å·¥æ˜¯å¦å­˜åœ¨
                    string checkEmpSql = "SELECT EMP_NAME FROM VW_M1EMP_MAST WHERE EMP_NO=@EMP_NO";
                    string empName = null;
                    using (var cmd = new SqlCommand(checkEmpSql, con))
                    {
                        cmd.Parameters.AddWithValue("@EMP_NO", row.EmpNo);
                        empName = cmd.ExecuteScalar() as string;
                    }

                    if (string.IsNullOrEmpty(empName))
                    {
                        result.ErrorMessages.Add(new ImportError
                        {
                            RowNumber = row.RowNumber,
                            EmpNo = row.EmpNo,
                            Message = "æŸ¥ç„¡æ­¤å“¡å·¥"
                        });
                        continue;
                    }

                    // ğŸ”¹ 2. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼ã€ŒåŒä¸€å€‹ç¾¤çµ„ã€
                    string checkGroupSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID";
                    using (var cmd = new SqlCommand(checkGroupSql, con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);
                        if ((int)cmd.ExecuteScalar() > 0)
                        {
                            result.ErrorMessages.Add(new ImportError
                            {
                                RowNumber = row.RowNumber,
                                EmpNo = row.EmpNo,
                                Message = "æ­¤ç¾¤çµ„å·²å­˜åœ¨è©²å“¡å·¥"
                            });
                            continue;
                        }
                    }

                    // ğŸ”¹ 3. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼ã€Œè©²ç³»çµ±çš„å…¶ä»–ç¾¤çµ„ã€
                    string checkSystemSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO<>@APG_NO AND U_ID=@U_ID";
                    using (var cmd = new SqlCommand(checkSystemSql, con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);
                        if ((int)cmd.ExecuteScalar() > 0)
                        {
                            result.ErrorMessages.Add(new ImportError
                            {
                                RowNumber = row.RowNumber,
                                EmpNo = row.EmpNo,
                                Message = "è©²ç³»çµ±å…¶ä»–ç¾¤çµ„å·²å­˜åœ¨è©²å“¡å·¥"
                            });
                            continue;
                        }
                    }

                    // ğŸ”¹ 4. å¯«å…¥ AP_USER
                    string insertSql = @"
                        INSERT INTO AP_USER(SYS_ID, APG_NO, U_ID, U_NAME, CREATOR, CREATE_TIME)
                        VALUES(@SYS_ID, @APG_NO, @U_ID, @U_NAME, @CREATOR, GETDATE())";

                    using (var cmd = new SqlCommand(insertSql, con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);
                        cmd.Parameters.AddWithValue("@U_NAME", empName);
                        cmd.Parameters.AddWithValue("@CREATOR", creator);
                        cmd.ExecuteNonQuery();
                        successCount++;
                    }
                }
                catch (Exception exRow)
                {
                    result.ErrorMessages.Add(new ImportError
                    {
                        RowNumber = row.RowNumber,
                        EmpNo = row.EmpNo,
                        Message = "å¯«å…¥éŒ¯èª¤ï¼š" + exRow.Message
                    });
                }
            }
        }

        result.SuccessCount = successCount;
        result.IsSuccess = successCount > 0 && result.ErrorMessages.Count == 0;

        if (successCount == 0)
            result.ErrorMessage = "åŒ¯å…¥å¤±æ•—ï¼Œæ‰€æœ‰è³‡æ–™å‡æœ‰éŒ¯èª¤";
        else if (result.ErrorMessages.Count > 0)
            result.ErrorMessage = "éƒ¨åˆ†è³‡æ–™åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤æ¸…å–®";
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = "è™•ç† Excel åŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message;
    }

    return result;
}


â¸»

âœ… ç¾åœ¨ä½ çš„é‚è¼¯æ˜¯ï¼š
	â€¢	å“¡å·¥ä¸å­˜åœ¨ â†’ âŒ éŒ¯èª¤
	â€¢	åŒç¾¤çµ„å·²å­˜åœ¨ â†’ âŒ éŒ¯èª¤
	â€¢	åŒç³»çµ±å…¶ä»–ç¾¤çµ„å·²å­˜åœ¨ â†’ âŒ éŒ¯èª¤
	â€¢	éƒ½æ²’å•é¡Œ â†’ âœ… æ–°å¢

â¸»

è¦ä¸è¦æˆ‘é †ä¾¿å¹«ä½ æŠŠ å‰ç«¯é¡¯ç¤ºéŒ¯èª¤æ¸…å–®çš„è¡¨æ ¼ æ”¹æˆç´…è‰²è¡¨æ ¼ï¼ˆè·Ÿä½ ä¹‹å‰å‚³çš„ modal æ¨£å¼ä¸€è‡´ï¼Œæœ‰å‹•ç•«æç¤ºï¼‰ï¼Ÿ
// æ‰“é–‹æ‰¹æ¬¡åŒ¯å…¥ Modal
function openImportModal() {
    $('#importGroupNo').val($('#groupSelect').val()); // å¸¶ç›®å‰ç¾¤çµ„
    $('#importResult').empty();
    $("#errorSection").addClass("d-none");
    $("#successSection").addClass("d-none");
    $("#uploadProgress").addClass("d-none");
    $(".progress-bar").css("width", "0%");
    $('#importModal').modal('show');
}

// ä¸‹è¼‰ç¯„æœ¬
function downloadTemplate() {
    window.location.href = '@Url.Action("DownloadImportTemplate","AP")';
}

// åŒ¯å…¥è¡¨å–®é€å‡º
$("#importForm").submit(function (e) {
    e.preventDefault();
    var formData = new FormData(this);

    // é¡¯ç¤ºé€²åº¦æ¢å‹•ç•«
    $("#uploadProgress").removeClass("d-none");
    $(".progress-bar").css("width", "50%");

    $.ajax({
        url: '@Url.Action("ImportUsers", "AP")',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function (res) {
            // æ­¸é›¶é€²åº¦æ¢
            $("#uploadProgress").addClass("d-none");
            $(".progress-bar").css("width", "0%");

            if (res.success) {
                // âœ… æˆåŠŸ
                $("#successMessage").text(res.message);
                $("#successSection").removeClass("d-none");
                $("#errorSection").addClass("d-none");
                loadUsers(); // åˆ·æ–°ç®¡ç†ä½¿ç”¨è€…æ¸…å–®
            } else {
                // âŒ å¤±æ•—
                $("#errorMessage").text(res.message);
                $("#errorSection").removeClass("d-none");
                $("#successSection").addClass("d-none");

                // æ¸…ç©ºèˆŠçš„éŒ¯èª¤è¡¨æ ¼
                $("#errorTable tbody").empty();

                if (res.errors && res.errors.length > 0) {
                    res.errors.forEach(err => {
                        $("#errorTable tbody").append(
                            `<tr class="table-danger animate__animated animate__fadeIn">
                                <td>${err.RowNumber}</td>
                                <td>${err.EmpNo}</td>
                                <td>${err.Message}</td>
                            </tr>`
                        );
                    });
                }
            }
        },
        error: function () {
            $("#uploadProgress").addClass("d-none");
            $(".progress-bar").css("width", "0%");
            alert("ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        }
    });
});

// é‡æ–°ä¸Šå‚³æŒ‰éˆ•
$("#btnRetryUpload").click(function () {
    $("#errorSection").addClass("d-none");
    $("#successSection").addClass("d-none");
    $("#importForm")[0].reset();
});

