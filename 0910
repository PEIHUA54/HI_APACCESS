å¥½ ğŸ‘ æˆ‘å¹«ä½ é‡å¯«æ–°ç‰ˆ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ï¼Œç›´æ¥å‘¼å« DLL çš„ åŠŸèƒ½ 1 (GetUserNameAndGroup) ä¾†å®Œæˆã€ŒAD â†’ å“¡ç·¨ã€èˆ‡ã€Œå–åŸºæœ¬è³‡æ–™ã€ï¼Œä¸é¡å¤–åšåŠŸèƒ½ 7ã€‚

â¸»

ğŸ”¹æ–°ç‰ˆ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™

using Newtonsoft.Json;
using HI_APACCESS_DLL_FRAMEWORK;
using POSFILE_APPLY.Models;
using System;
using System.Web;

namespace POSFILE_APPLY.Service
{
    public class SVS_å“¡å·¥åŸºæœ¬è³‡æ–™
    {
        #region ADã€å“¡ç·¨

        /// <summary>
        /// å–å¾—å“¡å·¥ AD (å¾ Windows ç™»å…¥è³‡è¨Š)
        /// </summary>
        internal static string Get_å“¡å·¥AD()
        {
            string EMP_DOM_ID = HttpContext.Current.User.Identity.Name
                .Substring(HttpContext.Current.User.Identity.Name.LastIndexOf("\\") + 1);

            if (String.IsNullOrEmpty(EMP_DOM_ID))
            {
                var principal = new System.Security.Principal.WindowsPrincipal(
                    System.Security.Principal.WindowsIdentity.GetCurrent());
                string[] adname = principal.Identity.Name.Split('\\');
                EMP_DOM_ID = adname[1].ToUpper();
            }

            return EMP_DOM_ID;
        }

        /// <summary>
        /// é€é DLL åŠŸèƒ½1 å–å¾—å“¡ç·¨
        /// </summary>
        internal static string Get_å“¡å·¥ç·¨è™Ÿ(string AD = null, string environment = "TEST")
        {
            try
            {
                string userAd = string.IsNullOrEmpty(AD) ? Get_å“¡å·¥AD() : AD;

                var req = new M_AP.GetUserNameAndGroupRequestModel
                {
                    SysID = "HI_POSIMG",   // å¯ä¾å¯¦éš›ç³»çµ±ä»£è™Ÿèª¿æ•´
                    UserAD = userAd,
                    Environment = environment
                };

                string json_input = JsonConvert.SerializeObject(req);
                string response = new APACCESS().GetUserNameAndGroup(json_input);
                var res = JsonConvert.DeserializeObject<M_AP.GetUserNameAndGroupResponseModel>(response);

                if (res.Result_code == "0000" && res.Result != null)
                {
                    return res.Result.UserID;  // ç›´æ¥å›å“¡ç·¨
                }
                else
                {
                    return null; // æŸ¥ä¸åˆ°æˆ–éŒ¯èª¤
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Get_å“¡å·¥ç·¨è™Ÿ éŒ¯èª¤: {ex.Message}");
                return null;
            }
        }

        #endregion

        /// <summary>
        /// å–å¾—å“¡å·¥åŸºæœ¬è³‡æ–™ï¼ˆå§“åã€éƒ¨é–€ã€è·ç¨±ï¼‰
        /// </summary>
        internal static M_AP.EmployeeBasicInfo Get_å“¡å·¥åŸºæœ¬è³‡æ–™(string AD, string environment = "TEST")
        {
            try
            {
                var req = new M_AP.GetUserNameAndGroupRequestModel
                {
                    SysID = "HI_POSIMG",
                    UserAD = AD,
                    Environment = environment
                };

                string json_input = JsonConvert.SerializeObject(req);
                string response = new APACCESS().GetUserNameAndGroup(json_input);
                var res = JsonConvert.DeserializeObject<M_AP.GetUserNameAndGroupResponseModel>(response);

                if (res.Result_code == "0000" && res.Result != null)
                {
                    return new M_AP.EmployeeBasicInfo
                    {
                        UserID = res.Result.UserID,
                        UserName = res.Result.UserName,
                        OrganName = res.Result.OrganName,
                        PostName = res.Result.PostName
                    };
                }
                else
                {
                    return null;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Get_å“¡å·¥åŸºæœ¬è³‡æ–™ éŒ¯èª¤: {ex.Message}");
                return null;
            }
        }
    }
}


â¸»

ğŸ”¹POSFILE_APPLY.Models è£œå……æ¨¡å‹

åœ¨ M_AP åŠ é€™äº› Request/Response æ¨¡å‹ï¼ˆå°æ‡‰ DLL åŠŸèƒ½1ï¼‰ï¼š

namespace POSFILE_APPLY.Models
{
    public class M_AP
    {
        // ===== åŠŸèƒ½1 Request =====
        public class GetUserNameAndGroupRequestModel
        {
            public string SysID { get; set; }
            public string UserAD { get; set; }
            public string Environment { get; set; }
        }

        // ===== åŠŸèƒ½1 Response =====
        public class GetUserNameAndGroupResponseModel
        {
            public string Result_code { get; set; }
            public string Msg { get; set; }
            public ResultData Result { get; set; }

            public class ResultData
            {
                public string UserID { get; set; }
                public string UserName { get; set; }
                public string OrganName { get; set; }
                public string PostName { get; set; }
            }
        }

        // ===== ç°¡åŒ–å“¡å·¥åŸºæœ¬è³‡æ–™æ¨¡å‹ =====
        public class EmployeeBasicInfo
        {
            public string UserID { get; set; }
            public string UserName { get; set; }
            public string OrganName { get; set; }
            public string PostName { get; set; }
        }
    }
}


â¸»

ğŸ”¹æ¸¬è©¦æ–¹å¼

public ActionResult Test_GetEmpInfo()
{
    string ad = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥AD();
    string empNo = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ(ad, "TEST");
    var empInfo = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™(ad, "TEST");

    return Content($@"
        AD: {ad}<br/>
        EmpNo: {empNo}<br/>
        Name: {empInfo?.UserName}<br/>
        éƒ¨é–€: {empInfo?.OrganName}<br/>
        è·ç¨±: {empInfo?.PostName}
    ");
}


â¸»

âœ… é€™æ¨£ä½ çš„ æ–°ç‰ˆ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ï¼š
	â€¢	åªç”¨ DLL åŠŸèƒ½ 1 (GetUserNameAndGroup)
	â€¢	å°±èƒ½å®Œæˆ AD â†’ å“¡ç·¨ + åŸºæœ¬è³‡æ–™æŸ¥è©¢
	â€¢	ä¸éœ€è¦é¡å¤–çš„åŠŸèƒ½ 7

â¸»

è¦ä¸è¦æˆ‘æ¥è‘—ä¹Ÿå¹«ä½ æŠŠ SVS_å®¢è£½åŒ–å…ƒä»¶ æ”¹å¯«æˆç›´æ¥å‘¼å« DLL åŠŸèƒ½ 5ï¼Ÿ

å¥½ ğŸ‘ é‚£æˆ‘å¹«ä½ é‡å¯«æ–°ç‰ˆ SVS_å®¢è£½åŒ–å…ƒä»¶ï¼Œè®“å®ƒå®Œå…¨å‘¼å« DLL çš„ åŠŸèƒ½ 5 (CheckBtnEnabled) ä¾†åˆ¤æ–·æŒ‰éˆ•æ˜¯å¦é¡¯ç¤ºã€‚é€™æ¨£ Razor é é¢ @Html.Hi_Btn(...) å°±ä¸ç”¨è‡ªå·±æ‰“ SQLã€‚

â¸»

ğŸ”¹æ–°ç‰ˆ SVS_å®¢è£½åŒ–å…ƒä»¶

using Newtonsoft.Json;
using HI_APACCESS_DLL_FRAMEWORK;
using POSFILE_APPLY.Models;
using System;
using System.Collections.Generic;
using System.Web.Mvc;

namespace POSFILE_APPLY.Service
{
    public static class SVS_å®¢è£½åŒ–å…ƒä»¶
    {
        #region æŒ‰éˆ•æ¬Šé™ - æ­£å‘æ³•å¯¦ä½œ

        /// <summary>
        /// å®¢è£½åŒ–æ¬Šé™ Button Helper
        /// </summary>
        /// <param name="helper">HtmlHelper</param>
        /// <param name="FUNC_ID">é é¢åŠŸèƒ½ID</param>
        /// <param name="APG_NO">ä½¿ç”¨è€…ç¾¤çµ„</param>
        /// <param name="ButtonID">æŒ‰éˆ•ID</param>
        /// <param name="ButtonText">æŒ‰éˆ•æ–‡å­—</param>
        /// <param name="ButtonType">æŒ‰éˆ•ç¨®é¡ï¼šsubmitã€buttonâ€¦</param>
        /// <param name="HtmlAttributes">Htmlå±¬æ€§ï¼šclassã€styleã€eventâ€¦</param>
        /// <returns>MvcHtmlString (æœ‰æ¬Šé™æ‰å›å‚³ buttonï¼Œæ²’æ¬Šé™å›å‚³ null)</returns>
        public static MvcHtmlString Hi_Btn(this HtmlHelper helper,
            string FUNC_ID, string APG_NO,
            string ButtonID, string ButtonText, string ButtonType,
            object HtmlAttributes, string environment = "TEST")
        {
            try
            {
                // 1. å‘¼å« DLL åŠŸèƒ½ 5
                var req = new M_AP.CheckBtnEnabledRequestModel
                {
                    SysID = "HI_POSIMG",  // å¯ä¾å¯¦éš›ç³»çµ±ä»£è™Ÿèª¿æ•´
                    FuncID = FUNC_ID,
                    GroupID = APG_NO,
                    BtnID = ButtonID,
                    Environment = environment
                };

                string json_input = JsonConvert.SerializeObject(req);
                string response = new APACCESS().CheckBtnEnabled(json_input);
                var res = JsonConvert.DeserializeObject<M_AP.CheckBtnEnabledResponseModel>(response);

                // 2. åˆ¤æ–·æ˜¯å¦æœ‰æ¬Šé™
                if (res.Result_code == "0000" && res.HasPermission)
                {
                    // ç”¢ç”Ÿ button
                    TagBuilder tb = new TagBuilder("button");
                    if (!string.IsNullOrWhiteSpace(ButtonText)) tb.InnerHtml = ButtonText;
                    if (!string.IsNullOrWhiteSpace(ButtonID)) tb.Attributes.Add("id", ButtonID);
                    if (!string.IsNullOrWhiteSpace(ButtonType)) tb.Attributes.Add("type", ButtonType);

                    if (HtmlAttributes != null)
                    {
                        var dict = JsonConvert.DeserializeObject<Dictionary<string, string>>(
                            JsonConvert.SerializeObject(HtmlAttributes));
                        foreach (var kv in dict)
                        {
                            string key = kv.Key.Contains("_") ? kv.Key.Replace("_", "-") : kv.Key;
                            if (tb.Attributes.ContainsKey(key))
                                tb.Attributes[key] = kv.Value;
                            else
                                tb.Attributes.Add(key, kv.Value);
                        }
                    }

                    return MvcHtmlString.Create(tb.ToString());
                }

                // æ²’æœ‰æ¬Šé™ â†’ ä¸é¡¯ç¤º
                return null;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Hi_Btn éŒ¯èª¤: {ex.Message}");
                return null;
            }
        }

        #endregion
    }
}


â¸»

ğŸ”¹POSFILE_APPLY.Models è£œå……æ¨¡å‹

åœ¨ M_AP è£¡åŠ åŠŸèƒ½ 5 çš„ Request/Response æ¨¡å‹ï¼š

namespace POSFILE_APPLY.Models
{
    public partial class M_AP
    {
        // ===== åŠŸèƒ½5 Request =====
        public class CheckBtnEnabledRequestModel
        {
            public string SysID { get; set; }
            public string FuncID { get; set; }
            public string GroupID { get; set; }
            public string BtnID { get; set; }
            public string Environment { get; set; }
        }

        // ===== åŠŸèƒ½5 Response =====
        public class CheckBtnEnabledResponseModel
        {
            public string Result_code { get; set; }
            public string Msg { get; set; }
            public bool HasPermission { get; set; }
        }
    }
}


â¸»

ğŸ”¹Razor é é¢ç”¨æ³•

ä»¥å‰å¯«æ³•ï¼š

@Html.Hi_Btn("FUNC123", "007", "btnSave", "å„²å­˜", "submit", new { @class = "btn btn-primary" })

æ–°çš„ DLL å‘¼å«å¾Œï¼Œé‚è¼¯æœƒè®Šæˆï¼š
	â€¢	DLL å›å‚³ HasPermission = true â†’ ç”¢ç”Ÿ <button>
	â€¢	DLL å›å‚³ HasPermission = false â†’ ä¸ç”¢ç”Ÿä»»ä½•æ±è¥¿ (null)

â¸»

âœ… é€™æ¨£ä¸€ä¾†ï¼š
	â€¢	SVS_å®¢è£½åŒ–å…ƒä»¶ ä¸éœ€è¦è‡ªå·±æŸ¥ SQL
	â€¢	æ¬Šé™åˆ¤æ–·å…¨éƒ¨çµ±ä¸€èµ° DLL â†’ åŠŸèƒ½ 5
	â€¢	Razor é é¢ç…§èˆŠå¯« @Html.Hi_Btn(...)ï¼Œä¸éœ€è¦æ”¹å‹•

â¸»

è¦ä¸è¦æˆ‘å†å¹«ä½ æŠŠ èˆŠçš„ Get_Tree ä¹Ÿä¸€èµ·æ”¹æ‰ â†’ ç›´æ¥å‘¼å« DLL çš„ åŠŸèƒ½ 3 (GetTree)ï¼Ÿ