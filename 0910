éå¸¸å¥½ ğŸ‘Œ
ä½ å•å¾—å°ï¼Œç¬¬ 8 é»æˆ‘ä¹‹å‰åªå¯«ä¿®æ”¹é‡é»ï¼Œé€™è£¡æˆ‘ç›´æ¥çµ¦ä½  å®Œæ•´ã€å¯è²¼ä¸Šæ›¿æ›çš„å…©å€‹å‡½å¼ï¼ˆupdateButtonListHierarchical() å’Œ loadButtonsForPage()ï¼‰ ï¼Œå·²å®Œæ•´æ•´åˆã€Œ001 å¯æ“ä½œã€é001å”¯è®€ã€é‚è¼¯ã€‚
åŒæ™‚ä¹Ÿä¿æŒä½ åŸæœ¬çš„ç‰ˆå‹ã€æ¨£å¼ã€è¼‰å…¥é †åºã€‚

â¸»

âœ… ä¸€ã€å®Œæ•´æ›¿æ› updateButtonListHierarchical()

// éšå±¤å¼æ›´æ–°æŒ‰éˆ•åˆ—è¡¨ï¼ˆä¾ç™»å…¥èº«åˆ†æ±ºå®šæ˜¯å¦å”¯è®€ï¼‰
function updateButtonListHierarchical() {
    if (allFunctions.length === 0) {
        $('#buttonList').html('<div class="no-data">ç„¡å¯ç”¨é é¢</div>');
        return;
    }

    const isAdmin = (currentGroupID === '001');
    const parentChildMap = {};
    const parentPages = [];

    // åˆ†é›¢çˆ¶é é¢èˆ‡å­é é¢
    allFunctions.forEach(func => {
        const funcId = getFuncId(func);
        const parentId = getParentId(func);

        if (!parentId || parentId === '' || parentId === 'HOME') {
            parentPages.push(func);
            parentChildMap[funcId] = parentChildMap[funcId] || [];
        } else if (func.IS_SHOW === 'Y') {
            parentChildMap[parentId] = parentChildMap[parentId] || [];
            parentChildMap[parentId].push(func);
        }
    });

    // ä¾æ’åºæ’åº
    parentPages.sort((a, b) => (parseInt(a.SORT_NO) || 999) - (parseInt(b.SORT_NO) || 999));
    Object.keys(parentChildMap).forEach(pid => {
        parentChildMap[pid].sort((a, b) => (parseInt(a.SORT_NO) || 999) - (parseInt(b.SORT_NO) || 999));
    });

    let html = '';

    parentPages.forEach(parentFunc => {
        const parentId = getFuncId(parentFunc);
        const parentName = getFuncName(parentFunc);
        const children = parentChildMap[parentId] || [];

        // çˆ¶é é¢ header
        html += `
        <div class="parent-page-header" id="parent-header-${parentId}">
            <i class="fas fa-folder"></i> ${parentName}
            <small class="text-muted" style="margin-left:10px;">(${parentId})</small>
        </div>`;

        // çˆ¶é é¢æŒ‰éˆ•å€å¡Š
        const parentHasPagePermission = groupPermissions[parentId] && groupPermissions[parentId].hasPagePermission;
        const parentSectionStyle = parentHasPagePermission
            ? 'margin-bottom:15px;border:1px solid #dee2e6;border-radius:6px;background:#f8f9fa;margin-left:20px;'
            : 'margin-bottom:15px;border:1px solid #dee2e6;border-radius:6px;background:#f5f5f5;opacity:0.6;margin-left:20px;';

        html += `
        <div class="page-section parent-section" id="page-section-${parentId}" style="${parentSectionStyle}">
            <div class="page-header" style="background:#e9ecef;padding:10px 15px;border-bottom:1px solid #dee2e6;font-weight:bold;color:#495057;display:flex;justify-content:space-between;align-items:center;">
                <span>
                    <i class="fas fa-folder-open"></i> ${parentName}
                    <small class="text-muted" style="margin-left:10px;">(${parentId})</small>
                </span>
                <div style="display:flex;gap:5px;">
                    ${isAdmin ? `
                    <button type="button" class="btn btn-sm btn-primary" onclick="selectAllButtons('${parentId}')" style="font-size:11px;padding:2px 8px;" ${!parentHasPagePermission ? 'disabled' : ''}>
                        <i class="fas fa-check-square"></i> å…¨å‹¾é¸
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllButtons('${parentId}')" style="font-size:11px;padding:2px 8px;" ${!parentHasPagePermission ? 'disabled' : ''}>
                        <i class="fas fa-square"></i> å…¨å–æ¶ˆ
                    </button>` : ''}
                </div>
            </div>
            <div class="buttons-container" id="buttons-${parentId}" style="padding:10px;">
                <div class="no-data"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
            </div>`;

        // å­é é¢
        if (children.length > 0) {
            html += `<div style="margin:10px 15px;border-top:2px solid #6c757d;"></div>`;
            children.forEach(childFunc => {
                const funcId = getFuncId(childFunc);
                const funcName = getFuncName(childFunc);
                const hasPagePermission = groupPermissions[funcId] && groupPermissions[funcId].hasPagePermission;

                html += `
                <div class="child-page-section" style="margin:10px;border:1px solid #ccc;border-radius:4px;background:${hasPagePermission ? '#fff' : '#f5f5f5'};${!hasPagePermission ? 'opacity:0.6;' : ''}">
                    <div class="page-header" style="background:#f1f3f4;padding:8px 12px;border-bottom:1px solid #ccc;font-weight:bold;color:#495057;display:flex;justify-content:space-between;align-items:center;font-size:14px;">
                        <span>
                            <i class="fas fa-file-alt"></i> ${funcName}
                            <small class="text-muted" style="margin-left:10px;">(${funcId})</small>
                        </span>
                        <div style="display:flex;gap:5px;">
                            ${isAdmin ? `
                            <button type="button" class="btn btn-sm btn-primary" onclick="selectAllButtons('${funcId}')" style="font-size:10px;padding:1px 6px;" ${!hasPagePermission ? 'disabled' : ''}>
                                <i class="fas fa-check-square"></i> å…¨å‹¾é¸
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllButtons('${funcId}')" style="font-size:10px;padding:1px 6px;" ${!hasPagePermission ? 'disabled' : ''}>
                                <i class="fas fa-square"></i> å…¨å–æ¶ˆ
                            </button>` : ''}
                        </div>
                    </div>
                    <div class="buttons-container" id="buttons-${funcId}" style="padding:8px;">
                        <div class="no-data"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
                    </div>
                </div>`;
            });
        }

        html += `</div>`;
    });

    $('#buttonList').html(html);

    // è¼‰å…¥æ¯å€‹é é¢çš„æŒ‰éˆ•è³‡æ–™
    parentPages.forEach(parentFunc => {
        loadButtonsForPage(getFuncId(parentFunc));
        (parentChildMap[getFuncId(parentFunc)] || []).forEach(childFunc => {
            loadButtonsForPage(getFuncId(childFunc));
        });
    });
}


â¸»

âœ… äºŒã€å®Œæ•´æ›¿æ› loadButtonsForPage()

// è¼‰å…¥æŒ‡å®šé é¢çš„æŒ‰éˆ•åˆ—è¡¨ï¼ˆ001 å¯æ“ä½œã€é001å”¯è®€ï¼‰
function loadButtonsForPage(funcId) {
    const isAdmin = (currentGroupID === '001');
    const hasPagePermission = groupPermissions[funcId] && groupPermissions[funcId].hasPagePermission;

    $.get('@Url.Action("GetButtonsByFuncId", "AP")', {
        func_id: funcId,
        sysID: currentSysID
    }, function (response) {
        let buttonHtml = '';

        if (response.success && Array.isArray(response.data) && response.data.length > 0) {
            response.data.forEach(function (btn) {
                const hasPermission = (groupPermissions[funcId]?.buttons?.[btn.BTNSEQ]) || false;

                if (isAdmin) {
                    // âœ… ç®¡ç†å“¡ï¼šå¯å‹¾é¸æ“ä½œ
                    buttonHtml += `
                    <div class="btn-item ${hasPermission ? 'has-permission' : ''}"
                         onclick="toggleButtonPermissionByClick('${funcId}', '${btn.BTNSEQ}')">
                        <div class="permission-content">
                            <input type="checkbox" class="permission-checkbox" ${hasPermission ? 'checked' : ''}>
                            <span class="permission-title">${btn.BTN_NAME}</span>
                            <span class="permission-info">ID: ${btn.BTNID}</span>
                        </div>
                    </div>`;
                } else {
                    // âŒ é001ï¼šå”¯è®€é¡¯ç¤ºï¼Œç„¡checkboxã€ç„¡onclick
                    buttonHtml += `
                    <div class="btn-item ${hasPermission ? 'has-permission' : ''}" style="pointer-events:none;">
                        <div class="permission-content">
                            <span class="permission-title">${btn.BTN_NAME}</span>
                            <span class="permission-info">ID: ${btn.BTNID}</span>
                        </div>
                    </div>`;
                }
            });

            $(`#buttons-${funcId}`).html(buttonHtml).css({ 'padding': '10px', 'min-height': 'auto' });
        } else {
            // æ²’æœ‰æŒ‰éˆ•
            const noDataHtml = `<div class="no-data-compact" style="padding:8px;text-align:center;color:#6c757d;font-size:12px;">æ­¤é é¢ç„¡æŒ‰éˆ•</div>`;
            $(`#buttons-${funcId}`).html(noDataHtml).css({ 'padding': '0', 'min-height': '30px' });
        }
    }).fail(function () {
        const errorHtml = `<div class="no-data-compact" style="padding:8px;text-align:center;color:#dc3545;font-size:12px;">è¼‰å…¥å¤±æ•—</div>`;
        $(`#buttons-${funcId}`).html(errorHtml).css({ 'padding': '0', 'min-height': '30px' });
    });
}


â¸»

ğŸ“˜ æ”¹å®Œå¾Œæ•ˆæœç¸½çµ

ç™»å…¥èº«åˆ†	æŒ‰éˆ•æ¬Šé™æ“ä½œ	å‹¾é¸åŠŸèƒ½	å…¨å‹¾é¸/å…¨å–æ¶ˆæŒ‰éˆ•	æŒ‰éˆ•å€å¡Šç‹€æ…‹
001	âœ… å¯ä»¥æ“ä½œ	âœ… å¯å‹¾é¸	âœ… é¡¯ç¤ºå¯ç”¨	æ­£å¸¸äº’å‹•
é001	âŒ å”¯è®€	âŒ ä¸å¯å‹¾	âŒ æŒ‰éˆ•éš±è—	åªæœ‰é¡¯ç¤ºç‹€æ…‹


â¸»

æ˜¯å¦è¦æˆ‘å¹«ä½ è£œä¸Šã€Œé001ç™»å…¥ â†’ æŒ‰éˆ•åˆ—ç°éšèƒŒæ™¯é¡¯ç¤ºã€çš„CSSï¼ˆè®“æ•´å€‹æ¬Šé™å€å¡Šä¸€çœ¼çœ‹å‡ºæ˜¯å”¯è®€ï¼‰ï¼Ÿ