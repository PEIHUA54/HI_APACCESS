å¥½å•é¡Œ ğŸ‘
ä½ ç¾åœ¨çš„éœ€æ±‚æ˜¯ï¼š
	â€¢	TEST â†’ ç”¨æ¸¬è©¦çš„ DB é€£ç·šå­—ä¸² (ä¾‹å¦‚ Hilife-tfs, HI_APLOG)
	â€¢	PROD â†’ ç”¨æ­£å¼çš„ DB é€£ç·šå­—ä¸² (ä¾‹å¦‚ localhost, Possc, sa)

æ‰€ä»¥æˆ‘å€‘è¦åœ¨ FCommon.BuildConnectionString() è£¡é¢åˆ¤æ–· å‚³é€²ä¾†çš„ environmentï¼Œç„¶å¾Œçµ¦ä¸åŒçš„ SqlConnectionStringBuilderã€‚

â¸»

ğŸ“Œ ä¿®æ”¹å¾Œçš„ FCommon

using System;
using System.Collections.Generic;
using System.Data.SqlClient;

namespace HI_APACCESS_DLL_FRAMEWORK.Factory
{
    internal static class FCommon
    {
        /// <summary>
        /// å»ºç«‹ SQL é€£ç·šå­—ä¸² (ä¾ç…§ç’°å¢ƒä¸åŒåˆ‡æ›)
        /// </summary>
        internal static string BuildConnectionString(string environment)
        {
            SqlConnectionStringBuilder csb;

            if (environment == "TEST")
            {
                // æ¸¬è©¦ç’°å¢ƒé€£ç·šå­—ä¸²
                csb = new SqlConnectionStringBuilder
                {
                    DataSource = "Hilife-tfs",
                    InitialCatalog = "HI_APLOG",
                    PersistSecurityInfo = true,
                    TrustServerCertificate = true,
                    UserID = "pos",
                    Password = "pos1",
                    Encrypt = true
                };
            }
            else if (environment == "PROD")
            {
                // æ­£å¼ç’°å¢ƒé€£ç·šå­—ä¸²
                csb = new SqlConnectionStringBuilder
                {
                    DataSource = "localhost",
                    InitialCatalog = "Possc",
                    PersistSecurityInfo = true,
                    TrustServerCertificate = true,
                    UserID = "sa",
                    Password = "ä½ çš„æ­£å¼å¯†ç¢¼", // âš  è«‹æ›æˆæ­£å¼çš„å¯†ç¢¼
                    Encrypt = true
                };
            }
            else
            {
                throw new ArgumentException("ç’°å¢ƒåƒæ•¸éŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD");
            }

            return csb.ConnectionString;
        }

        /// <summary>
        /// å–å¾—æˆæ¬Šç³»çµ±æ¸…å–®ï¼ˆéœ€å‚³å…¥ç’°å¢ƒåƒæ•¸ï¼‰
        /// </summary>
        internal static List<string> GetAuthorizedSystemsList(string environment)
        {
            string sql = "SELECT [SYS_ID] FROM [HI_TMMAIN].[dbo].[AP_SYS]";
            var systemIds = new List<string>();

            try
            {
                using (SqlConnection conn = new SqlConnection(BuildConnectionString(environment)))
                using (SqlCommand cmd = new SqlCommand(sql, conn))
                {
                    conn.Open();
                    using (var reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            systemIds.Add(reader["SYS_ID"].ToString());
                        }
                    }
                }
            }
            catch
            {
                // DB æ›æ‰æ™‚å›å‚³é è¨­æ¸…å–®
                return new List<string> { "HI_POS", "HI_POSIMG", "POS_LOG" };
            }

            return systemIds;
        }
    }
}


â¸»

ğŸ“Œ Factory å‘¼å«æ–¹å¼è¦æ”¹

åŸæœ¬ï¼š

using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString()))

è¦æ”¹æˆå‚³ç’°å¢ƒé€²å»ï¼š

using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))

åŒç†ï¼Œå‘¼å«æˆæ¬Šç³»çµ±æ¸…å–®çš„åœ°æ–¹ä¹Ÿè¦æ”¹ï¼š

var authorizedSystems = FCommon.GetAuthorizedSystemsList(environment);


â¸»

âœ… å¥½è™•

é€™æ¨£ä½ çš„ç¨‹å¼å¯ä»¥ï¼š
	â€¢	TEST â†’ é€£åˆ°æ¸¬è©¦ DB
	â€¢	PROD â†’ é€£åˆ°æ­£å¼ DB
	â€¢	å…¶ä»–å­—ä¸² â†’ ç›´æ¥ä¸Ÿ Exception (ç’°å¢ƒåƒæ•¸éŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD)

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ åŠŸèƒ½ 1 çš„ Factory æ”¹æˆæ–°ç‰ˆï¼Œç›´æ¥ç”¨ FCommon.BuildConnectionString(environment)ï¼Œè®“ä½ å¯ä»¥æ¸¬è©¦å…©å€‹ç’°å¢ƒåˆ‡æ›ï¼Ÿ