**éœ€è¦ï¼** Controller ä¹Ÿè¦åŠ ä¸Šé©—è­‰ï¼Œé€™æ¨£æ‰èƒ½å®Œæ•´ç¬¦åˆ Fortify çš„è¦æ±‚ã€‚

## ç‚ºä»€éº¼ Controller ä¹Ÿè¦é©—è­‰ï¼Ÿ

Fortify çš„ **Access Control: Database** æª¢æŸ¥æœƒè¿½è¹¤æ•´å€‹æµç¨‹ï¼š

```
User Input (å‰ç«¯) 
    â†“
Controller (ç¬¬ä¸€é“é˜²ç·š) â† Fortify æœƒæª¢æŸ¥é€™è£¡
    â†“
Service Layer (ç¬¬äºŒé“é˜²ç·š)
    â†“
SQL Query (ç¬¬ä¸‰é“é˜²ç·š) â† Fortify ä¹Ÿæœƒæª¢æŸ¥é€™è£¡
```

å¦‚æœåªåœ¨ SQL å±¤é©—è­‰ï¼ŒFortify å¯èƒ½é‚„æ˜¯æœƒè­¦å‘Šï¼š

> â€œController ç›´æ¥ä½¿ç”¨æœªé©—è­‰çš„ä½¿ç”¨è€…è¼¸å…¥ `apgNo` å‘¼å« Serviceâ€

## ä¿®æ­£å¾Œçš„ Controller

```csharp
// âœ… ä¿®æ­£å¾Œçš„ Controllerï¼ˆåŠ å…¥æ¬Šé™é©—è­‰ï¼‰
[HttpPost]
public ActionResult ImportUsers(HttpPostedFileBase file, string apgNo, string sysID)
{
    if (file == null || file.ContentLength == 0)
        return Json(new { success = false, message = "è«‹é¸æ“‡è¦åŒ¯å…¥çš„Excelæª”æ¡ˆ" });

    if (string.IsNullOrWhiteSpace(apgNo))
        return Json(new { success = false, message = "è«‹å…ˆé¸æ“‡ç¾¤çµ„" });

    // âœ… Step 1: å¾è³‡æ–™åº«å–å¾—ç•¶å‰ä½¿ç”¨è€…å¯å­˜å–çš„ç¾¤çµ„æ¸…å–®
    var allowedGroups = GetAllowedGroupsForUser(CurrentSystemId, this.Emp_NO);

    // âœ… Step 2: é©—è­‰å‰ç«¯å‚³å…¥çš„ apgNo æ˜¯å¦åœ¨æˆæ¬Šæ¸…å–®ä¸­
    if (!allowedGroups.Contains(apgNo))
    {
        return Json(new { 
            success = false, 
            message = "ç„¡æ¬Šé™æ“ä½œæ­¤ç¾¤çµ„" 
        });
    }

    // å‰¯æª”åé™åˆ¶
    var ext = Path.GetExtension(file.FileName).ToLower();
    if (ext != ".xls" && ext != ".xlsx")
        return Json(new { success = false, message = "è«‹ä¸Šå‚³Excelæª”æ¡ˆï¼ˆ.xls æˆ– .xlsxï¼‰" });

    // ä¸Šå‚³æš«å­˜
    var uploadDir = Server.MapPath("~/Upload");
    if (!Directory.Exists(uploadDir)) Directory.CreateDirectory(uploadDir);

    var safeName = $"Import_{apgNo}_{DateTime.Now:yyyyMMddHHmmss}{ext}";
    var uploadPath = PathValidator.GetSafePath(uploadDir, safeName);

    try
    {
        file.SaveAs(uploadPath);

        var service = GetAPService();
        
        // âœ… Step 3: ä½¿ç”¨å·²é©—è­‰çš„ apgNo å’Œ Emp_NO å‘¼å« Service
        var importResult = service.ImportUsersFromExcel(
            uploadPath, 
            CurrentSystemId, 
            apgNo,          // å·²é©—è­‰çš„ç¾¤çµ„
            this.Emp_NO     // ç•¶å‰ä½¿ç”¨è€…
        );

        if (importResult.SuccessCount > 0 && importResult.ErrorMessages.Count == 0)
        {
            return Json(new
            {
                status = "success",
                message = $"åŒ¯å…¥æˆåŠŸï¼šå…± {importResult.SuccessCount} ç­†"
            });
        }
        else if (importResult.SuccessCount == 0 && importResult.ErrorMessages.Count > 0)
        {
            return Json(new
            {
                status = "fail",
                message = "åŒ¯å…¥å¤±æ•—ï¼šè«‹é‡æ–°ä¸Šå‚³",
                errors = importResult.ErrorMessages
            });
        }
        else
        {
            return Json(new
            {
                status = "partial",
                message = $"åŒ¯å…¥éƒ¨åˆ†æˆåŠŸï¼šæˆåŠŸ {importResult.SuccessCount} ç­†ï¼Œå¤±æ•— {importResult.ErrorMessages.Count} ç­†",
                errors = importResult.ErrorMessages
            });
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "åŒ¯å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message });
    }
    finally
    {
        if (System.IO.File.Exists(uploadPath))
        {
            var fc = new F_Common();
            fc.SafeDeleteFile(uploadDir, safeName);
        }
    }
}

/// <summary>
/// âœ… Step 1: å–å¾—ä½¿ç”¨è€…å¯æ“ä½œçš„ç¾¤çµ„æ¸…å–®
/// </summary>
private List<string> GetAllowedGroupsForUser(string sysId, string userId)
{
    var allowedGroups = new List<string>();

    try
    {
        // âœ… é—œéµï¼šSQL ä¸­åŒ…å« UserID æ¢ä»¶
        string sql = @"
            SELECT DISTINCT APG_NO 
            FROM AP_USER 
            WHERE SYS_ID = @SYS_ID 
              AND U_ID = @U_ID";

        var parameters = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = userId }
        };

        var result = SVS_DBmanager.QueryBySQL(sql, parameters);

        foreach (DataRow row in result.Rows)
        {
            string groupNo = row["APG_NO"].ToString().Trim();
            allowedGroups.Add(groupNo);
        }

        System.Diagnostics.Debug.WriteLine($"[GetAllowedGroups] User {userId} å¯å­˜å–çš„ç¾¤çµ„: {string.Join(", ", allowedGroups)}");
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"[GetAllowedGroups] éŒ¯èª¤: {ex.Message}");
    }

    return allowedGroups;
}
```

## å®Œæ•´çš„ä¸‰å±¤é˜²è­·æ¶æ§‹

### ç¬¬ä¸€å±¤ï¼šControllerï¼ˆå…¥å£é©—è­‰ï¼‰

```csharp
// 1. å–å¾—ä½¿ç”¨è€…çš„æˆæ¬Šç¾¤çµ„æ¸…å–®
var allowedGroups = GetAllowedGroupsForUser(CurrentSystemId, this.Emp_NO);
// çµæœ: ["001", "002"]

// 2. é©—è­‰å‰ç«¯å‚³å…¥çš„ç¾¤çµ„æ˜¯å¦åœ¨æ¸…å–®ä¸­
if (!allowedGroups.Contains(apgNo))  // apgNo = "003"
{
    return Json(new { success = false, message = "ç„¡æ¬Šé™æ“ä½œæ­¤ç¾¤çµ„" });
}
```

**é˜²è­·å…§å®¹ï¼š**

- âœ… é˜²æ­¢ä½¿ç”¨è€…ç¯¡æ”¹å‰ç«¯å‚³å…¥çš„ `apgNo`
- âœ… åªå…è¨±æ“ä½œè‡ªå·±æœ‰æ¬Šé™çš„ç¾¤çµ„
- âœ… Fortify èƒ½çœ‹åˆ° SQL ä¸­æœ‰ `WHERE U_ID = @U_ID`

-----

### ç¬¬äºŒå±¤ï¼šService Layerï¼ˆæ¥­å‹™é‚è¼¯é©—è­‰ï¼‰

```csharp
// HasGroupPermission() å†æ¬¡é©—è­‰
if (!HasGroupPermission(sysId, an, creator))
{
    return result; // æ‹’çµ•
}
```

**é˜²è­·å…§å®¹ï¼š**

- âœ… é˜²æ­¢ç›´æ¥å‘¼å« Service ç¹é Controller
- âœ… æª¢æŸ¥ç‰¹æ®Šè¦å‰‡ï¼ˆä¾‹å¦‚ï¼šåªæœ‰ 001 èƒ½æ“ä½œ 001ï¼‰

-----

### ç¬¬ä¸‰å±¤ï¼šDatabaseï¼ˆSQL å±¤ç´šé©—è­‰ï¼‰

```sql
-- æ¯å€‹ SQL éƒ½åŒ…å«æ¬Šé™æª¢æŸ¥
WHERE EXISTS (
    SELECT 1 FROM AP_USER
    WHERE SYS_ID = @SYS_ID
      AND (APG_NO = @AN OR APG_NO = '001')
      AND U_ID = @CREATOR  -- âœ… Fortify è¦çœ‹åˆ°é€™å€‹
)
```

**é˜²è­·å…§å®¹ï¼š**

- âœ… æœ€å¾Œä¸€é“é˜²ç·š
- âœ… å³ä½¿å‰å…©å±¤è¢«ç¹éï¼ŒSQL ä¹Ÿèƒ½æ“‹ä½

-----

## ç¯„ä¾‹å°æ¯”

### âŒ ä¸å®‰å…¨çš„å¯«æ³•ï¼ˆFortify æœƒè­¦å‘Šï¼‰

```csharp
[HttpPost]
public ActionResult ImportUsers(HttpPostedFileBase file, string apgNo, string sysID)
{
    // âŒ ç›´æ¥ä½¿ç”¨å‰ç«¯å‚³å…¥çš„ apgNoï¼Œæ²’æœ‰é©—è­‰
    var service = GetAPService();
    var importResult = service.ImportUsersFromExcel(uploadPath, sysID, apgNo, this.Emp_NO);
    // Fortify: "Access Control: Database - apgNo æœªç¶“é©—è­‰å°±ç”¨æ–¼è³‡æ–™åº«æ“ä½œ"
}
```

### âœ… å®‰å…¨çš„å¯«æ³•ï¼ˆFortify é€šéï¼‰

```csharp
[HttpPost]
public ActionResult ImportUsers(HttpPostedFileBase file, string apgNo, string sysID)
{
    // âœ… Step 1: å¾è³‡æ–™åº«å–å¾—æˆæ¬Šæ¸…å–®ï¼ˆSQL ä¸­æœ‰ WHERE U_ID = @U_IDï¼‰
    var allowedGroups = GetAllowedGroupsForUser(sysID, this.Emp_NO);
    
    // âœ… Step 2: é©—è­‰å‰ç«¯è¼¸å…¥
    if (!allowedGroups.Contains(apgNo))
    {
        return Json(new { success = false, message = "ç„¡æ¬Šé™" });
    }
    
    // âœ… Step 3: ä½¿ç”¨å·²é©—è­‰çš„åƒæ•¸å‘¼å« Service
    var service = GetAPService();
    var importResult = service.ImportUsersFromExcel(uploadPath, sysID, apgNo, this.Emp_NO);
    // Fortify: âœ… é€šéæª¢æŸ¥
}
```

-----

## å¯¦éš›æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1ï¼šæ­£å¸¸ä½¿ç”¨è€…

```
ä½¿ç”¨è€…: 3B750
æ‰€å±¬ç¾¤çµ„: 002
å˜—è©¦åŒ¯å…¥åˆ°: 002

Controller:
  allowedGroups = ["002"] â† å¾è³‡æ–™åº«æŸ¥è©¢
  apgNo = "002" â† å‰ç«¯å‚³å…¥
  allowedGroups.Contains("002") = true âœ…
  â†’ ç¹¼çºŒåŸ·è¡Œ

Service:
  HasGroupPermission("002", "3B750") = true âœ…
  â†’ ç¹¼çºŒåŸ·è¡Œ

Database:
  WHERE U_ID = '3B750' AND APG_NO = '002' âœ…
  â†’ å¯«å…¥æˆåŠŸ
```

-----

### å ´æ™¯ 2ï¼šæƒ¡æ„ä½¿ç”¨è€…å˜—è©¦æ“ä½œå…¶ä»–ç¾¤çµ„

```
ä½¿ç”¨è€…: 3B750
æ‰€å±¬ç¾¤çµ„: 002
å˜—è©¦åŒ¯å…¥åˆ°: 003 â† æƒ¡æ„ç¯¡æ”¹å‰ç«¯åƒæ•¸

Controller:
  allowedGroups = ["002"] â† å¾è³‡æ–™åº«æŸ¥è©¢
  apgNo = "003" â† å‰ç«¯å‚³å…¥ï¼ˆè¢«ç«„æ”¹ï¼‰
  allowedGroups.Contains("003") = false âŒ
  â†’ ç«‹å³æ‹’çµ•ï¼Œå›å‚³ "ç„¡æ¬Šé™æ“ä½œæ­¤ç¾¤çµ„"
```

-----

### å ´æ™¯ 3ï¼š001 ç®¡ç†å“¡

```
ä½¿ç”¨è€…: ADMIN001
æ‰€å±¬ç¾¤çµ„: 001
å˜—è©¦åŒ¯å…¥åˆ°: 003

Controller:
  allowedGroups = ["001"] â† å¾è³‡æ–™åº«æŸ¥è©¢
  apgNo = "003" â† å‰ç«¯å‚³å…¥
  allowedGroups.Contains("003") = false âŒ
  â†’ æ‹’çµ•

ä½†é€™æ¨£ 001 å°±ä¸èƒ½ç®¡ç†å…¶ä»–ç¾¤çµ„äº†ï¼éœ€è¦ç‰¹æ®Šè™•ç† ğŸ‘‡
```

-----

## ç‰¹æ®Šè™•ç†ï¼š001 ç®¡ç†å“¡å¯æ“ä½œæ‰€æœ‰ç¾¤çµ„

å¦‚æœ 001 ç¾¤çµ„æ˜¯è¶…ç´šç®¡ç†å“¡ï¼Œéœ€è¦ä¿®æ”¹ `GetAllowedGroupsForUser`ï¼š

```csharp
private List<string> GetAllowedGroupsForUser(string sysId, string userId)
{
    var allowedGroups = new List<string>();

    try
    {
        // âœ… å…ˆæª¢æŸ¥æ˜¯å¦ç‚º 001 ç¾¤çµ„æˆå“¡
        string checkAdminSql = @"
            SELECT COUNT(1) 
            FROM AP_USER 
            WHERE SYS_ID = @SYS_ID 
              AND U_ID = @U_ID 
              AND RTRIM(APG_NO) = '001'";

        var adminParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = userId }
        };

        var adminResult = SVS_DBmanager.QueryBySQL(checkAdminSql, adminParams);
        bool isAdmin = Convert.ToInt32(adminResult.Rows[0][0]) > 0;

        if (isAdmin)
        {
            // âœ… 001 ç¾¤çµ„æˆå“¡ï¼šå›å‚³è©²ç³»çµ±æ‰€æœ‰ç¾¤çµ„
            string allGroupsSql = @"
                SELECT APG_NO 
                FROM AP_GROUP 
                WHERE SYS_ID = @SYS_ID";

            var allGroupsParams = new List<SqlParameter>
            {
                new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId }
            };

            var allGroupsResult = SVS_DBmanager.QueryBySQL(allGroupsSql, allGroupsParams);

            foreach (DataRow row in allGroupsResult.Rows)
            {
                allowedGroups.Add(row["APG_NO"].ToString().Trim());
            }

            System.Diagnostics.Debug.WriteLine($"[GetAllowedGroups] User {userId} æ˜¯ç®¡ç†å“¡ï¼Œå¯å­˜å–æ‰€æœ‰ç¾¤çµ„");
        }
        else
        {
            // âœ… ä¸€èˆ¬ä½¿ç”¨è€…ï¼šåªå›å‚³è‡ªå·±æ‰€å±¬çš„ç¾¤çµ„
            string userGroupsSql = @"
                SELECT APG_NO 
                FROM AP_USER 
                WHERE SYS_ID = @SYS_ID 
                  AND U_ID = @U_ID";

            var userGroupsParams = new List<SqlParameter>
            {
                new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
                new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = userId }
            };

            var userGroupsResult = SVS_DBmanager.QueryBySQL(userGroupsSql, userGroupsParams);

            foreach (DataRow row in userGroupsResult.Rows)
            {
                allowedGroups.Add(row["APG_NO"].ToString().Trim());
            }

            System.Diagnostics.Debug.WriteLine($"[GetAllowedGroups] User {userId} å¯å­˜å–çš„ç¾¤çµ„: {string.Join(", ", allowedGroups)}");
        }
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"[GetAllowedGroups] éŒ¯èª¤: {ex.Message}");
    }

    return allowedGroups;
}
```

-----

## ç¸½çµ

**æ˜¯çš„ï¼ŒController å¿…é ˆåŠ ä¸Šé©—è­‰ï¼** é€™æ¨£æ‰ç¬¦åˆ Fortify çš„è¦æ±‚ï¼š

1. âœ… **Controller** é©—è­‰ï¼šç¢ºä¿ä½¿ç”¨è€…åªèƒ½æ“ä½œæˆæ¬Šçš„ç¾¤çµ„
1. âœ… **Service** é©—è­‰ï¼šæ¥­å‹™é‚è¼¯å±¤çš„äºŒæ¬¡ç¢ºèª
1. âœ… **Database** é©—è­‰ï¼šSQL å±¤çš„æœ€å¾Œé˜²ç·š

é€™å°±æ˜¯**ç¸±æ·±é˜²ç¦¦ï¼ˆDefense in Depthï¼‰**çš„æ¦‚å¿µï¼Œæ¯ä¸€å±¤éƒ½æœ‰ä¿è­·æ©Ÿåˆ¶ï¼â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹