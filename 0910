å¤ªå¥½äº†ï¼Œä½ çš„ Web.config å·²ç¶“ç”¨ Environment = "HI_APACCESS_TEST" / "HI_APACCESS" åšå€åˆ†ã€‚
æ¥ä¸‹ä¾†åªè¦æŠŠã€Œç’°å¢ƒåˆ¤æ–·ã€é›†ä¸­åˆ°ä¸€å€‹å° helperï¼Œç„¶å¾ŒæŠŠåŸæœ¬ç¡¬å¯« "TEST" çš„åœ°æ–¹æ”¹æ‰å³å¯ã€‚

ä¸‹é¢çµ¦ä½ æœ€å°æ”¹å‹•é›†ï¼šæ–°å¢ 1 å€‹ Helper æª”ã€ä¿®æ”¹ 3 å€‹å‘¼å« DLL çš„åœ°æ–¹ï¼ˆå…¶é¤˜ç¨‹å¼ä¸å‹•ï¼‰ã€‚

â¸»

1) æ–°å¢ EnvHelper.cs

æ”¾åœ¨ Web å°ˆæ¡ˆï¼ˆHI_APACCESSï¼‰çš„ Service è³‡æ–™å¤¾å³å¯ã€‚

using System;
using System.Configuration;

namespace HI_APACCESS.Service
{
    internal static class EnvHelper
    {
        /// <summary>
        /// ä¾ Web.config çš„ appSettings["Environment"] æ¨å° DLL éœ€è¦çš„ Environment å€¼
        /// DEV / TEST / PROD
        /// </summary>
        internal static string ResolveEnvForDll()
        {
            var raw = (ConfigurationManager.AppSettings["Environment"] ?? "")
                .Trim()
                .ToUpperInvariant();

            if (raw.Contains("DEV"))  return "DEV";
            if (raw.Contains("TEST")) return "TEST";
            if (raw.Contains("PROD")) return "PROD";

            // è‹¥å€¼ä¸åœ¨é æœŸï¼ˆæˆ–å¿˜äº†è¨­ï¼‰ï¼Œé è¨­èµ° TESTï¼Œé¿å…èª¤é€£æ­£å¼
            return "TEST";
        }
    }
}

ä¹‹å¾Œä½ åªè¦æ”¹ Web.config çš„ Environment å€¼ï¼Œé€™è£¡å°±æœƒè‡ªå‹•å›å‚³ DEV/TEST/PROD çµ¦ DLLã€‚

â¸»

2) ä¿®æ”¹ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ï¼ˆä¸‰å€‹åœ°æ–¹æŠŠç¡¬å¯« â€œTESTâ€ æ›æ‰ï¼‰

using HI_APACCESS.ViewModels;
using Newtonsoft.Json;
using System.Linq;
using System.Collections.Generic;
using HI_APACCESS_DLL;

namespace HI_APACCESS.Service
{
    public class SVS_å“¡å·¥åŸºæœ¬è³‡æ–™
    {
        #region ADã€å“¡ç·¨ã€ åŸºæœ¬è³‡æ–™

        internal static string Get_å“¡å·¥AD()
        {
            string EMP_DOM_ID = System.Web.HttpContext.Current.User.Identity.Name
                .Substring(System.Web.HttpContext.Current.User.Identity.Name.LastIndexOf("\\") + 1);

            if (string.IsNullOrEmpty(EMP_DOM_ID))
            {
                var principal = new System.Security.Principal.WindowsPrincipal(
                    System.Security.Principal.WindowsIdentity.GetCurrent());
                string name = principal.Identity.Name;
                string[] adname = name.Split(new string[] { "\\" }, StringSplitOptions.RemoveEmptyEntries);
                EMP_DOM_ID = adname[1].ToString().ToUpper();
            }
            return EMP_DOM_ID;
        }

        /// <summary>
        /// å–å¾—å“¡å·¥ç·¨è™Ÿï¼ˆå‘¼å« DLL åŠŸèƒ½1ï¼‰
        /// </summary>
        internal static string Get_å“¡å·¥ç·¨è™Ÿ(string ad = null)
        {
            var req = new Models.M_AP_DLL.GetUserDataRequestModel
            {
                SysID = "HI_APACCESS",
                UserAD = string.IsNullOrEmpty(ad) ? Get_å“¡å·¥AD() : ad,
                Environment = EnvHelper.ResolveEnvForDll(),   // â† é€™è£¡æ”¹ï¼šä¸å†ç¡¬å¯« "TEST"
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetUserData(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetUserDataResponseModel>(response);

            return res?.Result?.UserID ?? req.UserAD; // æ‰¾ä¸åˆ°å°±å› AD
        }

        /// <summary>
        /// å–å¾—å“¡å·¥åŸºæœ¬è³‡æ–™ï¼ˆå‘¼å« DLL åŠŸèƒ½1ï¼‰
        /// </summary>
        internal static VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨± Get_å“¡å·¥åŸºæœ¬è³‡æ–™(string ad)
        {
            var req = new Models.M_AP_DLL.GetUserDataRequestModel
            {
                SysID = "HI_APACCESS",
                UserAD = ad,
                Environment = EnvHelper.ResolveEnvForDll(),   // â† é€™è£¡æ”¹
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetUserData(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetUserDataResponseModel>(response);

            if (res?.Result == null) return null;

            return new VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨±
            {
                AD        = req.UserAD,
                EMP_NO    = res.Result.UserID,
                EMP_NAME  = res.Result.UserName,
                POST_NAME = res.Result.PostName,
                ORGAN_CAP = res.Result.OrganName,
                APG_NO    = res.Result.GroupID
            };
        }

        #endregion

        #region æ¬Šé™æ¨¹ï¼ˆå‘¼å« DLL åŠŸèƒ½3ï¼‰

        internal static List<VM_Employee.WebTree_Node> Get_Tree(string groupId)
        {
            var req = new Models.M_AP_DLL.GetTreeRequestModel
            {
                SysID = "HI_APACCESS",
                GroupID = groupId,
                Environment = EnvHelper.ResolveEnvForDll(),   // â† é€™è£¡æ”¹
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetTree(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetTreeResponseModel>(response);

            if (res?.Result == null) return new List<VM_Employee.WebTree_Node>();

            // æ‰å¹³ â†’ æ¨¹
            var allNodes = res.Result.Select(x => new VM_Employee.WebTree_Node
            {
                FUNC_ID  = x.FuncID,
                FUNC_NA  = x.FuncName,
                PARENT_ID= x.ParentID,
                VIEW_H   = x.Controller,
                VIEW_HB  = x.Action,
                SORT_NO  = x.Sort.ToString(),
                WebTree  = new List<VM_Employee.WebTree_Node>()
            }).ToList();

            var dict = allNodes.ToDictionary(x => x.FUNC_ID, x => x);
            var roots = new List<VM_Employee.WebTree_Node>();

            foreach (var node in allNodes)
            {
                if (string.IsNullOrEmpty(node.PARENT_ID) || node.PARENT_ID == "HOME")
                    roots.Add(node);
                else if (dict.ContainsKey(node.PARENT_ID))
                    dict[node.PARENT_ID].WebTree.Add(node);
            }

            SortTree(roots);
            return roots;
        }

        private static void SortTree(List<VM_Employee.WebTree_Node> nodes)
        {
            nodes.Sort((a, b) => int.Parse(a.SORT_NO).CompareTo(int.Parse(b.SORT_NO)));
            foreach (var n in nodes)
                if (n.WebTree != null && n.WebTree.Count > 0)
                    SortTree(n.WebTree);
        }

        #endregion
    }
}


â¸»

3) Web.configï¼ˆä½ å·²ç¶“æœ‰ï¼Œé€™è£¡åªç¤ºæ„ï¼‰

<appSettings>
  <!-- æ¸¬è©¦å€ -->
  <add key="Environment" value="HI_APACCESS_TEST"/>
  <!-- æ­£å¼å€å°±æ”¹æˆ -->
  <!-- <add key="Environment" value="HI_APACCESS"/> -->
</appSettings>

ä¸ç”¨åœ¨ç¨‹å¼ç¢¼è£¡å¯« "TEST" æˆ– "PROD"ï¼Œå…¨éƒ¨äº¤çµ¦ EnvHelper.ResolveEnvForDll() è‡ªå‹•åˆ¤æ–·ã€‚

â¸»

4)ï¼ˆå¯é¸ï¼‰è‹¥é é¢ä¸Šæœ‰ç”¨åˆ° Hi_Btn æˆ–å…¶ä»– DLL å‘¼å«

è«‹æŠŠåŸæœ¬ç¡¬å¯« "TEST" çš„åœ°æ–¹ä¹Ÿæ”¹æˆï¼š

Environment = EnvHelper.ResolveEnvForDll()

é€™æ¨£æ•´å€‹ç¶²ç«™çš„ç’°å¢ƒåˆ‡æ›å°±åªé  Web.config ä¸€è¡Œäº†ã€‚ä¹¾æ·¨ã€å¥½ç¶­è­·ã€ä¸Šç·šä¸æœƒè¸©é›·ã€‚ğŸ‘

â¸»

å¦‚æœä½ è¦æ”¯æ´ DEVï¼ˆæœ¬æ©Ÿ / é–‹ç™¼ DBï¼‰ï¼Œä¹Ÿåªè¦æŠŠ Web.config çš„ value æ›æˆ HI_APACCESS_DEVï¼ŒDLL æœƒåƒåˆ° "DEV"ï¼Œå»é€£ä½ åœ¨ DLL çš„ FCommon.BuildConnectionString("DEV") è¨­å®šçš„é€£ç·šå­—ä¸²ã€‚