ğŸ‘Œ æˆ‘çœ‹æ‡‚ä½ çš„ç‹€æ³äº†ï¼Œå…©å€‹å•é¡Œè¦åˆ†é–‹è™•ç†ï¼š

â¸»

1ï¸âƒ£ Get_Tree æ²’æœ‰çˆ¶å­ç›®éŒ„ï¼Œé»é€£çµæœƒ 403.14 Forbidden

é€™æ˜¯å› ç‚ºä½ ç¾åœ¨çš„ DLL æ”¹ç‰ˆæµç¨‹ æ²’æœ‰æ¨¡æ“¬åŸæœ¬ SQL çš„ NODE/éšå±¤é‚è¼¯ã€‚
åŸæœ¬ SQL ç”¨äº† CONVERT(HIERARCHYID, NODE) æ’åºï¼Œç¢ºä¿çˆ¶ç›®éŒ„åœ¨å‰ã€å­ç›®éŒ„è·Ÿéš¨ã€‚

ä½†æ˜¯ä½ ç¾åœ¨åœ¨ç¨‹å¼è£¡åªé ï¼š

.Where(x => x.NODE.Split('/').Length == 3) // æ¯ç›®éŒ„
.Where(x => x.NODE.Split('/').Length == 4) // å­ç›®éŒ„

é€™æ¨£æœƒæ¼æ‰å¤šå±¤å·¢ç‹€ (ä¾‹å¦‚ä¸‰å±¤ä»¥ä¸Š)ï¼Œä¹Ÿæ²’æœ‰çœŸæ­£å»ºç«‹æ¨¹ç‹€çµæ§‹ã€‚
å› æ­¤é»é€²å»æ™‚ URL æœƒç¼ºè·¯å¾‘æˆ–æ‰¾ä¸åˆ°ï¼Œæœ€å¾Œå°±å ± 403.14ã€‚

â¸»

âœ… è§£æ³•ï¼šç”¨ ParentID å»ºç«‹æ¨¹ç‹€ + SortNo æ’åº

æˆ‘å¹«ä½ æ•´ç†éç¨‹å¼ï¼Œç›´æ¥ç”¨ Dictionary å»ºæ¨¹ç‹€ï¼š

internal static List<VM_Employee.WebTree_Node> Get_Tree(string sysId, string groupId, string environment = "TEST")
{
    var req = new M_AP.GetTreeRequestModel
    {
        SysID = sysId,
        GroupID = groupId,
        Environment = environment
    };

    string json_input = JsonConvert.SerializeObject(req);
    string response = new APACCESS().GetTree(json_input);
    var res = JsonConvert.DeserializeObject<M_AP.GetTreeResponseModel>(response);

    if (res?.Result == null) return new List<VM_Employee.WebTree_Node>();

    // è½‰æ›
    var allNodes = res.Result.Select(x => new VM_Employee.WebTree_Node
    {
        FUNC_ID = x.FuncID,
        FUNC_NA = x.FuncName,
        PARENT_ID = x.ParentID,
        VIEW_H = x.Controller,
        VIEW_HB = x.Action,
        SORT_NO = x.Sort.ToString(),
        WebTree = new List<VM_Employee.WebTree_Node>()
    }).ToList();

    // å»ºç«‹å­—å…¸
    var dict = allNodes.ToDictionary(x => x.FUNC_ID, x => x);

    // æ¨¹ç‹€åŒ–
    List<VM_Employee.WebTree_Node> roots = new List<VM_Employee.WebTree_Node>();
    foreach (var node in allNodes)
    {
        if (string.IsNullOrEmpty(node.PARENT_ID) || node.PARENT_ID == "HOME")
        {
            roots.Add(node);
        }
        else if (dict.ContainsKey(node.PARENT_ID))
        {
            dict[node.PARENT_ID].WebTree.Add(node);
        }
    }

    // æ’åº (éè¿´)
    SortTree(roots);

    return roots;
}

private static void SortTree(List<VM_Employee.WebTree_Node> nodes)
{
    nodes.Sort((a, b) => int.Parse(a.SORT_NO).CompareTo(int.Parse(b.SORT_NO)));
    foreach (var node in nodes)
    {
        if (node.WebTree != null && node.WebTree.Count > 0)
        {
            SortTree(node.WebTree);
        }
    }
}

ğŸ‘‰ é€™æ¨£å°±å¯ä»¥é‚„åŸ SQL çš„æ•ˆæœï¼š
	â€¢	æ¯ç›®éŒ„åœ¨å‰
	â€¢	å­ç›®éŒ„è·Ÿåœ¨æ¯ç›®éŒ„ä¸‹é¢
	â€¢	å„å±¤éƒ½æœ‰æ’åº

â¸»

2ï¸âƒ£ HI_BTN æœ‰æ¬Šé™å»ä¸é¡¯ç¤ºæŒ‰éˆ•

æˆ‘çœ‹ä½ çš„ Hi_Btnï¼š

string ret = IfBtnAuth_Positive(FUNC_ID, APG_NO, ButtonID, Type) ? tb.ToString() : null;
return MvcHtmlString.Create(ret);

å•é¡Œåœ¨æ–¼ï¼š
	â€¢	ç•¶ ret = null æ™‚ï¼ŒMvcHtmlString.Create(null) æœƒè¼¸å‡ºå­—ä¸² "null"ï¼Œä¸æ˜¯ç©º â†’ HTML ä¸æœƒé¡¯ç¤ºã€‚
	â€¢	è€Œä¸”ä½ çš„ Type åƒæ•¸åœ¨åˆ¤æ–·è£¡æ ¹æœ¬æ²’ç”¨åˆ°ï¼Œæ°¸é èµ° æ­£å‘æ³•ã€‚

â¸»

âœ… è§£æ³•ï¼šè£œå¼·åˆ¤æ–·

public static MvcHtmlString Hi_Btn(this HtmlHelper helper,
    string FUNC_ID, string APG_NO, string Type,
    string ButtonID, string ButtonText, string ButtonType, object HtmlAttributes)
{
    TagBuilder tb = ButtonTagBuilder(ButtonText, ButtonID, ButtonType, HtmlAttributes);
    bool hasPermission = IfBtnAuth_Positive(FUNC_ID, APG_NO, ButtonID, Type);

    if (!hasPermission)
        return MvcHtmlString.Empty; // âœ… æ”¹é€™è£¡ï¼Œé¿å…è¼¸å‡º "null"

    return MvcHtmlString.Create(tb.ToString());
}


â¸»

ğŸ” å»ºè­°æ¸¬è©¦æ–¹å‘
	1.	Get_Tree
	â€¢	æŠŠ AP_FUNC çš„çˆ¶å­å±¤ç´š (FUNC_ID / PARENT_ID) å°å‡ºä¾†ï¼Œç¢ºèªæ˜¯å¦æ­£ç¢ºæ›ä¸Šå»ã€‚
	â€¢	ç¢ºèª roots æœ‰ HOME â†’ child â†’ subchildã€‚
	2.	Hi_Btn
	â€¢	å…ˆç›´æ¥ Console.WriteLine($"FUNC={FUNC_ID}, APG={APG_NO}, Button={ButtonID}, result={hasPermission}")
	â€¢	ç¢ºèª SQL æŸ¥è©¢æ˜¯å¦çœŸçš„æœ‰å› COUNT > 0ã€‚
	â€¢	è‹¥å›å‚³æœ‰è³‡æ–™ï¼ŒæŒ‰éˆ•æ‡‰è©²æœƒæ­£å¸¸é¡¯ç¤ºã€‚

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ å¯«ä¸€å€‹ Web æ¸¬è©¦é ï¼ŒåŒæ™‚æŠŠ æ¬Šé™æ¨¹ + æŒ‰éˆ• æ¸²æŸ“å‡ºä¾†ï¼Œé€™æ¨£ä½ ä¸€é€²å»å°±èƒ½çœ‹çµæœï¼Ÿ