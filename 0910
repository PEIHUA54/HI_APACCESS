å¥½ğŸ‘Œ æˆ‘å¹«ä½ æŠŠ åŠŸèƒ½ 1ã€2ã€3 çš„å®Œæ•´ Models / Factory / SQL å…¨éƒ¨éƒ½æ•´ç†å¥½ï¼Œç…§æŠ„å°±èƒ½è·‘ã€‚

â¸»

ğŸ”¹ åŠŸèƒ½ 1ï¼šGetAllUser (å–å¾—å…¨éƒ¨äººå“¡æ¸…å–®)

Request Model

namespace HI_APACCESS_DLL.Models
{
    public class GetAllUserModel
    {
        public class GetAllUserRequest
        {
            public string SysID { get; set; }
            public string Environment { get; set; }
        }

        public class ResultData
        {
            public string UserID { get; set; }
            public string UserName { get; set; }
        }

        public class GetAllUserResponse
        {
            public string Result_code { get; set; }
            public string Msg { get; set; }
            public List<ResultData> Result { get; set; }
        }
    }
}

Factory

using HI_APACCESS_DLL.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;

namespace HI_APACCESS_DLL.Factory
{
    internal class FGetAllUser
    {
        internal GetAllUserModel.GetAllUserResponse Execute(string sysId, string environment)
        {
            var response = new GetAllUserModel.GetAllUserResponse();

            try
            {
                if (environment != "TEST" && environment != "PROD")
                {
                    response.Result_code = Common.Codes.ENV_ERROR;
                    response.Msg = "ç’°å¢ƒéŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD";
                    return response;
                }

                var resultList = new List<GetAllUserModel.ResultData>();

                using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))
                {
                    conn.Open();

                    string sql = @"
SELECT EMP_ID AS UserID,
       EMP_NAME AS UserName
FROM [HI_TMMAIN].[dbo].[AP_USER]
WHERE SYS_ID=@SysID
ORDER BY EMP_ID";

                    using (var cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);

                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                resultList.Add(new GetAllUserModel.ResultData
                                {
                                    UserID = reader["UserID"].ToString(),
                                    UserName = reader["UserName"].ToString()
                                });
                            }
                        }
                    }
                }

                if (resultList.Count == 0)
                {
                    response.Result_code = Common.Codes.NO_PERMISSION;
                    response.Msg = "æŸ¥ç„¡äººå“¡";
                }
                else
                {
                    response.Result_code = Common.Codes.SUCCESS;
                    response.Msg = "æˆåŠŸ";
                    response.Result = resultList;
                }
            }
            catch (Exception ex)
            {
                response.Result_code = Common.Codes.SYSTEM_ERROR;
                response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
            }

            return response;
        }
    }
}


â¸»

ğŸ”¹ åŠŸèƒ½ 2ï¼šä¿®æ”¹ GetGroupAllUser (å›å‚³ UserName)

Request Model

namespace HI_APACCESS_DLL.Models
{
    public class GetGroupAllUserModel
    {
        public class GetGroupAllUserRequest
        {
            public string SysID { get; set; }
            public string GroupID { get; set; }
            public bool IsIncludeChildGroups { get; set; }
            public string Environment { get; set; }
        }

        public class ResultData
        {
            public string UserID { get; set; }
            public string UserName { get; set; }
        }

        public class GetGroupAllUserResponse
        {
            public string Result_code { get; set; }
            public string Msg { get; set; }
            public List<ResultData> Result { get; set; }
        }
    }
}

Factory

using HI_APACCESS_DLL.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;

namespace HI_APACCESS_DLL.Factory
{
    internal class FGetGroupAllUser
    {
        internal GetGroupAllUserModel.GetGroupAllUserResponse Execute(string sysId, string groupId, bool isIncludeChildGroups, string environment)
        {
            var response = new GetGroupAllUserModel.GetGroupAllUserResponse();

            try
            {
                if (environment != "TEST" && environment != "PROD")
                {
                    response.Result_code = Common.Codes.ENV_ERROR;
                    response.Msg = "ç’°å¢ƒéŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD";
                    return response;
                }

                var resultList = new List<GetGroupAllUserModel.ResultData>();

                using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))
                {
                    conn.Open();

                    string sql = @"
SELECT u.EMP_ID AS UserID,
       u.EMP_NAME AS UserName
FROM [HI_TMMAIN].[dbo].[AP_USER_GROUP] g
INNER JOIN [HI_TMMAIN].[dbo].[AP_USER] u 
    ON g.EMP_ID = u.EMP_ID AND g.SYS_ID = u.SYS_ID
WHERE g.SYS_ID = @SysID
  AND g.APG_NO = @GroupID";

                    if (isIncludeChildGroups)
                    {
                        sql += @" OR g.APG_NO IN (
                                    SELECT ChildGroupID 
                                    FROM [HI_TMMAIN].[dbo].[AP_GROUP_RELATION] 
                                    WHERE ParentGroupID = @GroupID
                                 )";
                    }

                    using (var cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@GroupID", groupId);

                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                resultList.Add(new GetGroupAllUserModel.ResultData
                                {
                                    UserID = reader["UserID"].ToString(),
                                    UserName = reader["UserName"].ToString()
                                });
                            }
                        }
                    }
                }

                if (resultList.Count == 0)
                {
                    response.Result_code = Common.Codes.NO_PERMISSION;
                    response.Msg = "æŸ¥ç„¡æ¬Šé™";
                }
                else
                {
                    response.Result_code = Common.Codes.SUCCESS;
                    response.Msg = "æˆåŠŸ";
                    response.Result = resultList;
                }
            }
            catch (Exception ex)
            {
                response.Result_code = Common.Codes.SYSTEM_ERROR;
                response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
            }

            return response;
        }
    }
}


â¸»

ğŸ”¹ åŠŸèƒ½ 3ï¼šä¿®æ”¹ GetTree (å¢åŠ  Memo)

Request Model

namespace HI_APACCESS_DLL.Models
{
    public class GetTreeModel
    {
        public class GetTreeRequest
        {
            public string SysID { get; set; }
            public string GroupID { get; set; }
            public string Environment { get; set; }
        }

        public class ResultData
        {
            public string FuncID { get; set; }
            public string FuncName { get; set; }
            public string ParentID { get; set; }
            public string Controller { get; set; }
            public string Action { get; set; }
            public int Sort { get; set; }
            public string Level { get; set; }
            public string Memo { get; set; } // æ–°å¢
        }

        public class GetTreeResponse
        {
            public string Result_code { get; set; }
            public string Msg { get; set; }
            public List<ResultData> Result { get; set; }
        }
    }
}

Factory

using HI_APACCESS_DLL.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;

namespace HI_APACCESS_DLL.Factory
{
    internal class FGetTree
    {
        internal GetTreeModel.GetTreeResponse Execute(string sysId, string groupId, string environment)
        {
            var response = new GetTreeModel.GetTreeResponse();

            try
            {
                if (environment != "TEST" && environment != "PROD")
                {
                    response.Result_code = Common.Codes.ENV_ERROR;
                    response.Msg = "ç’°å¢ƒéŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD";
                    return response;
                }

                var resultList = new List<GetTreeModel.ResultData>();

                using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString(environment)))
                {
                    conn.Open();

                    string sql = @"
SELECT DISTINCT
    CASE WHEN a.PARENT_ID = 'HOME' THEN '0'
         WHEN a.PARENT_ID <> 'HOME' THEN '1'
    END AS LEVEL,
    a.FUNC_ID,
    a.FUNC_NA,
    a.VIEW_H AS CONTROLLER,
    a.VIEW_HB AS ACTION,
    a.SORT_NO,
    a.PARENT_ID,
    a.MEMO
FROM [HI_TMMAIN].[dbo].[AP_FUNC] a
LEFT JOIN [HI_TMMAIN].[dbo].[AP_USER_FUNC_CONFIG] b 
    ON a.FUNC_ID = b.FUNC_ID
WHERE a.SYS_ID=@SysID 
  AND b.APG_NO=@GroupID
  AND a.IS_SHOW = 'Y'
ORDER BY a.SORT_NO";

                    using (var cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@GroupID", groupId);

                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                resultList.Add(new GetTreeModel.ResultData
                                {
                                    FuncID = reader["FUNC_ID"].ToString(),
                                    FuncName = reader["FUNC_NA"].ToString(),
                                    Controller = reader["CONTROLLER"].ToString(),
                                    Action = reader["ACTION"].ToString(),
                                    Sort = Convert.ToInt32(reader["SORT_NO"]),
                                    ParentID = reader["PARENT_ID"].ToString(),
                                    Level = reader["LEVEL"].ToString(),
                                    Memo = reader["MEMO"].ToString()
                                });
                            }
                        }
                    }
                }

                if (resultList.Count == 0)
                {
                    response.Result_code = Common.Codes.NO_PERMISSION;
                    response.Msg = "æŸ¥ç„¡æ¬Šé™";
                }
                else
                {
                    response.Result_code = Common.Codes.SUCCESS;
                    response.Msg = "æˆåŠŸ";
                    response.Result = resultList;
                }
            }
            catch (Exception ex)
            {
                response.Result_code = Common.Codes.SYSTEM_ERROR;
                response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
            }

            return response;
        }
    }
}


â¸»

è¦ä¸è¦æˆ‘å†å¹«ä½ æŠŠé€™ä¸‰å€‹ APACCESS å¤–å±¤å‘¼å«æ–¹æ³• (APACCESS.cs) ä¹Ÿè£œä¸Šï¼Ÿ
åƒ GetAllUser(json)ã€GetGroupAllUser(json)ã€GetTree(json)ï¼Œé€™æ¨£ä½ åœ¨ SVS å‘¼å«å°±ä¸ç”¨å†è‡ªå·±çµ„ Factoryã€‚
å¥½ğŸ‘Œ é‚£æˆ‘å¹«ä½ æŠŠ APACCESS å¤–å±¤å‘¼å«æ–¹æ³•ï¼ˆAPACCESS.csï¼‰ä¹Ÿè£œä¸Šï¼Œè®“ä½ åœ¨ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ æˆ– SVS_å®¢è£½åŒ–å…ƒä»¶ ç›´æ¥å‘¼å« new APACCESS().XXX(json) å°±å¥½ï¼Œä¸ç”¨è‡ªå·±ç®¡ Factoryã€‚

â¸»

ğŸ”¹ APACCESS.csï¼ˆå¤–å±¤å‘¼å«ï¼‰

using HI_APACCESS_DLL.Factory;
using HI_APACCESS_DLL.Models;
using Newtonsoft.Json;
using System;

namespace HI_APACCESS_DLL
{
    public class APACCESS
    {
        /// <summary>
        /// åŠŸèƒ½1 - å–å¾—å…¨éƒ¨äººå“¡æ¸…å–®
        /// </summary>
        public string GetAllUser(string json)
        {
            try
            {
                var req = JsonConvert.DeserializeObject<GetAllUserModel.GetAllUserRequest>(json);
                var res = new FGetAllUser().Execute(req.SysID, req.Environment);
                return JsonConvert.SerializeObject(res);
            }
            catch (Exception ex)
            {
                return JsonConvert.SerializeObject(new GetAllUserModel.GetAllUserResponse
                {
                    Result_code = Common.Codes.SYSTEM_ERROR,
                    Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message
                });
            }
        }

        /// <summary>
        /// åŠŸèƒ½2 - å–å¾—ç¾¤çµ„äººå“¡æ¸…å–® (å¯å«å­ç¾¤çµ„)
        /// </summary>
        public string GetGroupAllUser(string json)
        {
            try
            {
                var req = JsonConvert.DeserializeObject<GetGroupAllUserModel.GetGroupAllUserRequest>(json);
                var res = new FGetGroupAllUser().Execute(req.SysID, req.GroupID, req.IsIncludeChildGroups, req.Environment);
                return JsonConvert.SerializeObject(res);
            }
            catch (Exception ex)
            {
                return JsonConvert.SerializeObject(new GetGroupAllUserModel.GetGroupAllUserResponse
                {
                    Result_code = Common.Codes.SYSTEM_ERROR,
                    Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message
                });
            }
        }

        /// <summary>
        /// åŠŸèƒ½3 - å–å¾—æ¨¹ç‹€åŠŸèƒ½æ¸…å–®
        /// </summary>
        public string GetTree(string json)
        {
            try
            {
                var req = JsonConvert.DeserializeObject<GetTreeModel.GetTreeRequest>(json);
                var res = new FGetTree().Execute(req.SysID, req.GroupID, req.Environment);
                return JsonConvert.SerializeObject(res);
            }
            catch (Exception ex)
            {
                return JsonConvert.SerializeObject(new GetTreeModel.GetTreeResponse
                {
                    Result_code = Common.Codes.SYSTEM_ERROR,
                    Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message
                });
            }
        }
    }
}


â¸»

ğŸ”¹ ä½¿ç”¨ç¯„ä¾‹

å‘¼å«åŠŸèƒ½ 1ï¼šGetAllUser

var req = new GetAllUserModel.GetAllUserRequest
{
    SysID = "HI_POSIMG",
    Environment = "TEST"
};
string json_input = JsonConvert.SerializeObject(req);
string response = new APACCESS().GetAllUser(json_input);
var res = JsonConvert.DeserializeObject<GetAllUserModel.GetAllUserResponse>(response);


â¸»

å‘¼å«åŠŸèƒ½ 2ï¼šGetGroupAllUser

var req = new GetGroupAllUserModel.GetGroupAllUserRequest
{
    SysID = "HI_POSIMG",
    GroupID = "001",
    IsIncludeChildGroups = true,
    Environment = "TEST"
};
string json_input = JsonConvert.SerializeObject(req);
string response = new APACCESS().GetGroupAllUser(json_input);
var res = JsonConvert.DeserializeObject<GetGroupAllUserModel.GetGroupAllUserResponse>(response);


â¸»

å‘¼å«åŠŸèƒ½ 3ï¼šGetTree

var req = new GetTreeModel.GetTreeRequest
{
    SysID = "HI_POSIMG",
    GroupID = "001",
    Environment = "TEST"
};
string json_input = JsonConvert.SerializeObject(req);
string response = new APACCESS().GetTree(json_input);
var res = JsonConvert.DeserializeObject<GetTreeModel.GetTreeResponse>(response);


â¸»

ğŸ‘‰ é€™æ¨£ä½ å¤–å±¤å‘¼å«çš„æ–¹å¼è·Ÿä¹‹å‰åŠŸèƒ½ 5 / åŠŸèƒ½ 6 æ˜¯ä¸€è‡´çš„ï¼Œ
SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ å°±å¯ä»¥ä¹¾ä¹¾æ·¨æ·¨å‘¼å«ï¼Œä¸ç”¨å†å‹• Factoryã€‚

è¦ä¸è¦æˆ‘é †ä¾¿å¹«ä½ æŠŠ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ è£¡é¢ å‘¼å«åŠŸèƒ½ 1ã€2ã€3 çš„æ–°ç‰ˆå¯«æ³•ä¹Ÿæ•´ç†çµ¦ä½ ï¼Ÿ