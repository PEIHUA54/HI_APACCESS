1.Cross-Site Scripting: DOM
     $(function () {
         function showMsg(type, text) {
             var alertDiv = document.createElement('div');
             alertDiv.className = 'alert alert-' + type + ' mb-0';
             alertDiv.setAttribute('role', 'alert');
             alertDiv.textContent = text;

             var container = document.getElementById('batchMsg');
             container.innerHTML = '';  // 清空
             container.appendChild(alertDiv);
         }

         function confirmBatch() {
             const batchNo = $.trim($("#batchNo").val());

             if (!batchNo) {
                 showMsg('danger', '批號不能為空');
                 return;
             }

             $.post('@Url.Action("CONFIRM_BATCH_NO", "COLLSTAMP")', { batchNo: batchNo }, function (res) {
                 if (res.success) {
                     showMsg('success', '✅ ' + res.message);
                     setTimeout(function () {
                         $('#batchConfirmModal').modal('hide');
                     }, 3000);
                 } else {
                     showMsg('danger', res.message);
                 }
             }).fail(function () {
                 showMsg('danger', '系統錯誤，請稍後再試');
             });
         }

         // 按鈕點擊事件
         $("#btnBatchConfirm").click(function () {
             confirmBatch();
         });

         // Enter 鍵送出
         $("#batchConfirmForm").on("submit", function (e) {
             e.preventDefault();
             confirmBatch();
         });

         // Modal 開啟時清空輸入
         $('#batchConfirmModal').on('shown.bs.modal', function () {
             $("#batchNo").val("");
             $("#batchMsg").text("");
             $("#batchNo").focus();
         });

         // Modal 關閉時重整頁面
         $('#batchConfirmModal').on('hidden.bs.modal', function () {
             location.reload();
         });
     });

2.Cross-Site Scripting: Reflected 、 Formula Injection
Sink點: return File 那句
    //匯出EXCEL
    [HttpPost]
    [ValidateAntiForgeryToken]
    public ActionResult ExportToExcel(string pingcode_caseno = null, string pingcode = null, string shopid = null)
    {
        try
        {
            // 1) 基本檢核：至少有一個條件
            if (string.IsNullOrWhiteSpace(pingcode_caseno) &&
                string.IsNullOrWhiteSpace(pingcode) &&
                string.IsNullOrWhiteSpace(shopid))
            {
                TempData["ErrorMessage"] = "請至少輸入一個查詢條件才能匯出Excel";
                return RedirectToAction("DCORDER_ORDER");
            }

            // 2) 查詢參數白名單化（僅用於查詢，避免帶控制字元）
            var q1 = SanitizeQuery(pingcode_caseno);
            var q2 = SanitizeQuery(pingcode);
            var q3 = SanitizeQuery(shopid);

            // 3) 查資料
            var resultList = f_DCORDER_ORDER.SearchDCOrderData(q1, q2, q3);
            if (resultList == null || !resultList.Any())
            {
                TempData["ErrorMessage"] = "查無資料可匯出，請檢查輸入的資料";
                return RedirectToAction("DCORDER_ORDER");
            }

            // 4) Excel 公式防護（逐欄位處理）
            var safeResultList = SanitizeExcelData(resultList);

            // 5) 產出 Excel
            byte[] excelContent = GenerateExcelContent(safeResultList, q1, q2, q3);

            // 6) 建立安全的檔名：固定前綴 + 時間戳 ⭐⭐⭐
            // Fortify: 檔名由伺服器端生成，不含使用者輸入
            string fileName = BuildSafeFileName("來蓋章贈品貨態追蹤報表", DateTime.Now);

            // 7) 使用 FileContentResult
            return File(excelContent, "application/vnd.ms-excel", fileName);

            //
            //// 6) 固定檔名（不含使用者輸入）
            //string fileName = $"來蓋章贈品貨態追蹤報表_{DateTime.Now:yyyyMMddHHmmss}.xls";
            //string safeFileName = GetSafeFileName(fileName);

            //// 7) 設定 Header 防止 XSS
            //Response.Clear();
            //Response.Buffer = true; // 確保完整輸出
            //Response.Charset = "";  // 避免 ASP.NET 自動加 charset
            //Response.ContentEncoding = Encoding.UTF8; 
            //Response.ContentType = "application/vnd.ms-excel";
            //Response.AddHeader("Content-Disposition",
            //    $"attachment; filename=\"{safeFileName}\"; filename*=UTF-8''{Uri.EscapeDataString(safeFileName)}");
            //Response.BinaryWrite(excelContent); // Fortify
            //Response.Flush();  // 強制將資料送出
            //Response.End();
            //return new EmptyResult();


            //
            // 6) 伺服器產安全檔名（不含任何使用者輸入）
            //string fileName = $"來蓋章贈品貨態追蹤報表_{DateTime.Now:yyyyMMdd_HHmmss}.xls";
            //string safeFileNmae = HttpUtility.UrlPathEncode(fileName);
            //string encOrDecFileName = SVS_Common.Enc_DecString(safeFileNmae);
            // 7) 回傳檔案
            //return File(excelContent, "application/vnd.ms-excel", encOrDecFileName);
        }
        catch (Exception ex)
        {
            TempData["ErrorMessage"] = "匯出Excel時發生錯誤，請聯繫系統管理員";
            System.Diagnostics.Debug.WriteLine($"Excel匯出錯誤: {ex.Message}");
            return RedirectToAction("DCORDER_ORDER");
        }
    }

 /// <summary>
 /// 對 M_DCORDER_ORDER.D_BODY 結果清單進行 Formula Injection 防護
 /// </summary>
 /// <param name="resultList">查詢結果清單</param>
 /// <returns>清理後的安全資料</returns>
 private List<M_DCORDER_ORDER.D_BODY> SanitizeExcelData(IEnumerable<M_DCORDER_ORDER.D_BODY> resultList)
 {
     var safeList = new List<M_DCORDER_ORDER.D_BODY>();

     foreach (var item in resultList)
     {
         // 清理所有會出現在 Excel 中的字串欄位
         var safeItem = new M_DCORDER_ORDER.D_BODY
         {
             // 字串欄位需要進行 Formula Injection 防護
             DC_ORDER_NO = SanitizeExcelCellValue(item.DC_ORDER_NO),
             caseno = SanitizeExcelCellValue(item.caseno),
             pingcode_caseno = SanitizeExcelCellValue(item.pingcode_caseno),
             PRD_ID = SanitizeExcelCellValue(item.PRD_ID),
             PRD_NAME = SanitizeExcelCellValue(item.PRD_NAME),
             pingcode = SanitizeExcelCellValue(item.pingcode),
             shopid = SanitizeExcelCellValue(item.shopid),
             DC_ARRIVE_DATE = SanitizeExcelCellValue(item.DC_ARRIVE_DATE),

             // 這兩個欄位在註解中標示「略過」，但如果會顯示在 Excel 中還是要清理
             狀態 = SanitizeExcelCellValue(item.狀態),
             異狀提醒 = SanitizeExcelCellValue(item.異狀提醒)
         };

         safeList.Add(safeItem);
     }

     return safeList;
 }

 /// <summary>
 /// 清理 Excel 單元格內容，防止 Formula Injection
 /// </summary>
 /// <param name="cellValue">單元格值</param>
 /// <returns>安全的單元格值</returns>
 private string SanitizeExcelCellValue(string cellValue)
 {
     if (string.IsNullOrWhiteSpace(cellValue))
         return string.Empty;

     string sanitized = cellValue.Trim();

     // **檢查是否以危險字符開頭**
     if (sanitized.Length > 0)
     {
         char firstChar = sanitized[0];

         // Excel 公式觸發字符：= + - @ \t \r
         if (firstChar == '=' || firstChar == '+' || firstChar == '-' ||
             firstChar == '@' || firstChar == '\t' || firstChar == '\r' ||
             char.IsControl(firstChar))
         {
             // **方法：在前面加單引號，強制為文字**
             sanitized = "'" + sanitized;
         }
     }

     // **移除危險的命令執行相關字串（不區分大小寫）**
     sanitized = Regex.Replace(sanitized, @"\bcmd\b", "", RegexOptions.IgnoreCase);
     sanitized = Regex.Replace(sanitized, @"\bpowershell\b", "", RegexOptions.IgnoreCase);
     sanitized = Regex.Replace(sanitized, @"\bscript\b", "", RegexOptions.IgnoreCase);

     // **移除管道字符和其他危險符號**
     sanitized = sanitized.Replace("|", "")
                          .Replace("&", "")
                          .Replace(";", "");

     return sanitized;
 }

 /// <summary>
 /// 生成安全的檔案名稱（不包含使用者輸入）
 /// </summary>
 /// <returns>安全的檔案名稱</returns>
 private string GenerateSecureFileName()
 {
     // 使用固定前綴 + 時間戳，避免包含使用者輸入資料
     return $"來蓋章贈品貨態追蹤報表_{DateTime.Now:yyyyMMdd_HHmmss}.xls";
 }

 /// <summary>
 /// 進一步清理檔案名稱，確保完全安全
 /// </summary>
 /// <param name="fileName">檔案名稱</param>
 /// <returns>安全的檔案名稱</returns>
 private string SanitizeFileName(string fileName)
 {
     if (string.IsNullOrWhiteSpace(fileName))
         return "export.xls";

     // 移除檔案名稱中可能有問題的字符
     string[] invalidChars = { "<", ">", ":", "\"", "|", "?", "*", "/", "\\", ";", "&", "(", ")", "{", "}", "[", "]", "'" };
     string safeFileName = fileName;

     foreach (string invalidChar in invalidChars)
     {
         safeFileName = safeFileName.Replace(invalidChar, "");
     }

     // 確保檔案名稱不會太長
     if (safeFileName.Length > 100)
     {
         string extension = System.IO.Path.GetExtension(safeFileName);
         string nameWithoutExt = System.IO.Path.GetFileNameWithoutExtension(safeFileName);
         safeFileName = nameWithoutExt.Substring(0, 100 - extension.Length) + extension;
     }

     return safeFileName;
 }

 /// <summary>
 /// 產生Excel內容
 /// </summary>
 private byte[] GenerateExcelContent(IEnumerable<M_DCORDER_ORDER.D_BODY> data, string pingcode_caseno, string pingcode, string shopid)
 {
     var html = new StringBuilder();

     // Excel檔案開頭（設定編碼和樣式）
     html.AppendLine("<?xml version=\"1.0\"?>");
     html.AppendLine("<?mso-application progid=\"Excel.Sheet\"?>");
     html.AppendLine("<Workbook xmlns=\"urn:schemas-microsoft-com:office:spreadsheet\"");
     html.AppendLine(" xmlns:o=\"urn:schemas-microsoft-com:office:office\"");
     html.AppendLine(" xmlns:x=\"urn:schemas-microsoft-com:office:excel\"");
     html.AppendLine(" xmlns:ss=\"urn:schemas-microsoft-com:office:spreadsheet\">");

     // 樣式
     html.AppendLine("<Styles>");
     html.AppendLine("<Style ss:ID=\"headerStyle\">");
     html.AppendLine("<Font ss:Bold=\"1\" ss:Size=\"12\"/>");
     html.AppendLine("<Interior ss:Color=\"#D3D3D3\" ss:Pattern=\"Solid\"/>");
     html.AppendLine("<Borders>");
     html.AppendLine("<Border ss:Position=\"Bottom\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("<Border ss:Position=\"Left\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("<Border ss:Position=\"Right\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("<Border ss:Position=\"Top\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("</Borders>");
     html.AppendLine("</Style>");

     html.AppendLine("<Style ss:ID=\"dataStyle\">");
     html.AppendLine("<Borders>");
     html.AppendLine("<Border ss:Position=\"Bottom\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("<Border ss:Position=\"Left\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("<Border ss:Position=\"Right\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("<Border ss:Position=\"Top\" ss:LineStyle=\"Continuous\" ss:Weight=\"1\"/>");
     html.AppendLine("</Borders>");
     html.AppendLine("</Style>");
     html.AppendLine("</Styles>");

     // 工作表
     html.AppendLine("<Worksheet ss:Name=\"來蓋章贈品貨態追蹤報表\">");
     html.AppendLine("<Table ss:ExpandedColumnCount=\"8\" ss:ExpandedRowCount=\"1000\" x:FullColumns=\"1\" x:FullRows=\"1\">");

     //欄位寬度
     html.AppendLine("<Column ss:Index=\"1\" ss:AutoFitWidth=\"1\" ss:Width=\"120\"/>"); // C單單號
     html.AppendLine("<Column ss:Index=\"2\" ss:AutoFitWidth=\"1\" ss:Width=\"150\"/>"); // 來蓋章活動案號
     html.AppendLine("<Column ss:Index=\"3\" ss:AutoFitWidth=\"1\" ss:Width=\"130\"/>"); // 行動條碼案號
     html.AppendLine("<Column ss:Index=\"4\" ss:AutoFitWidth=\"1\" ss:Width=\"100\"/>"); // 貨號
     html.AppendLine("<Column ss:Index=\"5\" ss:AutoFitWidth=\"1\" ss:Width=\"200\"/>"); // 商品名稱
     html.AppendLine("<Column ss:Index=\"6\" ss:AutoFitWidth=\"1\" ss:Width=\"120\"/>"); // PingCode
     html.AppendLine("<Column ss:Index=\"7\" ss:AutoFitWidth=\"1\" ss:Width=\"80\"/>");  // 店編
     html.AppendLine("<Column ss:Index=\"8\" ss:AutoFitWidth=\"1\" ss:Width=\"120\"/>"); // 到店日

     // 報表標題行
     html.AppendLine("<Row>");
     html.AppendLine("<Cell ss:MergeAcross=\"7\" ss:StyleID=\"headerStyle\">");
     html.AppendLine("<Data ss:Type=\"String\">來蓋章贈品貨態追蹤報表</Data>");
     html.AppendLine("</Cell>");
     html.AppendLine("</Row>");

     // 查詢條件行
     html.AppendLine("<Row>");
     html.AppendLine("<Cell ss:MergeAcross=\"7\">");
     var conditions = new List<string>();

     // **修正：對查詢條件進行 Formula Injection 防護和 XML 跳脫**
     if (!string.IsNullOrEmpty(pingcode_caseno))
     {
         var safe = SanitizeExcelCellValue(pingcode_caseno);
         conditions.Add($"行動條碼案號: {EscapeXml(safe)}");
     }
     if (!string.IsNullOrEmpty(pingcode))
     {
         var safe = SanitizeExcelCellValue(pingcode);
         conditions.Add($"PingCode: {EscapeXml(safe)}");
     }
     if (!string.IsNullOrEmpty(shopid))
     {
         var safe = SanitizeExcelCellValue(shopid);
         conditions.Add($"門市代號: {EscapeXml(safe)}");
     }

     string conditionText = conditions.Any() ? string.Join(" | ", conditions) : "全部資料";
     html.AppendLine($"<Data ss:Type=\"String\">{conditionText}</Data>");
     html.AppendLine("</Cell>");
     html.AppendLine("</Row>");

     //html.AppendLine("<Row>");
     //html.AppendLine("<Cell ss:MergeAcross=\"7\">");
     //var conditions = new List<string>();
     //if (!string.IsNullOrEmpty(pingcode_caseno)) conditions.Add($"行動條碼案號: {pingcode_caseno}");
     //if (!string.IsNullOrEmpty(pingcode)) conditions.Add($"PingCode: {pingcode}");
     //if (!string.IsNullOrEmpty(shopid)) conditions.Add($"門市代號: {shopid}");

     //string conditionText = conditions.Any() ? string.Join(" | ", conditions) : "全部資料";
     //html.AppendLine($"<Data ss:Type=\"String\">查詢條件: {conditionText}</Data>");
     //html.AppendLine("</Cell>");
     //html.AppendLine("</Row>");

     // 匯出時間行
     html.AppendLine("<Row>");
     html.AppendLine("<Cell ss:MergeAcross=\"7\">");
     html.AppendLine($"<Data ss:Type=\"String\">匯出時間: {DateTime.Now:yyyy/MM/dd HH:mm:ss}</Data>");
     html.AppendLine("</Cell>");
     html.AppendLine("</Row>");

     // 空白行
     html.AppendLine("<Row></Row>");

     // 表頭
     html.AppendLine("<Row>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">C單單號</Data></Cell>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">來蓋章活動案號</Data></Cell>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">行動條碼案號</Data></Cell>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">貨號</Data></Cell>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">商品名稱</Data></Cell>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">PingCode</Data></Cell>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">店編</Data></Cell>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">到店日</Data></Cell>");
     html.AppendLine("</Row>");

     // 資料行
     foreach (var item in data)
     {
         html.AppendLine("<Row>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.DC_ORDER_NO)}</Data></Cell>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.caseno)}</Data></Cell>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.pingcode_caseno)}</Data></Cell>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.PRD_ID)}</Data></Cell>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.PRD_NAME)}</Data></Cell>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.pingcode)}</Data></Cell>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.shopid)}</Data></Cell>");
         html.AppendLine($"<Cell ss:StyleID=\"dataStyle\"><Data ss:Type=\"String\">{EscapeXml(item.DC_ARRIVE_DATE)}</Data></Cell>");
         html.AppendLine("</Row>");
     }

     // 統計行
     html.AppendLine("<Row></Row>");
     html.AppendLine("<Row>");
     html.AppendLine("<Cell ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">總計</Data></Cell>");
     html.AppendLine($"<Cell ss:MergeAcross=\"6\" ss:StyleID=\"headerStyle\"><Data ss:Type=\"String\">共 {data.Count()} 筆資料</Data></Cell>");
     html.AppendLine("</Row>");

     html.AppendLine("</Table>");
     html.AppendLine("</Worksheet>");
     html.AppendLine("</Workbook>");

     // 轉換成byte array
     return Encoding.UTF8.GetBytes(html.ToString());

 }
    #region Fortify Helper

    // Query 白名單 
    private static string SanitizeQuery(string input, int maxLen = 100)
    {
        if (string.IsNullOrWhiteSpace(input)) return null;
        var s = input.Trim();

        // 僅允許：中英文、數字、- _ . 空白
        s = Regex.Replace(s, @"[^\p{L}\p{Nd}\-_\.\s]", "");

        if (s.Length > maxLen) s = s.Substring(0, maxLen);
        // Fortify: Input has been sanitized by whitelist regex
        return string.IsNullOrWhiteSpace(s) ? null : s;
    }

    /// <summary>
    /// XML特殊字元跳脫處理
    /// </summary>
    private string EscapeXml(string text)
    {
        if (string.IsNullOrEmpty(text))
            return string.Empty;

        // **順序很重要：先處理 & 避免重複跳脫**
        return text.Replace("&", "&amp;")
                   .Replace("<", "&lt;")
                   .Replace(">", "&gt;")
                   .Replace("\"", "&quot;")
                   .Replace("'", "&apos;")
                   .Replace("\r", "")
                   .Replace("\n", "&#10;");
    }

    /// <summary>
    /// 產生安全的檔名（移除所有可能造成問題的字元）
    /// </summary>
    private string GetSafeFileName(string fileName)
    {
        if (string.IsNullOrWhiteSpace(fileName))
            return "export.xls";

        // 只保留安全字元：中文、英文、數字、底線、連字號、點
        string safe = Regex.Replace(fileName, @"[^\p{L}\p{Nd}_\-\.]", "");

        // 確保有副檔名
        if (!safe.EndsWith(".xls") && !safe.EndsWith(".xlsx"))
            safe += ".xls";

        return safe;
    }

    /// <summary>
    /// 建立安全的檔名（固定前綴 + 時間戳）
    /// Fortify: 所有參數都是伺服器端生成，不含使用者輸入
    /// </summary>
    /// <param name="prefix">固定的檔名前綴</param>
    /// <param name="timestamp">時間戳</param>
    /// <returns>安全的檔名</returns>
    private string BuildSafeFileName(string prefix, DateTime timestamp)
    {
        // Fortify: prefix 是硬編碼的字串常數
        // Fortify: timestamp 是伺服器端的 DateTime 物件

        // 使用白名單字元（只保留中文、英文、數字）
        string safePrefix = Regex.Replace(prefix, @"[^\p{L}\p{Nd}]", "");

        // 格式化時間戳（只包含數字和底線）
        string timeStamp = timestamp.ToString("yyyyMMdd_HHmmss");

        // 組合檔名
        string fileName = $"{safePrefix}_{timeStamp}.xls";

        // Fortify: 返回的檔名完全由伺服器端生成，無使用者輸入
        return fileName;
    }
    #endregion
