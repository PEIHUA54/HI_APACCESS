ğŸ‘Œ æ˜ç™½äº†ï¼Œä½ ç¾åœ¨è¦æ”¹æˆ éƒ¨åˆ†æˆåŠŸã€éƒ¨åˆ†å¤±æ•— çš„æ¨¡å¼ï¼š
	1.	å…è¨±æˆåŠŸçš„ç­†æ•¸å…ˆå¯«å…¥
	2.	å¤±æ•—çš„ç­†æ•¸æ”¶é›†èµ·ä¾†ï¼Œé¡¯ç¤ºéŒ¯èª¤æ¸…å–®
	3.	æœ€å¾Œé¡¯ç¤ºï¼šæˆåŠŸ X ç­†ï¼Œå¤±æ•— Y ç­†
	4.	æˆåŠŸçš„ç­†æ•¸è¦å¯«å…¥è³‡æ–™åº«ï¼Œä¸¦åˆ·æ–°ä½¿ç”¨è€…æ¸…å–®

â¸»

1. Controller

æ”¹å‹•é‡é»ï¼š
	â€¢	message æ”¹æˆã€ŒæˆåŠŸ/å¤±æ•—ç­†æ•¸ã€
	â€¢	ä¿ç•™ errors çµ¦å‰ç«¯é¡¯ç¤º

[HttpPost]
public ActionResult ImportUsers(HttpPostedFileBase file, string apgNo)
{
    if (file == null || file.ContentLength == 0)
        return Json(new { success = false, message = "è«‹é¸æ“‡è¦åŒ¯å…¥çš„Excelæª”æ¡ˆ" });

    if (string.IsNullOrWhiteSpace(apgNo))
        return Json(new { success = false, message = "è«‹å…ˆé¸æ“‡ç¾¤çµ„" });

    var ext = Path.GetExtension(file.FileName).ToLower();
    if (ext != ".xls" && ext != ".xlsx")
        return Json(new { success = false, message = "è«‹ä¸Šå‚³Excelæª”æ¡ˆï¼ˆ.xls æˆ– .xlsxï¼‰" });

    var uploadDir = Server.MapPath("~/Upload");
    if (!Directory.Exists(uploadDir)) Directory.CreateDirectory(uploadDir);

    var safeName = $"Import_{apgNo}_{DateTime.Now:yyyyMMddHHmmss}{ext}";
    var uploadPath = PathValidator.GetSafePath(uploadDir, safeName);

    try
    {
        file.SaveAs(uploadPath);

        var service = GetAPService();
        var importResult = service.ImportUsersFromExcel(uploadPath, CurrentSystemId, apgNo, this.Emp_NO);

        string msg = $"æˆåŠŸ {importResult.SuccessCount} ç­†ï¼Œå¤±æ•— {importResult.ErrorMessages.Count} ç­†";

        return Json(new
        {
            success = true, // âœ… ä¸ç®¡æœ‰éŒ¯èª¤é‚„æ˜¯æˆåŠŸéƒ½å› trueï¼Œå‰ç«¯åˆ¤æ–·ç”¨éŒ¯èª¤æ¸…å–®
            message = msg,
            errors = importResult.ErrorMessages.Select(e => new
            {
                RowNumber = e.RowNumber,
                EmpNo = e.EmpNo,
                Message = e.Message
            })
        });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "åŒ¯å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message });
    }
    finally
    {
        if (System.IO.File.Exists(uploadPath))
        {
            var fc = new F_Common();
            fc.SafeDeleteFile(uploadDir, safeName);
        }
    }
}


â¸»

2. F_AP æ–¹æ³•

æ”¹å‹•é‡é»ï¼š
	â€¢	ä¸è¦åœ¨ã€Œæœ‰éŒ¯èª¤ã€æ™‚ç›´æ¥ return
	â€¢	æˆåŠŸç­†æ•¸ç´¯åŠ 
	â€¢	å¤±æ•—ç­†æ•¸æ”¶é›†åˆ° ErrorMessages

public ImportResult ImportUsersFromExcel(string filePath, string sysId, string apgNo, string creator)
{
    ImportResult result = new ImportResult { ErrorMessages = new List<ImportError>() };

    try
    {
        var rows = new List<(int RowNumber, string EmpNo)>();

        // è®€ Excel
        using (var stream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.Read))
        using (var reader = ExcelReaderFactory.CreateReader(stream))
        {
            int rowIndex = 0;
            while (reader.Read())
            {
                rowIndex++;
                if (rowIndex == 1)
                {
                    string header = reader.GetString(0)?.Trim();
                    if (string.IsNullOrEmpty(header) || header != "å“¡å·¥ç·¨è™Ÿ")
                    {
                        result.IsSuccess = false;
                        result.ErrorMessage = "Excel æ ¼å¼éŒ¯èª¤ï¼šç¬¬ä¸€åˆ—ç¬¬ä¸€æ¬„å¿…é ˆæ˜¯ã€Œå“¡å·¥ç·¨è™Ÿã€";
                        return result;
                    }
                    continue;
                }

                string empNo = reader.GetValue(0)?.ToString().Trim();
                if (!string.IsNullOrEmpty(empNo))
                    rows.Add((rowIndex, empNo));
            }
        }

        if (rows.Count == 0)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "Excel ç„¡ä»»ä½•å“¡å·¥è³‡æ–™";
            return result;
        }

        int successCount = 0;

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["ConnDB_TFS_HI_TMMAIN"].ConnectionString))
        {
            con.Open();

            foreach (var row in rows)
            {
                try
                {
                    // æª¢æŸ¥å“¡å·¥æ˜¯å¦å­˜åœ¨
                    string empName = null;
                    using (var cmd = new SqlCommand("SELECT EMP_NAME FROM VW_M1EMP_MAST WHERE EMP_NO=@EMP_NO", con))
                    {
                        cmd.Parameters.AddWithValue("@EMP_NO", row.EmpNo);
                        empName = cmd.ExecuteScalar() as string;
                    }

                    if (string.IsNullOrEmpty(empName))
                    {
                        result.ErrorMessages.Add(new ImportError { RowNumber = row.RowNumber, EmpNo = row.EmpNo, Message = "æŸ¥ç„¡æ­¤å“¡å·¥" });
                        continue;
                    }

                    // åŒç¾¤çµ„æª¢æŸ¥
                    using (var cmd = new SqlCommand("SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID", con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);
                        if ((int)cmd.ExecuteScalar() > 0)
                        {
                            result.ErrorMessages.Add(new ImportError { RowNumber = row.RowNumber, EmpNo = row.EmpNo, Message = "æ­¤ç¾¤çµ„å·²å­˜åœ¨è©²å“¡å·¥" });
                            continue;
                        }
                    }

                    // ç³»çµ±å…¶ä»–ç¾¤çµ„æª¢æŸ¥
                    using (var cmd = new SqlCommand("SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO<>@APG_NO AND U_ID=@U_ID", con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);
                        if ((int)cmd.ExecuteScalar() > 0)
                        {
                            result.ErrorMessages.Add(new ImportError { RowNumber = row.RowNumber, EmpNo = row.EmpNo, Message = "è©²ç³»çµ±å…¶ä»–ç¾¤çµ„å·²å­˜åœ¨è©²å“¡å·¥" });
                            continue;
                        }
                    }

                    // å¯«å…¥
                    using (var cmd = new SqlCommand(@"
                        INSERT INTO AP_USER(SYS_ID,APG_NO,U_ID,U_NAME,CREATOR,CREATE_TIME)
                        VALUES(@SYS_ID,@APG_NO,@U_ID,@U_NAME,@CREATOR,GETDATE())", con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);
                        cmd.Parameters.AddWithValue("@U_NAME", empName);
                        cmd.Parameters.AddWithValue("@CREATOR", creator);
                        cmd.ExecuteNonQuery();
                        successCount++;
                    }
                }
                catch (Exception exRow)
                {
                    result.ErrorMessages.Add(new ImportError { RowNumber = row.RowNumber, EmpNo = row.EmpNo, Message = "å¯«å…¥éŒ¯èª¤ï¼š" + exRow.Message });
                }
            }
        }

        result.SuccessCount = successCount;
        result.IsSuccess = true; // âœ… ä¸è«–æœ‰ç„¡éŒ¯èª¤ï¼Œéƒ½å› trueï¼Œå‰ç«¯è‡ªå·±é¡¯ç¤ºéŒ¯èª¤æ¸…å–®
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = "è™•ç† Excel åŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message;
    }

    return result;
}


â¸»

3. JS

æ”¹å‹•é‡é»ï¼š
	â€¢	æˆåŠŸå’ŒéŒ¯èª¤åŒæ™‚é¡¯ç¤º
	â€¢	é¡¯ç¤ºã€ŒæˆåŠŸ X ç­†ï¼Œå¤±æ•— Y ç­†ã€
	â€¢	æˆåŠŸä»ç„¶æœƒåˆ·æ–°ä½¿ç”¨è€…æ¸…å–®

$("#importForm").submit(function (e) {
    e.preventDefault();
    var formData = new FormData(this);

    $("#uploadProgress").removeClass("d-none");
    $(".progress-bar").css("width", "50%");

    $.ajax({
        url: '@Url.Action("ImportUsers", "AP")',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function (res) {
            $("#uploadProgress").addClass("d-none");
            $(".progress-bar").css("width", "0%");

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            $("#successMessage").text(res.message);
            $("#successSection").removeClass("d-none");

            // æ¸…ç©ºéŒ¯èª¤è¡¨æ ¼
            $("#errorTable tbody").empty();

            if (res.errors && res.errors.length > 0) {
                $("#errorSection").removeClass("d-none");
                res.errors.forEach(err => {
                    $("#errorTable tbody").append(
                        `<tr class="table-danger">
                            <td>${err.RowNumber}</td>
                            <td>${err.EmpNo}</td>
                            <td>${err.Message}</td>
                        </tr>`
                    );
                });
            } else {
                $("#errorSection").addClass("d-none");
            }

            // âœ… åˆ·æ–°ä½¿ç”¨è€…å€å¡Š
            loadUsers();
        },
        error: function () {
            $("#uploadProgress").addClass("d-none");
            $(".progress-bar").css("width", "0%");
            alert("ä¼ºæœå™¨ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        }
    });
});


â¸»

é€™æ¨£ä¿®æ”¹å¾Œï¼š
	â€¢	æœƒã€Œéƒ¨åˆ†æˆåŠŸã€æ’å…¥ DB
	â€¢	å‰ç«¯æœƒé¡¯ç¤º æˆåŠŸ X ç­†ï¼Œå¤±æ•— Y ç­†
	â€¢	å¤±æ•—çš„ç­†æ•¸æœƒåœ¨éŒ¯èª¤è¡¨æ ¼ä¸­åˆ—å‡º
	â€¢	æˆåŠŸç­†æ•¸æœƒç«‹å³åæ‡‰åœ¨ ç®¡ç†ä½¿ç”¨è€…æ¸…å–®

â¸»

è¦ä¸è¦æˆ‘å†å¹«ä½ æŠŠ View çš„éŒ¯èª¤æ¸…å–®è¡¨æ ¼æ¨£å¼ï¼ˆç´…æ¡†ã€å‹•ç•«ï¼‰å¥—å¥½ï¼Ÿ