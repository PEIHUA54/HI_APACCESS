    <!-- 上傳區 -->
    <div id="uploadFormSection">
        <form id="importForm" enctype="multipart/form-data" method="post">
            <input type="hidden" name="apgNo" id="importGroupNo" />
            <input type="hidden" name="sysID"  id="importSysID" value="@Session["CurrentSystemId"]" />
            <div class="mb-3">
                <input type="file" class="form-control" name="file" accept=".xls,.xlsx" required />
            </div>
            <div class="d-flex">
                <button type="submit" class="btn btn-primary">匯入</button>
                <button type="button" class="btn btn-success" onclick="downloadTemplate()">
                    <i class="fas fa-download"></i> 下載範本
                </button>
            </div>
        </form>

        <!-- 匯入進度 -->
        <div id="uploadProgress" class="progress mt-3 d-none">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
    </div>
js:

        const currentSysID   = @Html.Raw(Json.Encode(Session["CurrentSystemId"] ?? ""));
        const currentGroupID = @Html.Raw(Json.Encode(Session["CurrentGroupId"]  ?? ""));
        const isAdmin = (currentGroupID === '001');
 

  // 批次匯入使用者MODAL
   function openImportModal() {
       $('#importGroupNo').val($('#groupSelect').val()); // 帶目前群組
       $('#importResult').empty();
       $("#errorSection").addClass("d-none");
       $("#successSection").addClass("d-none");
       $("#uploadProgress").addClass("d-none");
       $(".progress-bar").css("width", "0%");
       $('#importModal').modal('show');
       $('#importSysID').val(currentSysID);
   }

  // 匯入表單送出
  $("#importForm").submit(function (e) {
      e.preventDefault();
      var formData = new FormData(this);


      $("#uploadProgress").removeClass("d-none");
      $(".progress-bar").css("width", "50%");

      $.ajax({
          url: '@Url.Action("ImportUsers", "AP")',
          type: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          success: function (res) {
              $("#uploadProgress").addClass("d-none");
              $(".progress-bar").css("width", "0%");

              // 清空舊的訊息區塊
              $("#successSection, #errorSection, #partialSection").addClass("d-none");
              $("#errorTable tbody").empty();

              if (res.status === "success") {
                  // 全部成功
                  $("#successMessage").text(res.message);
                  $("#successSection").removeClass("d-none");
                  loadUsers();
              }
              else if (res.status === "fail") {
                  // 全部失敗
                  $("#errorMessage").text(res.message);
                  $("#errorSection").removeClass("d-none");

                  if (res.errors && res.errors.length > 0) {
                      res.errors.forEach(err => {
                          $("#errorTable tbody").append(
                              `<tr>
                                  <td>${err.RowNumber}</td>
                                  <td>${err.EmpNo}</td>
                                  <td>${err.Message}</td>
                              </tr>`
                          );
                      });
                  }
              }
              else if (res.status === "partial") {
                  // 部分成功
                  $("#partialMessage").text(res.message);
                  $("#partialSection").removeClass("d-none");

                  if (res.errors && res.errors.length > 0) {
                      res.errors.forEach(err => {
                          $("#errorTable tbody").append(
                              `<tr>
                          <td>${err.RowNumber}</td>
                          <td>${err.EmpNo}</td>
                          <td>${err.Message}</td>
                      </tr>`
                          );
                      });
                  }

                  loadUsers();
              }
          },
          error: function () {
              $("#uploadProgress").addClass("d-none");
              $(".progress-bar").css("width", "0%");
              alert("伺服器發生錯誤，請稍後再試。");
          }
      });
  });


後端:
        #region 批次匯入
        public ImportResult ImportUsersFromExcel(string filePath, string sysId, string apgNo, string creator)
        {
            ImportResult result = new ImportResult()
            {
                ErrorMessages = new List<ImportError>()
            };

            try
            {
                apgNo = apgNo?.Trim();

                // **1. 驗證權限**
                if (!HasGroupPermissionViaSP(sysId, apgNo, creator))
                {
                    result.IsSuccess = false;
                    result.ErrorMessage = apgNo == "001"
                        ? "僅001群組成員可以操作001群組的批次匯入"
                        : "無權限操作此群組";
                    return result;
                }

                // **2. 驗證群組存在**
                var validateParams = new List<SqlParameter>
                {
                    new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
                    new SqlParameter("@APG_NO", SqlDbType.Char, 3) { Value = apgNo }  
                };

                string validateGroupSql = "SELECT COUNT(1) FROM AP_GROUP WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO";
                var validateResult = SVS_DBmanager.QueryBySQL(validateGroupSql, validateParams);

                if (validateResult.Rows.Count == 0 || Convert.ToInt32(validateResult.Rows[0][0]) == 0)
                {
                    result.IsSuccess = false;
                    result.ErrorMessage = "群組不存在";
                    return result;
                }

                // **3. 讀取 Excel**
                var rows = ReadExcelData(filePath, result);
                if (!result.IsSuccess || rows == null) return result;

                // **4. 批次處理每筆資料**
                int successCount = 0;
                foreach (var row in rows)
                {
                    if (ProcessUserRow(row, sysId, apgNo, creator, result))
                    {
                        successCount++;
                    }
                }

                result.SuccessCount = successCount;
                result.IsSuccess = true;
            }
            catch (Exception ex)
            {
                result.IsSuccess = false;
                result.ErrorMessage = "處理 Excel 匯入時發生錯誤：" + ex.Message;
            }

            return result;
        }

        /// <summary>
        /// 檢查使用者是否有權限操作指定群組
        /// </summary>
        private bool HasGroupPermissionViaSP(string sysId, string targetApgNo, string userId)
        {
            try
            {
                var parameters = new List<SqlParameter>
                {
                    new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
                    new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = targetApgNo },
                    new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = userId }
                };

                string permissionCheckSql = @"
            SELECT 
                CASE 
                    WHEN EXISTS (
                        SELECT 1 FROM AP_USER 
                        WHERE SYS_ID = @SYS_ID 
                          AND RTRIM(APG_NO) = '001'
                          AND U_ID = @U_ID
                    ) THEN 1
                    WHEN RTRIM(@APG_NO) = '001' THEN 0
                    ELSE 1
                END AS HasPermission";

                var result = SVS_DBmanager.QueryBySQL(permissionCheckSql, parameters);

                return result.Rows.Count > 0 && Convert.ToInt32(result.Rows[0]["HasPermission"]) == 1;
            }
            catch (Exception ex)
            {
                // Log error
                return false;
            }
        }

        /// <summary>
        /// 讀取 Excel 資料
        /// </summary>
        private List<(int RowNumber, string EmpNo)> ReadExcelData(string filePath, ImportResult result)
        {
            var rows = new List<(int RowNumber, string EmpNo)>();

            try
            {
                using (var stream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.Read))
                using (var reader = ExcelReaderFactory.CreateReader(stream))
                {
                    int rowIndex = 0;
                    while (reader.Read())
                    {
                        rowIndex++;

                        if (rowIndex == 1)
                        {
                            string header = reader.GetString(0)?.Trim();
                            if (string.IsNullOrEmpty(header) || header != "員工編號")
                            {
                                result.IsSuccess = false;
                                result.ErrorMessage = "Excel 格式錯誤：第一列第一欄必須是「員工編號」";
                                return null;
                            }
                            continue;
                        }

                        string empNo = reader.GetValue(0)?.ToString().Trim();
                        if (!string.IsNullOrEmpty(empNo))
                        {
                            // ⭐ 驗證員工編號長度（varchar(10)）
                            if (empNo.Length > 10)
                            {
                                result.ErrorMessages.Add(new ImportError
                                {
                                    RowNumber = rowIndex,
                                    EmpNo = empNo,
                                    Message = "員工編號長度超過10個字元"
                                });
                                continue;
                            }

                            rows.Add((rowIndex, empNo));
                        }
                    }
                }

                if (rows.Count == 0)
                {
                    result.IsSuccess = false;
                    result.ErrorMessage = "Excel 無任何員工資料";
                    return null;
                }

                return rows;
            }
            catch (Exception ex)
            {
                result.IsSuccess = false;
                result.ErrorMessage = "讀取 Excel 時發生錯誤：" + ex.Message;
                return null;
            }
        }

        /// <summary>
        /// 處理單筆員工資料
        /// </summary>
        private bool ProcessUserRow((int RowNumber, string EmpNo) row, string sysId, string apgNo, string creator, ImportResult result)
        {
            try
            {
                // 1. 檢查員工是否存在
                var empParams = new List<SqlParameter>
                {
                    new SqlParameter("@EMP_NO", SqlDbType.VarChar, 10) { Value = row.EmpNo }
                };

                string checkEmpSql = "SELECT EMP_NAME FROM [HI-AUTOS].[dbo].[M1EMP_MAST] WHERE EMP_NO=@EMP_NO";
                var empResult = SVS_DBmanager.QueryBySQL(checkEmpSql, empParams);
                
                if (empResult.Rows.Count == 0)
                {
                    result.ErrorMessages.Add(new ImportError
                    {
                        RowNumber = row.RowNumber,
                        EmpNo = row.EmpNo,
                        Message = "查無此員工"
                    });
                    return false;
                }

                string empName = empResult.Rows[0]["EMP_NAME"].ToString();

                // ⭐ 驗證姓名長度（nvarchar(20)）
                if (empName.Length > 20)
                {
                    result.ErrorMessages.Add(new ImportError
                    {
                        RowNumber = row.RowNumber,
                        EmpNo = row.EmpNo,
                        Message = "員工姓名長度超過20個字元"
                    });
                    return false;
                }

                // 2. 檢查是否已存在於同一個群組
                var checkUserParams = new List<SqlParameter>
                {
                    new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
                    new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = apgNo },
                    new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo }
                };

                string checkUserSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID";
                var userResult = SVS_DBmanager.QueryBySQL(checkUserSql, checkUserParams);

                if (Convert.ToInt32(userResult.Rows[0][0]) > 0)
                {
                    result.ErrorMessages.Add(new ImportError
                    {
                        RowNumber = row.RowNumber,
                        EmpNo = row.EmpNo,
                        Message = "此群組已存在該員工"
                    });
                    return false;
                }

                // 3. 檢查是否已存在於該系統的其他群組
                var checkSystemParams = new List<SqlParameter>
                {
                    new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
                    new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = apgNo },
                    new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo }
                };

                string checkSystemSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO<>@APG_NO AND U_ID=@U_ID";
                var systemResult = SVS_DBmanager.QueryBySQL(checkSystemSql, checkSystemParams);

                if (Convert.ToInt32(systemResult.Rows[0][0]) > 0)
                {
                    result.ErrorMessages.Add(new ImportError
                    {
                        RowNumber = row.RowNumber,
                        EmpNo = row.EmpNo,
                        Message = "此系統其他群組已存在該員工"
                    });
                    return false;
                }

                // 4. 寫入 AP_USER
                var insertParams = new List<SqlParameter>
                {
                    new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
                    new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = apgNo },
                    new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo },
                    new SqlParameter("@U_NAME", SqlDbType.NVarChar, 20) { Value = empName }, 
                    new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
                };

                string insertSql = @"
            INSERT INTO AP_USER(SYS_ID, APG_NO, U_ID, U_NAME, CREATOR, CREATE_TIME)
            VALUES(@SYS_ID, @APG_NO, @U_ID, @U_NAME, @CREATOR, GETDATE())";

                SVS_DBmanager.ExecuteSQL(insertSql, insertParams);
                return true;
            }
            catch (Exception exRow)
            {
                result.ErrorMessages.Add(new ImportError
                {
                    RowNumber = row.RowNumber,
                    EmpNo = row.EmpNo,
                    Message = "寫入錯誤：" + exRow.Message
                });
                return false;
            }
        }


        #endregion

這是使用站台進去的syscontroller / action
 // 導向群組管理
 [HttpPost]
 public JsonResult RedirectToGroupManagement(string sysId)
 {
     try
     {
         if (string.IsNullOrWhiteSpace(sysId))
             return Json(new { success = false, message = "請選擇系統" });

         if (!IsValidSystemId(sysId))
             return Json(new { success = false, message = "無效的系統ID格式" });

         // 寫 Session
         Session["CurrentSystemId"] = sysId;
         Session["CurrentGroupId"] = "001";     
         Session["FromInternalSite"] = true;

         return Json(new { success = true });
     }
     catch (Exception ex)
     {
         return Json(new { success = false, message = "導向失敗：" + ex.Message });
     }

這是用token進去的apcontroller:
  public ActionResult GroupManagement()
  {
      var systemId = Session["CurrentSystemId"] as string;
      var groupId = Session["CurrentGroupId"] as string;

      if (string.IsNullOrEmpty(systemId))
          return Content("<h3>系統ID遺失，請重新透過權限管理連結進入</h3>");

      bool isFromInternalSite = Session["FromInternalSite"] != null && (bool)Session["FromInternalSite"];

      ViewBag.SystemId = systemId;
      ViewBag.GroupId = groupId;
      ViewBag.Title = "群組權限管理 - " + systemId;
      ViewBag.ShowSwitchButton = isFromInternalSite;

      return View();
  }
