æˆ‘äº†è§£å•é¡Œäº†ï¼ç•¶ä½¿ç”¨ TOKEN é€²å…¥æ™‚ï¼Œä¸æ‡‰è©²åŸ·è¡Œ `GetTicket()` ä¸¦å–å¾—ç›®éŒ„æ¨¹ï¼Œå› ç‚º TOKEN ä½¿ç”¨è€…æ˜¯é‡å°ç‰¹å®šç³»çµ±çš„ï¼Œä¸éœ€è¦çœ‹åˆ°å®Œæ•´çš„ç›®éŒ„é¸å–®ã€‚

è®“æˆ‘ä¿®æ”¹ `HI_APACCESSBaseController.cs`ï¼š

```csharp
using HI_APACCESS.Service;
using HI_APACCESS.ViewModels;
using Newtonsoft.Json;
using Serilog;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Security.Cryptography;
using System.Web.Mvc;
using System.Web.Security;
using System.IO;
using System.Text.RegularExpressions;
using HI_APACCESS.Factory.F_AP;
using HI_APACCESS.AttributeFilter;

namespace HI_APACCESS.Controllers
{
    [AP_LOG]
    [AP_LOG_Exception]
    public abstract class HI_APACCESSBaseController : Controller
    {
        private FormsAuthenticationTicket ticket;
        private string str_AD_Form;
        private string str_UserData_Form;
        private string AD;
        public string Emp_NO_åŸå§‹;
        public string Emp_NO;
        private VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨± Emp_Data;
        public string APG_NO;
        public List<VM_Employee.WebTree_Node> WebTrees;

        // æ–°å¢ï¼šåˆ¤æ–·æ˜¯å¦ç‚º TOKEN ç™»å…¥
        private bool IsTokenLogin
        {
            get
            {
                return !string.IsNullOrEmpty(Session["CurrentSystemId"] as string) &&
                       !string.IsNullOrEmpty(Session["CurrentEmpNo"] as string);
            }
        }

        public HI_APACCESSBaseController()
        {
            this.Emp_NO_åŸå§‹ = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ(SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥AD());
            this.Emp_NO = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ(this.AD).ToUpper().Trim();
        }

        private void GetTicket()
        {
            // å¦‚æœæ˜¯ TOKEN ç™»å…¥ï¼Œä¸åŸ·è¡Œ Ticket é‚è¼¯
            if (IsTokenLogin)
            {
                // TOKEN ç™»å…¥ï¼šå¾ Session å–å¾—å“¡å·¥ç·¨è™Ÿ
                this.Emp_NO = Session["CurrentEmpNo"] as string;
                this.AD = this.Emp_NO; // TOKEN ä½¿ç”¨è€…ä½¿ç”¨å“¡å·¥ç·¨è™Ÿä½œç‚º AD
                this.APG_NO = string.Empty; // TOKEN ä½¿ç”¨è€…ä¸éœ€è¦ APG_NO
                this.WebTrees = new List<VM_Employee.WebTree_Node>(); // TOKEN ä½¿ç”¨è€…ä¸é¡¯ç¤ºç›®éŒ„æ¨¹
                this.Emp_Data = null; // TOKEN ä½¿ç”¨è€…ä¸éœ€è¦å®Œæ•´å“¡å·¥è³‡æ–™
                return;
            }

            // ä¸€èˆ¬ç™»å…¥ï¼šåŸ·è¡ŒåŸæœ¬çš„ Ticket é‚è¼¯
            this.ticket = null;
            var authCookie = Request.Cookies[FormsAuthentication.FormsCookieName];
            if (authCookie != null && !string.IsNullOrWhiteSpace(authCookie.Value))
            {
                var decryptedTicket = FormsAuthentication.Decrypt(authCookie.Value);
                if (decryptedTicket.Expiration >= DateTime.Now)
                {
                    this.ticket = decryptedTicket;
                    this.str_AD_Form = this.ticket?.Name;
                    this.str_UserData_Form = this.ticket?.UserData;
                    this.AD = !string.IsNullOrEmpty(str_AD_Form) ? str_AD_Form : SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥AD();
                    this.Emp_NO = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥ç·¨è™Ÿ(this.AD).ToUpper().Trim();
                    this.Emp_Data = !string.IsNullOrEmpty(this.str_UserData_Form) ? JsonConvert.DeserializeObject<VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨±>(this.str_UserData_Form) : SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™(this.Emp_NO_åŸå§‹);
                    this.APG_NO = this.Emp_Data?.APG_NO ?? string.Empty;
                    
                    // ä¸€èˆ¬ç™»å…¥æ‰å–å¾—ç›®éŒ„æ¨¹
                    this.WebTrees = string.IsNullOrEmpty(this.APG_NO) ? new List<VM_Employee.WebTree_Node>() : SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_Tree(this.APG_NO);
                }
            }
        }

        protected override void HandleUnknownAction(string actionName)
        {
            this.Redirect("/?wrongView=" + actionName).ExecuteResult(this.ControllerContext);
        }

        protected override void OnException(ExceptionContext filterContext)
        {
            base.OnException(filterContext);

            var exception = filterContext.Exception;
            var user = filterContext.RequestContext.HttpContext.User;

            if ((exception is CryptographicException)
                || (exception is HttpAntiForgeryException && (user == null || !user.Identity.IsAuthenticated)))
            {
                HandleAuthenticationException(filterContext);
                return;
            }

            if (exception is HttpAntiForgeryException)
            {
                var action = filterContext.RequestContext.RouteData.Values["action"] as string;
                var controller = filterContext.RequestContext.RouteData.Values["controller"] as string;
                if (action == "Login" && controller == "Account" && user != null && user.Identity.IsAuthenticated)
                {
                    HandleAuthenticationException(filterContext);
                    return;
                }
            }

            ILogger log = SVS_Serilog._log;
            log.Error<string>(exception, exception.Message, exception.StackTrace);
        }

        private void HandleAuthenticationException(ExceptionContext filterContext)
        {
            filterContext.ExceptionHandled = true;
            Session.Abandon();
            FormsAuthentication.SignOut();
            filterContext.Result = new RedirectResult(Url.Action("Login", "Account"));
        }

        private static string[] List_æ’é™¤æ¸…å–®_ctrl => Array.ConvertAll(new string[] { "Account", "Home", "SYSTEM_SET", "AP", "SYS" }, x => x.ToUpper());
        private static string[] List_æ’é™¤æ¸…å–®_action => Array.ConvertAll(new string[]
        {
          "Login", "Logout", "RefreshSession", "Main" //å…¶ä»–
          ,"PageManagement","GroupManagement","Index","TokenEntry","TokenEntry_FUNC","Entry","Entry_FUNC"
          ,"SYS_APPLY","SYS_FUNC_SET","SYS_PERMISSION_SET"

        }, x => x.ToUpper());

        //é é¢æ¬Šé™çµ±ä¸€æ§ç®¡ï¼Œæ²’æœ‰æ¬Šé™å°±å°å»å…¬ä½ˆæ¬„é é¢
        protected override void OnActionExecuting(ActionExecutingContext filterContext)
        {
            base.OnActionExecuting(filterContext);
            GetTicket();

            if (filterContext.ActionDescriptor is ReflectedActionDescriptor actionDescriptor)
            {
                string ReturnType = actionDescriptor.MethodInfo.ReturnType.Name;
                string ctrlName = filterContext.ActionDescriptor.ControllerDescriptor.ControllerName.ToUpper();
                string actionName = filterContext.ActionDescriptor.ActionName.ToUpper();

                // TOKEN ç™»å…¥ä½¿ç”¨è€…ï¼šè·³éæ‰€æœ‰æ¬Šé™æª¢æŸ¥
                if (IsTokenLogin)
                {
                    return;
                }

                // APã€HOMEã€ç‰¹å®š Action ä¸åšæ¬Šé™æª¢æŸ¥
                if (ctrlName == "AP" || ctrlName == "HOME" ||
                    new[] { "PAGEMANAGEMENT", "GROUPMANAGEMENT", "TOKENENTRY", "TOKENENTRY_FUNC", "INDEX" }.Contains(actionName))
                {
                    return;
                }

                // ä¸€èˆ¬ç™»å…¥ä½¿ç”¨è€…ï¼šé€²è¡Œæ¬Šé™æª¢æŸ¥
                if (ReturnType == "ActionResult"
                    && filterContext.HttpContext.Request.HttpMethod == "GET"
                    && !filterContext.HttpContext.Request.IsAjaxRequest())
                {
                    var _List_æ’é™¤æ¸…å–®_ctrl = List_æ’é™¤æ¸…å–®_ctrl.Select(x => x.ToUpper()).ToArray();
                    var _List_æ’é™¤æ¸…å–®_action = List_æ’é™¤æ¸…å–®_action.Select(x => x.ToUpper()).ToArray();

                    if (WebTrees != null
                        && !_List_æ’é™¤æ¸…å–®_ctrl.Contains(ctrlName)
                        && !WebTrees.Any(x => string.IsNullOrEmpty(x.PARENT_ID) && x.FUNC_ID == ctrlName))
                    {
                        filterContext.Result = new RedirectResult(Url.Action("Main", "Home"));
                        return;
                    }
                }
            }
        }

        protected string CurrentSystemId
        {
            get
            {
                return Session["CurrentSystemId"] as string;
            }
        }

        protected F_AP GetAPService()
        {
            string currentSystemId = Session["CurrentSystemId"] as string;
            if (string.IsNullOrEmpty(currentSystemId))
            {
                throw new InvalidOperationException("ç³»çµ±IDéºå¤±ï¼Œè«‹é‡æ–°ç™»å…¥");
            }
            return new F_AP(currentSystemId);
        }
    }
}
```

## é—œéµä¿®æ”¹èªªæ˜

### 1. **æ–°å¢ `IsTokenLogin` å±¬æ€§**

```csharp
private bool IsTokenLogin
{
    get
    {
        return !string.IsNullOrEmpty(Session["CurrentSystemId"] as string) &&
               !string.IsNullOrEmpty(Session["CurrentEmpNo"] as string);
    }
}
```

ç”¨ä¾†åˆ¤æ–·ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦é€é TOKEN ç™»å…¥ã€‚

### 2. **ä¿®æ”¹ `GetTicket()` æ–¹æ³•**

```csharp
private void GetTicket()
{
    // å¦‚æœæ˜¯ TOKEN ç™»å…¥ï¼Œä¸åŸ·è¡Œ Ticket é‚è¼¯
    if (IsTokenLogin)
    {
        this.Emp_NO = Session["CurrentEmpNo"] as string;
        this.AD = this.Emp_NO;
        this.APG_NO = string.Empty;
        this.WebTrees = new List<VM_Employee.WebTree_Node>(); // ğŸ‘ˆ ç©ºçš„ç›®éŒ„æ¨¹
        this.Emp_Data = null;
        return; // ç›´æ¥è¿”å›ï¼Œä¸åŸ·è¡Œä¸‹é¢çš„ Ticket é‚è¼¯
    }
    
    // ä¸€èˆ¬ç™»å…¥æ‰åŸ·è¡ŒåŸæœ¬çš„é‚è¼¯...
}
```

### 3. **ä¿®æ”¹ `OnActionExecuting()` æ¬Šé™æª¢æŸ¥**

```csharp
protected override void OnActionExecuting(ActionExecutingContext filterContext)
{
    base.OnActionExecuting(filterContext);
    GetTicket();
    
    // TOKEN ç™»å…¥ä½¿ç”¨è€…ï¼šè·³éæ‰€æœ‰æ¬Šé™æª¢æŸ¥
    if (IsTokenLogin)
    {
        return; // ğŸ‘ˆ TOKEN ä½¿ç”¨è€…ç›´æ¥é€šéï¼Œä¸æª¢æŸ¥ç›®éŒ„æ¨¹
    }
    
    // ä¸€èˆ¬ç™»å…¥ä½¿ç”¨è€…ï¼šé€²è¡ŒåŸæœ¬çš„æ¬Šé™æª¢æŸ¥...
}
```

## æ•ˆæœ

### **TOKEN ç™»å…¥æ™‚ï¼š**

- âœ… `WebTrees` = ç©ºæ¸…å–®ï¼Œä¸æœƒé¡¯ç¤ºç›®éŒ„æ¨¹
- âœ… è·³éæ‰€æœ‰æ¬Šé™æª¢æŸ¥
- âœ… åªèƒ½è¨ªå• `GroupManagement` å’Œ `PageManagement`
- âœ… `Emp_NO` å¾ Session å–å¾—

### **ä¸€èˆ¬ç™»å…¥æ™‚ï¼š**

- âœ… `WebTrees` = å®Œæ•´ç›®éŒ„æ¨¹ï¼Œæ­£å¸¸é¡¯ç¤ºé¸å–®
- âœ… åŸ·è¡Œæ¬Šé™æª¢æŸ¥
- âœ… å¯ä»¥è¨ªå•æ‰€æœ‰æœ‰æ¬Šé™çš„é é¢ï¼ˆåŒ…æ‹¬æ–°å¢çš„ä¸‰å€‹ SYS åŠŸèƒ½ï¼‰
- âœ… `Emp_NO` å¾ Ticket å–å¾—

## è£œå……ï¼šå¦‚æœä½ çš„ Layout æˆ– _Menu æœ‰ä½¿ç”¨åˆ° WebTrees

ç¢ºä¿ä½ çš„ View ä¸­æœ‰åˆ¤æ–·ï¼Œä¾‹å¦‚ï¼š

```html
<!-- åœ¨ _Layout.cshtml æˆ– _Menu.cshtml ä¸­ -->
@if (Model.WebTrees != null && Model.WebTrees.Any())
{
    <!-- é¡¯ç¤ºç›®éŒ„æ¨¹ -->
    @foreach (var node in Model.WebTrees)
    {
        <!-- æ¸²æŸ“é¸å–® -->
    }
}
else
{
    <!-- TOKEN ä½¿ç”¨è€…ä¸é¡¯ç¤ºç›®éŒ„æ¨¹ -->
}
```

é€™æ¨£ä¿®æ”¹å¾Œï¼ŒTOKEN ç™»å…¥çš„ä½¿ç”¨è€…å°±ä¸æœƒçœ‹åˆ°ç›®éŒ„æ¨¹äº†ï¼æœ‰ä»»ä½•å•é¡Œéš¨æ™‚å‘Šè¨´æˆ‘ã€‚â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹