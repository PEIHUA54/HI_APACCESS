å®Œç¾ï¼æ ¹æ“šæ‚¨æä¾›çš„è³‡æ–™åº«çµæ§‹æˆªåœ–ï¼Œæˆ‘çœ‹åˆ° `AP_USER` è¡¨çš„æ¬„ä½å®šç¾©ï¼š

## ğŸ“‹ AP_USER è¡¨çµæ§‹

|Column Name|Data Type       |é•·åº¦|
|-----------|----------------|--|
|SYS_ID     |varchar(30)     |30|
|APG_NO     |varchar(3)      |3 |
|U_ID       |varchar(10)     |10|
|U_NAME     |**nvarchar(20)**|20|
|CREATOR    |varchar(10)     |10|
|CREATE_TIME|datetime        |- |
|EDITOR     |varchar(10)     |10|
|EDIT_TIME  |datetime        |- |

## âš ï¸ é‡è¦ç™¼ç¾

æ‚¨æåˆ°å¦ä¸€å€‹ table (æ‡‰è©²æ˜¯ `AP_GROUP`) çš„ `APG_NO` æ˜¯ `char(3)`ï¼Œé€™æœƒé€ æˆ**è³‡æ–™é¡å‹ä¸ä¸€è‡´**çš„å•é¡Œï¼

-----

## ğŸ”§ ä¿®æ­£å¾Œçš„å®Œæ•´ç¨‹å¼ç¢¼

```csharp
/// <summary>
/// æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…ï¼ˆæ ¹æ“šå¯¦éš›è³‡æ–™åº«çµæ§‹ï¼‰
/// </summary>
public ImportResult ImportUsersFromExcel(string filePath, string sysId, string apgNo, string creator)
{
    ImportResult result = new ImportResult()
    {
        ErrorMessages = new List<ImportError>()
    };

    try
    {
        var dbManager = new SVS_DBmanager();
        
        // **é‡è¦ï¼šAPG_NO çµ±ä¸€ Trim è™•ç†ï¼ˆå› ç‚º char æœƒè£œç©ºç™½ï¼‰**
        apgNo = apgNo?.Trim();
        
        // **1. é©—è­‰æ¬Šé™**
        if (!HasGroupPermissionViaSP(dbManager, sysId, apgNo, creator))
        {
            result.IsSuccess = false;
            result.ErrorMessage = apgNo == "001" 
                ? "åƒ…001ç¾¤çµ„æˆå“¡å¯ä»¥æ“ä½œ001ç¾¤çµ„çš„æ‰¹æ¬¡åŒ¯å…¥" 
                : "ç„¡æ¬Šé™æ“ä½œæ­¤ç¾¤çµ„";
            return result;
        }

        // **2. é©—è­‰ç¾¤çµ„å­˜åœ¨**
        var validateParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.Char, 3) { Value = apgNo }  // â­ Char(3)
        };
        
        string validateGroupSql = "SELECT COUNT(1) FROM AP_GROUP WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO";
        var validateResult = dbManager.QueryBySQL(validateGroupSql, validateParams);
        
        if (validateResult.Rows.Count == 0 || Convert.ToInt32(validateResult.Rows[0][0]) == 0)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "ç¾¤çµ„ä¸å­˜åœ¨";
            return result;
        }

        // **3. è®€å– Excel**
        var rows = ReadExcelData(filePath, result);
        if (!result.IsSuccess || rows == null) return result;

        // **4. æ‰¹æ¬¡è™•ç†æ¯ç­†è³‡æ–™**
        int successCount = 0;
        foreach (var row in rows)
        {
            if (ProcessUserRow(dbManager, row, sysId, apgNo, creator, result))
            {
                successCount++;
            }
        }

        result.SuccessCount = successCount;
        result.IsSuccess = true;
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = "è™•ç† Excel åŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message;
    }

    return result;
}

/// <summary>
/// æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰æ¬Šé™æ“ä½œæŒ‡å®šç¾¤çµ„
/// </summary>
private bool HasGroupPermissionViaSP(SVS_DBmanager dbManager, string sysId, string targetApgNo, string userId)
{
    try
    {
        // â­ æ³¨æ„ï¼šAPG_NO åœ¨ AP_USER æ˜¯ varchar(3)ï¼Œåœ¨ AP_GROUP å¯èƒ½æ˜¯ char(3)
        // çµ±ä¸€ä½¿ç”¨ varchar å³å¯ï¼ŒSQL Server æœƒè‡ªå‹•è½‰æ›
        var parameters = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = targetApgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = userId }
        };

        string permissionCheckSql = @"
            SELECT 
                CASE 
                    WHEN EXISTS (
                        SELECT 1 FROM AP_USER 
                        WHERE SYS_ID = @SYS_ID 
                          AND RTRIM(APG_NO) = '001'
                          AND U_ID = @U_ID
                    ) THEN 1
                    WHEN RTRIM(@APG_NO) = '001' THEN 0
                    ELSE 1
                END AS HasPermission";

        var result = dbManager.QueryBySQL(permissionCheckSql, parameters);
        
        return result.Rows.Count > 0 && Convert.ToInt32(result.Rows[0]["HasPermission"]) == 1;
    }
    catch (Exception ex)
    {
        // Log error
        return false;
    }
}

/// <summary>
/// è®€å– Excel è³‡æ–™
/// </summary>
private List<(int RowNumber, string EmpNo)> ReadExcelData(string filePath, ImportResult result)
{
    var rows = new List<(int RowNumber, string EmpNo)>();
    
    try
    {
        using (var stream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.Read))
        using (var reader = ExcelReaderFactory.CreateReader(stream))
        {
            int rowIndex = 0;
            while (reader.Read())
            {
                rowIndex++;

                if (rowIndex == 1)
                {
                    string header = reader.GetString(0)?.Trim();
                    if (string.IsNullOrEmpty(header) || header != "å“¡å·¥ç·¨è™Ÿ")
                    {
                        result.IsSuccess = false;
                        result.ErrorMessage = "Excel æ ¼å¼éŒ¯èª¤ï¼šç¬¬ä¸€åˆ—ç¬¬ä¸€æ¬„å¿…é ˆæ˜¯ã€Œå“¡å·¥ç·¨è™Ÿã€";
                        return null;
                    }
                    continue;
                }

                string empNo = reader.GetValue(0)?.ToString().Trim();
                if (!string.IsNullOrEmpty(empNo))
                {
                    // â­ é©—è­‰å“¡å·¥ç·¨è™Ÿé•·åº¦ï¼ˆvarchar(10)ï¼‰
                    if (empNo.Length > 10)
                    {
                        result.ErrorMessages.Add(new ImportError
                        {
                            RowNumber = rowIndex,
                            EmpNo = empNo,
                            Message = "å“¡å·¥ç·¨è™Ÿé•·åº¦è¶…é10å€‹å­—å…ƒ"
                        });
                        continue;
                    }
                    
                    rows.Add((rowIndex, empNo));
                }
            }
        }

        if (rows.Count == 0)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "Excel ç„¡ä»»ä½•å“¡å·¥è³‡æ–™";
            return null;
        }

        return rows;
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = "è®€å– Excel æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message;
        return null;
    }
}

/// <summary>
/// è™•ç†å–®ç­†å“¡å·¥è³‡æ–™
/// </summary>
private bool ProcessUserRow(SVS_DBmanager dbManager, (int RowNumber, string EmpNo) row, 
                            string sysId, string apgNo, string creator, ImportResult result)
{
    try
    {
        // 1. æª¢æŸ¥å“¡å·¥æ˜¯å¦å­˜åœ¨
        var empParams = new List<SqlParameter>
        {
            new SqlParameter("@EMP_NO", SqlDbType.VarChar, 10) { Value = row.EmpNo }
        };
        
        string checkEmpSql = "SELECT EMP_NAME FROM [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST] WHERE EMP_NO=@EMP_NO";
        var empResult = dbManager.QueryBySQL(checkEmpSql, empParams);
        
        if (empResult.Rows.Count == 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "æŸ¥ç„¡æ­¤å“¡å·¥"
            });
            return false;
        }
        
        string empName = empResult.Rows[0]["EMP_NAME"].ToString();
        
        // â­ é©—è­‰å§“åé•·åº¦ï¼ˆnvarchar(20)ï¼‰
        if (empName.Length > 20)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "å“¡å·¥å§“åé•·åº¦è¶…é20å€‹å­—å…ƒ"
            });
            return false;
        }

        // 2. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼åŒä¸€å€‹ç¾¤çµ„
        var checkUserParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo }
        };
        
        string checkUserSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID";
        var userResult = dbManager.QueryBySQL(checkUserSql, checkUserParams);
        
        if (Convert.ToInt32(userResult.Rows[0][0]) > 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "æ­¤ç¾¤çµ„å·²å­˜åœ¨è©²å“¡å·¥"
            });
            return false;
        }

        // 3. æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼è©²ç³»çµ±çš„å…¶ä»–ç¾¤çµ„
        var checkSystemParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo }
        };
        
        string checkSystemSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO<>@APG_NO AND U_ID=@U_ID";
        var systemResult = dbManager.QueryBySQL(checkSystemSql, checkSystemParams);
        
        if (Convert.ToInt32(systemResult.Rows[0][0]) > 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "æ­¤ç³»çµ±å…¶ä»–ç¾¤çµ„å·²å­˜åœ¨è©²å“¡å·¥"
            });
            return false;
        }

        // 4. å¯«å…¥ AP_USER
        var insertParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@APG_NO", SqlDbType.VarChar, 3) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo },
            new SqlParameter("@U_NAME", SqlDbType.NVarChar, 20) { Value = empName },  // â­ NVarChar(20)
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };

        string insertSql = @"
            INSERT INTO AP_USER(SYS_ID, APG_NO, U_ID, U_NAME, CREATOR, CREATE_TIME)
            VALUES(@SYS_ID, @APG_NO, @U_ID, @U_NAME, @CREATOR, GETDATE())";

        dbManager.ExecuteSQL(insertSql, insertParams);
        return true;
    }
    catch (Exception exRow)
    {
        result.ErrorMessages.Add(new ImportError
        {
            RowNumber = row.RowNumber,
            EmpNo = row.EmpNo,
            Message = "å¯«å…¥éŒ¯èª¤ï¼š" + exRow.Message
        });
        return false;
    }
}
```

-----

## ğŸ”‘ é—œéµé‡é»æ•´ç†

### 1. **APG_NO çš„ CHAR vs VARCHAR å•é¡Œ**

```csharp
// AP_GROUP: APG_NO char(3)      â†’ "001" å¯¦éš›å­˜ç‚º "001" (charæœƒè£œç©ºç™½ä½†é€™è£¡å‰›å¥½3ç¢¼)
// AP_USER:  APG_NO varchar(3)   â†’ "001" å­˜ç‚º "001"

// å»ºè­°åœ¨æ¯”å°æ™‚ä½¿ç”¨ RTRIM å»é™¤å¯èƒ½çš„ç©ºç™½
WHERE RTRIM(APG_NO) = '001'
```

### 2. **åƒæ•¸è¨­å®šç¸½è¡¨**

|æ¬„ä½     |AP_USER         |AP_GROUP   |C# åƒæ•¸è¨­å®š                 |
|-------|----------------|-----------|------------------------|
|SYS_ID |varchar(30)     |?          |`SqlDbType.VarChar, 30` |
|APG_NO |varchar(3)      |char(3)    |`SqlDbType.VarChar, 3`  |
|U_ID   |varchar(10)     |-          |`SqlDbType.VarChar, 10` |
|U_NAME |**nvarchar(20)**|-          |`SqlDbType.NVarChar, 20`|
|CREATOR|varchar(10)     |varchar(10)|`SqlDbType.VarChar, 10` |

### 3. **å”¯ä¸€çš„ NVARCHAR æ¬„ä½**

- åªæœ‰ `U_NAME` æ˜¯ `nvarchar(20)` â†’ ç”¨ä¾†å„²å­˜ä¸­æ–‡å§“å
- å…¶ä»–æ¬„ä½éƒ½æ˜¯ `varchar` â†’ è‹±æ•¸å­—

é€™æ¨£çš„è¨­å®šæ˜¯æ­£ç¢ºçš„ï¼ä¿®æ”¹å¾Œæ‡‰è©²å¯ä»¥é€šé Fortify æƒæäº†ã€‚â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹