// 在 PosFile_Apply 專案中建立這些 Model 類別

namespace POSFILE_APPLY.Models
{
/// <summary>
/// 請求模型
/// </summary>
public class GetUrlRequsetModel
{
public string sys_id { get; set; }
public string type { get; set; }
public string environment { get; set; }
}

```
/// <summary>
/// 回應模型
/// </summary>
public class GetUrlResponseModel
{
    public string code { get; set; }
    public string message { get; set; }
    public string url { get; set; }
}
```

}

// 修正後的 APController
using POSFILE_APPLY.Factory;
using POSFILE_APPLY.Service;
using POSFILE_APPLY.Models;  // 加入 Models 參考
using System;
using System.Collections.Generic;
using System.IdentityModel.Claims;
using System.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Linq;
using System.Text;
using System.Web;
using System.Web.Mvc;
using X.PagedList;
using static DevExpress.Xpo.Helpers.AssociatedCollectionCriteriaHelper;
using HI_APACCESS_DLL_FRAMEWORK; // 引用 DLL
using Newtonsoft.Json;

namespace POSFILE_APPLY.Controllers
{
public class APController : POSFILE_APPLYBaseController
{
// 權限管理導向 Action（使用 DLL 新版本）
public ActionResult AP_ACCESS_SYS()
{
try
{
var req_para = new GetUrlRequsetModel()
{
sys_id = “HI_POSIMG”,  // 修正：使用正確的系統ID
environment = “TEST”,
type = “2”             // 類型2 = 權限設定
};

```
            string json_input = JsonConvert.SerializeObject(req_para);
            string response = new HI_APACCESS_DLL_FRAMEWORK.Class1().GetFunctionAndAccessUrl(json_input);
            GetUrlResponseModel response_ = JsonConvert.DeserializeObject<GetUrlResponseModel>(response);
            
            if (response_.code == "0000")
            {
                string script = $@"
                    <script>
                       window.open('{response_.url}', '_blank');                       
                       window.location.href='{Url.Action("Main","Home")}';
                    </script>";
                return Content(script, "text/html");
            }
            else
            {
                return Content($"<script>alert('取得權限管理連結失敗：{response_.message}');</script>", "text/html");
            }
        }
        catch (Exception ex)
        {
            return Content($"<script>alert('導向權限管理系統發生錯誤：{ex.Message}');</script>", "text/html");
        }
    }

    // 系統頁面定義管理導向 Action（使用 DLL 新版本）
    public ActionResult AP_ACCESS_SYS_FUNC()
    {
        try
        {
            var req_para = new GetUrlRequsetModel()
            {
                sys_id = "HI_POSIMG",
                environment = "TEST",
                type = "1"             // 類型1 = 頁面功能設定
            };
            
            string json_input = JsonConvert.SerializeObject(req_para);
            string response = new HI_APACCESS_DLL_FRAMEWORK.Class1().GetFunctionAndAccessUrl(json_input);
            GetUrlResponseModel response_ = JsonConvert.DeserializeObject<GetUrlResponseModel>(response);
            
            if (response_.code == "0000")
            {
                string script = $@"
                    <script>
                       window.open('{response_.url}', '_blank');                       
                       window.location.href='{Url.Action("Main","Home")}';
                    </script>";
                return Content(script, "text/html");
            }
            else
            {
                return Content($"<script>alert('取得頁面功能管理連結失敗：{response_.message}');</script>", "text/html");
            }
        }
        catch (Exception ex)
        {
            return Content($"<script>alert('導向權限管理系統發生錯誤：{ex.Message}');</script>", "text/html");
        }
    }

    // 測試 DLL 的方法
    public ActionResult TestDLL()
    {
        try
        {
            // 測試權限設定
            var req1 = new GetUrlRequsetModel()
            {
                sys_id = "HI_POSIMG",
                environment = "TEST",
                type = "2"
            };
            string json1 = JsonConvert.SerializeObject(req1);
            string response1 = new HI_APACCESS_DLL_FRAMEWORK.Class1().GetFunctionAndAccessUrl(json1);
            
            // 測試頁面功能設定
            var req2 = new GetUrlRequsetModel()
            {
                sys_id = "HI_POSIMG",
                environment = "TEST",
                type = "1"
            };
            string json2 = JsonConvert.SerializeObject(req2);
            string response2 = new HI_APACCESS_DLL_FRAMEWORK.Class1().GetFunctionAndAccessUrl(json2);
            
            string html = $@"
                <h3>DLL 測試結果</h3>
                <h4>權限設定 (類型2)：</h4>
                <pre>{response1}</pre>
                <h4>頁面功能設定 (類型1)：</h4>
                <pre>{response2}</pre>
            ";
            
            return Content(html, "text/html");
        }
        catch (Exception ex)
        {
            return Content($"<h3>DLL 測試失敗</h3><p>{ex.Message}</p>", "text/html");
        }
    }

    // 【保留】原本的方法（備用）
    public ActionResult AP_ACCESS_SYS_OLD()
    {
        try
        {
            string token = new JwtHelper().GenerateToken("HI_POSIMG", this.Emp_NO);
```

#if DEBUG
string url = $“http://localhost:53088/Home/TokenEntry?token={token}”;
#else
string url = $“http://10.8.254.68/HI_APACCESS_TEST/Home/TokenEntry?token={token}”;
#endif
string script = $@”
<script>
window.open(’{url}’, ‘_blank’);  
window.location.href=’{Url.Action(“Main”,“Home”)}’;
</script>”;
return Content(script, “text/html”);
}
catch (Exception ex)
{
return Content($”<script>alert(‘導向權限管理系統發生錯誤：{ex.Message}’);</script>”, “text/html”);
}
}

```
    public ActionResult AP_ACCESS_SYS_FUNC_OLD()
    {
        try
        {
            string token = new JwtHelper().GenerateToken("HI_POSIMG", this.Emp_NO);
```

#if DEBUG
string url = $“http://localhost:53088/Home/TokenEntry_FUNC?token={token}”;
#else
string url = $“http://10.8.254.68/HI_APACCESS_TEST/Home/TokenEntry_FUNC?token={token}”;
#endif
string script = $@”
<script>
window.open(’{url}’, ‘_blank’);  
window.location.href=’{Url.Action(“Main”, “Home”)}’;
</script>”;
return Content(script, “text/html”);
}
catch (Exception ex)
{
return Content($”<script>alert(‘導向權限管理系統發生錯誤：{ex.Message}’);</script>”, “text/html”);
}
}
}
}

