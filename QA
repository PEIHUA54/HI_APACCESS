        // 取得權限設定ViewModel
        public List<PermissionSettingViewModel> GetPermissionSettings(string apg_no = null)
        {
            string sql = @"
SELECT DISTINCT g.APG_NO, g.APG_NAME, f.FUNC_ID, f.FUNC_NA,
               CASE WHEN ufc.FUNC_ID IS NOT NULL THEN 1 ELSE 0 END as HasPagePermission,
              CASE 
        WHEN f.[PARENT_ID] IS NULL OR f.[PARENT_ID] = '' OR f.[PARENT_ID] = 'HOME' 
        THEN CAST(ISNULL(f.[SORT_NO], '999') AS VARCHAR(10)) + '.0'
        ELSE 
            ISNULL(
                (SELECT CAST(ISNULL(p.[SORT_NO], '999') AS VARCHAR(10)) + '.' + CAST(ISNULL(f.[SORT_NO], '999') AS VARCHAR(10))
                 FROM [HI_TMMAIN].[dbo].[AP_FUNC] p 
                 WHERE p.[FUNC_ID] = f.[PARENT_ID] AND p.[SYS_ID] = f.[SYS_ID]
                ), 
                '999.' + CAST(ISNULL(f.[SORT_NO], '999') AS VARCHAR(10))
            )
        END as SortPath
            FROM [HI_TMMAIN].[dbo].[AP_GROUP] g
            CROSS JOIN [HI_TMMAIN].[dbo].[AP_FUNC] f
            LEFT JOIN [HI_TMMAIN].[dbo].[AP_USER_FUNC_CONFIG] ufc 
                ON g.SYS_ID = ufc.SYS_ID AND g.APG_NO = ufc.APG_NO AND f.FUNC_ID = ufc.FUNC_ID
            WHERE g.SYS_ID = @SYS_ID AND f.SYS_ID = @SYS_ID
";

            List<SqlParameter> parameters = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", _sysId)
        };

            if (!string.IsNullOrEmpty(apg_no))
            {
                sql += " AND g.APG_NO = @APG_NO";
                parameters.Add(new SqlParameter("@APG_NO", apg_no));
            }

            sql += " ORDER BY g.APG_NO, SortPath, f.FUNC_ID";  // 修正排序邏輯

            DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);

            var result = new List<PermissionSettingViewModel>();
            foreach (DataRow row in dt.Rows)
            {
                var viewModel = new PermissionSettingViewModel
                {
                    APG_NO = row["APG_NO"].ToString(),
                    APG_NAME = row["APG_NAME"].ToString(),
                    FUNC_ID = row["FUNC_ID"].ToString(),
                    FUNC_NA = row["FUNC_NA"].ToString(),
                    HasPagePermission = Convert.ToBoolean(row["HasPagePermission"])
                };

                // 取得按鈕權限
                viewModel.ButtonPermissions = GetButtonPermissionItems(viewModel.APG_NO, viewModel.FUNC_ID);
                result.Add(viewModel);
            }

            return result;
        }
