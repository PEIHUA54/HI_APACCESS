好的，根據你提供的 Model，我重新寫一次完整的程式碼：

## 1. 新增員工相關 Model

```csharp
// 員工資料模型
public class EmployeeModel
{
    [Display(Name = "員工編號")]
    public string EMP_NO { get; set; }

    [Display(Name = "員工姓名")]
    public string EMP_NAME { get; set; }

    [Display(Name = "部門")]
    public string ORGAN_CAP { get; set; }

    [Display(Name = "階職")]
    public string POST_NAME { get; set; }
}

// 使用者權限查詢結果模型
public class UserPermissionQueryModel
{
    public UserModel UserInfo { get; set; }
    public List<PermissionSettingViewModel> Permissions { get; set; }
}
```

## 2. Controller 新增方法

```csharp
#region 查詢和員工相關 AJAX

// 查詢人員權限
[HttpGet]
public JsonResult SearchUserPermissions(string u_id)
{
    try
    {
        var service = GetAPService();
        var userInfo = service.GetUserPermissions(u_id);
        if (userInfo != null)
        {
            return Json(new { success = true, data = userInfo }, JsonRequestBehavior.AllowGet);
        }
        else
        {
            return Json(new { success = false, message = "查無此人員資料" }, JsonRequestBehavior.AllowGet);
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "查詢人員權限發生錯誤：" + ex.Message }, JsonRequestBehavior.AllowGet);
    }
}

// 取得員工清單
[HttpGet]
public JsonResult GetEmployeeList(string keyword = "")
{
    try
    {
        var service = GetAPService();
        var employees = service.GetEmployeeList(keyword);
        return Json(new { success = true, data = employees }, JsonRequestBehavior.AllowGet);
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "取得員工清單發生錯誤：" + ex.Message }, JsonRequestBehavior.AllowGet);
    }
}

// 根據員工編號取得員工資訊
[HttpGet]
public JsonResult GetEmployeeInfo(string emp_no)
{
    try
    {
        var service = GetAPService();
        var employee = service.GetEmployeeInfo(emp_no);
        if (employee != null)
        {
            return Json(new { success = true, data = employee }, JsonRequestBehavior.AllowGet);
        }
        else
        {
            return Json(new { success = false, message = "查無此員工" }, JsonRequestBehavior.AllowGet);
        }
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "取得員工資訊發生錯誤：" + ex.Message }, JsonRequestBehavior.AllowGet);
    }
}

#endregion
```

## 3. F_AP 新增方法

```csharp
#region 查詢和員工管理

// 查詢人員完整權限資訊
public UserPermissionQueryModel GetUserPermissions(string u_id)
{
    string sql = @"
    SELECT u.[SYS_ID], u.[APG_NO], g.[APG_NAME], u.[U_ID], u.[U_NAME], 
           u.[CREATOR], u.[CREATE_TIME], u.[EDITOR], u.[EDIT_TIME]
    FROM [HI_TMMAIN].[dbo].[AP_USER] u
    LEFT JOIN [HI_TMMAIN].[dbo].[AP_GROUP] g ON u.SYS_ID = g.SYS_ID AND u.APG_NO = g.APG_NO
    WHERE u.[SYS_ID] = @SYS_ID AND u.[U_ID] = @U_ID";

    List<SqlParameter> parameters = new List<SqlParameter>
    {
        new SqlParameter("@SYS_ID", _sysId),
        new SqlParameter("@U_ID", u_id)
    };

    DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
    if (dt.Rows.Count > 0)
    {
        var userInfo = SVS_DBmanager.ConvertToList<UserModel>(dt).FirstOrDefault();
        if (userInfo != null)
        {
            // 取得該使用者的群組權限
            var permissions = GetGroupPermissions(userInfo.APG_NO);
            return new UserPermissionQueryModel
            {
                UserInfo = userInfo,
                Permissions = permissions.data
            };
        }
    }
    return null;
}

// 取得員工清單
public List<EmployeeModel> GetEmployeeList(string keyword = "")
{
    string sql = @"
    SELECT [EMP_NO], [EMP_NAME], [ORGAN_CAP], [POST_NAME]
    FROM [HI_TMMAIN].[dbo].[VW_M1EMP_MAST]
    WHERE 1=1";

    List<SqlParameter> parameters = new List<SqlParameter>();

    if (!string.IsNullOrWhiteSpace(keyword))
    {
        sql += " AND ([EMP_NO] LIKE @KEYWORD OR [EMP_NAME] LIKE @KEYWORD)";
        parameters.Add(new SqlParameter("@KEYWORD", $"%{keyword}%"));
    }

    sql += " ORDER BY [EMP_NO]";

    DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
    return SVS_DBmanager.ConvertToList<EmployeeModel>(dt);
}

// 根據員工編號取得員工資訊
public EmployeeModel GetEmployeeInfo(string emp_no)
{
    string sql = @"
    SELECT [EMP_NO], [EMP_NAME], [ORGAN_CAP], [POST_NAME]
    FROM [HI_TMMAIN].[dbo].[VW_M1EMP_MAST]
    WHERE [EMP_NO] = @EMP_NO";

    List<SqlParameter> parameters = new List<SqlParameter>
    {
        new SqlParameter("@EMP_NO", emp_no)
    };

    DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
    var employees = SVS_DBmanager.ConvertToList<EmployeeModel>(dt);
    return employees.FirstOrDefault();
}

#endregion
```

## 4. 修改 View

在群組選擇區上方加入查詢功能：

```html
<!-- 查詢功能區 -->
<div class="search-section" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
    <div class="row align-items-center">
        <div class="col-md-2">
            <label class="form-label mb-0"><strong>查詢人員權限：</strong></label>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" class="form-control" id="searchUserId" placeholder="請輸入員工編號">
                <div class="input-group-append">
                    <button type="button" class="btn btn-info" onclick="searchUserPermissions()">
                        <i class="fas fa-search"></i> 查詢
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-secondary" onclick="clearSearch()">
                <i class="fas fa-times"></i> 清除
            </button>
        </div>
    </div>
</div>

<!-- 查詢結果顯示區 -->
<div id="searchResult" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
    <h6><i class="fas fa-user"></i> 查詢結果</h6>
    <div id="searchResultContent"></div>
</div>
```

修改使用者 Modal：

```html
<!-- 使用者 Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增使用者</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="userIdSelect">員工編號 <span class="text-danger">*</span></label>
                        <select class="form-control" id="userIdSelect" style="width: 100%;" required>
                            <option value="">-- 請選擇或輸入員工編號 --</option>
                        </select>
                        <small class="form-text text-muted">
                            可直接輸入員工編號搜尋，例如輸入 "3B7" 會顯示所有相關編號 (3B750、3B777...)
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="userName">員工姓名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="userName" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="userDept">部門</label>
                                <input type="text" class="form-control" id="userDept" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="userPost">階職</label>
                                <input type="text" class="form-control" id="userPost" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveUser()">儲存</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
```

## 5. JavaScript 新增功能

```javascript
// 查詢人員權限
function searchUserPermissions() {
    const userId = $('#searchUserId').val().trim();
    if (!userId) {
        alert('請輸入員工編號');
        return;
    }

    $.get('@Url.Action("SearchUserPermissions", "AP")', { u_id: userId }, function (response) {
        if (response.success) {
            displaySearchResult(response.data);
            $('#searchResult').show();
        } else {
            alert(response.message);
            $('#searchResult').hide();
        }
    }).fail(function() {
        alert('查詢失敗，請稍後再試');
        $('#searchResult').hide();
    });
}

// 顯示查詢結果
function displaySearchResult(data) {
    const userInfo = data.UserInfo;
    
    let html = `
        <div class="row">
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-6">
                        <strong>員工編號：</strong>${userInfo.U_ID}<br>
                        <strong>員工姓名：</strong>${userInfo.U_NAME}
                    </div>
                    <div class="col-md-6">
                        <strong>所屬群組：</strong>${userInfo.APG_NAME} (${userInfo.APG_NO})<br>
                        <strong>建立時間：</strong>${userInfo.CREATE_TIME || 'N/A'}
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-right">
                <button type="button" class="btn btn-primary btn-sm" onclick="loadUserGroup('${userInfo.APG_NO}')">
                    <i class="fas fa-eye"></i> 檢視該群組權限
                </button>
            </div>
        </div>`;

    $('#searchResultContent').html(html);
}

// 載入使用者群組
function loadUserGroup(apgNo) {
    $('#groupSelect').val(apgNo);
    loadGroupData();
    clearSearch();
}

// 清除查詢
function clearSearch() {
    $('#searchUserId').val('');
    $('#searchResult').hide();
}

// 初始化員工下拉選單（支援搜尋）
function initEmployeeSelect() {
    $('#userIdSelect').select2({
        ajax: {
            url: '@Url.Action("GetEmployeeList", "AP")',
            dataType: 'json',
            delay: 300,
            data: function (params) {
                return {
                    keyword: params.term || ''
                };
            },
            processResults: function (data) {
                if (data.success) {
                    return {
                        results: data.data.map(function(emp) {
                            return {
                                id: emp.EMP_NO,
                                text: `${emp.EMP_NO} - ${emp.EMP_NAME} (${emp.ORGAN_CAP})`,
                                empData: emp
                            };
                        })
                    };
                }
                return { results: [] };
            },
            cache: true
        },
        placeholder: '請輸入員工編號或姓名搜尋',
        allowClear: true,
        minimumInputLength: 0,
        language: {
            noResults: function() {
                return "查無相關員工資料";
            },
            searching: function() {
                return "搜尋中...";
            }
        }
    });

    // 監聽選擇事件
    $('#userIdSelect').on('select2:select', function (e) {
        onEmployeeSelect();
    });

    // 監聽清除事件
    $('#userIdSelect').on('select2:clear', function (e) {
        $('#userName, #userDept, #userPost').val('');
    });
}

// 員工選擇事件
function onEmployeeSelect() {
    const empNo = $('#userIdSelect').val();
    if (empNo) {
        $.get('@Url.Action("GetEmployeeInfo", "AP")', { emp_no: empNo }, function (response) {
            if (response.success) {
                const emp = response.data;
                $('#userName').val(emp.EMP_NAME || '');
                $('#userDept').val(emp.ORGAN_CAP || '');
                $('#userPost').val(emp.POST_NAME || '');
            } else {
                alert('取得員工資訊失敗：' + response.message);
            }
        }).fail(function() {
            alert('取得員工資訊失敗，請稍後再試');
        });
    } else {
        $('#userName, #userDept, #userPost').val('');
    }
}

// 修改 openUserModal 函數
function openUserModal() {
    $('#userForm')[0].reset();
    
    // 重新初始化 Select2
    if ($('#userIdSelect').hasClass('select2-hidden-accessible')) {
        $('#userIdSelect').select2('destroy');
    }
    
    initEmployeeSelect();
    $('#userModal').modal('show');
}

// 修改 saveUser 函數
function saveUser() {
    const formData = {
        APG_NO: currentGroup,
        U_ID: $('#userIdSelect').val(),
        U_NAME: $('#userName').val()
    };

    if (!formData.U_ID || !formData.U_NAME.trim()) {
        alert('請選擇員工');
        return;
    }

    $.post('@Url.Action("AddUser", "AP")', formData, function (response) {
        if (response.success) {
            alert(response.message);
            $('#userModal').modal('hide');
            loadUsers();
        } else {
            alert(response.message);
        }
    }).fail(function() {
        alert('新增失敗，請稍後再試');
    });
}

// 頁面載入時允許搜尋
$(document).ready(function () {
    loadGroups();
    loadAllFunctions();
    
    // 支援 Enter 鍵搜尋
    $('#searchUserId').on('keypress', function(e) {
        if (e.which === 13) {
            searchUserPermissions();
        }
    });
});
```

別忘了在頁面中引入 Select2：

```html
<!-- 在 head 中加入 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- 在 Scripts section 最前面加入 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
```

這樣就完成了：

1. 上方的人員權限查詢功能，可以查詢特定員工並自動載入其所屬群組權限
1. 新增人員時的智慧下拉選單，支援模糊搜尋（輸入 “3B7” 會顯示相關的 3B750、3B777 等）和自動填入員工資訊​​​​​​​​​​​​​​​​