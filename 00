/// <summary>
/// 匯出帳號清單 (Excel加密)
/// </summary>
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;


        // 1. 產生授權碼 (使用 HI_CODEGUARD_DLL)
        CODE_GUARD codeGuard = new CODE_GUARD();
        string getCodeRequest = JsonConvert.SerializeObject(new
        {
            SysID = systemId,
            Data = this.Emp_NO,
            CodeLength = 8
        });

        string getCodeResponse = codeGuard.GetCode(getCodeRequest);
        dynamic codeResult = JsonConvert.DeserializeObject(getCodeResponse);

        if (codeResult.Result_code != "0000")
        {
            return Content($"<script>alert('產生授權碼失敗: {codeResult.Msg}'); window.history.back();</script>", "text/html");
        }

        string authCode = codeResult.Code.ToString();

        // 2. 取得帳號清單
        var service = GetAPService();
        var userList = service.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('查無資料'); window.history.back();</script>", "text/html");
        }

        // 3. 產生加密 Excel (密碼 = 授權碼)
        string fileName = $"{DateTime.Now:yyyyMMddHHmmss}_匯出帳號清單";
        byte[] excelBytes = CreateEncryptedExcel(userList, systemId, authCode);

        // 4. 儲存記錄到資料庫
        var recordModel = new CodeGuardRecordModel
        {
            FILE_NAME = fileName,
            CODE_GUARD = authCode,
            CREATOR = this.Emp_NO,
            SYS_ID = systemId
        };

        var saveResult = service.SaveCodeGuardRecord(recordModel);
        //if (!saveResult)
        //{
        //    System.Diagnostics.Debug.WriteLine("儲存授權碼記錄失敗");
        //}

        // 5. 刪除超過3個月的舊記錄
        service.DeleteOldRecords();

        // 6. 顯示授權碼提示並下載
        TempData["AuthCode"] = authCode;
        TempData["FileName"] = fileName;

        // 7. 回傳加密的 Excel 檔案
        return File(excelBytes, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            $"{fileName}.xlsx");
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('匯出失敗: {ex.Message}'); window.history.back();</script>", "text/html");
    }
}

/// <summary>
/// 使用 NPOI 建立加密 Excel
/// </summary>
private byte[] CreateEncryptedExcel(List<UserExportModel> userList, string systemId, string password)
{
    try
    {
        // 1. 建立工作簿
        XSSFWorkbook workbook = new XSSFWorkbook();
        ISheet sheet = workbook.CreateSheet("帳號清單");

        // 2. 建立標題列樣式
        ICellStyle headerStyle = workbook.CreateCellStyle();
        headerStyle.FillForegroundColor = NPOI.HSSF.Util.HSSFColor.Grey25Percent.Index;
        headerStyle.FillPattern = FillPattern.SolidForeground;
        headerStyle.Alignment = HorizontalAlignment.Center;
        headerStyle.VerticalAlignment = VerticalAlignment.Center;

        // 設定邊框
        headerStyle.BorderTop = BorderStyle.Thin;
        headerStyle.BorderBottom = BorderStyle.Thin;
        headerStyle.BorderLeft = BorderStyle.Thin;
        headerStyle.BorderRight = BorderStyle.Thin;

        IFont headerFont = workbook.CreateFont();
        headerFont.IsBold = true;
        headerFont.FontHeightInPoints = 11;
        headerFont.FontName = "微軟正黑體";
        headerStyle.SetFont(headerFont);

        // 3. 建立資料列樣式
        ICellStyle cellStyle = workbook.CreateCellStyle();
        cellStyle.Alignment = HorizontalAlignment.Left;
        cellStyle.VerticalAlignment = VerticalAlignment.Center;
        cellStyle.BorderTop = BorderStyle.Thin;
        cellStyle.BorderBottom = BorderStyle.Thin;
        cellStyle.BorderLeft = BorderStyle.Thin;
        cellStyle.BorderRight = BorderStyle.Thin;

        IFont cellFont = workbook.CreateFont();
        cellFont.FontName = "微軟正黑體";
        cellStyle.SetFont(cellFont);

        // 4. 建立標題列
        IRow headerRow = sheet.CreateRow(0);
        string[] headers = new string[]
        {
    "系統", "帳號", "姓名", "群組代號", "群組名稱",
    "部門代號", "部門名稱", "建立人員", "建立日期", "修改人員", "修改日期"
        };

        for (int i = 0; i < headers.Length; i++)
        {
            ICell cell = headerRow.CreateCell(i);
            cell.SetCellValue(headers[i]);
            cell.CellStyle = headerStyle;
        }

        // 5. 填入資料
        int rowIndex = 1;
        foreach (var user in userList)
        {
            IRow dataRow = sheet.CreateRow(rowIndex);

            CreateStyledCell(dataRow, 0, systemId ?? "", cellStyle);
            CreateStyledCell(dataRow, 1, user.U_ID ?? "", cellStyle);
            CreateStyledCell(dataRow, 2, user.U_NAME ?? "", cellStyle);
            CreateStyledCell(dataRow, 3, user.APG_NO ?? "", cellStyle);
            CreateStyledCell(dataRow, 4, user.APG_NAME ?? "", cellStyle);
            CreateStyledCell(dataRow, 5, user.ORGAN_NO ?? "", cellStyle);
            CreateStyledCell(dataRow, 6, user.ORGAN_CAP ?? "", cellStyle);
            CreateStyledCell(dataRow, 7, user.CREATOR ?? "", cellStyle);
            CreateStyledCell(dataRow, 8, user.CREATE_TIME ?? "", cellStyle);
            CreateStyledCell(dataRow, 9, user.EDITOR ?? "", cellStyle);
            CreateStyledCell(dataRow, 10, user.EDIT_TIME ?? "", cellStyle);

            rowIndex++;
        }

        // 6. 自動調整欄寬
        for (int i = 0; i < headers.Length; i++)
        {
            sheet.AutoSizeColumn(i);
            // 加一點額外寬度讓內容更好看
            int currentWidth = (int)sheet.GetColumnWidth(i);
            sheet.SetColumnWidth(i, currentWidth + 1000);
        }

        // 7. 凍結首列
        sheet.CreateFreezePane(0, 1);

        // 8. 將工作簿寫入未加密的串流
        byte[] unencryptedBytes;
        using (MemoryStream ms = new MemoryStream())
        {
            workbook.Write(ms, false);
            unencryptedBytes = ms.ToArray();
        }
        workbook.Close();

        // 9. 加密 Excel 檔案
        byte[] encryptedBytes = EncryptExcelFile(unencryptedBytes, password);

        return encryptedBytes;
    }
    catch (Exception ex)
    {
        throw new Exception($"建立 Excel 失敗: {ex.Message}", ex);
    }
}

/// <summary>
/// 建立帶樣式的儲存格
/// </summary>
private void CreateStyledCell(IRow row, int columnIndex, string value, ICellStyle style)
{
    ICell cell = row.CreateCell(columnIndex);
    cell.SetCellValue(value);
    cell.CellStyle = style;
}

/// <summary>
/// 加密 Excel 檔案
/// </summary>
private byte[] EncryptExcelFile(byte[] excelBytes, string password)
{
    try
    {
        // 讀取未加密的 Excel
        using (MemoryStream inputStream = new MemoryStream(excelBytes))
        {
            // 建立 POIFSFileSystem
            POIFSFileSystem fs = new POIFSFileSystem();

            // 建立加密資訊 (使用 Agile 加密模式)
            EncryptionInfo info = new EncryptionInfo(EncryptionMode.Agile);
            Encryptor enc = info.Encryptor;

            // 設定密碼
            enc.ConfirmPassword(password);

            // 將 Excel 內容寫入加密串流
            using (Stream encryptedStream = enc.GetDataStream(fs))
            {
                inputStream.Position = 0;
                inputStream.CopyTo(encryptedStream);
            }

            // 輸出加密後的檔案
            using (MemoryStream outputStream = new MemoryStream())
            {
                fs.WriteFileSystem(outputStream);
                fs.Close();
                return outputStream.ToArray();
            }
        }
    }
    catch (Exception ex)
    {
        throw new Exception($"Excel 加密失敗: {ex.Message}", ex);
    }
}

/// <summary>
/// 查看匯出記錄
/// </summary>
[HttpGet]
public ActionResult ExportRecords()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        string employeeNo = Session["UserID"] as string;

        if (string.IsNullOrEmpty(employeeNo))
        {
            return Content("<script>alert('無法取得員工編號'); window.history.back();</script>", "text/html");
        }

        var service = GetAPService();
        var records = service.GetMyExportRecords(employeeNo, systemId);

        return View(records);
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('查詢失敗: {ex.Message}'); window.history.back();</script>", "text/html");
    }
}


f_ap:
        // 取得所有使用者清單(用於匯出)
        public List<UserExportModel> GetAllUsersForExport(string systemId)
        {
            string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.GetAllUsersForExport);

            List<SqlParameter> parameters = new List<SqlParameter>
            {
                new SqlParameter("@SYS_ID", systemId)
            };

            DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
            return SVS_DBmanager.ConvertToList<UserExportModel>(dt);
        }

        /// <summary>
        /// 儲存授權碼記錄
        /// </summary>
        public string SaveCodeGuardRecord(CodeGuardRecordModel model)
        {
            string sql = @"
 INSERT INTO [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
       ([FILE_NAME], [CODE_GUARD], [CREATOR], [CREATE_TIME])
 VALUES
       (@FILE_NAME, @CODE_GUARD, @CREATOR, GETDATE())
";

            List<SqlParameter> parameters = new List<SqlParameter>
                {
                    new SqlParameter("@FILE_NAME", model.FILE_NAME ?? (object)DBNull.Value),
                    new SqlParameter("@CODE_GUARD", model.CODE_GUARD ?? (object)DBNull.Value),
                    new SqlParameter("@CREATOR", model.CREATOR ?? (object)DBNull.Value),
                    //new SqlParameter("@SYS_ID", string.IsNullOrEmpty(model.SYS_ID) ? (object)DBNull.Value : model.SYS_ID)
                };

            return SVS_DBmanager.ExecuteSQL(sql, parameters);
        }

        /// <summary>
        /// 取得個人匯出記錄(最近3個月)
        /// </summary>
        public List<ExportRecordViewModel> GetMyExportRecords(string creator, string systemId)
        {
            try
            {
                string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.GetMyExportRecords);

                List<SqlParameter> parameters = new List<SqlParameter>
                {
                    new SqlParameter("@CREATOR", creator ?? (object)DBNull.Value),
                    new SqlParameter("@SYS_ID", systemId ?? (object)DBNull.Value)
                };

                DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
                return SVS_DBmanager.ConvertToList<ExportRecordViewModel>(dt);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"查詢匯出記錄失敗: {ex.Message}");
                return new List<ExportRecordViewModel>();
            }
        }

        /// <summary>
        /// 刪除超過3個月的記錄
        /// </summary>
        public string DeleteOldRecords()
        {
            string sql = @"
 DELETE FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
                WHERE [CREATE_TIME] < DATEADD(MONTH, -3, GETDATE()
";

            return SVS_DBmanager.ExecuteSQL(sql);
        }
