對!你說得對!單筆新增也需要這兩個檢查。讓我補上:

-----

## 修正 F_AP 的 ValidateEmployeeForInsert 方法

```csharp
/// <summary>
/// 單筆新增時驗證員工 (對外公開方法)
/// </summary>
/// <param name="sysId">系統ID</param>
/// <param name="apgNo">群組編號</param>
/// <param name="empNo">員工編號</param>
/// <param name="creator">建立者</param>
/// <param name="empName">員工姓名(輸出)</param>
/// <returns>錯誤訊息,null表示驗證通過</returns>
public string ValidateEmployeeForInsert(string sysId, string apgNo, string empNo, string creator, out string empName)
{
    empName = string.Empty;

    try
    {
        // 1. ⭐ 使用 DLL 檢查員工是否存在及是否離職
        if (!ValidateEmployee(empNo, out empName, out string errorMessage))
        {
            return errorMessage;
        }

        // 2. ⭐ 檢查是否已存在於同一個群組
        string checkUserSql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.ProcessUserRow_chkuser);
        var checkUserParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@AN", SqlDbType.VarChar, 3) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = empNo },
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };
        var userResult = SVS_DBmanager.QueryBySQL(checkUserSql, checkUserParams);

        if (Convert.ToInt32(userResult.Rows[0][0]) > 0)
        {
            return "此群組已存在該員工";
        }

        // 3. ⭐ 檢查是否已存在於該系統的其他群組
        string checkSystemSql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.ProcessUserRow_chksys);
        var checkSystemParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@AN", SqlDbType.VarChar, 3) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = empNo },
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };
        var systemResult = SVS_DBmanager.QueryBySQL(checkSystemSql, checkSystemParams);

        if (Convert.ToInt32(systemResult.Rows[0][0]) > 0)
        {
            return "此系統其他群組已存在該員工";
        }

        return null; // 驗證通過
    }
    catch (Exception ex)
    {
        return "驗證員工時發生錯誤：" + ex.Message;
    }
}
```

-----

## 修正 Controller 的 AddUser

```csharp
// 新增使用者
[HttpPost]
public JsonResult AddUser([Bind] UserModel model)
{
    try
    {
        model.SYS_ID = CurrentSystemId;

        if (ModelState.IsValid)
        {
            var service = GetAPService();
            
            // ⭐ 傳入完整參數進行檢查
            string validationError = service.ValidateEmployeeForInsert(
                CurrentSystemId,    // sysId
                model.APG_NO,       // apgNo
                model.U_ID,         // empNo
                Emp_NO,             // creator
                out string empName  // empName (輸出)
            );
            
            if (validationError != null)
            {
                return Json(new { success = false, message = validationError });
            }

            // 如果 model.U_NAME 是空的,使用從 DLL 取得的姓名
            if (string.IsNullOrWhiteSpace(model.U_NAME))
            {
                model.U_NAME = empName;
            }

            var result = service.InsertUser(model, Emp_NO);
            if (result == null || !result.Contains("fail"))
            {
                return Json(new { success = true, message = "使用者新增成功" });
            }
            else
            {
                return Json(new { success = false, message = "使用者新增失敗：" + result });
            }
        }
        return Json(new { success = false, message = "資料驗證失敗" });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "新增使用者發生錯誤：" + ex.Message });
    }
}
```

-----

## 完整的 F_AP 三個方法

```csharp
/// <summary>
/// 呼叫 DLL 檢查員工是否存在及是否離職
/// </summary>
/// <param name="empNo">員工編號</param>
/// <param name="empName">員工姓名(輸出)</param>
/// <param name="errorMessage">錯誤訊息(輸出)</param>
/// <returns>true:可以使用, false:不可使用</returns>
private bool ValidateEmployee(string empNo, out string empName, out string errorMessage)
{
    empName = string.Empty;
    errorMessage = string.Empty;

    try
    {
        var request = new
        {
            Type = "3",
            EmpNoList = new List<string> { empNo },
            Environment = EnvHelper.EnvironmentForDll()
        };

        string requestJson = JsonConvert.SerializeObject(request);
        string responseJson = new HI_APACCESS_DLL.APACCESS().GetEmpMast(requestJson);
        
        var response = JsonConvert.DeserializeObject<GetEmpMastModel.GetEmpMastResponse>(responseJson);

        if (response.Result == null || response.Result.Count == 0)
        {
            errorMessage = "查無此員工";
            return false;
        }

        var empData = response.Result[0];
        empName = empData.EmpName;

        if (!string.IsNullOrEmpty(empData.EndDate?.Trim()))
        {
            errorMessage = $"此員工已離職 (離職日期: {empData.EndDate})";
            return false;
        }

        if (empName.Length > 20)
        {
            errorMessage = "員工姓名長度超過20個字元";
            return false;
        }

        return true;
    }
    catch (Exception ex)
    {
        errorMessage = "查詢員工資料時發生錯誤：" + ex.Message;
        return false;
    }
}

/// <summary>
/// 單筆新增時驗證員工 (對外公開方法)
/// </summary>
/// <param name="sysId">系統ID</param>
/// <param name="apgNo">群組編號</param>
/// <param name="empNo">員工編號</param>
/// <param name="creator">建立者</param>
/// <param name="empName">員工姓名(輸出)</param>
/// <returns>錯誤訊息,null表示驗證通過</returns>
public string ValidateEmployeeForInsert(string sysId, string apgNo, string empNo, string creator, out string empName)
{
    empName = string.Empty;

    try
    {
        // 1. 使用 DLL 檢查員工是否存在及是否離職
        if (!ValidateEmployee(empNo, out empName, out string errorMessage))
        {
            return errorMessage;
        }

        // 2. 檢查是否已存在於同一個群組
        string checkUserSql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.ProcessUserRow_chkuser);
        var checkUserParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@AN", SqlDbType.VarChar, 3) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = empNo },
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };
        var userResult = SVS_DBmanager.QueryBySQL(checkUserSql, checkUserParams);

        if (Convert.ToInt32(userResult.Rows[0][0]) > 0)
        {
            return "此群組已存在該員工";
        }

        // 3. 檢查是否已存在於該系統的其他群組
        string checkSystemSql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.ProcessUserRow_chksys);
        var checkSystemParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@AN", SqlDbType.VarChar, 3) { Value = apgNo },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = empNo },
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };
        var systemResult = SVS_DBmanager.QueryBySQL(checkSystemSql, checkSystemParams);

        if (Convert.ToInt32(systemResult.Rows[0][0]) > 0)
        {
            return "此系統其他群組已存在該員工";
        }

        return null; // 驗證通過
    }
    catch (Exception ex)
    {
        return "驗證員工時發生錯誤：" + ex.Message;
    }
}

/// <summary>
/// 處理單筆員工資料 (批次匯入用)
/// </summary>
private bool ProcessUserRow((int RowNumber, string EmpNo) row, string sysId, string an, string creator, ImportResult result)
{
    try
    {
        // 1. 使用 DLL 檢查員工
        if (!ValidateEmployee(row.EmpNo, out string empName, out string errorMessage))
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = errorMessage
            });
            return false;
        }

        // 2. 檢查是否已存在於同一個群組
        string checkUserSql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.ProcessUserRow_chkuser);
        var checkUserParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@AN", SqlDbType.VarChar, 3) { Value = an },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo },
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };
        var userResult = SVS_DBmanager.QueryBySQL(checkUserSql, checkUserParams);

        if (Convert.ToInt32(userResult.Rows[0][0]) > 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "此群組已存在該員工"
            });
            return false;
        }

        // 3. 檢查是否已存在於該系統的其他群組
        string checkSystemSql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.ProcessUserRow_chksys);
        var checkSystemParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@AN", SqlDbType.VarChar, 3) { Value = an },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo },
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };
        var systemResult = SVS_DBmanager.QueryBySQL(checkSystemSql, checkSystemParams);

        if (Convert.ToInt32(systemResult.Rows[0][0]) > 0)
        {
            result.ErrorMessages.Add(new ImportError
            {
                RowNumber = row.RowNumber,
                EmpNo = row.EmpNo,
                Message = "此系統其他群組已存在該員工"
            });
            return false;
        }

        // 4. 寫入 AP_USER
        string insertSql = @"
    INSERT INTO AP_USER(SYS_ID, APG_NO, U_ID, U_NAME, CREATOR, CREATE_TIME)
    SELECT @SYS_ID, @AN, @U_ID, @U_NAME, @CREATOR, GETDATE()
    WHERE EXISTS (
        SELECT 1 FROM AP_USER
        WHERE SYS_ID = @SYS_ID
          AND (APG_NO = @AN OR APG_NO = '001')
          AND U_ID = @CREATOR
    )";
        var insertParams = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", SqlDbType.VarChar, 30) { Value = sysId },
            new SqlParameter("@AN", SqlDbType.VarChar, 3) { Value = an },
            new SqlParameter("@U_ID", SqlDbType.VarChar, 10) { Value = row.EmpNo },
            new SqlParameter("@U_NAME", SqlDbType.NVarChar, 20) { Value = empName },
            new SqlParameter("@CREATOR", SqlDbType.VarChar, 10) { Value = creator }
        };

        SVS_DBmanager.ExecuteSQL(insertSql, insertParams);

        return true;
    }
    catch (Exception exRow)
    {
        result.ErrorMessages.Add(new ImportError
        {
            RowNumber = row.RowNumber,
            EmpNo = row.EmpNo,
            Message = "寫入錯誤：" + exRow.Message
        });
        return false;
    }
}
```

-----

## 檢查流程總結

**單筆新增 (AddUser):**

1. ✅ 檢查員工是否存在
1. ✅ 檢查員工是否離職
1. ✅ 檢查此群組是否已有該員工
1. ✅ 檢查其他群組是否已有該員工

**批次匯入 (ImportUsers → ProcessUserRow):**

1. ✅ 檢查員工是否存在
1. ✅ 檢查員工是否離職
1. ✅ 檢查此群組是否已有該員工
1. ✅ 檢查其他群組是否已有該員工

現在單筆新增跟批次匯入的檢查邏輯完全一致了!​​​​​​​​​​​​​​​​