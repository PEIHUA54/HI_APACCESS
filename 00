å¥½çš„!ä½ çš„æƒ³æ³•æ˜¯å°çš„,åœ¨ `Data` æ¬„ä½åŠ ä¸Šæ™‚é–“æˆ³è¨˜,ç¢ºä¿æ¯æ¬¡ç”¢ç”Ÿçš„æˆæ¬Šç¢¼éƒ½ä¸åŒã€‚

-----

## ğŸ”§ ä¿®æ”¹æ–¹æ¡ˆ

### âœ… åªéœ€è¦æ”¹ Controller å‘¼å«çš„åœ°æ–¹

**å…¶ä»–éƒ½ä¸ç”¨æ”¹!** HI_CODEGUARD_DLL çš„é‚è¼¯ä¿æŒä¸è®Šã€‚

-----

## ğŸ“ Controller ä¿®æ”¹

### APController.cs - ExportUserList æ–¹æ³•

```csharp
/// <summary>
/// åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (ExcelåŠ å¯† - ä½¿ç”¨ EPPlus)
/// </summary>
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;

        // 1. ç”¢ç”Ÿæˆæ¬Šç¢¼ (Data åŠ ä¸Šæ™‚é–“æˆ³è¨˜)
        CODE_GUARD codeGuard = new CODE_GUARD();
        
        // â­ åŠ ä¸Šå®Œæ•´æ™‚é–“æˆ³è¨˜ (å¹´æœˆæ—¥æ™‚åˆ†ç§’)
        string timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
        string dataWithTimestamp = this.Emp_NO + timestamp;
        
        string getCodeRequest = JsonConvert.SerializeObject(new
        {
            SysID = systemId,
            Data = dataWithTimestamp,  // â­ ä¾‹å¦‚: "3750" + "20251205085414" = "375020251205085414"
            CodeLength = 8
        });

        string getCodeResponse = codeGuard.GetCode(getCodeRequest);
        dynamic codeResult = JsonConvert.DeserializeObject(getCodeResponse);

        if (codeResult.Result_code != "0000")
        {
            return Content($"<script>alert('ç”¢ç”Ÿæˆæ¬Šç¢¼å¤±æ•—: {codeResult.Msg}'); window.history.back();</script>", "text/html");
        }

        string authCode = codeResult.Code.ToString();

        // 2. å–å¾—å¸³è™Ÿæ¸…å–®
        var service = GetAPService();
        var userList = service.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
        }

        // 3. ç”¢ç”ŸåŠ å¯† Excel
        string fileName = $"{DateTime.Now:yyyyMMddHHmmss}_åŒ¯å‡ºå¸³è™Ÿæ¸…å–®";
        byte[] excelBytes = CreateEncryptedExcel(userList, systemId, authCode);

        // 4. å„²å­˜è¨˜éŒ„åˆ°è³‡æ–™åº«
        var recordModel = new CodeGuardRecordModel
        {
            FILE_NAME = fileName,
            CODE_GUARD = authCode,
            CREATOR = this.Emp_NO,
            SYS_ID = systemId
        };

        service.SaveCodeGuardRecord(recordModel);

        // 5. åˆªé™¤è¶…é3å€‹æœˆçš„èˆŠè¨˜éŒ„
        service.DeleteOldRecords();

        // 6. å„²å­˜æˆæ¬Šç¢¼åˆ° TempData (ä¾›å‰ç«¯é¡¯ç¤º)
        TempData["AuthCode"] = authCode;
        TempData["FileName"] = fileName;

        // 7. å›å‚³åŠ å¯†çš„ Excel æª”æ¡ˆ
        return File(excelBytes, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            $"{fileName}.xlsx");
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—: {ex.Message}'); window.history.back();</script>", "text/html");
    }
}
```

-----

## ğŸ” ä¿®æ”¹èªªæ˜

### ä¿®æ”¹å‰:

```csharp
string getCodeRequest = JsonConvert.SerializeObject(new
{
    SysID = systemId,           // "HI_POS"
    Data = this.Emp_NO,         // "3750"
    CodeLength = 8
});
```

**å•é¡Œ:** åŒä¸€åˆ†é˜å…§,ç›¸åŒå“¡å·¥å¤šæ¬¡åŒ¯å‡ºæœƒç”¢ç”Ÿç›¸åŒæˆæ¬Šç¢¼ã€‚

-----

### ä¿®æ”¹å¾Œ:

```csharp
// â­ åŠ ä¸Šæ™‚é–“æˆ³è¨˜
string timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
string dataWithTimestamp = this.Emp_NO + timestamp;

string getCodeRequest = JsonConvert.SerializeObject(new
{
    SysID = systemId,                // "HI_POS"
    Data = dataWithTimestamp,        // "375020251205085414"
    CodeLength = 8
});
```

**æ•ˆæœ:**

- ç¬¬1æ¬¡åŒ¯å‡º (08:54:14): `Data = "375020251205085414"` â†’ æˆæ¬Šç¢¼: `A1B2C3D4`
- ç¬¬2æ¬¡åŒ¯å‡º (08:54:25): `Data = "375020251205085425"` â†’ æˆæ¬Šç¢¼: `X7Y8Z9W0`
- **æ¯ç§’éƒ½ä¸åŒ!**

-----

## âœ… é©—è­‰æˆæ¬Šç¢¼ä¸ç”¨æ”¹

### VerifyCode é‚è¼¯åˆ†æ

ä½ çš„ `VerifyCode` æ‡‰è©²æ˜¯æª¢æŸ¥:

1. æˆæ¬Šç¢¼æ˜¯å¦åœ¨æœ‰æ•ˆæ™‚é–“å…§ (ä¾‹å¦‚ 3 åˆ†é˜)
1. æˆæ¬Šç¢¼æ ¼å¼æ˜¯å¦æ­£ç¢º

**å› ç‚º:**

- æˆæ¬Šç¢¼å·²ç¶“å„²å­˜åœ¨è³‡æ–™åº« `CODEGUARD_RECORD.CODE_GUARD`
- Excel å¯†ç¢¼å°±æ˜¯é€™å€‹æˆæ¬Šç¢¼
- é©—è­‰æ™‚åªéœ€è¦æ¯”å°è³‡æ–™åº«ä¸­çš„æˆæ¬Šç¢¼å³å¯

**æ‰€ä»¥é©—è­‰é‚è¼¯å®Œå…¨ä¸ç”¨æ”¹!**

-----

## ğŸ“Š å®Œæ•´æµç¨‹åœ–

### ç”¢ç”Ÿæˆæ¬Šç¢¼:

```
å“¡å·¥ç·¨è™Ÿ + æ™‚é–“æˆ³è¨˜ â†’ HI_CODEGUARD_DLL â†’ æˆæ¬Šç¢¼
"3750" + "20251205085414" â†’ GetCode() â†’ "A1B2C3D4"
                          â†“
                    å„²å­˜åˆ°è³‡æ–™åº«
                    CODE_GUARD = "A1B2C3D4"
                          â†“
                    ä½œç‚º Excel å¯†ç¢¼
```

### é©—è­‰æˆæ¬Šç¢¼:

```
ä½¿ç”¨è€…è¼¸å…¥æˆæ¬Šç¢¼ â†’ æŸ¥è©¢è³‡æ–™åº« â†’ æ¯”å°
"A1B2C3D4" â†’ SELECT * WHERE CODE_GUARD = "A1B2C3D4" â†’ âœ… æ‰¾åˆ°è¨˜éŒ„
```

-----

## ğŸ¯ æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦ 1: ç›¸åŒå“¡å·¥é€£çºŒåŒ¯å‡º

```
æ™‚é–“: 2025-12-05 08:54:14
Data: "375020251205085414"
æˆæ¬Šç¢¼: A1B2C3D4

æ™‚é–“: 2025-12-05 08:54:25
Data: "375020251205085425"
æˆæ¬Šç¢¼: X7Y8Z9W0  â† ä¸åŒ!
```

### æ¸¬è©¦ 2: ä¸åŒå“¡å·¥åŒæ™‚åŒ¯å‡º

```
å“¡å·¥ 3750:
Data: "375020251205085414"
æˆæ¬Šç¢¼: A1B2C3D4

å“¡å·¥ 3751:
Data: "375120251205085414"
æˆæ¬Šç¢¼: P9Q8R7S6  â† ä¸åŒ!
```

-----

## ğŸ’¡ å…¶ä»–å¯èƒ½éœ€è¦æ³¨æ„çš„

### 1. å¦‚æœä½ æœ‰ VerifyCode åŠŸèƒ½

å¦‚æœä½ çš„ç³»çµ±æœ‰è®“ä½¿ç”¨è€…æ‰‹å‹•é©—è­‰æˆæ¬Šç¢¼çš„åŠŸèƒ½:

```csharp
// VerifyCode ä¸ç”¨æ”¹,å› ç‚º:
// 1. æˆæ¬Šç¢¼å·²ç¶“å­˜åœ¨è³‡æ–™åº«
// 2. ç›´æ¥æ¯”å°å³å¯

public ActionResult VerifyAuthCode(string authCode)
{
    var service = GetAPService();
    var record = service.FindRecordByCode(authCode);
    
    if (record != null)
    {
        return Json(new { success = true, message = "æˆæ¬Šç¢¼æœ‰æ•ˆ" });
    }
    else
    {
        return Json(new { success = false, message = "æˆæ¬Šç¢¼ç„¡æ•ˆæˆ–å·²éæœŸ" });
    }
}
```

### 2. å¦‚æœä½ æƒ³é™åˆ¶æˆæ¬Šç¢¼æœ‰æ•ˆæœŸ

åœ¨ Factory çš„æŸ¥è©¢ä¸­åŠ ä¸Šæ™‚é–“åˆ¤æ–·:

```csharp
public CodeGuardRecordModel FindRecordByCode(string authCode)
{
    string sql = @"
        SELECT TOP 1 *
        FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
        WHERE [CODE_GUARD] = @CODE_GUARD
          AND [CREATE_TIME] >= DATEADD(MINUTE, -3, GETDATE())  -- 3åˆ†é˜å…§æœ‰æ•ˆ
        ORDER BY [CREATE_TIME] DESC
    ";
    
    // ... åŸ·è¡ŒæŸ¥è©¢
}
```

-----

## âœ… ç¸½çµ

### éœ€è¦ä¿®æ”¹:

- âœ… **Controller** - åœ¨ `ExportUserList` åŠ ä¸Šæ™‚é–“æˆ³è¨˜

### ä¸éœ€è¦ä¿®æ”¹:

- âœ… **HI_CODEGUARD_DLL** - é‚è¼¯å®Œå…¨ä¸è®Š
- âœ… **VerifyCode** - é©—è­‰é‚è¼¯ä¸è®Š
- âœ… **Factory** - è³‡æ–™åº«æ“ä½œä¸è®Š
- âœ… **Model** - è³‡æ–™çµæ§‹ä¸è®Š
- âœ… **View** - å‰ç«¯é¡¯ç¤ºä¸è®Š

-----

å®Œæˆ! ğŸ‰

ç¾åœ¨æ¯æ¬¡åŒ¯å‡ºéƒ½æœƒç”¢ç”Ÿä¸åŒçš„æˆæ¬Šç¢¼,å³ä½¿åŒä¸€å€‹å“¡å·¥åœ¨åŒä¸€åˆ†é˜å…§é€£çºŒåŒ¯å‡ºä¹Ÿä¸æœƒé‡è¤‡!â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹