å•Š!æˆ‘ç†è§£éŒ¯äº†!ä½ èªªå¾—å°! ğŸ¯

-----

## âœ… æ­£ç¢ºçš„åšæ³•:æ”¹ DLL

**å› ç‚ºé€™å€‹ DLL æ˜¯çµ¦å¾ˆå¤šåœ°æ–¹ä½¿ç”¨çš„,æ‰€ä»¥æ‡‰è©²åœ¨ DLL å…§éƒ¨å°±è™•ç†å¥½æ™‚é–“æˆ³è¨˜çš„é‚è¼¯,è€Œä¸æ˜¯æ¯å€‹å‘¼å«çš„åœ°æ–¹éƒ½è¦è¨˜å¾—åŠ ã€‚**

-----

## ğŸ”§ ä¿®æ”¹ HI_CODEGUARD_DLL

### FGetCode.cs ä¿®æ”¹

```csharp
internal class FGetCode
{
    // ç”¢æˆæ¬Šç¢¼
    public MGetCode.GetCodeResponse Execute(string sysID, string data, int codeLength)
    {
        var response = new MGetCode.GetCodeResponse();

        try
        {
            // åƒæ•¸é©—è­‰
            if (string.IsNullOrWhiteSpace(sysID))
            {
                response.Result_code = Common.Codes.PARAMETER_ERROR;
                response.Msg = "ç³»çµ±IDä¸å¯ç‚ºç©º";
                return response;
            }

            if (string.IsNullOrWhiteSpace(data))
            {
                response.Result_code = Common.Codes.PARAMETER_ERROR;
                response.Msg = "è³‡æ–™ä¸å¯ç‚ºç©º";
                return response;
            }

            if (codeLength <= 0)
            {
                response.Result_code = Common.Codes.PARAMETER_ERROR;
                response.Msg = "æˆæ¬Šç¢¼é•·åº¦å¿…é ˆå¤§æ–¼0";
                return response;
            }

            // ç”¢ç”Ÿæˆæ¬Šç¢¼
            string code = GetCode(sysID, data, codeLength);

            response.Result_code = Common.Codes.SUCCESS;
            response.Msg = "æˆåŠŸ";
            response.Code = code; 
        }
        catch (Exception ex)
        {
            response.Result_code = Common.Codes.SYSTEM_ERROR;
            response.Msg = "ç”¢ç”Ÿæˆæ¬Šç¢¼å¤±æ•—ï¼š" + ex.Message;
        }

        return response;
    }

    // è¨ˆç®—æˆæ¬Šç¢¼
    private string GetCode(string sysId, string data, int codeLength)
    {
        DateTime now = DateTime.Now;

        // â­â­â­ é—œéµä¿®æ”¹:åŠ ä¸Šå®Œæ•´æ™‚é–“æˆ³è¨˜åˆ° data â­â­â­
        string timestamp = now.ToString("yyyyMMddHHmmss");
        string dataWithTimestamp = data + timestamp;

        // æ™‚é–“ç²¾ç¢ºåˆ°åˆ†é˜,ç§’æ•¸è¨­ç‚º0
        DateTime tryTime = new DateTime(now.Year, now.Month, now.Day,
               now.Hour, now.Minute, 0);
        string timeStr = tryTime.ToString("yyyy-MM-dd HH:mm:ss");

        // â­ çµ„åˆåŸå§‹å­—ä¸²: ç³»çµ±ID + è³‡æ–™(å«æ™‚é–“æˆ³è¨˜) + æ™‚é–“
        string rawString = sysId + dataWithTimestamp + timeStr;

        byte[] inputBytes = Encoding.UTF8.GetBytes(rawString);

        // SHA256 é›œæ¹Šè™•ç†
        using (SHA256 sha256 = SHA256.Create())
        {
            byte[] hashBytes = sha256.ComputeHash(inputBytes);
            StringBuilder hex = new StringBuilder();
            foreach (byte b in hashBytes)
            {
                hex.AppendFormat("{0:X2}", b);
            }

            // å–å‰Nç¢¼ä½œç‚ºæˆæ¬Šç¢¼
            string fullHash = hex.ToString();
            if (codeLength > fullHash.Length)
                codeLength = fullHash.Length;

            return fullHash.Substring(0, codeLength).ToUpper();
        }
    }
}
```

-----

## ğŸ“ ä¿®æ”¹èªªæ˜

### ä¿®æ”¹å‰:

```csharp
private string GetCode(string sysId, string data, int codeLength)
{
    DateTime tryTime = DateTime.Now;
    tryTime = new DateTime(tryTime.Year, tryTime.Month, tryTime.Day,
           tryTime.Hour, tryTime.Minute, 0);
    string timeStr = tryTime.ToString("yyyy-MM-dd HH:mm:ss");

    // âŒ åŸæœ¬:ç›´æ¥ç”¨ data
    string rawString = sysId + data + timeStr;
    
    // ...
}
```

### ä¿®æ”¹å¾Œ:

```csharp
private string GetCode(string sysId, string data, int codeLength)
{
    DateTime now = DateTime.Now;

    // â­ åŠ ä¸Šå®Œæ•´æ™‚é–“æˆ³è¨˜åˆ° data
    string timestamp = now.ToString("yyyyMMddHHmmss");
    string dataWithTimestamp = data + timestamp;

    // æ™‚é–“ç²¾ç¢ºåˆ°åˆ†é˜
    DateTime tryTime = new DateTime(now.Year, now.Month, now.Day,
           now.Hour, now.Minute, 0);
    string timeStr = tryTime.ToString("yyyy-MM-dd HH:mm:ss");

    // âœ… ä½¿ç”¨åŠ ä¸Šæ™‚é–“æˆ³è¨˜çš„ data
    string rawString = sysId + dataWithTimestamp + timeStr;
    
    // ...
}
```

-----

## ğŸ¯ æ•ˆæœèªªæ˜

### å‘¼å«ç«¯ (Controller) ä¸ç”¨æ”¹:

```csharp
// âœ… å‘¼å«ç«¯ç¶­æŒåŸæ¨£,ä¸ç”¨åŠ æ™‚é–“æˆ³è¨˜
string getCodeRequest = JsonConvert.SerializeObject(new
{
    SysID = systemId,      // "HI_POS"
    Data = this.Emp_NO,    // "3750"  â† å°±å‚³å“¡å·¥ç·¨è™Ÿå°±å¥½
    CodeLength = 8
});

string getCodeResponse = codeGuard.GetCode(getCodeRequest);
```

### DLL å…§éƒ¨è‡ªå‹•è™•ç†:

```csharp
// DLL å…§éƒ¨æœƒè‡ªå‹•åŠ ä¸Šæ™‚é–“æˆ³è¨˜
data = "3750"
timestamp = "20251205085414"
dataWithTimestamp = "3750" + "20251205085414" = "375020251205085414"

rawString = "HI_POS" + "375020251205085414" + "2025-12-05 08:54:00"
```

-----

## ğŸ“Š å®Œæ•´æµç¨‹åœ–

### ç¬¬1æ¬¡åŒ¯å‡º (08:54:14):

```
Controller å‚³å…¥:
{
  "SysID": "HI_POS",
  "Data": "3750",
  "CodeLength": 8
}
    â†“
DLL å…§éƒ¨è™•ç†:
data = "3750"
timestamp = "20251205085414"
dataWithTimestamp = "375020251205085414"
    â†“
rawString = "HI_POS" + "375020251205085414" + "2025-12-05 08:54:00"
    â†“
SHA256 åŠ å¯†
    â†“
æˆæ¬Šç¢¼ = "A1B2C3D4"
```

### ç¬¬2æ¬¡åŒ¯å‡º (08:54:25):

```
Controller å‚³å…¥:
{
  "SysID": "HI_POS",
  "Data": "3750",      â† ä¸€æ¨£çš„åƒæ•¸
  "CodeLength": 8
}
    â†“
DLL å…§éƒ¨è™•ç†:
data = "3750"
timestamp = "20251205085425"  â† æ™‚é–“ä¸åŒ
dataWithTimestamp = "375020251205085425"
    â†“
rawString = "HI_POS" + "375020251205085425" + "2025-12-05 08:54:00"
    â†“
SHA256 åŠ å¯†
    â†“
æˆæ¬Šç¢¼ = "X7Y8Z9W0"  â† ä¸åŒ!
```

-----

## âœ… å„ªé»

### 1. **çµ±ä¸€ç®¡ç†**

- æ‰€æœ‰å‘¼å« `GetCode()` çš„åœ°æ–¹éƒ½è‡ªå‹•æœ‰æ™‚é–“æˆ³è¨˜
- ä¸ç”¨æ¯å€‹åœ°æ–¹éƒ½è¨˜å¾—åŠ 

### 2. **å‘å¾Œç›¸å®¹**

- å‘¼å«ç«¯çš„ç¨‹å¼ç¢¼å®Œå…¨ä¸ç”¨æ”¹
- åªè¦é‡æ–°ç·¨è­¯ DLL å°±å¥½

### 3. **é¿å…äººç‚ºéŒ¯èª¤**

- ä¸æœƒæœ‰äººå¿˜è¨˜åŠ æ™‚é–“æˆ³è¨˜
- DLL å…§éƒ¨çµ±ä¸€è™•ç†

-----

## ğŸ” VerifyCode è¦æ”¹å—?

### ç­”æ¡ˆ:ä¸ç”¨æ”¹!

**åŸå› :**

- é©—è­‰æ™‚æ˜¯ç›´æ¥å¾è³‡æ–™åº«æ¯”å°æˆæ¬Šç¢¼
- ä¸éœ€è¦é‡æ–°è¨ˆç®—æˆæ¬Šç¢¼
- æ‰€ä»¥ `VerifyCode` å®Œå…¨ä¸ç”¨å‹•

```csharp
// VerifyCode ä¸ç”¨æ”¹ (å¦‚æœä½ æœ‰é€™å€‹åŠŸèƒ½)
public string VerifyCode(string requestJson)
{
    // ç›´æ¥å¾è³‡æ–™åº«æŸ¥è©¢æˆæ¬Šç¢¼
    // ä¸éœ€è¦é‡æ–°è¨ˆç®—,æ‰€ä»¥ä¸å—å½±éŸ¿
    
    var request = JsonConvert.DeserializeObject<MVerifyCode.VerifyCodeRequest>(requestJson);
    
    // æŸ¥è©¢è³‡æ–™åº«
    var record = FindRecordByCode(request.Code);
    
    if (record != null)
    {
        // æˆæ¬Šç¢¼æœ‰æ•ˆ
    }
}
```

-----

## ğŸ“ ä¿®æ”¹æ¸…å–®

### éœ€è¦ä¿®æ”¹:

- âœ… **HI_CODEGUARD_DLL/Factory/FGetCode.cs** - `GetCode` æ–¹æ³•

### ä¸éœ€è¦ä¿®æ”¹:

- âŒ CODE_GUARD.cs (ä¸ç”¨æ”¹)
- âŒ FVerifyCode.cs (ä¸ç”¨æ”¹)
- âŒ MGetCode.cs (ä¸ç”¨æ”¹)
- âŒ MVerifyCode.cs (ä¸ç”¨æ”¹)
- âŒ Controller (ä¸ç”¨æ”¹)
- âŒ Factory (ä¸ç”¨æ”¹)
- âŒ View (ä¸ç”¨æ”¹)

-----

## ğŸ”¨ ç·¨è­¯æ­¥é©Ÿ

1. **ä¿®æ”¹ DLL å°ˆæ¡ˆ**

- é–‹å•Ÿ `HI_CODEGUARD_DLL` å°ˆæ¡ˆ
- ä¿®æ”¹ `FGetCode.cs`
- Build å°ˆæ¡ˆ

1. **æ›´æ–°åƒè€ƒ**

- åœ¨ `HI_APACCESS` å°ˆæ¡ˆ
- å³éµ References â†’ æ›´æ–° `HI_CODEGUARD_DLL` åƒè€ƒ
- æˆ–è¤‡è£½æ–°çš„ DLL åˆ° bin è³‡æ–™å¤¾

1. **æ¸¬è©¦**

- Rebuild Solution
- æ¸¬è©¦åŒ¯å‡ºåŠŸèƒ½

-----

## âœ… æ¸¬è©¦æ¡ˆä¾‹

```csharp
// æ¸¬è©¦ 1: ç›¸åŒå“¡å·¥é€£çºŒåŒ¯å‡º
// 08:54:14 â†’ æˆæ¬Šç¢¼ A1B2C3D4
// 08:54:25 â†’ æˆæ¬Šç¢¼ X7Y8Z9W0  âœ… ä¸åŒ

// æ¸¬è©¦ 2: ä¸åŒå“¡å·¥åŒæ™‚åŒ¯å‡º
// å“¡å·¥3750 â†’ æˆæ¬Šç¢¼ A1B2C3D4
// å“¡å·¥3751 â†’ æˆæ¬Šç¢¼ P9Q8R7S6  âœ… ä¸åŒ
```

-----

å®Œæˆ! ğŸ‰

**é€™æ¨£æ”¹å°äº†!åœ¨ DLL å…§éƒ¨çµ±ä¸€è™•ç†æ™‚é–“æˆ³è¨˜,æ‰€æœ‰ä½¿ç”¨é€™å€‹ DLL çš„åœ°æ–¹éƒ½æœƒè‡ªå‹•äº«æœ‰é€™å€‹åŠŸèƒ½,ä¸ç”¨æ¯å€‹åœ°æ–¹éƒ½æ”¹!**