æˆ‘çœ‹åˆ°å¹¾å€‹å•é¡Œ,è®“æˆ‘å¹«ä½ ä¿®æ­£:

-----

## ğŸ› å•é¡Œåˆ†æ

### 1. **View éŒ¯èª¤** (åœ–ç‰‡ä¸­çš„éŒ¯èª¤)

```csharp
CS1061: 'string' does not contain a definition for 'xlsx'
```

**å•é¡Œ:** `@Model[i].FILE_NAME.xlsx` é€™æ¨£å¯«æ˜¯éŒ¯çš„

**æ­£ç¢ºå¯«æ³•:**

```csharp
@Model[i].FILE_NAME.xlsx  âŒ éŒ¯èª¤
@(Model[i].FILE_NAME).xlsx  âœ… æ­£ç¢º
```

### 2. **SQL èªæ³•éŒ¯èª¤**

åœ¨ `DeleteOldRecords()` æ–¹æ³•ä¸­,SQL å°‘äº†å³æ‹¬è™Ÿ

### 3. **è³‡æ–™è¡¨çµæ§‹å•é¡Œ**

ä½ çš„ `SaveCodeGuardRecord` æ²’æœ‰æ’å…¥ `SYS_ID`,ä½† `GetMyExportRecords` å»è¦æŸ¥è©¢ `SYS_ID`

-----

## ğŸ”§ å®Œæ•´ä¿®æ­£ç¨‹å¼ç¢¼

### 1. **ExportRecords.cshtml** (ä¿®æ­£ View)

```html
@model List<HI_APACCESS.Models.ExportRecordViewModel>

@{
    ViewBag.Title = "åŒ¯å‡ºè¨˜éŒ„";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">
        <i class="fas fa-history"></i> å¸³è™Ÿæ¸…å–®åŒ¯å‡ºè¨˜éŒ„ (æœ€è¿‘3å€‹æœˆ)
    </div>
</section>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            @if (Model != null && Model.Count > 0)
            {
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i> 
                    å…±æœ‰ <strong>@Model.Count</strong> ç­†è¨˜éŒ„
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th style="width: 5%;" class="text-center">åºè™Ÿ</th>
                                <th style="width: 35%;">æª”æ¡ˆåç¨±</th>
                                <th style="width: 15%;" class="text-center">ç³»çµ±ID</th>
                                <th style="width: 15%;" class="text-center">åŒ¯å‡ºäººå“¡</th>
                                <th style="width: 20%;" class="text-center">åŒ¯å‡ºæ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                <tr>
                                    <td class="text-center">@(i + 1)</td>
                                    <td>
                                        <i class="fas fa-file-excel text-success"></i> 
                                        @(Model[i].FILE_NAME).xlsx
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-primary">@Model[i].SYS_ID</span>
                                    </td>
                                    <td class="text-center">@Model[i].CREATOR</td>
                                    <td class="text-center">@Model[i].CREATE_TIME</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning text-center" role="alert" style="padding: 50px;">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h5>ç›®å‰æ²’æœ‰åŒ¯å‡ºè¨˜éŒ„</h5>
                    <p class="text-muted">æœ€è¿‘ 3 å€‹æœˆå…§æ²’æœ‰åŒ¯å‡ºå¸³è™Ÿæ¸…å–®çš„è¨˜éŒ„</p>
                </div>
            }
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <button type="button" class="btn btn-secondary" onclick="window.close();">
                <i class="fas fa-times"></i> é—œé–‰è¦–çª—
            </button>
        </div>
    </div>
</div>

<style>
    .table {
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table thead th {
        vertical-align: middle;
    }
    
    .table tbody td {
        vertical-align: middle;
    }
    
    .badge {
        font-size: 0.9em;
        padding: 5px 10px;
    }
</style>
```

-----

### 2. **F_AP.cs** (ä¿®æ­£ Factory)

```csharp
/// <summary>
/// å–å¾—æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®(ç”¨æ–¼åŒ¯å‡º)
/// </summary>
public List<UserExportModel> GetAllUsersForExport(string systemId)
{
    string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.GetAllUsersForExport);

    List<SqlParameter> parameters = new List<SqlParameter>
    {
        new SqlParameter("@SYS_ID", systemId)
    };

    DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
    return SVS_DBmanager.ConvertToList<UserExportModel>(dt);
}

/// <summary>
/// å„²å­˜æˆæ¬Šç¢¼è¨˜éŒ„
/// </summary>
public string SaveCodeGuardRecord(CodeGuardRecordModel model)
{
    string sql = @"
        INSERT INTO [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
            ([FILE_NAME], [CODE_GUARD], [CREATOR], [CREATE_TIME], [SYS_ID])
        VALUES
            (@FILE_NAME, @CODE_GUARD, @CREATOR, GETDATE(), @SYS_ID)
    ";

    List<SqlParameter> parameters = new List<SqlParameter>
    {
        new SqlParameter("@FILE_NAME", model.FILE_NAME ?? (object)DBNull.Value),
        new SqlParameter("@CODE_GUARD", model.CODE_GUARD ?? (object)DBNull.Value),
        new SqlParameter("@CREATOR", model.CREATOR ?? (object)DBNull.Value),
        new SqlParameter("@SYS_ID", string.IsNullOrEmpty(model.SYS_ID) ? (object)DBNull.Value : model.SYS_ID)
    };

    return SVS_DBmanager.ExecuteSQL(sql, parameters);
}

/// <summary>
/// å–å¾—å€‹äººåŒ¯å‡ºè¨˜éŒ„(æœ€è¿‘3å€‹æœˆ)
/// </summary>
public List<ExportRecordViewModel> GetMyExportRecords(string creator, string systemId)
{
    try
    {
        string sql = @"
            SELECT 
                [ID],
                [FILE_NAME],
                [CREATOR],
                CONVERT(varchar, [CREATE_TIME], 120) as CREATE_TIME,
                ISNULL([SYS_ID], '') as SYS_ID
            FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
            WHERE [CREATOR] = @CREATOR
              AND ([SYS_ID] = @SYS_ID OR @SYS_ID IS NULL)
              AND [CREATE_TIME] >= DATEADD(MONTH, -3, GETDATE())
            ORDER BY [CREATE_TIME] DESC
        ";

        List<SqlParameter> parameters = new List<SqlParameter>
        {
            new SqlParameter("@CREATOR", creator ?? (object)DBNull.Value),
            new SqlParameter("@SYS_ID", string.IsNullOrEmpty(systemId) ? (object)DBNull.Value : systemId)
        };

        DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
        return SVS_DBmanager.ConvertToList<ExportRecordViewModel>(dt);
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"æŸ¥è©¢åŒ¯å‡ºè¨˜éŒ„å¤±æ•—: {ex.Message}");
        return new List<ExportRecordViewModel>();
    }
}

/// <summary>
/// åˆªé™¤è¶…é3å€‹æœˆçš„è¨˜éŒ„
/// </summary>
public string DeleteOldRecords()
{
    string sql = @"
        DELETE FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
        WHERE [CREATE_TIME] < DATEADD(MONTH, -3, GETDATE())
    ";

    return SVS_DBmanager.ExecuteSQL(sql);
}
```

-----

### 3. **Controller** (è£œå……å®Œæ•´çš„éŒ¯èª¤è™•ç†)

```csharp
/// <summary>
/// åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (ExcelåŠ å¯†)
/// </summary>
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;

        // 1. ç”¢ç”Ÿæˆæ¬Šç¢¼ (ä½¿ç”¨ HI_CODEGUARD_DLL)
        CODE_GUARD codeGuard = new CODE_GUARD();
        string getCodeRequest = JsonConvert.SerializeObject(new
        {
            SysID = systemId,
            Data = this.Emp_NO,
            CodeLength = 8
        });

        string getCodeResponse = codeGuard.GetCode(getCodeRequest);
        dynamic codeResult = JsonConvert.DeserializeObject(getCodeResponse);

        if (codeResult.Result_code != "0000")
        {
            return Content($"<script>alert('ç”¢ç”Ÿæˆæ¬Šç¢¼å¤±æ•—: {codeResult.Msg}'); window.history.back();</script>", "text/html");
        }

        string authCode = codeResult.Code.ToString();

        // 2. å–å¾—å¸³è™Ÿæ¸…å–®
        var service = GetAPService();
        var userList = service.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
        }

        // 3. ç”¢ç”ŸåŠ å¯† Excel (å¯†ç¢¼ = æˆæ¬Šç¢¼)
        string fileName = $"{DateTime.Now:yyyyMMddHHmmss}_åŒ¯å‡ºå¸³è™Ÿæ¸…å–®";
        byte[] excelBytes = CreateEncryptedExcel(userList, systemId, authCode);

        // 4. å„²å­˜è¨˜éŒ„åˆ°è³‡æ–™åº«
        var recordModel = new CodeGuardRecordModel
        {
            FILE_NAME = fileName,
            CODE_GUARD = authCode,
            CREATOR = this.Emp_NO,
            SYS_ID = systemId
        };

        var saveResult = service.SaveCodeGuardRecord(recordModel);
        
        // 5. åˆªé™¤è¶…é3å€‹æœˆçš„èˆŠè¨˜éŒ„
        service.DeleteOldRecords();

        // 6. é¡¯ç¤ºæˆæ¬Šç¢¼æç¤ºä¸¦ä¸‹è¼‰
        TempData["AuthCode"] = authCode;
        TempData["FileName"] = fileName;

        // 7. å›å‚³åŠ å¯†çš„ Excel æª”æ¡ˆ
        return File(excelBytes, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            $"{fileName}.xlsx");
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—: {ex.Message}\\n\\n{ex.StackTrace}'); window.history.back();</script>", "text/html");
    }
}

/// <summary>
/// ä½¿ç”¨ NPOI å»ºç«‹åŠ å¯† Excel
/// </summary>
private byte[] CreateEncryptedExcel(List<UserExportModel> userList, string systemId, string password)
{
    try
    {
        // 1. å»ºç«‹å·¥ä½œç°¿
        XSSFWorkbook workbook = new XSSFWorkbook();
        ISheet sheet = workbook.CreateSheet("å¸³è™Ÿæ¸…å–®");

        // 2. å»ºç«‹æ¨™é¡Œåˆ—æ¨£å¼
        ICellStyle headerStyle = workbook.CreateCellStyle();
        headerStyle.FillForegroundColor = NPOI.HSSF.Util.HSSFColor.Grey25Percent.Index;
        headerStyle.FillPattern = FillPattern.SolidForeground;
        headerStyle.Alignment = HorizontalAlignment.Center;
        headerStyle.VerticalAlignment = VerticalAlignment.Center;

        // è¨­å®šé‚Šæ¡†
        headerStyle.BorderTop = BorderStyle.Thin;
        headerStyle.BorderBottom = BorderStyle.Thin;
        headerStyle.BorderLeft = BorderStyle.Thin;
        headerStyle.BorderRight = BorderStyle.Thin;

        IFont headerFont = workbook.CreateFont();
        headerFont.IsBold = true;
        headerFont.FontHeightInPoints = 11;
        headerFont.FontName = "å¾®è»Ÿæ­£é»‘é«”";
        headerStyle.SetFont(headerFont);

        // 3. å»ºç«‹è³‡æ–™åˆ—æ¨£å¼
        ICellStyle cellStyle = workbook.CreateCellStyle();
        cellStyle.Alignment = HorizontalAlignment.Left;
        cellStyle.VerticalAlignment = VerticalAlignment.Center;
        cellStyle.BorderTop = BorderStyle.Thin;
        cellStyle.BorderBottom = BorderStyle.Thin;
        cellStyle.BorderLeft = BorderStyle.Thin;
        cellStyle.BorderRight = BorderStyle.Thin;

        IFont cellFont = workbook.CreateFont();
        cellFont.FontName = "å¾®è»Ÿæ­£é»‘é«”";
        cellStyle.SetFont(cellFont);

        // 4. å»ºç«‹æ¨™é¡Œåˆ—
        IRow headerRow = sheet.CreateRow(0);
        string[] headers = new string[]
        {
            "ç³»çµ±", "å¸³è™Ÿ", "å§“å", "ç¾¤çµ„ä»£è™Ÿ", "ç¾¤çµ„åç¨±",
            "éƒ¨é–€ä»£è™Ÿ", "éƒ¨é–€åç¨±", "å»ºç«‹äººå“¡", "å»ºç«‹æ—¥æœŸ", "ä¿®æ”¹äººå“¡", "ä¿®æ”¹æ—¥æœŸ"
        };

        for (int i = 0; i < headers.Length; i++)
        {
            ICell cell = headerRow.CreateCell(i);
            cell.SetCellValue(headers[i]);
            cell.CellStyle = headerStyle;
        }

        // 5. å¡«å…¥è³‡æ–™
        int rowIndex = 1;
        foreach (var user in userList)
        {
            IRow dataRow = sheet.CreateRow(rowIndex);

            CreateStyledCell(dataRow, 0, systemId ?? "", cellStyle);
            CreateStyledCell(dataRow, 1, user.U_ID ?? "", cellStyle);
            CreateStyledCell(dataRow, 2, user.U_NAME ?? "", cellStyle);
            CreateStyledCell(dataRow, 3, user.APG_NO ?? "", cellStyle);
            CreateStyledCell(dataRow, 4, user.APG_NAME ?? "", cellStyle);
            CreateStyledCell(dataRow, 5, user.ORGAN_NO ?? "", cellStyle);
            CreateStyledCell(dataRow, 6, user.ORGAN_CAP ?? "", cellStyle);
            CreateStyledCell(dataRow, 7, user.CREATOR ?? "", cellStyle);
            CreateStyledCell(dataRow, 8, user.CREATE_TIME ?? "", cellStyle);
            CreateStyledCell(dataRow, 9, user.EDITOR ?? "", cellStyle);
            CreateStyledCell(dataRow, 10, user.EDIT_TIME ?? "", cellStyle);

            rowIndex++;
        }

        // 6. è‡ªå‹•èª¿æ•´æ¬„å¯¬
        for (int i = 0; i < headers.Length; i++)
        {
            sheet.AutoSizeColumn(i);
            // åŠ ä¸€é»é¡å¤–å¯¬åº¦è®“å…§å®¹æ›´å¥½çœ‹
            int currentWidth = sheet.GetColumnWidth(i);
            sheet.SetColumnWidth(i, currentWidth + 1000);
        }

        // 7. å‡çµé¦–åˆ—
        sheet.CreateFreezePane(0, 1);

        // 8. å°‡å·¥ä½œç°¿å¯«å…¥æœªåŠ å¯†çš„ä¸²æµ
        byte[] unencryptedBytes;
        using (MemoryStream ms = new MemoryStream())
        {
            workbook.Write(ms, false);
            unencryptedBytes = ms.ToArray();
        }
        workbook.Close();

        // 9. åŠ å¯† Excel æª”æ¡ˆ
        byte[] encryptedBytes = EncryptExcelFile(unencryptedBytes, password);

        return encryptedBytes;
    }
    catch (Exception ex)
    {
        throw new Exception($"å»ºç«‹ Excel å¤±æ•—: {ex.Message}", ex);
    }
}

/// <summary>
/// å»ºç«‹å¸¶æ¨£å¼çš„å„²å­˜æ ¼
/// </summary>
private void CreateStyledCell(IRow row, int columnIndex, string value, ICellStyle style)
{
    ICell cell = row.CreateCell(columnIndex);
    cell.SetCellValue(value);
    cell.CellStyle = style;
}

/// <summary>
/// åŠ å¯† Excel æª”æ¡ˆ
/// </summary>
private byte[] EncryptExcelFile(byte[] excelBytes, string password)
{
    try
    {
        // è®€å–æœªåŠ å¯†çš„ Excel
        using (MemoryStream inputStream = new MemoryStream(excelBytes))
        {
            // å»ºç«‹ POIFSFileSystem
            POIFSFileSystem fs = new POIFSFileSystem();

            // å»ºç«‹åŠ å¯†è³‡è¨Š (ä½¿ç”¨ Agile åŠ å¯†æ¨¡å¼)
            EncryptionInfo info = new EncryptionInfo(EncryptionMode.Agile);
            Encryptor enc = info.Encryptor;

            // è¨­å®šå¯†ç¢¼
            enc.ConfirmPassword(password);

            // å°‡ Excel å…§å®¹å¯«å…¥åŠ å¯†ä¸²æµ
            using (Stream encryptedStream = enc.GetDataStream(fs))
            {
                inputStream.Position = 0;
                inputStream.CopyTo(encryptedStream);
            }

            // è¼¸å‡ºåŠ å¯†å¾Œçš„æª”æ¡ˆ
            using (MemoryStream outputStream = new MemoryStream())
            {
                fs.WriteFilesystem(outputStream);
                fs.Close();
                return outputStream.ToArray();
            }
        }
    }
    catch (Exception ex)
    {
        throw new Exception($"Excel åŠ å¯†å¤±æ•—: {ex.Message}", ex);
    }
}

/// <summary>
/// æŸ¥çœ‹åŒ¯å‡ºè¨˜éŒ„
/// </summary>
[HttpGet]
public ActionResult ExportRecords()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;

        var service = GetAPService();
        var records = service.GetMyExportRecords(this.Emp_NO, systemId);

        return View(records);
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('æŸ¥è©¢å¤±æ•—: {ex.Message}'); window.history.back();</script>", "text/html");
    }
}
```

-----

## ğŸ“ ä¿®æ­£é‡é»ç¸½çµ

### 1. **View ä¿®æ­£**

```csharp
// âŒ éŒ¯èª¤
@Model[i].FILE_NAME.xlsx

// âœ… æ­£ç¢º
@(Model[i].FILE_NAME).xlsx
```

### 2. **SQL ä¿®æ­£**

```csharp
// âŒ éŒ¯èª¤ - å°‘äº†å³æ‹¬è™Ÿ
WHERE [CREATE_TIME] < DATEADD(MONTH, -3, GETDATE()

// âœ… æ­£ç¢º
WHERE [CREATE_TIME] < DATEADD(MONTH, -3, GETDATE())
```

### 3. **è³‡æ–™è¡¨çµæ§‹ä¸€è‡´æ€§**

- `SaveCodeGuardRecord` è¦æ’å…¥ `SYS_ID`
- `GetMyExportRecords` è¦æŸ¥è©¢ `SYS_ID`

-----

## âœ… æ¸¬è©¦æ­¥é©Ÿ

1. é‡æ–°ç·¨è­¯å°ˆæ¡ˆ
1. ç¢ºèªæ²’æœ‰ç·¨è­¯éŒ¯èª¤
1. æ¸¬è©¦åŒ¯å‡ºåŠŸèƒ½
1. æ¸¬è©¦æŸ¥çœ‹è¨˜éŒ„åŠŸèƒ½

å®Œæˆ! ğŸ‰â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹