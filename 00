æ˜ç™½äº†!ä½ éœ€è¦ç”¨æˆæ¬Šç¢¼ä¾†åŠ å¯† Excel,è®“ä½¿ç”¨è€…å¿…é ˆè¼¸å…¥æˆæ¬Šç¢¼æ‰èƒ½é–‹å•Ÿã€‚

ä»¥ä¸‹æ˜¯å®Œæ•´çš„ NPOI åŠ å¯†å¯¦ä½œ:

-----

## ğŸ“¦ 1. NuGet å¥—ä»¶å®‰è£

```
Install-Package NPOI -Version 2.7.1
```

åœ¨ `packages.config` åŠ å…¥:

```xml
<package id="NPOI" version="2.7.1" targetFramework="net48" />
```

-----

## ğŸ® 2. Controller å®Œæ•´ç¨‹å¼ç¢¼

```csharp
using System;
using System.Collections.Generic;
using System.IO;
using System.Web.Mvc;
using HI_CODEGUARD_DLL;
using Newtonsoft.Json;
using NPOI.XSSF.UserModel;
using NPOI.SS.UserModel;
using NPOI.POIFS.FileSystem;
using NPOI.POIFS.Crypt;
using YourNamespace.Models;
using YourNamespace.Factory;

#region åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (åŠ å¯†ç‰ˆ)

/// <summary>
/// åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (ExcelåŠ å¯†)
/// </summary>
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        string employeeNo = Session["UserID"] as string; // å¾ Session å–å¾—å“¡å·¥ç·¨è™Ÿ

        if (string.IsNullOrEmpty(employeeNo))
        {
            return Content("<script>alert('ç„¡æ³•å–å¾—å“¡å·¥ç·¨è™Ÿ'); window.history.back();</script>", "text/html");
        }

        // 1. ç”¢ç”Ÿæˆæ¬Šç¢¼ (ä½¿ç”¨ HI_CODEGUARD_DLL)
        CODE_GUARD codeGuard = new CODE_GUARD();
        string getCodeRequest = JsonConvert.SerializeObject(new
        {
            SysID = systemId,
            Data = employeeNo,
            CodeLength = 8
        });

        string getCodeResponse = codeGuard.GetCode(getCodeRequest);
        dynamic codeResult = JsonConvert.DeserializeObject(getCodeResponse);

        if (codeResult.Result_code != "0000")
        {
            return Content($"<script>alert('ç”¢ç”Ÿæˆæ¬Šç¢¼å¤±æ•—: {codeResult.Msg}'); window.history.back();</script>", "text/html");
        }

        string authCode = codeResult.Code.ToString();

        // 2. å–å¾—å¸³è™Ÿæ¸…å–®
        var service = GetAPService();
        var userList = service.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
        }

        // 3. ç”¢ç”ŸåŠ å¯† Excel (å¯†ç¢¼ = æˆæ¬Šç¢¼)
        string fileName = $"{DateTime.Now:yyyyMMddHHmmss}_åŒ¯å‡ºå¸³è™Ÿæ¸…å–®";
        byte[] excelBytes = CreateEncryptedExcel(userList, systemId, authCode);

        // 4. å„²å­˜è¨˜éŒ„åˆ°è³‡æ–™åº«
        var recordModel = new CodeGuardRecordModel
        {
            FILE_NAME = fileName,
            CODE_GUARD = authCode,
            CREATOR = employeeNo,
            SYS_ID = systemId
        };

        bool saveResult = service.SaveCodeGuardRecord(recordModel);
        if (!saveResult)
        {
            System.Diagnostics.Debug.WriteLine("å„²å­˜æˆæ¬Šç¢¼è¨˜éŒ„å¤±æ•—");
        }

        // 5. åˆªé™¤è¶…é3å€‹æœˆçš„èˆŠè¨˜éŒ„
        service.DeleteOldRecords();

        // 6. é¡¯ç¤ºæˆæ¬Šç¢¼æç¤ºä¸¦ä¸‹è¼‰
        TempData["AuthCode"] = authCode;
        TempData["FileName"] = fileName;

        // 7. å›å‚³åŠ å¯†çš„ Excel æª”æ¡ˆ
        return File(excelBytes, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
            $"{fileName}.xlsx");
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—: {ex.Message}'); window.history.back();</script>", "text/html");
    }
}

/// <summary>
/// ä½¿ç”¨ NPOI å»ºç«‹åŠ å¯† Excel
/// </summary>
private byte[] CreateEncryptedExcel(List<UserExportModel> userList, string systemId, string password)
{
    try
    {
        // 1. å»ºç«‹å·¥ä½œç°¿
        XSSFWorkbook workbook = new XSSFWorkbook();
        ISheet sheet = workbook.CreateSheet("å¸³è™Ÿæ¸…å–®");

        // 2. å»ºç«‹æ¨™é¡Œåˆ—æ¨£å¼
        ICellStyle headerStyle = workbook.CreateCellStyle();
        headerStyle.FillForegroundColor = NPOI.HSSF.Util.HSSFColor.Grey25Percent.Index;
        headerStyle.FillPattern = FillPattern.SolidForeground;
        headerStyle.Alignment = HorizontalAlignment.Center;
        headerStyle.VerticalAlignment = VerticalAlignment.Center;
        
        // è¨­å®šé‚Šæ¡†
        headerStyle.BorderTop = BorderStyle.Thin;
        headerStyle.BorderBottom = BorderStyle.Thin;
        headerStyle.BorderLeft = BorderStyle.Thin;
        headerStyle.BorderRight = BorderStyle.Thin;
        
        IFont headerFont = workbook.CreateFont();
        headerFont.IsBold = true;
        headerFont.FontHeightInPoints = 11;
        headerFont.FontName = "å¾®è»Ÿæ­£é»‘é«”";
        headerStyle.SetFont(headerFont);

        // 3. å»ºç«‹è³‡æ–™åˆ—æ¨£å¼
        ICellStyle cellStyle = workbook.CreateCellStyle();
        cellStyle.Alignment = HorizontalAlignment.Left;
        cellStyle.VerticalAlignment = VerticalAlignment.Center;
        cellStyle.BorderTop = BorderStyle.Thin;
        cellStyle.BorderBottom = BorderStyle.Thin;
        cellStyle.BorderLeft = BorderStyle.Thin;
        cellStyle.BorderRight = BorderStyle.Thin;
        
        IFont cellFont = workbook.CreateFont();
        cellFont.FontName = "å¾®è»Ÿæ­£é»‘é«”";
        cellStyle.SetFont(cellFont);

        // 4. å»ºç«‹æ¨™é¡Œåˆ—
        IRow headerRow = sheet.CreateRow(0);
        string[] headers = new string[] 
        { 
            "ç³»çµ±", "å¸³è™Ÿ", "å§“å", "ç¾¤çµ„ä»£è™Ÿ", "ç¾¤çµ„åç¨±", 
            "éƒ¨é–€ä»£è™Ÿ", "éƒ¨é–€åç¨±", "å»ºç«‹äººå“¡", "å»ºç«‹æ—¥æœŸ", "ä¿®æ”¹äººå“¡", "ä¿®æ”¹æ—¥æœŸ" 
        };

        for (int i = 0; i < headers.Length; i++)
        {
            ICell cell = headerRow.CreateCell(i);
            cell.SetCellValue(headers[i]);
            cell.CellStyle = headerStyle;
        }

        // 5. å¡«å…¥è³‡æ–™
        int rowIndex = 1;
        foreach (var user in userList)
        {
            IRow dataRow = sheet.CreateRow(rowIndex);

            CreateStyledCell(dataRow, 0, systemId ?? "", cellStyle);
            CreateStyledCell(dataRow, 1, user.U_ID ?? "", cellStyle);
            CreateStyledCell(dataRow, 2, user.U_NAME ?? "", cellStyle);
            CreateStyledCell(dataRow, 3, user.APG_NO ?? "", cellStyle);
            CreateStyledCell(dataRow, 4, user.APG_NAME ?? "", cellStyle);
            CreateStyledCell(dataRow, 5, user.ORGAN_NO ?? "", cellStyle);
            CreateStyledCell(dataRow, 6, user.ORGAN_CAP ?? "", cellStyle);
            CreateStyledCell(dataRow, 7, user.CREATOR ?? "", cellStyle);
            CreateStyledCell(dataRow, 8, user.CREATE_TIME ?? "", cellStyle);
            CreateStyledCell(dataRow, 9, user.EDITOR ?? "", cellStyle);
            CreateStyledCell(dataRow, 10, user.EDIT_TIME ?? "", cellStyle);

            rowIndex++;
        }

        // 6. è‡ªå‹•èª¿æ•´æ¬„å¯¬
        for (int i = 0; i < headers.Length; i++)
        {
            sheet.AutoSizeColumn(i);
            // åŠ ä¸€é»é¡å¤–å¯¬åº¦è®“å…§å®¹æ›´å¥½çœ‹
            int currentWidth = sheet.GetColumnWidth(i);
            sheet.SetColumnWidth(i, currentWidth + 1000);
        }

        // 7. å‡çµé¦–åˆ—
        sheet.CreateFreezePane(0, 1);

        // 8. å°‡å·¥ä½œç°¿å¯«å…¥æœªåŠ å¯†çš„ä¸²æµ
        byte[] unencryptedBytes;
        using (MemoryStream ms = new MemoryStream())
        {
            workbook.Write(ms, false);
            unencryptedBytes = ms.ToArray();
        }
        workbook.Close();

        // 9. åŠ å¯† Excel æª”æ¡ˆ
        byte[] encryptedBytes = EncryptExcelFile(unencryptedBytes, password);

        return encryptedBytes;
    }
    catch (Exception ex)
    {
        throw new Exception($"å»ºç«‹ Excel å¤±æ•—: {ex.Message}", ex);
    }
}

/// <summary>
/// å»ºç«‹å¸¶æ¨£å¼çš„å„²å­˜æ ¼
/// </summary>
private void CreateStyledCell(IRow row, int columnIndex, string value, ICellStyle style)
{
    ICell cell = row.CreateCell(columnIndex);
    cell.SetCellValue(value);
    cell.CellStyle = style;
}

/// <summary>
/// åŠ å¯† Excel æª”æ¡ˆ
/// </summary>
private byte[] EncryptExcelFile(byte[] excelBytes, string password)
{
    try
    {
        // è®€å–æœªåŠ å¯†çš„ Excel
        using (MemoryStream inputStream = new MemoryStream(excelBytes))
        {
            // å»ºç«‹ POIFSFileSystem
            POIFSFileSystem fs = new POIFSFileSystem();
            
            // å»ºç«‹åŠ å¯†è³‡è¨Š (ä½¿ç”¨ Agile åŠ å¯†æ¨¡å¼)
            EncryptionInfo info = new EncryptionInfo(EncryptionMode.Agile);
            Encryptor enc = info.Encryptor;
            
            // è¨­å®šå¯†ç¢¼
            enc.ConfirmPassword(password);

            // å°‡ Excel å…§å®¹å¯«å…¥åŠ å¯†ä¸²æµ
            using (Stream encryptedStream = enc.GetDataStream(fs))
            {
                inputStream.Position = 0;
                inputStream.CopyTo(encryptedStream);
            }

            // è¼¸å‡ºåŠ å¯†å¾Œçš„æª”æ¡ˆ
            using (MemoryStream outputStream = new MemoryStream())
            {
                fs.WriteFilesystem(outputStream);
                fs.Close();
                return outputStream.ToArray();
            }
        }
    }
    catch (Exception ex)
    {
        throw new Exception($"Excel åŠ å¯†å¤±æ•—: {ex.Message}", ex);
    }
}

/// <summary>
/// æŸ¥çœ‹åŒ¯å‡ºè¨˜éŒ„
/// </summary>
[HttpGet]
public ActionResult ExportRecords()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        string employeeNo = Session["UserID"] as string;

        if (string.IsNullOrEmpty(employeeNo))
        {
            return Content("<script>alert('ç„¡æ³•å–å¾—å“¡å·¥ç·¨è™Ÿ'); window.history.back();</script>", "text/html");
        }

        var service = GetAPService();
        var records = service.GetMyExportRecords(employeeNo, systemId);

        return View(records);
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('æŸ¥è©¢å¤±æ•—: {ex.Message}'); window.history.back();</script>", "text/html");
    }
}

#endregion
```

-----

## ğŸ–¼ï¸ 3. View - GroupManagement.cshtml (ä¿®æ”¹)

```html
<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">ç³»çµ±ç¾¤çµ„æ¬Šé™ç®¡ç† : @ViewBag.SystemId</div>
    
    @if (showSwitchButton)
    {
        <div class="row mb-3">
            <div class="col-md-12">
                <button type="button" class="btn btn-secondary" id="btnSwitchSystem">
                    <i class="fas fa-exchange-alt"></i> åˆ‡æ›ç³»çµ±
                </button>
            </div>
        </div>
    }
    
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-outline-info" id="btnExportUsers">
                <i class="fas fa-file-export"></i> åŒ¯å‡ºå¸³è™Ÿæ¸…å–®
            </button>
            <button type="button" class="btn btn-outline-success" id="btnExportRecords">
                <i class="fas fa-history"></i> åŒ¯å‡ºè¨˜éŒ„
            </button>
        </div>
    </div>
</section>

<!-- æˆæ¬Šç¢¼é¡¯ç¤º Modal -->
<div class="modal fade" id="authCodeModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-key"></i> Excel æª”æ¡ˆæˆæ¬Šç¢¼
                </h5>
            </div>
            <div class="modal-body text-center">
                <p class="mb-3">æª”æ¡ˆå·²åŠ å¯†,è«‹ä½¿ç”¨ä»¥ä¸‹æˆæ¬Šç¢¼é–‹å•Ÿ:</p>
                <div class="alert alert-info" style="font-size: 24px; font-weight: bold; letter-spacing: 3px;">
                    <span id="displayAuthCode"></span>
                </div>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    è«‹å¦¥å–„ä¿ç®¡æ­¤æˆæ¬Šç¢¼,éºå¤±å°‡ç„¡æ³•é–‹å•Ÿæª”æ¡ˆ!
                </p>
                <p class="text-muted">
                    <small>æª”æ¡ˆåç¨±: <span id="displayFileName"></span></small>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnCopyAuthCode">
                    <i class="fas fa-copy"></i> è¤‡è£½æˆæ¬Šç¢¼
                </button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">
                    <i class="fas fa-check"></i> æˆ‘å·²è¨˜ä¸‹æˆæ¬Šç¢¼
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        // åŒ¯å‡ºå¸³è™Ÿæ¸…å–®æŒ‰éˆ•äº‹ä»¶
        $('#btnExportUsers').click(function () {
            if (confirm('åŒ¯å‡ºçš„ Excel æª”æ¡ˆå°‡æœƒåŠ å¯†ä¿è­·ã€‚\n\nç³»çµ±æœƒç”¢ç”Ÿä¸€çµ„æˆæ¬Šç¢¼,é–‹å•Ÿæª”æ¡ˆæ™‚éœ€è¦è¼¸å…¥æ­¤æˆæ¬Šç¢¼ã€‚\n\nç¢ºå®šè¦åŒ¯å‡ºå—?')) {
                // é–‹å§‹ä¸‹è¼‰
                window.location.href = '@Url.Action("ExportUserList", "AP")';
                
                // å»¶é²é¡¯ç¤ºæˆæ¬Šç¢¼ (ç­‰æª”æ¡ˆé–‹å§‹ä¸‹è¼‰)
                setTimeout(function() {
                    showAuthCode();
                }, 500);
            }
        });

        // åŒ¯å‡ºè¨˜éŒ„æŒ‰éˆ•äº‹ä»¶
        $('#btnExportRecords').click(function () {
            window.open('@Url.Action("ExportRecords", "AP")', '_blank');
        });

        // è¤‡è£½æˆæ¬Šç¢¼
        $('#btnCopyAuthCode').click(function() {
            var authCode = $('#displayAuthCode').text();
            
            // å»ºç«‹æš«æ™‚çš„ textarea ä¾†è¤‡è£½æ–‡å­—
            var $temp = $('<textarea>');
            $('body').append($temp);
            $temp.val(authCode).select();
            document.execCommand('copy');
            $temp.remove();
            
            // é¡¯ç¤ºæç¤º
            $(this).html('<i class="fas fa-check"></i> å·²è¤‡è£½!');
            setTimeout(() => {
                $(this).html('<i class="fas fa-copy"></i> è¤‡è£½æˆæ¬Šç¢¼');
            }, 2000);
        });

        // é¡¯ç¤ºæˆæ¬Šç¢¼
        function showAuthCode() {
            @if (TempData["AuthCode"] != null && TempData["FileName"] != null)
            {
                <text>
                var authCode = '@TempData["AuthCode"]';
                var fileName = '@TempData["FileName"]';
                
                $('#displayAuthCode').text(authCode);
                $('#displayFileName').text(fileName + '.xlsx');
                $('#authCodeModal').modal('show');
                </text>
            }
        }
    });
</script>
}

<style>
    .modal-body {
        padding: 30px;
    }
    
    #displayAuthCode {
        font-family: 'Courier New', monospace;
        user-select: all;
    }
</style>
```

-----

## ğŸ“‹ 4. View - ExportRecords.cshtml

```html
@model List<YourNamespace.Models.ExportRecordViewModel>

@{
    ViewBag.Title = "åŒ¯å‡ºè¨˜éŒ„";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">
        <i class="fas fa-history"></i> å¸³è™Ÿæ¸…å–®åŒ¯å‡ºè¨˜éŒ„ (æœ€è¿‘3å€‹æœˆ)
    </div>
</section>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            @if (Model != null && Model.Count > 0)
            {
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i> 
                    å…±æœ‰ <strong>@Model.Count</strong> ç­†è¨˜éŒ„
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th style="width: 5%;" class="text-center">åºè™Ÿ</th>
                                <th style="width: 35%;">æª”æ¡ˆåç¨±</th>
                                <th style="width: 15%;" class="text-center">ç³»çµ±ID</th>
                                <th style="width: 15%;" class="text-center">åŒ¯å‡ºäººå“¡</th>
                                <th style="width: 20%;" class="text-center">åŒ¯å‡ºæ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                <tr>
                                    <td class="text-center">@(i + 1)</td>
                                    <td>
                                        <i class="fas fa-file-excel text-success"></i> 
                                        @Model[i].FILE_NAME.xlsx
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-primary">@Model[i].SYS_ID</span>
                                    </td>
                                    <td class="text-center">@Model[i].CREATOR</td>
                                    <td class="text-center">@Model[i].CREATE_TIME</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning text-center" role="alert" style="padding: 50px;">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h5>ç›®å‰æ²’æœ‰åŒ¯å‡ºè¨˜éŒ„</h5>
                    <p class="text-muted">æœ€è¿‘ 3 å€‹æœˆå…§æ²’æœ‰åŒ¯å‡ºå¸³è™Ÿæ¸…å–®çš„è¨˜éŒ„</p>
                </div>
            }
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <button type="button" class="btn btn-secondary" onclick="window.close();">
                <i class="fas fa-times"></i> é—œé–‰è¦–çª—
            </button>
        </div>
    </div>
</div>

<style>
    .table {
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table thead th {
        vertical-align: middle;
    }
    
    .table tbody td {
        vertical-align: middle;
    }
    
    .badge {
        font-size: 0.9em;
        padding: 5px 10px;
    }
</style>
```

-----

## âœ… ä½¿ç”¨æµç¨‹

1. **ä½¿ç”¨è€…é»æ“Šã€ŒåŒ¯å‡ºå¸³è™Ÿæ¸…å–®ã€**

- ç³»çµ±ç”¨ `HI_CODEGUARD_DLL` ç”¢ç”Ÿ 8 ç¢¼æˆæ¬Šç¢¼

1. **ç”¢ç”ŸåŠ å¯† Excel**

- ä½¿ç”¨ NPOI å»ºç«‹ Excel
- ä½¿ç”¨æˆæ¬Šç¢¼åŠ å¯†æª”æ¡ˆ

1. **å„²å­˜è¨˜éŒ„**

- æª”æ¡ˆåç¨±ã€æˆæ¬Šç¢¼ã€åŒ¯å‡ºäººå“¡ã€æ™‚é–“å­˜å…¥ `CODEGUARD_RECORD` è¡¨

1. **é¡¯ç¤ºæˆæ¬Šç¢¼**

- å½ˆå‡º Modal é¡¯ç¤ºæˆæ¬Šç¢¼
- æä¾›è¤‡è£½åŠŸèƒ½

1. **ä¸‹è¼‰æª”æ¡ˆ**

- ä½¿ç”¨è€…ä¸‹è¼‰åŠ å¯†çš„ Excel
- é–‹å•Ÿæ™‚éœ€è¦è¼¸å…¥æˆæ¬Šç¢¼

-----

## ğŸ” æ¸¬è©¦æ–¹å¼

1. é»æ“Šã€ŒåŒ¯å‡ºå¸³è™Ÿæ¸…å–®ã€
1. æœƒå‡ºç¾ Modal é¡¯ç¤ºæˆæ¬Šç¢¼ (ä¾‹å¦‚: `A1B2C3D4`)
1. è¤‡è£½æˆ–è¨˜ä¸‹æˆæ¬Šç¢¼
1. ä¸‹è¼‰ Excel æª”æ¡ˆ
1. é–‹å•Ÿ Excel æ™‚,æœƒè¦æ±‚è¼¸å…¥å¯†ç¢¼
1. è¼¸å…¥æˆæ¬Šç¢¼å³å¯é–‹å•ŸæŸ¥çœ‹å…§å®¹

å®Œæˆ! ğŸ‰â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹