/// <summary>
/// 匯出帳號清單 (Excel加密 - 使用 EPPlus)
/// </summary>
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;

        // 1. 產生授權碼
        CODE_GUARD codeGuard = new CODE_GUARD();
        
        // ⭐⭐⭐ 只改這裡!加上時間戳記 ⭐⭐⭐
        string timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
        string dataWithTimestamp = this.Emp_NO + timestamp;
        
        string getCodeRequest = JsonConvert.SerializeObject(new
        {
            SysID = systemId,
            Data = dataWithTimestamp,  // ⭐ 改這個參數就好
            CodeLength = 8
        });

        string getCodeResponse = codeGuard.GetCode(getCodeRequest);
        dynamic codeResult = JsonConvert.DeserializeObject(getCodeResponse);

        if (codeResult.Result_code != "0000")
        {
            return Content($"<script>alert('產生授權碼失敗: {codeResult.Msg}'); window.history.back();</script>", "text/html");
        }

        string authCode = codeResult.Code.ToString();

        // 2-7. 後面都不用改...
        // (取得帳號清單、產生Excel、儲存記錄、回傳檔案)
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('匯出失敗: {ex.Message}'); window.history.back();</script>", "text/html");
    }
}
