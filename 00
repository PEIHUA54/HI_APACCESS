跳授權碼modal:
檔案名稱: 20251125110035_匯出帳號清單.xlsx
檔案已加密,請使用以下授權碼開啟:A99F24F2(複製放授權碼旁邊)
關閉
匯出紀錄modal:
少了授權碼欄位
目前成功匯出excel，但沒有加密，沒有輸入授權碼就可以打開看到資料。
controller:
        #region 匯出帳號清單
    

        /// <summary>
        /// 匯出帳號清單 (Excel加密)
        /// </summary>
        [HttpGet]
        public ActionResult ExportUserList()
        {
            try
            {
                string systemId = Session["CurrentSystemId"] as string;

                // 1. 產生授權碼
                CODE_GUARD codeGuard = new CODE_GUARD();
                string getCodeRequest = JsonConvert.SerializeObject(new
                {
                    SysID = systemId,
                    Data = this.Emp_NO,
                    CodeLength = 8
                });

                string getCodeResponse = codeGuard.GetCode(getCodeRequest);
                dynamic codeResult = JsonConvert.DeserializeObject(getCodeResponse);

                if (codeResult.Result_code != "0000")
                {
                    return Content($"<script>alert('產生授權碼失敗: {codeResult.Msg}'); window.history.back();</script>", "text/html");
                }

                string authCode = codeResult.Code.ToString();

                // 2. 取得帳號清單
                var service = GetAPService();
                var userList = service.GetAllUsersForExport(systemId);

                if (userList == null || userList.Count == 0)
                {
                    return Content("<script>alert('查無資料'); window.history.back();</script>", "text/html");
                }

                // 3. 產生加密 Excel
                string fileName = $"{DateTime.Now:yyyyMMddHHmmss}_匯出帳號清單";
                byte[] excelBytes = CreateEncryptedExcel(userList, systemId, authCode);

                // 4. 儲存記錄到資料庫
                var recordModel = new CodeGuardRecordModel
                {
                    FILE_NAME = fileName,
                    CODE_GUARD = authCode,
                    CREATOR = this.Emp_NO,
                    SYS_ID = systemId
                };

                service.SaveCodeGuardRecord(recordModel);

                // 5. 刪除超過3個月的舊記錄
                service.DeleteOldRecords();

                // 6. 儲存授權碼到 TempData (供 Ajax 取得)
                TempData["AuthCode"] = authCode;
                TempData["FileName"] = fileName;

                // 7. 回傳 Excel 檔案
                return File(excelBytes, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    $"{fileName}.xlsx");
            }
            catch (Exception ex)
            {
                return Content($"<script>alert('匯出失敗: {ex.Message}'); window.history.back();</script>", "text/html");
            }
        }

        /// <summary>
        /// 使用 NPOI 建立加密 Excel
        /// </summary>
        private byte[] CreateEncryptedExcel(List<UserExportModel> userList, string systemId, string password)
        {
            try
            {
                XSSFWorkbook workbook = new XSSFWorkbook();
                ISheet sheet = workbook.CreateSheet("帳號清單");

                // 建立樣式
                ICellStyle headerStyle = workbook.CreateCellStyle();
                headerStyle.FillForegroundColor = NPOI.HSSF.Util.HSSFColor.Grey25Percent.Index;
                headerStyle.FillPattern = FillPattern.SolidForeground;
                headerStyle.Alignment = HorizontalAlignment.Center;
                headerStyle.VerticalAlignment = VerticalAlignment.Center;
                headerStyle.BorderTop = BorderStyle.Thin;
                headerStyle.BorderBottom = BorderStyle.Thin;
                headerStyle.BorderLeft = BorderStyle.Thin;
                headerStyle.BorderRight = BorderStyle.Thin;

                IFont headerFont = workbook.CreateFont();
                headerFont.IsBold = true;
                headerFont.FontHeightInPoints = 11;
                headerFont.FontName = "微軟正黑體";
                headerStyle.SetFont(headerFont);

                ICellStyle cellStyle = workbook.CreateCellStyle();
                cellStyle.Alignment = HorizontalAlignment.Left;
                cellStyle.VerticalAlignment = VerticalAlignment.Center;
                cellStyle.BorderTop = BorderStyle.Thin;
                cellStyle.BorderBottom = BorderStyle.Thin;
                cellStyle.BorderLeft = BorderStyle.Thin;
                cellStyle.BorderRight = BorderStyle.Thin;

                IFont cellFont = workbook.CreateFont();
                cellFont.FontName = "微軟正黑體";
                cellStyle.SetFont(cellFont);

                // 建立標題列
                IRow headerRow = sheet.CreateRow(0);
                string[] headers = { "系統", "帳號", "姓名", "群組代號", "群組名稱",
                            "部門代號", "部門名稱", "建立人員", "建立日期", "修改人員", "修改日期" };

                for (int i = 0; i < headers.Length; i++)
                {
                    ICell cell = headerRow.CreateCell(i);
                    cell.SetCellValue(headers[i]);
                    cell.CellStyle = headerStyle;
                }

                // 填入資料
                int rowIndex = 1;
                foreach (var user in userList)
                {
                    IRow dataRow = sheet.CreateRow(rowIndex);
                    CreateStyledCell(dataRow, 0, systemId ?? "", cellStyle);
                    CreateStyledCell(dataRow, 1, user.U_ID ?? "", cellStyle);
                    CreateStyledCell(dataRow, 2, user.U_NAME ?? "", cellStyle);
                    CreateStyledCell(dataRow, 3, user.APG_NO ?? "", cellStyle);
                    CreateStyledCell(dataRow, 4, user.APG_NAME ?? "", cellStyle);
                    CreateStyledCell(dataRow, 5, user.ORGAN_NO ?? "", cellStyle);
                    CreateStyledCell(dataRow, 6, user.ORGAN_CAP ?? "", cellStyle);
                    CreateStyledCell(dataRow, 7, user.CREATOR ?? "", cellStyle);
                    CreateStyledCell(dataRow, 8, user.CREATE_TIME ?? "", cellStyle);
                    CreateStyledCell(dataRow, 9, user.EDITOR ?? "", cellStyle);
                    CreateStyledCell(dataRow, 10, user.EDIT_TIME ?? "", cellStyle);
                    rowIndex++;
                }

                // 自動調整欄寬
                for (int i = 0; i < headers.Length; i++)
                {
                    sheet.AutoSizeColumn(i);
                    int currentWidth = (int)sheet.GetColumnWidth(i);
                    sheet.SetColumnWidth(i, currentWidth + 1000);
                }

                // 凍結首列
                sheet.CreateFreezePane(0, 1);

                // 工作表保護
                sheet.ProtectSheet(password);
                workbook.LockStructure();

                // 寫入串流
                using (MemoryStream stream = new MemoryStream())
                {
                    workbook.Write(stream, false);
                    workbook.Close();
                    return stream.ToArray();
                }
            }
            catch (Exception ex)
            {
                throw new Exception($"建立 Excel 失敗: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 建立帶樣式的儲存格
        /// </summary>
        private void CreateStyledCell(IRow row, int columnIndex, string value, ICellStyle style)
        {
            ICell cell = row.CreateCell(columnIndex);
            cell.SetCellValue(value);
            cell.CellStyle = style;
        }

        /// <summary>
        /// 加密 Excel 檔案
        /// </summary>
        private byte[] EncryptExcelFile(byte[] excelBytes, string password)
        {
            try
            {
                // 讀取未加密的 Excel
                using (MemoryStream inputStream = new MemoryStream(excelBytes))
                {
                    // 建立 POIFSFileSystem
                    POIFSFileSystem fs = new POIFSFileSystem();

                    // 建立加密資訊 (使用 Agile 加密模式)
                    EncryptionInfo info = new EncryptionInfo(EncryptionMode.Agile);
                    Encryptor enc = info.Encryptor;

                    // 設定密碼
                    enc.ConfirmPassword(password);

                    // 將 Excel 內容寫入加密串流
                    using (Stream encryptedStream = enc.GetDataStream(fs))
                    {
                        inputStream.Position = 0;
                        inputStream.CopyTo(encryptedStream);
                    }

                    // 輸出加密後的檔案
                    using (MemoryStream outputStream = new MemoryStream())
                    {
                        fs.WriteFileSystem(outputStream);
                        fs.Close();
                        return outputStream.ToArray();
                    }
                }
            }
            catch (Exception ex)
            {
                throw new Exception($"Excel 加密失敗: {ex.Message}", ex);
            }
        }

        /// <summary>
        /// 查看匯出記錄
        /// </summary>
        [HttpGet]
        public ActionResult ExportRecords()
        {
            try
            {
                string systemId = Session["CurrentSystemId"] as string;

                var service = GetAPService();
                var records = service.GetMyExportRecords(this.Emp_NO, systemId);

                return View(records);
            }
            catch (Exception ex)
            {
                return Content($"<script>alert('查詢失敗: {ex.Message}'); window.history.back();</script>", "text/html");
            }
        }

        /// <summary>
        /// 取得授權碼資訊 (Ajax)
        /// </summary>
        [HttpGet]
        public JsonResult GetAuthCodeInfo()
        {
            try
            {
                if (TempData["AuthCode"] != null && TempData["FileName"] != null)
                {
                    var authCode = TempData["AuthCode"].ToString();
                    var fileName = TempData["FileName"].ToString();

                    // 保留 TempData 供下次使用
                    TempData.Keep("AuthCode");
                    TempData.Keep("FileName");

                    return Json(new
                    {
                        success = true,
                        authCode = authCode,
                        fileName = fileName
                    }, JsonRequestBehavior.AllowGet);
                }

                return Json(new { success = false }, JsonRequestBehavior.AllowGet);
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = ex.Message }, JsonRequestBehavior.AllowGet);
            }
        }

        /// <summary>
        /// 取得匯出記錄 (Ajax)
        /// </summary>
        [HttpGet]
        public JsonResult GetExportRecords()
        {
            try
            {
                string systemId = Session["CurrentSystemId"] as string;

                var service = GetAPService();
                var records = service.GetMyExportRecords(this.Emp_NO, systemId);

                if (records != null && records.Count > 0)
                {
                    return Json(new
                    {
                        success = true,
                        records = records
                    }, JsonRequestBehavior.AllowGet);
                }
                else
                {
                    return Json(new
                    {
                        success = false,
                        message = "目前沒有匯出記錄"
                    }, JsonRequestBehavior.AllowGet);
                }
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    message = $"查詢失敗: {ex.Message}"
                }, JsonRequestBehavior.AllowGet);
            }
        }

        #endregion
