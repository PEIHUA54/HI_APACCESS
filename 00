åŒ¯å‡ºå¸³è™Ÿæ¸…å–®éœ€è¦ä¿®æ”¹ï¼ŒåŒ¯å‡ºå¸³è™Ÿæ¸…å–®æ™‚è¦åŠ å¯†ï¼›
é¦–å…ˆ(ç”¨æˆæ¬Šç¢¼DLLç”¢ å‰›å‰›åšçš„GETCODE) åƒæ•¸1.ç³»çµ±ID 2.DATA:å“¡å·¥ç·¨è™Ÿ 3.é•·åº¦8ç¢¼ï¼Œ
ç”¢å‡ºæˆæ¬Šç¢¼ï¼Œè¦å­˜å…¥è³‡æ–™è¡¨[HI_TMMAIN].[dbo].[CODEGUARD_RECORD]ï¼Œ
è³‡æ–™è¡¨FILE_NAMEæ¬„ä½=>å¹´æœˆæ—¥æ™‚åˆ†ç§’+"åŒ¯å‡ºå¸³è™Ÿæ¸…å–®"ï¼Œ
åŒ¯å‡ºEXCELè¡¨è¦åŠ å¯†ï¼Œå¯†ç¢¼ç‚ºæˆæ¬Šç¢¼ï¼Œ
åŠ ä¸€å€‹æŒ‰éˆ•(åŒ¯å‡ºç´€éŒ„)åªèƒ½çœ‹åˆ°è‡ªå·±åŒ¯å‡ºçš„ç´€éŒ„ï¼ŒSELECT é€™è¡¨[CODEGUARD_RECORD] è¨­æ¢ä»¶ï¼Œ
ç´€éŒ„ä¿ç•™3å€‹æœˆï¼Œè¶…éä¸‰å€‹æœˆå°±DELETEåˆªæ‰ã€‚

ç•¶ç„¶å¯ä»¥!NPOI æ˜¯æ›´è¼•é‡ä¸”å…è²»çš„é¸æ“‡ã€‚æˆ‘ä¾†æ”¹ç”¨ NPOI å¯¦ä½œ:

-----

## ğŸ“¦ 1. NuGet å¥—ä»¶å®‰è£

```
Install-Package NPOI -Version 2.7.1
```

æˆ–åœ¨ `packages.config` åŠ å…¥:

```xml
<package id="NPOI" version="2.7.1" targetFramework="net48" />
```

-----

## ğŸ® 2. Controller (APController.cs) - ä½¿ç”¨ NPOI

```csharp
using System;
using System.Collections.Generic;
using System.IO;
using System.Web.Mvc;
using HI_CODEGUARD_DLL;
using Newtonsoft.Json;
using NPOI.XSSF.UserModel;
using NPOI.SS.UserModel;
using NPOI.POIFS.Crypt;
using YourNamespace.Models;
using YourNamespace.Factory;

#region åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (åŠ å¯†ç‰ˆ - ä½¿ç”¨ NPOI)

// åŒ¯å‡ºå¸³è™Ÿæ¸…å–® (åŠ å¯† Excel)
[HttpGet]
public ActionResult ExportUserList()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        string employeeNo = Session["UserID"] as string; // å¾ Session å–å¾—å“¡å·¥ç·¨è™Ÿ

        if (string.IsNullOrEmpty(employeeNo))
        {
            return Content("<script>alert('ç„¡æ³•å–å¾—å“¡å·¥ç·¨è™Ÿ'); window.history.back();</script>", "text/html");
        }

        // 1. ç”¢ç”Ÿæˆæ¬Šç¢¼
        CODE_GUARD codeGuard = new CODE_GUARD();
        string getCodeRequest = JsonConvert.SerializeObject(new
        {
            SysID = systemId,
            Data = employeeNo,
            CodeLength = 8
        });

        string getCodeResponse = codeGuard.GetCode(getCodeRequest);
        dynamic codeResult = JsonConvert.DeserializeObject(getCodeResponse);

        if (codeResult.Result_code != "0000")
        {
            return Content($"<script>alert('ç”¢ç”Ÿæˆæ¬Šç¢¼å¤±æ•—:{codeResult.Msg}'); window.history.back();</script>", "text/html");
        }

        string authCode = codeResult.Code.ToString();

        // 2. å–å¾—å¸³è™Ÿæ¸…å–®
        var service = GetAPService();
        var userList = service.GetAllUsersForExport(systemId);

        if (userList == null || userList.Count == 0)
        {
            return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
        }

        // 3. ç”¢ç”ŸåŠ å¯† Excel
        string fileName = $"{DateTime.Now:yyyyMMddHHmmss}_åŒ¯å‡ºå¸³è™Ÿæ¸…å–®";
        byte[] excelBytes = CreateEncryptedExcelWithNPOI(userList, systemId, authCode);

        // 4. å„²å­˜è¨˜éŒ„åˆ°è³‡æ–™åº«
        var recordModel = new CodeGuardRecordModel
        {
            FILE_NAME = fileName,
            CODE_GUARD = authCode,
            CREATOR = employeeNo,
            SYS_ID = systemId
        };

        bool saveResult = service.SaveCodeGuardRecord(recordModel);
        if (!saveResult)
        {
            // è¨˜éŒ„å¤±æ•—ä½†ä¸å½±éŸ¿ä¸‹è¼‰
            System.Diagnostics.Debug.WriteLine("å„²å­˜æˆæ¬Šç¢¼è¨˜éŒ„å¤±æ•—");
        }

        // 5. åˆªé™¤è¶…é3å€‹æœˆçš„èˆŠè¨˜éŒ„
        service.DeleteOldRecords();

        // 6. å›å‚³åŠ å¯†çš„ Excel æª”æ¡ˆ
        return File(excelBytes, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
            $"{fileName}.xlsx");
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—:{ex.Message}'); window.history.back();</script>", "text/html");
    }
}

// ä½¿ç”¨ NPOI å»ºç«‹åŠ å¯† Excel
private byte[] CreateEncryptedExcelWithNPOI(List<UserExportModel> userList, string systemId, string password)
{
    // å»ºç«‹æ–°çš„ Excel å·¥ä½œç°¿ (XLSX)
    IWorkbook workbook = new XSSFWorkbook();
    ISheet sheet = workbook.CreateSheet("å¸³è™Ÿæ¸…å–®");

    // å»ºç«‹æ¨™é¡Œåˆ—æ¨£å¼
    ICellStyle headerStyle = workbook.CreateCellStyle();
    headerStyle.FillForegroundColor = NPOI.HSSF.Util.HSSFColor.Grey25Percent.Index;
    headerStyle.FillPattern = FillPattern.SolidForeground;
    headerStyle.Alignment = HorizontalAlignment.Center;
    headerStyle.VerticalAlignment = VerticalAlignment.Center;
    
    IFont headerFont = workbook.CreateFont();
    headerFont.IsBold = true;
    headerFont.FontHeightInPoints = 11;
    headerStyle.SetFont(headerFont);

    // å»ºç«‹ä¸€èˆ¬å„²å­˜æ ¼æ¨£å¼
    ICellStyle cellStyle = workbook.CreateCellStyle();
    cellStyle.Alignment = HorizontalAlignment.Left;
    cellStyle.VerticalAlignment = VerticalAlignment.Center;

    // å»ºç«‹æ¨™é¡Œåˆ—
    IRow headerRow = sheet.CreateRow(0);
    string[] headers = new string[] 
    { 
        "ç³»çµ±", "å¸³è™Ÿ", "å§“å", "ç¾¤çµ„ä»£è™Ÿ", "ç¾¤çµ„åç¨±", 
        "éƒ¨é–€ä»£è™Ÿ", "éƒ¨é–€åç¨±", "å»ºç«‹äººå“¡", "å»ºç«‹æ—¥æœŸ", "ä¿®æ”¹äººå“¡", "ä¿®æ”¹æ—¥æœŸ" 
    };

    for (int i = 0; i < headers.Length; i++)
    {
        ICell cell = headerRow.CreateCell(i);
        cell.SetCellValue(headers[i]);
        cell.CellStyle = headerStyle;
    }

    // å¡«å…¥è³‡æ–™
    int rowIndex = 1;
    foreach (var user in userList)
    {
        IRow dataRow = sheet.CreateRow(rowIndex);

        // ç³»çµ±
        ICell cell0 = dataRow.CreateCell(0);
        cell0.SetCellValue(systemId ?? "");
        cell0.CellStyle = cellStyle;

        // å¸³è™Ÿ
        ICell cell1 = dataRow.CreateCell(1);
        cell1.SetCellValue(user.U_ID ?? "");
        cell1.CellStyle = cellStyle;

        // å§“å
        ICell cell2 = dataRow.CreateCell(2);
        cell2.SetCellValue(user.U_NAME ?? "");
        cell2.CellStyle = cellStyle;

        // ç¾¤çµ„ä»£è™Ÿ
        ICell cell3 = dataRow.CreateCell(3);
        cell3.SetCellValue(user.APG_NO ?? "");
        cell3.CellStyle = cellStyle;

        // ç¾¤çµ„åç¨±
        ICell cell4 = dataRow.CreateCell(4);
        cell4.SetCellValue(user.APG_NAME ?? "");
        cell4.CellStyle = cellStyle;

        // éƒ¨é–€ä»£è™Ÿ
        ICell cell5 = dataRow.CreateCell(5);
        cell5.SetCellValue(user.ORGAN_NO ?? "");
        cell5.CellStyle = cellStyle;

        // éƒ¨é–€åç¨±
        ICell cell6 = dataRow.CreateCell(6);
        cell6.SetCellValue(user.ORGAN_CAP ?? "");
        cell6.CellStyle = cellStyle;

        // å»ºç«‹äººå“¡
        ICell cell7 = dataRow.CreateCell(7);
        cell7.SetCellValue(user.CREATOR ?? "");
        cell7.CellStyle = cellStyle;

        // å»ºç«‹æ—¥æœŸ
        ICell cell8 = dataRow.CreateCell(8);
        cell8.SetCellValue(user.CREATE_TIME ?? "");
        cell8.CellStyle = cellStyle;

        // ä¿®æ”¹äººå“¡
        ICell cell9 = dataRow.CreateCell(9);
        cell9.SetCellValue(user.EDITOR ?? "");
        cell9.CellStyle = cellStyle;

        // ä¿®æ”¹æ—¥æœŸ
        ICell cell10 = dataRow.CreateCell(10);
        cell10.SetCellValue(user.EDIT_TIME ?? "");
        cell10.CellStyle = cellStyle;

        rowIndex++;
    }

    // è‡ªå‹•èª¿æ•´æ¬„å¯¬
    for (int i = 0; i < headers.Length; i++)
    {
        sheet.AutoSizeColumn(i);
        // è¨­å®šæœ€å°å’Œæœ€å¤§å¯¬åº¦
        int currentWidth = sheet.GetColumnWidth(i);
        if (currentWidth < 2000) // æœ€å°å¯¬åº¦
        {
            sheet.SetColumnWidth(i, 2000);
        }
        else if (currentWidth > 10000) // æœ€å¤§å¯¬åº¦
        {
            sheet.SetColumnWidth(i, 10000);
        }
    }

    // å¯«å…¥è¨˜æ†¶é«”ä¸²æµ (æœªåŠ å¯†)
    MemoryStream stream = new MemoryStream();
    workbook.Write(stream);
    stream.Flush();

    // é—œé–‰å·¥ä½œç°¿
    workbook.Close();

    // åŠ å¯†è™•ç†
    byte[] encryptedBytes = EncryptExcelWithPassword(stream.ToArray(), password);

    stream.Close();

    return encryptedBytes;
}

// Excel åŠ å¯†æ–¹æ³• (ä½¿ç”¨ NPOI)
private byte[] EncryptExcelWithPassword(byte[] excelBytes, string password)
{
    try
    {
        // è®€å–æœªåŠ å¯†çš„ Excel
        using (MemoryStream inputStream = new MemoryStream(excelBytes))
        {
            XSSFWorkbook workbook = new XSSFWorkbook(inputStream);

            // å»ºç«‹è¼¸å‡ºä¸²æµ
            using (MemoryStream outputStream = new MemoryStream())
            {
                // NPOI çš„åŠ å¯†æ–¹å¼
                POIFSFileSystem fs = new POIFSFileSystem();
                EncryptionInfo info = new EncryptionInfo(EncryptionMode.Agile);
                Encryptor enc = info.Encryptor;
                enc.ConfirmPassword(password);

                // å°‡å·¥ä½œç°¿å¯«å…¥åŠ å¯†ä¸²æµ
                using (var encryptedStream = enc.GetDataStream(fs))
                {
                    workbook.Write(encryptedStream);
                }

                // å°‡åŠ å¯†å¾Œçš„æª”æ¡ˆå¯«å…¥è¼¸å‡ºä¸²æµ
                fs.WriteFilesystem(outputStream);

                workbook.Close();
                fs.Close();

                return outputStream.ToArray();
            }
        }
    }
    catch (Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"åŠ å¯†å¤±æ•—: {ex.Message}");
        // å¦‚æœåŠ å¯†å¤±æ•—,è¿”å›æœªåŠ å¯†çš„æª”æ¡ˆ
        return excelBytes;
    }
}

// æŸ¥çœ‹åŒ¯å‡ºè¨˜éŒ„
[HttpGet]
public ActionResult ExportRecords()
{
    try
    {
        string systemId = Session["CurrentSystemId"] as string;
        string employeeNo = Session["UserID"] as string;

        if (string.IsNullOrEmpty(employeeNo))
        {
            return Content("<script>alert('ç„¡æ³•å–å¾—å“¡å·¥ç·¨è™Ÿ'); window.history.back();</script>", "text/html");
        }

        var service = GetAPService();
        var records = service.GetMyExportRecords(employeeNo, systemId);

        return View(records);
    }
    catch (Exception ex)
    {
        return Content($"<script>alert('æŸ¥è©¢å¤±æ•—:{ex.Message}'); window.history.back();</script>", "text/html");
    }
}

#endregion
```

-----

## ğŸ“ 3. ç°¡åŒ–ç‰ˆ (å¦‚æœ NPOI åŠ å¯†æœ‰å•é¡Œ)

NPOI çš„åŠ å¯†åŠŸèƒ½æ¯”è¼ƒè¤‡é›œ,å¦‚æœé‡åˆ°å•é¡Œ,å¯ä»¥ä½¿ç”¨é€™å€‹ç°¡åŒ–ç‰ˆæœ¬:

```csharp
// ä½¿ç”¨ NPOI å»ºç«‹ Excel (ç°¡åŒ–ç‰ˆ - å…ˆä¸åŠ å¯†)
private byte[] CreateEncryptedExcelWithNPOI(List<UserExportModel> userList, string systemId, string password)
{
    // å»ºç«‹æ–°çš„ Excel å·¥ä½œç°¿ (XLSX)
    IWorkbook workbook = new XSSFWorkbook();
    ISheet sheet = workbook.CreateSheet("å¸³è™Ÿæ¸…å–®");

    // å»ºç«‹æ¨™é¡Œåˆ—æ¨£å¼
    ICellStyle headerStyle = workbook.CreateCellStyle();
    headerStyle.FillForegroundColor = NPOI.HSSF.Util.HSSFColor.Grey25Percent.Index;
    headerStyle.FillPattern = FillPattern.SolidForeground;
    headerStyle.Alignment = HorizontalAlignment.Center;
    
    IFont headerFont = workbook.CreateFont();
    headerFont.IsBold = true;
    headerFont.FontHeightInPoints = 11;
    headerStyle.SetFont(headerFont);

    // å»ºç«‹æ¨™é¡Œåˆ—
    IRow headerRow = sheet.CreateRow(0);
    string[] headers = new string[] 
    { 
        "ç³»çµ±", "å¸³è™Ÿ", "å§“å", "ç¾¤çµ„ä»£è™Ÿ", "ç¾¤çµ„åç¨±", 
        "éƒ¨é–€ä»£è™Ÿ", "éƒ¨é–€åç¨±", "å»ºç«‹äººå“¡", "å»ºç«‹æ—¥æœŸ", "ä¿®æ”¹äººå“¡", "ä¿®æ”¹æ—¥æœŸ" 
    };

    for (int i = 0; i < headers.Length; i++)
    {
        ICell cell = headerRow.CreateCell(i);
        cell.SetCellValue(headers[i]);
        cell.CellStyle = headerStyle;
    }

    // å¡«å…¥è³‡æ–™
    int rowIndex = 1;
    foreach (var user in userList)
    {
        IRow dataRow = sheet.CreateRow(rowIndex);
        
        dataRow.CreateCell(0).SetCellValue(systemId ?? "");
        dataRow.CreateCell(1).SetCellValue(user.U_ID ?? "");
        dataRow.CreateCell(2).SetCellValue(user.U_NAME ?? "");
        dataRow.CreateCell(3).SetCellValue(user.APG_NO ?? "");
        dataRow.CreateCell(4).SetCellValue(user.APG_NAME ?? "");
        dataRow.CreateCell(5).SetCellValue(user.ORGAN_NO ?? "");
        dataRow.CreateCell(6).SetCellValue(user.ORGAN_CAP ?? "");
        dataRow.CreateCell(7).SetCellValue(user.CREATOR ?? "");
        dataRow.CreateCell(8).SetCellValue(user.CREATE_TIME ?? "");
        dataRow.CreateCell(9).SetCellValue(user.EDITOR ?? "");
        dataRow.CreateCell(10).SetCellValue(user.EDIT_TIME ?? "");

        rowIndex++;
    }

    // è‡ªå‹•èª¿æ•´æ¬„å¯¬
    for (int i = 0; i < headers.Length; i++)
    {
        sheet.AutoSizeColumn(i);
    }

    // ä½¿ç”¨ NPOI çš„ä¿è­·åŠŸèƒ½ (ç°¡æ˜“åŠ å¯†)
    sheet.ProtectSheet(password);
    
    // å¯«å…¥è¨˜æ†¶é«”ä¸²æµ
    using (MemoryStream stream = new MemoryStream())
    {
        workbook.Write(stream);
        workbook.Close();
        return stream.ToArray();
    }
}
```

-----

## ğŸ” 4. å®Œæ•´åŠ å¯†ç‰ˆæœ¬ (éœ€è¦é¡å¤–å¥—ä»¶)

å¦‚æœéœ€è¦çœŸæ­£çš„ Excel æª”æ¡ˆåŠ å¯†,éœ€è¦å®‰è£é¡å¤–å¥—ä»¶:

```
Install-Package NPOI -Version 2.7.1
Install-Package BouncyCastle.Cryptography -Version 2.2.1
```

ç„¶å¾Œä½¿ç”¨é€™å€‹å®Œæ•´ç‰ˆ:

```csharp
using System;
using System.IO;
using System.Collections.Generic;
using NPOI.XSSF.UserModel;
using NPOI.SS.UserModel;
using NPOI.POIFS.FileSystem;
using NPOI.POIFS.Crypt;
using NPOI.POIFS.Crypt.Agile;

// å®Œæ•´çš„åŠ å¯† Excel æ–¹æ³•
private byte[] CreateEncryptedExcelWithNPOI(List<UserExportModel> userList, string systemId, string password)
{
    // å»ºç«‹å·¥ä½œç°¿
    XSSFWorkbook workbook = new XSSFWorkbook();
    ISheet sheet = workbook.CreateSheet("å¸³è™Ÿæ¸…å–®");

    // å»ºç«‹æ¨™é¡Œåˆ—æ¨£å¼
    ICellStyle headerStyle = workbook.CreateCellStyle();
    headerStyle.FillForegroundColor = NPOI.HSSF.Util.HSSFColor.Grey25Percent.Index;
    headerStyle.FillPattern = FillPattern.SolidForeground;
    headerStyle.Alignment = HorizontalAlignment.Center;
    
    IFont headerFont = workbook.CreateFont();
    headerFont.IsBold = true;
    headerStyle.SetFont(headerFont);

    // å»ºç«‹æ¨™é¡Œåˆ—
    IRow headerRow = sheet.CreateRow(0);
    string[] headers = { "ç³»çµ±", "å¸³è™Ÿ", "å§“å", "ç¾¤çµ„ä»£è™Ÿ", "ç¾¤çµ„åç¨±", 
                         "éƒ¨é–€ä»£è™Ÿ", "éƒ¨é–€åç¨±", "å»ºç«‹äººå“¡", "å»ºç«‹æ—¥æœŸ", 
                         "ä¿®æ”¹äººå“¡", "ä¿®æ”¹æ—¥æœŸ" };

    for (int i = 0; i < headers.Length; i++)
    {
        ICell cell = headerRow.CreateCell(i);
        cell.SetCellValue(headers[i]);
        cell.CellStyle = headerStyle;
    }

    // å¡«å…¥è³‡æ–™
    int rowIndex = 1;
    foreach (var user in userList)
    {
        IRow row = sheet.CreateRow(rowIndex++);
        row.CreateCell(0).SetCellValue(systemId ?? "");
        row.CreateCell(1).SetCellValue(user.U_ID ?? "");
        row.CreateCell(2).SetCellValue(user.U_NAME ?? "");
        row.CreateCell(3).SetCellValue(user.APG_NO ?? "");
        row.CreateCell(4).SetCellValue(user.APG_NAME ?? "");
        row.CreateCell(5).SetCellValue(user.ORGAN_NO ?? "");
        row.CreateCell(6).SetCellValue(user.ORGAN_CAP ?? "");
        row.CreateCell(7).SetCellValue(user.CREATOR ?? "");
        row.CreateCell(8).SetCellValue(user.CREATE_TIME ?? "");
        row.CreateCell(9).SetCellValue(user.EDITOR ?? "");
        row.CreateCell(10).SetCellValue(user.EDIT_TIME ?? "");
    }

    // è‡ªå‹•èª¿æ•´æ¬„å¯¬
    for (int i = 0; i < headers.Length; i++)
    {
        sheet.AutoSizeColumn(i);
    }

    // å…ˆå¯«å…¥æœªåŠ å¯†çš„ä¸²æµ
    using (MemoryStream tempStream = new MemoryStream())
    {
        workbook.Write(tempStream, false);
        tempStream.Position = 0;

        // åŠ å¯†è™•ç†
        POIFSFileSystem fs = new POIFSFileSystem();
        EncryptionInfo info = new EncryptionInfo(EncryptionMode.Agile);
        Encryptor enc = info.Encryptor;
        enc.ConfirmPassword(password);

        using (Stream os = enc.GetDataStream(fs))
        {
            tempStream.CopyTo(os);
        }

        // è¼¸å‡ºåŠ å¯†å¾Œçš„æª”æ¡ˆ
        using (MemoryStream outputStream = new MemoryStream())
        {
            fs.WriteFilesystem(outputStream);
            workbook.Close();
            fs.Close();
            return outputStream.ToArray();
        }
    }
}
```

-----

## âš ï¸ é‡è¦æé†’

### NPOI åŠ å¯†çš„ä¸‰ç¨®æ–¹å¼:

1. **Sheet Protection (å·¥ä½œè¡¨ä¿è­·)** - æœ€ç°¡å–®
   
   ```csharp
   sheet.ProtectSheet(password);
   ```

- å„ªé»: ç°¡å–®æ˜“ç”¨
- ç¼ºé»: åªæ˜¯ä¿è­·ç·¨è¼¯,ä¸æ˜¯çœŸæ­£åŠ å¯†

1. **Workbook Protection (å·¥ä½œç°¿ä¿è­·)** - ä¸­ç­‰
   
   ```csharp
   workbook.LockStructure();
   ```

- å„ªé»: ä¿è­·æ•´å€‹å·¥ä½œç°¿
- ç¼ºé»: é‚„æ˜¯å¯ä»¥æ‰“é–‹æŸ¥çœ‹

1. **File Encryption (æª”æ¡ˆåŠ å¯†)** - æœ€å®‰å…¨

- ä½¿ç”¨ NPOI.POIFS.Crypt
- å„ªé»: çœŸæ­£çš„æª”æ¡ˆåŠ å¯†
- ç¼ºé»: ç¨‹å¼ç¢¼è¤‡é›œ,å¯èƒ½éœ€è¦é¡å¤–å¥—ä»¶

-----

## ğŸ’¡ æˆ‘çš„å»ºè­°

**ä½¿ç”¨ç°¡åŒ–ç‰ˆ + Sheet Protection:**

é€™æ¨£æœ€ç©©å®š,è€Œä¸”å°å¤§éƒ¨åˆ†ä½¿ç”¨å ´æ™¯å·²ç¶“è¶³å¤ :

```csharp
sheet.ProtectSheet(password);
```

å¦‚æœçœŸçš„éœ€è¦æª”æ¡ˆç´šåŠ å¯†,å»ºè­°ä½¿ç”¨ EPPlus,å› ç‚ºå®ƒçš„åŠ å¯†åŠŸèƒ½æ›´æˆç†Ÿç©©å®š! ğŸ¯â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹
CONTROLLER:
#region åŒ¯å‡ºå¸³è™Ÿæ¸…å–®
 // åŒ¯å‡ºå¸³è™Ÿæ¸…å–®
 [HttpGet]
 public ActionResult ExportUserList()
 {
     try
     {
         string systemId = Session["CurrentSystemId"] as string;

         // å–å¾—å¸³è™Ÿæ¸…å–®
         var service = GetAPService();
         var userList = service.GetAllUsersForExport(systemId);

         if (userList == null || userList.Count == 0)
         {
             return Content("<script>alert('æŸ¥ç„¡è³‡æ–™'); window.history.back();</script>", "text/html");
         }

         // å»ºç«‹ CSV å…§å®¹
         var csv = new System.Text.StringBuilder();

         // UTF-8 ç·¨ç¢¼
         csv.Append("\uFEFF");

         // æ¨™é¡Œåˆ—
         csv.AppendLine("ç³»çµ±,å¸³è™Ÿ,å§“å,ç¾¤çµ„ä»£è™Ÿ,ç¾¤çµ„åç¨±,éƒ¨é–€ä»£è™Ÿ,éƒ¨é–€åç¨±,å»ºç«‹äººå“¡,å»ºç«‹æ—¥æœŸ,ä¿®æ”¹äººå“¡,ä¿®æ”¹æ—¥æœŸ");

         // è³‡æ–™åˆ—
         foreach (var user in userList)
         {
             csv.AppendLine(string.Format("{0},{1},{2},{3},{4},{5},{6},{7},{8},{9},{10}",
                 FormatAsText(systemId),
                 FormatAsText(user.U_ID),        
                 FormatAsText(user.U_NAME),
                 FormatAsText(user.APG_NO),         
                 FormatAsText(user.APG_NAME),
                 FormatAsText(user.ORGAN_NO),
                 FormatAsText(user.ORGAN_CAP),
                 FormatAsText(user.CREATOR),
                 FormatAsText(user.CREATE_TIME),   
                 FormatAsText(user.EDITOR),
                 FormatAsText(user.EDIT_TIME)      
             ));
         }

         // è½‰æ›æˆ byte array
         byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());

         // ç”¢ç”Ÿæª”æ¡ˆ
         //string fileName = $"å¸³è™Ÿæ¸…å–®_{DateTime.Now:yyyyMMdd_HHmmss}.csv";

         return File(fileBytes, "text/csv", $"å¸³è™Ÿæ¸…å–®_{DateTime.Now:yyyyMMdd_HHmmss}.csv");
     }
     catch (Exception ex)
     {
         return Content($"<script>alert('åŒ¯å‡ºå¤±æ•—ï¼š{ex.Message}'); window.history.back();</script>", "text/html");
     }
 }

 // æ¬„ä½è™•ç†ï¼šè™•ç†é€—è™Ÿã€å¼•è™Ÿã€æ›è¡Œ
 private string FormatAsText(string field)
 {
     if (string.IsNullOrEmpty(field))
         return "";

     // ä½¿ç”¨ ="..." çš„æ–¹å¼å¼·åˆ¶ Excel ç•¶æˆæ–‡å­—
     // å¦‚æœæ¬„ä½å…§å«å¼•è™Ÿï¼Œéœ€è¦è·³è„«
     string escaped = field.Replace("\"", "\"\"");
     return $"=\"{escaped}\"";
 }
M_AP_SET:MODEL

  // å¸³è™ŸåŒ¯å‡º
  public class UserExportModel
  {
      public string U_ID { get; set; }
      public string U_NAME { get; set; }
      public string APG_NO { get; set; }
      public string APG_NAME { get; set; }
      public string ORGAN_NO { get; set; }
      public string ORGAN_CAP { get; set; }
      public string CREATOR { get; set; }
      public string CREATE_TIME { get; set; }
      public string EDITOR { get; set; }
      public string EDIT_TIME { get; set; }
  }
 
 // éœ€è¦å†æœ‰ä¸€å€‹å¸³è™ŸåŒ¯å‡ºç´€éŒ„MODEL
1.FILE_NAME æª”æ¡ˆåç¨±
2.CODE_GUARD æˆæ¬Šç¢¼
3.CREATOR è½‰å‡ºäººå“¡
4.CREATE_TIME è½‰å‡ºæ™‚é–“

F_AP:
    // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®(ç”¨æ–¼åŒ¯å‡º)
    public List<UserExportModel> GetAllUsersForExport(string systemId)
    {
        string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.GetAllUsersForExport);

        List<SqlParameter> parameters = new List<SqlParameter>
        {
            new SqlParameter("@SYS_ID", systemId)
        };

        DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
        return SVS_DBmanager.ConvertToList<UserExportModel>(dt);
    }

GetAllUsersForExport:SQL

	SELECT 
            u.[U_ID],
            u.[U_NAME],
            u.[APG_NO],
            g.[APG_NAME],
			m.[ORGAN_NO],
			m.[ORGAN_CAP],
            u.[CREATOR],
            CONVERT(varchar, u.[CREATE_TIME], 120) as CREATE_TIME, 
            u.[EDITOR],
            CONVERT(varchar, u.[EDIT_TIME], 120) as EDIT_TIME    
        FROM [HI-AUTOS].[dbo].[AP_USER] u
        LEFT JOIN [HI-AUTOS].[dbo].[AP_GROUP] g 
            ON u.[SYS_ID] = g.[SYS_ID] AND u.[APG_NO] = g.[APG_NO]
		LEFT JOIN [HI-AUTOS].[dbo].[M1EMP_MAST] m 
            ON u.U_ID = m.EMP_NO
        WHERE u.[SYS_ID] = @SYS_ID
        ORDER BY u.[APG_NO], u.[U_ID]

GroupManagement VIEW:

<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">ç³»çµ±ç¾¤çµ„æ¬Šé™ç®¡ç† : @ViewBag.SystemId</div>
    @if (showSwitchButton)
    {
        <div class="row mb-3">
            <div class="col-md-12">
                <button type="button" class="btn btn-secondary" id="btnSwitchSystem">
                    <i class="fas fa-exchange-alt"></i> åˆ‡æ›ç³»çµ±
                </button>
            </div>
        </div>
    }
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-outline-info" id="btnExportUsers">
                <i class="fas fa-file-export"></i>     åŒ¯å‡ºå¸³è™Ÿæ¸…å–®
            </button>
        </div>
    </div>
   // é€™é‚Šéœ€å¢åŠ ä¸€å€‹æŒ‰éˆ• (åŒ¯å‡ºç´€éŒ„)
</section>

JS:
    // åŒ¯å‡ºå¸³è™Ÿæ¸…å–®æŒ‰éˆ•äº‹ä»¶
    $('#btnExportUsers').click(function () {
        window.location.href = '@Url.Action("ExportUserList", "AP")';
    });
