æŠ±æ­‰!æˆ‘ä¾†è£œä¸Š Factory å’Œ Model çš„å®Œæ•´ç¨‹å¼ç¢¼:

-----

## ğŸ“ 1. Model (M_AP_SET.cs)

```csharp
using System;
using System.ComponentModel;
using Newtonsoft.Json;

namespace YourNamespace.Models
{
    /// <summary>
    /// å¸³è™ŸåŒ¯å‡º Model
    /// </summary>
    public class UserExportModel
    {
        public string U_ID { get; set; }
        public string U_NAME { get; set; }
        public string APG_NO { get; set; }
        public string APG_NAME { get; set; }
        public string ORGAN_NO { get; set; }
        public string ORGAN_CAP { get; set; }
        public string CREATOR { get; set; }
        public string CREATE_TIME { get; set; }
        public string EDITOR { get; set; }
        public string EDIT_TIME { get; set; }
    }

    /// <summary>
    /// æˆæ¬Šç¢¼è¨˜éŒ„ Model (è³‡æ–™åº«ç”¨)
    /// </summary>
    public class CodeGuardRecordModel
    {
        public int ID { get; set; }
        public string FILE_NAME { get; set; }
        public string CODE_GUARD { get; set; }
        public string CREATOR { get; set; }
        public DateTime CREATE_TIME { get; set; }
        public string SYS_ID { get; set; }
    }

    /// <summary>
    /// åŒ¯å‡ºè¨˜éŒ„é¡¯ç¤ºç”¨ Model (View ç”¨)
    /// </summary>
    public class ExportRecordViewModel
    {
        public int ID { get; set; }
        public string FILE_NAME { get; set; }
        public string CREATOR { get; set; }
        public string CREATE_TIME { get; set; }
        public string SYS_ID { get; set; }
    }
}
```

-----

## ğŸ”§ 2. Factory (F_AP.cs)

```csharp
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using YourNamespace.Models;

namespace YourNamespace.Factory
{
    public class F_AP
    {
        #region åŸºæœ¬çš„å–å¾— Service æ–¹æ³• (å¦‚æœä½ åŸæœ¬æ²’æœ‰çš„è©±)
        
        // å¦‚æœä½ çš„å°ˆæ¡ˆå·²ç¶“æœ‰ DBHelper æˆ–é¡ä¼¼çš„é¡åˆ¥,è«‹èª¿æ•´æˆä½ çš„å¯«æ³•
        
        #endregion

        #region å¸³è™ŸåŒ¯å‡ºç›¸é—œ

        /// <summary>
        /// å–å¾—æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–®(ç”¨æ–¼åŒ¯å‡º)
        /// </summary>
        public List<UserExportModel> GetAllUsersForExport(string systemId)
        {
            string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.GetAllUsersForExport);

            List<SqlParameter> parameters = new List<SqlParameter>
            {
                new SqlParameter("@SYS_ID", systemId)
            };

            DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
            return SVS_DBmanager.ConvertToList<UserExportModel>(dt);
        }

        #endregion

        #region æˆæ¬Šç¢¼è¨˜éŒ„ç›¸é—œ

        /// <summary>
        /// å„²å­˜æˆæ¬Šç¢¼è¨˜éŒ„
        /// </summary>
        public bool SaveCodeGuardRecord(CodeGuardRecordModel model)
        {
            try
            {
                string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.InsertCodeGuardRecord);

                List<SqlParameter> parameters = new List<SqlParameter>
                {
                    new SqlParameter("@FILE_NAME", model.FILE_NAME ?? (object)DBNull.Value),
                    new SqlParameter("@CODE_GUARD", model.CODE_GUARD ?? (object)DBNull.Value),
                    new SqlParameter("@CREATOR", model.CREATOR ?? (object)DBNull.Value),
                    new SqlParameter("@SYS_ID", string.IsNullOrEmpty(model.SYS_ID) ? (object)DBNull.Value : model.SYS_ID)
                };

                int result = SVS_DBmanager.ExecuteNonQuery(sql, parameters);
                return result > 0;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"å„²å­˜æˆæ¬Šç¢¼è¨˜éŒ„å¤±æ•—: {ex.Message}");
                return false;
            }
        }

        /// <summary>
        /// å–å¾—å€‹äººåŒ¯å‡ºè¨˜éŒ„(æœ€è¿‘3å€‹æœˆ)
        /// </summary>
        public List<ExportRecordViewModel> GetMyExportRecords(string creator, string systemId)
        {
            try
            {
                string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.GetMyExportRecords);

                List<SqlParameter> parameters = new List<SqlParameter>
                {
                    new SqlParameter("@CREATOR", creator ?? (object)DBNull.Value),
                    new SqlParameter("@SYS_ID", systemId ?? (object)DBNull.Value)
                };

                DataTable dt = SVS_DBmanager.QueryBySQL(sql, parameters);
                return SVS_DBmanager.ConvertToList<ExportRecordViewModel>(dt);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"æŸ¥è©¢åŒ¯å‡ºè¨˜éŒ„å¤±æ•—: {ex.Message}");
                return new List<ExportRecordViewModel>();
            }
        }

        /// <summary>
        /// åˆªé™¤è¶…é3å€‹æœˆçš„è¨˜éŒ„
        /// </summary>
        public bool DeleteOldRecords()
        {
            try
            {
                string sql = SVS_DBmanager.GetQuery(SVS_DBmanager.QueryKey.DeleteOldCodeGuardRecords);
                int result = SVS_DBmanager.ExecuteNonQuery(sql, null);
                return result >= 0;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"åˆªé™¤èˆŠè¨˜éŒ„å¤±æ•—: {ex.Message}");
                return false;
            }
        }

        #endregion
    }
}
```

-----

## ğŸ—„ï¸ 3. SVS_DBmanager.cs (SQL æŸ¥è©¢ç®¡ç†)

### 3.1 åœ¨ QueryKey enum ä¸­åŠ å…¥:

```csharp
public enum QueryKey
{
    // ... å…¶ä»–çš„ QueryKey
    
    // å¸³è™ŸåŒ¯å‡ºç›¸é—œ
    GetAllUsersForExport,
    
    // æˆæ¬Šç¢¼è¨˜éŒ„ç›¸é—œ
    InsertCodeGuardRecord,
    GetMyExportRecords,
    DeleteOldCodeGuardRecords
}
```

### 3.2 åœ¨ GetQuery æ–¹æ³•ä¸­åŠ å…¥:

```csharp
public static string GetQuery(QueryKey key)
{
    switch (key)
    {
        // ... å…¶ä»–çš„ case

        #region å¸³è™ŸåŒ¯å‡ºç›¸é—œ

        case QueryKey.GetAllUsersForExport:
            return @"
                SELECT 
                    u.[U_ID],
                    u.[U_NAME],
                    u.[APG_NO],
                    g.[APG_NAME],
                    m.[ORGAN_NO],
                    m.[ORGAN_CAP],
                    u.[CREATOR],
                    CONVERT(varchar, u.[CREATE_TIME], 120) as CREATE_TIME, 
                    u.[EDITOR],
                    CONVERT(varchar, u.[EDIT_TIME], 120) as EDIT_TIME    
                FROM [HI-AUTOS].[dbo].[AP_USER] u
                LEFT JOIN [HI-AUTOS].[dbo].[AP_GROUP] g 
                    ON u.[SYS_ID] = g.[SYS_ID] AND u.[APG_NO] = g.[APG_NO]
                LEFT JOIN [HI-AUTOS].[dbo].[M1EMP_MAST] m 
                    ON u.U_ID = m.EMP_NO
                WHERE u.[SYS_ID] = @SYS_ID
                ORDER BY u.[APG_NO], u.[U_ID]";

        #endregion

        #region æˆæ¬Šç¢¼è¨˜éŒ„ç›¸é—œ

        case QueryKey.InsertCodeGuardRecord:
            return @"
                INSERT INTO [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
                    ([FILE_NAME], [CODE_GUARD], [CREATOR], [CREATE_TIME], [SYS_ID])
                VALUES
                    (@FILE_NAME, @CODE_GUARD, @CREATOR, GETDATE(), @SYS_ID)";

        case QueryKey.GetMyExportRecords:
            return @"
                SELECT 
                    [ID],
                    [FILE_NAME],
                    [CREATOR],
                    CONVERT(varchar, [CREATE_TIME], 120) as CREATE_TIME,
                    [SYS_ID]
                FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
                WHERE [CREATOR] = @CREATOR
                  AND [SYS_ID] = @SYS_ID
                  AND [CREATE_TIME] >= DATEADD(MONTH, -3, GETDATE())
                ORDER BY [CREATE_TIME] DESC";

        case QueryKey.DeleteOldCodeGuardRecords:
            return @"
                DELETE FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
                WHERE [CREATE_TIME] < DATEADD(MONTH, -3, GETDATE())";

        #endregion

        default:
            throw new ArgumentException($"Invalid QueryKey: {key}");
    }
}
```

-----

## ğŸ“Š 4. è³‡æ–™è¡¨å»ºç«‹ SQL

```sql
-- å»ºç«‹æˆæ¬Šç¢¼è¨˜éŒ„è¡¨
USE [HI_TMMAIN]
GO

-- å¦‚æœè¡¨å·²å­˜åœ¨å‰‡åˆªé™¤
IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[CODEGUARD_RECORD]') AND type in (N'U'))
DROP TABLE [dbo].[CODEGUARD_RECORD]
GO

-- å»ºç«‹æ–°è¡¨
CREATE TABLE [dbo].[CODEGUARD_RECORD]
(
    [ID] INT IDENTITY(1,1) PRIMARY KEY,
    [FILE_NAME] NVARCHAR(200) NOT NULL,
    [CODE_GUARD] NVARCHAR(50) NOT NULL,
    [CREATOR] NVARCHAR(50) NOT NULL,
    [CREATE_TIME] DATETIME NOT NULL DEFAULT GETDATE(),
    [SYS_ID] NVARCHAR(50) NULL
)
GO

-- å»ºç«‹ç´¢å¼•æå‡æŸ¥è©¢æ•ˆèƒ½
CREATE INDEX IX_CODEGUARD_RECORD_CREATOR 
    ON [dbo].[CODEGUARD_RECORD]([CREATOR])
GO

CREATE INDEX IX_CODEGUARD_RECORD_CREATE_TIME 
    ON [dbo].[CODEGUARD_RECORD]([CREATE_TIME])
GO

CREATE INDEX IX_CODEGUARD_RECORD_SYS_ID 
    ON [dbo].[CODEGUARD_RECORD]([SYS_ID])
GO

-- åŠ å…¥èªªæ˜
EXEC sys.sp_addextendedproperty 
    @name=N'MS_Description', 
    @value=N'æˆæ¬Šç¢¼è¨˜éŒ„ä¸»éµ', 
    @level0type=N'SCHEMA', @level0name=N'dbo', 
    @level1type=N'TABLE', @level1name=N'CODEGUARD_RECORD', 
    @level2type=N'COLUMN', @level2name=N'ID'
GO

EXEC sys.sp_addextendedproperty 
    @name=N'MS_Description', 
    @value=N'æª”æ¡ˆåç¨±', 
    @level0type=N'SCHEMA', @level0name=N'dbo', 
    @level1type=N'TABLE', @level1name=N'CODEGUARD_RECORD', 
    @level2type=N'COLUMN', @level2name=N'FILE_NAME'
GO

EXEC sys.sp_addextendedproperty 
    @name=N'MS_Description', 
    @value=N'æˆæ¬Šç¢¼', 
    @level0type=N'SCHEMA', @level0name=N'dbo', 
    @level1type=N'TABLE', @level1name=N'CODEGUARD_RECORD', 
    @level2type=N'COLUMN', @level2name=N'CODE_GUARD'
GO

EXEC sys.sp_addextendedproperty 
    @name=N'MS_Description', 
    @value=N'åŒ¯å‡ºäººå“¡', 
    @level0type=N'SCHEMA', @level0name=N'dbo', 
    @level1type=N'TABLE', @level1name=N'CODEGUARD_RECORD', 
    @level2type=N'COLUMN', @level2name=N'CREATOR'
GO

EXEC sys.sp_addextendedproperty 
    @name=N'MS_Description', 
    @value=N'åŒ¯å‡ºæ™‚é–“', 
    @level0type=N'SCHEMA', @level0name=N'dbo', 
    @level1type=N'TABLE', @level1name=N'CODEGUARD_RECORD', 
    @level2type=N'COLUMN', @level2name=N'CREATE_TIME'
GO

EXEC sys.sp_addextendedproperty 
    @name=N'MS_Description', 
    @value=N'ç³»çµ±ID', 
    @level0type=N'SCHEMA', @level0name=N'dbo', 
    @level1type=N'TABLE', @level1name=N'CODEGUARD_RECORD', 
    @level2type=N'COLUMN', @level2name=N'SYS_ID'
GO

PRINT 'è³‡æ–™è¡¨ CODEGUARD_RECORD å»ºç«‹æˆåŠŸ!'
GO
```

-----

## ğŸ§ª 5. æ¸¬è©¦ç”¨ SQL (æ’å…¥æ¸¬è©¦è³‡æ–™)

```sql
-- æ’å…¥æ¸¬è©¦è³‡æ–™
INSERT INTO [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
    ([FILE_NAME], [CODE_GUARD], [CREATOR], [CREATE_TIME], [SYS_ID])
VALUES
    ('20241125120000_åŒ¯å‡ºå¸³è™Ÿæ¸…å–®', 'A1B2C3D4', 'E001', GETDATE(), 'HI_POS'),
    ('20241124150000_åŒ¯å‡ºå¸³è™Ÿæ¸…å–®', 'X9Y8Z7W6', 'E001', DATEADD(DAY, -1, GETDATE()), 'HI_POS'),
    ('20241120100000_åŒ¯å‡ºå¸³è™Ÿæ¸…å–®', 'M5N4O3P2', 'E001', DATEADD(DAY, -5, GETDATE()), 'HI_WMS')
GO

-- æŸ¥è©¢æ¸¬è©¦
SELECT * FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
ORDER BY [CREATE_TIME] DESC
GO

-- æŸ¥è©¢ç‰¹å®šä½¿ç”¨è€…çš„è¨˜éŒ„
SELECT 
    [ID],
    [FILE_NAME],
    [CREATOR],
    CONVERT(varchar, [CREATE_TIME], 120) as CREATE_TIME,
    [SYS_ID]
FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
WHERE [CREATOR] = 'E001'
  AND [SYS_ID] = 'HI_POS'
  AND [CREATE_TIME] >= DATEADD(MONTH, -3, GETDATE())
ORDER BY [CREATE_TIME] DESC
GO

-- åˆªé™¤è¶…é3å€‹æœˆçš„è¨˜éŒ„ (æ¸¬è©¦ç”¨)
DELETE FROM [HI_TMMAIN].[dbo].[CODEGUARD_RECORD]
WHERE [CREATE_TIME] < DATEADD(MONTH, -3, GETDATE())
GO
```

-----

## ğŸ”§ 6. Controller ä¸­å¦‚ä½•å–å¾— Service

åœ¨ä½ çš„ Controller ä¸­åŠ å…¥:

```csharp
/// <summary>
/// å–å¾— AP Service
/// </summary>
private F_AP GetAPService()
{
    return new F_AP();
}
```

æˆ–å¦‚æœä½ çš„å°ˆæ¡ˆæœ‰ä½¿ç”¨ DI (Dependency Injection):

```csharp
private readonly F_AP _apService;

public APController()
{
    _apService = new F_AP();
}

private F_AP GetAPService()
{
    return _apService;
}
```

-----

## ğŸ“‹ 7. å®Œæ•´çš„æª”æ¡ˆçµæ§‹

```
ä½ çš„å°ˆæ¡ˆ/
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ M_AP_SET.cs                    (åŒ…å« 3 å€‹ Model)
â”‚       â”œâ”€â”€ UserExportModel
â”‚       â”œâ”€â”€ CodeGuardRecordModel
â”‚       â””â”€â”€ ExportRecordViewModel
â”‚
â”œâ”€â”€ Factory/
â”‚   â””â”€â”€ F_AP.cs                        (åŒ…å«æ‰€æœ‰æ–¹æ³•)
â”‚       â”œâ”€â”€ GetAllUsersForExport()
â”‚       â”œâ”€â”€ SaveCodeGuardRecord()
â”‚       â”œâ”€â”€ GetMyExportRecords()
â”‚       â””â”€â”€ DeleteOldRecords()
â”‚
â”œâ”€â”€ DBManager/
â”‚   â””â”€â”€ SVS_DBmanager.cs               (SQL æŸ¥è©¢ç®¡ç†)
â”‚       â”œâ”€â”€ QueryKey (enum)
â”‚       â””â”€â”€ GetQuery(QueryKey)
â”‚
â”œâ”€â”€ Controllers/
â”‚   â””â”€â”€ APController.cs
â”‚       â”œâ”€â”€ ExportUserList()
â”‚       â”œâ”€â”€ CreateEncryptedExcel()
â”‚       â”œâ”€â”€ EncryptExcelFile()
â”‚       â””â”€â”€ ExportRecords()
â”‚
â””â”€â”€ Views/
    â”œâ”€â”€ AP/
    â”‚   â”œâ”€â”€ GroupManagement.cshtml
    â”‚   â””â”€â”€ ExportRecords.cshtml
    â””â”€â”€ Shared/
        â””â”€â”€ _Layout.cshtml
```

-----

## âœ… å®Œæ•´æµç¨‹æ¸¬è©¦æ­¥é©Ÿ

1. **åŸ·è¡Œ SQL å»ºç«‹è¡¨**
   
   ```sql
   -- åœ¨ SSMS åŸ·è¡Œå»ºè¡¨ SQL
   USE [HI_TMMAIN]
   GO
   -- åŸ·è¡Œä¸Šé¢çš„å»ºè¡¨ SQL
   ```
1. **ç¢ºèªå°ˆæ¡ˆå¼•ç”¨**

- HI_CODEGUARD_DLL.dll
- NPOI (NuGet å¥—ä»¶)
- Newtonsoft.Json

1. **ç·¨è­¯å°ˆæ¡ˆ**

- ç¢ºèªæ²’æœ‰ç·¨è­¯éŒ¯èª¤
- ç¢ºèªæ‰€æœ‰ Modelã€Factoryã€Controller éƒ½æ­£ç¢º

1. **æ¸¬è©¦åŠŸèƒ½**

- ç™»å…¥ç³»çµ±
- é€²å…¥ã€Œç³»çµ±ç¾¤çµ„æ¬Šé™ç®¡ç†ã€
- é»æ“Šã€ŒåŒ¯å‡ºå¸³è™Ÿæ¸…å–®ã€
- æŸ¥çœ‹æˆæ¬Šç¢¼ Modal
- ä¸‹è¼‰ Excel æª”æ¡ˆ
- ç”¨æˆæ¬Šç¢¼é–‹å•Ÿ Excel
- é»æ“Šã€ŒåŒ¯å‡ºè¨˜éŒ„ã€æŸ¥çœ‹è¨˜éŒ„

-----

å®Œæˆ! ğŸ‰ ç¾åœ¨æ‰€æœ‰ç¨‹å¼ç¢¼éƒ½çµ¦ä½ äº†!â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹