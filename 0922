æ˜ç™½ ğŸ‘ ä½ çš„éœ€æ±‚å°±æ˜¯è¦ç…§ã€ŒåŒ¯å…¥ + ä¸‹è¼‰ç¯„æœ¬ã€é€™å€‹æ¨¡å¼ä¾†åšï¼Œåƒä½ çµ¦çš„ UpLoadCheckshow å’Œ DownloadExcelTemplateã€‚æˆ‘å¹«ä½ é‡å°ã€Œæ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…ã€æ•´ç†ä¸€å€‹å®Œæ•´ç¯„ä¾‹ï¼š

â¸»

1ï¸âƒ£ Controller (APController.cs)

// æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…
[HttpPost]
public ActionResult UploadUsers(HttpPostedFileBase File, string apg_no)
{
    if (File == null || File.ContentLength == 0)
    {
        return Json(new { success = false, message = "è«‹é¸æ“‡è¦åŒ¯å…¥çš„ Excel æª”æ¡ˆ" });
    }

    // æª¢æŸ¥å‰¯æª”å
    string[] allowedExtensions = { ".xlsx", ".xls" };
    string fileExtension = Path.GetExtension(File.FileName).ToLower();
    if (!allowedExtensions.Contains(fileExtension))
    {
        return Json(new
        {
            success = false,
            message = "è«‹ä¸Šå‚³ Excel æª”æ¡ˆ(.xlsx æˆ– .xls)",
            errors = new[] {
                new { RowNumber = 0, KeyValue = "æª”æ¡ˆæ ¼å¼éŒ¯èª¤", ErrorMessage = "è«‹ä¸Šå‚³æ­£ç¢ºæ ¼å¼" }
            }
        });
    }

    // æª”æ¡ˆå­˜æ”¾ç›®éŒ„
    string uploadDir = Server.MapPath("~/File/Upload");
    if (!Directory.Exists(uploadDir))
        Directory.CreateDirectory(uploadDir);

    // ç”Ÿæˆå®‰å…¨æª”å
    string uniqueFileName = $"Users_{DateTime.Now:yyyyMMddHHmmss}{fileExtension}";
    string uploadPath = Path.Combine(uploadDir, uniqueFileName);

    try
    {
        File.SaveAs(uploadPath);

        // å‘¼å« F_AP æ–¹æ³•å»è™•ç† Excel
        var result = f_AP.ImportUsersFromExcel(uploadPath, apg_no, this.Emp_NO);

        if (result.IsSuccess)
        {
            return Json(new
            {
                success = true,
                message = $"æˆåŠŸåŒ¯å…¥ {result.ValidRows} ç­†è³‡æ–™ï¼"
            });
        }
        else
        {
            return Json(new
            {
                success = false,
                message = result.ErrorMessage,
                errors = result.Errors
            });
        }
    }
    catch (Exception ex)
    {
        return Json(new
        {
            success = false,
            message = "åŒ¯å…¥éŒ¯èª¤ï¼š" + ex.Message
        });
    }
    finally
    {
        if (System.IO.File.Exists(uploadPath))
        {
            System.IO.File.Delete(uploadPath);
        }
    }
}

// æä¾›ä¸‹è¼‰ Excel ç¯„æœ¬
[HttpGet]
public ActionResult DownloadUserTemplate()
{
    try
    {
        string templateFileName = "æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…ç¯„æœ¬.xlsx";
        string templatePath = Server.MapPath($"~/File/{templateFileName}");

        if (!System.IO.File.Exists(templatePath))
        {
            return Json(new { success = false, message = "æ‰¾ä¸åˆ°ç¯„æœ¬æª”æ¡ˆ" }, JsonRequestBehavior.AllowGet);
        }

        byte[] fileBytes = System.IO.File.ReadAllBytes(templatePath);
        return File(fileBytes,
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            templateFileName);
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "ä¸‹è¼‰ç¯„æœ¬å¤±æ•—ï¼š" + ex.Message }, JsonRequestBehavior.AllowGet);
    }
}


â¸»

2ï¸âƒ£ F_AP.cs

public class ImportResult
{
    public bool IsSuccess { get; set; }
    public int ValidRows { get; set; }
    public string ErrorMessage { get; set; }
    public List<object> Errors { get; set; } = new List<object>();
}

public ImportResult ImportUsersFromExcel(string filePath, string apgNo, string creator)
{
    var result = new ImportResult();
    try
    {
        using (var package = new OfficeOpenXml.ExcelPackage(new FileInfo(filePath)))
        {
            var ws = package.Workbook.Worksheets.First();
            var rowCount = ws.Dimension.Rows;
            int successCount = 0;

            for (int row = 2; row <= rowCount; row++)
            {
                string empNo = ws.Cells[row, 1].Text.Trim();
                if (string.IsNullOrEmpty(empNo)) continue;

                // æª¢æŸ¥å“¡å·¥æ˜¯å¦å­˜åœ¨
                if (!CheckEmployeeExists(empNo))
                {
                    result.Errors.Add(new { RowNumber = row, KeyValue = empNo, ErrorMessage = "ä¸å­˜åœ¨æ–¼ M1EMP_MAST" });
                    continue;
                }

                // æª¢æŸ¥æ˜¯å¦å·²åœ¨ç¾¤çµ„
                if (CheckUserInGroup(_sysId, apgNo, empNo))
                {
                    result.Errors.Add(new { RowNumber = row, KeyValue = empNo, ErrorMessage = "å·²å­˜åœ¨æ­¤ç¾¤çµ„" });
                    continue;
                }

                // å–å¾—å“¡å·¥è³‡è¨Š
                var emp = GetEmployeeInfo(empNo);
                if (emp == null)
                {
                    result.Errors.Add(new { RowNumber = row, KeyValue = empNo, ErrorMessage = "æ‰¾ä¸åˆ°å“¡å·¥åŸºæœ¬è³‡æ–™" });
                    continue;
                }

                // æ–°å¢
                var model = new UserModel
                {
                    SYS_ID = _sysId,
                    APG_NO = apgNo,
                    U_ID = emp.EMP_NO,
                    U_NAME = emp.EMP_NAME,
                    CREATOR = creator,
                    CREATE_TIME = DateTime.Now
                };
                InsertUser(model, creator);
                successCount++;
            }

            result.IsSuccess = result.Errors.Count == 0;
            result.ValidRows = successCount;
            if (result.Errors.Count > 0)
            {
                result.ErrorMessage = $"æœ‰ {result.Errors.Count} ç­†è³‡æ–™éŒ¯èª¤";
            }
        }
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = ex.Message;
    }
    return result;
}


â¸»

3ï¸âƒ£ View (cshtml)

<div>
    <button type="button" class="btn btn-primary" id="btnShowImport">æ‰¹æ¬¡åŒ¯å…¥</button>
    <button type="button" class="btn btn-success" id="btnDownloadTemplate">ä¸‹è¼‰ç¯„æœ¬</button>
</div>

<!-- åŒ¯å…¥ Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…</h5>
        <button type="button" class="btn-close" data-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="uploadForm" enctype="multipart/form-data" method="post" action="@Url.Action("UploadUsers","AP")">
          <input type="hidden" name="apg_no" value="@ViewBag.APG_NO" />
          <div class="mb-3">
            <input type="file" class="form-control" id="excelFile" name="File" accept=".xls,.xlsx" required />
          </div>
          <button type="submit" class="btn btn-primary" id="btnUpload">åŒ¯å…¥</button>
        </form>

        <!-- éŒ¯èª¤è¡¨æ ¼ -->
        <div id="errorSection" class="mt-4 d-none">
          <h5>éŒ¯èª¤æ¸…å–®ï¼š</h5>
          <table class="table table-bordered" id="errorTable">
            <thead>
              <tr>
                <th>è¡Œè™Ÿ</th>
                <th>å“¡ç·¨</th>
                <th>éŒ¯èª¤è¨Šæ¯</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- æˆåŠŸè¨Šæ¯ -->
        <div id="successSection" class="alert alert-success mt-4 d-none"></div>
      </div>
    </div>
  </div>
</div>

@section scripts{
<script>
$(function(){
    $("#btnShowImport").click(function(){
        $("#importModal").modal("show");
    });

    $("#btnDownloadTemplate").click(function(){
        window.location.href='@Url.Action("DownloadUserTemplate","AP")';
    });

    $("#uploadForm").submit(function(e){
        e.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            url: $(this).attr("action"),
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(res){
                if(res.success){
                    $("#successSection").removeClass("d-none").text(res.message);
                    $("#errorSection").addClass("d-none");
                }else{
                    $("#errorSection").removeClass("d-none");
                    $("#errorTable tbody").empty();
                    if(res.errors){
                        $.each(res.errors,function(i,err){
                            $("#errorTable tbody").append(
                                `<tr><td>${err.RowNumber}</td><td>${err.KeyValue}</td><td>${err.ErrorMessage}</td></tr>`
                            );
                        });
                    }
                }
            }
        });
    });
});
</script>
}


â¸»

âœ… é€™æ¨£å°±æœ‰ï¼š
	â€¢	ã€Œæ‰¹æ¬¡åŒ¯å…¥ã€Modalï¼ˆä¸Šå‚³ Excelï¼‰
	â€¢	ã€Œä¸‹è¼‰ç¯„æœ¬ã€æŒ‰éˆ•ï¼ˆå¾ ~/File/æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…ç¯„æœ¬.xlsx ä¸‹è¼‰ï¼‰
	â€¢	å¾Œç«¯æœƒé©—è­‰å“¡ç·¨æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦é‡è¤‡ï¼ŒéŒ¯èª¤æœƒä»¥è¡¨æ ¼é¡¯ç¤º

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ ç›´æ¥ç”Ÿä¸€ä»½ Excel ç¯„æœ¬æª”å…§å®¹ï¼ˆåªæœ‰æ¨™é¡Œåˆ—ï¼šå“¡ç·¨ï¼‰ï¼Œè®“ä½¿ç”¨è€…èƒ½ä¸‹è¼‰ï¼Ÿ