å¥½ ğŸ‘Œ
æˆ‘å¹«ä½ æ•´ç†ä¸€å€‹ å®Œæ•´å¯è·‘çš„ .NET Framework ç‰ˆæœ¬ ImportUsersFromExcel()ï¼Œç”¨ ExcelDataReader ä¾†è§£æ Excelï¼Œä¸ç”¨ OLEDBï¼Œä¹Ÿä¸ç”¨ CodePagesEncodingProviderã€‚

â¸»

ğŸ”§ ImportUsersFromExcel (å®Œæ•´ç¨‹å¼ç¢¼)

public ImportResult ImportUsersFromExcel(string filePath, string sysId, string apgNo, string creator)
{
    ImportResult result = new ImportResult()
    {
        ErrorMessages = new List<ImportError>()
    };

    try
    {
        // é˜²å‘†æª¢æŸ¥
        if (string.IsNullOrWhiteSpace(sysId))
        {
            result.IsSuccess = false;
            result.ErrorMessage = "ç³»çµ±ä»£è™Ÿéºå¤± (SYS_ID)";
            return result;
        }
        if (string.IsNullOrWhiteSpace(apgNo))
        {
            result.IsSuccess = false;
            result.ErrorMessage = "ç¾¤çµ„ä»£è™Ÿéºå¤± (APG_NO)";
            return result;
        }

        var rows = new List<(int RowNumber, string EmpNo)>();

        // è®€ Excel
        using (var stream = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.Read))
        using (var reader = ExcelReaderFactory.CreateReader(stream)) // è‡ªå‹•æ”¯æ´ .xls / .xlsx
        {
            int rowIndex = 0;
            while (reader.Read())
            {
                rowIndex++;

                // ç¬¬ä¸€åˆ—ç•¶è¡¨é ­ â†’ æª¢æŸ¥æ˜¯å¦æ­£ç¢º
                if (rowIndex == 1)
                {
                    string header = reader.GetString(0)?.Trim();
                    if (string.IsNullOrEmpty(header) || header != "å“¡å·¥ç·¨è™Ÿ")
                    {
                        result.IsSuccess = false;
                        result.ErrorMessage = "Excel æ ¼å¼éŒ¯èª¤ï¼šç¬¬ä¸€åˆ—ç¬¬ä¸€æ¬„å¿…é ˆæ˜¯ã€Œå“¡å·¥ç·¨è™Ÿã€";
                        return result;
                    }
                    continue;
                }

                // è®€å–è³‡æ–™
                string empNo = reader.GetValue(0)?.ToString().Trim();
                if (!string.IsNullOrEmpty(empNo))
                {
                    rows.Add((rowIndex, empNo));
                }
            }
        }

        // æ²’æœ‰è³‡æ–™
        if (rows.Count == 0)
        {
            result.IsSuccess = false;
            result.ErrorMessage = "Excel ç„¡ä»»ä½•å“¡å·¥è³‡æ–™";
            return result;
        }

        int successCount = 0;

        using (SqlConnection con = new SqlConnection(ConfigurationManager.ConnectionStrings["ConnDB_TFS_HI_TMMAIN"].ConnectionString))
        {
            con.Open();

            foreach (var row in rows)
            {
                try
                {
                    // æª¢æŸ¥å“¡å·¥æ˜¯å¦å­˜åœ¨
                    string checkEmpSql = "SELECT EMP_NAME FROM VW_M1EMP_MAST WHERE EMP_NO=@EMP_NO";
                    string empName = null;
                    using (var cmd = new SqlCommand(checkEmpSql, con))
                    {
                        cmd.Parameters.AddWithValue("@EMP_NO", row.EmpNo);
                        empName = cmd.ExecuteScalar() as string;
                    }

                    if (string.IsNullOrEmpty(empName))
                    {
                        result.ErrorMessages.Add(new ImportError
                        {
                            RowNumber = row.RowNumber,
                            EmpNo = row.EmpNo,
                            Message = "æŸ¥ç„¡æ­¤å“¡å·¥"
                        });
                        continue;
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼ç¾¤çµ„
                    string checkUserSql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID";
                    using (var cmd = new SqlCommand(checkUserSql, con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);

                        int exists = (int)cmd.ExecuteScalar();
                        if (exists > 0)
                        {
                            result.ErrorMessages.Add(new ImportError
                            {
                                RowNumber = row.RowNumber,
                                EmpNo = row.EmpNo,
                                Message = "æ­¤ç¾¤çµ„å·²å­˜åœ¨è©²å“¡å·¥"
                            });
                            continue;
                        }
                    }

                    // å¯«å…¥ AP_USER
                    string insertSql = @"
                        INSERT INTO AP_USER(SYS_ID, APG_NO, U_ID, U_NAME, CREATOR, CREATE_TIME)
                        VALUES(@SYS_ID, @APG_NO, @U_ID, @U_NAME, @CREATOR, GETDATE())";

                    using (var cmd = new SqlCommand(insertSql, con))
                    {
                        cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                        cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                        cmd.Parameters.AddWithValue("@U_ID", row.EmpNo);
                        cmd.Parameters.AddWithValue("@U_NAME", empName);
                        cmd.Parameters.AddWithValue("@CREATOR", creator);

                        cmd.ExecuteNonQuery();
                        successCount++;
                    }
                }
                catch (Exception exRow)
                {
                    result.ErrorMessages.Add(new ImportError
                    {
                        RowNumber = row.RowNumber,
                        EmpNo = row.EmpNo,
                        Message = "å¯«å…¥éŒ¯èª¤ï¼š" + exRow.Message
                    });
                }
            }
        }

        result.SuccessCount = successCount;
        result.IsSuccess = successCount > 0 && result.ErrorMessages.Count == 0;

        if (successCount == 0 && result.ErrorMessages.Count > 0)
        {
            result.ErrorMessage = "åŒ¯å…¥å¤±æ•—ï¼Œæ‰€æœ‰è³‡æ–™å‡æœ‰éŒ¯èª¤";
        }
        else if (result.ErrorMessages.Count > 0)
        {
            result.ErrorMessage = "éƒ¨åˆ†è³‡æ–™åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤æ¸…å–®";
        }
        else
        {
            result.ErrorMessage = "";
        }
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = "è™•ç† Excel åŒ¯å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message;
    }

    return result;
}


â¸»

ğŸ“Œ æµç¨‹èªªæ˜
	1.	ç”¨ ExcelDataReader æ‰“é–‹ Excelï¼Œç¬¬ä¸€åˆ—æª¢æŸ¥è¡¨é ­ =ã€Œå“¡å·¥ç·¨è™Ÿã€ã€‚
	2.	å¾ç¬¬äºŒåˆ—é–‹å§‹ï¼Œä¸€ç­†ä¸€ç­†è®€å–å“¡å·¥ç·¨è™Ÿã€‚
	3.	åˆ° DB æª¢æŸ¥ï¼š
	â€¢	å“¡å·¥æ˜¯å¦å­˜åœ¨ (VW_M1EMP_MAST)
	â€¢	æ˜¯å¦å·²å­˜åœ¨ç¾¤çµ„ (AP_USER)
	4.	å¦‚æœéƒ½é€šéï¼ŒINSERT æ–°çš„ä½¿ç”¨è€…è¨˜éŒ„ (AP_USER)ã€‚
	5.	éŒ¯èª¤ï¼ˆæ‰¾ä¸åˆ°å“¡å·¥/å·²å­˜åœ¨/DBéŒ¯èª¤ï¼‰æœƒæ”¶é›†é€² ErrorMessagesï¼Œæœ€å¾Œåœ¨å‰ç«¯ modal é¡¯ç¤ºã€‚

â¸»

é€™æ¨£å®Œå…¨ä¸ç”¨ OLEDBï¼Œä¹Ÿä¸ç”¨ ACE Providerï¼Œå–®ç´”åœ¨ç¨‹å¼ç«¯ç”¨ ExcelDataReader è§£æ Excelã€‚

è¦ä¸è¦æˆ‘ä¹Ÿå¹«ä½ æŠŠ View + å‰ç«¯ modal çš„éŒ¯èª¤è¨Šæ¯æ¸²æŸ“ï¼Œæ”¹æˆè¡¨æ ¼æ’ç‰ˆï¼ˆRowNumber, EmpNo, Message ä¸‰æ¬„ï¼‰ï¼Ÿé€™æ¨£éŒ¯èª¤æ¸…å–®æœƒæ›´æ¸…æ¥šã€‚