ğŸ‘Œ ç†è§£ä½ çš„ç‹€æ³äº†ã€‚
ä½ ä¸æƒ³å¼•å…¥ ExcelDataReader / NPOI é€™äº›é¡å¤–å¥—ä»¶ï¼Œè€Œæ˜¯æƒ³æ¯”ç…§ä½ å‚³çš„å°ˆæ¡ˆåšæ³•ï¼Œé  SQL çš„ OpenDataSource(OLEDB) æ–¹å¼æŠŠ Excel æš«å­˜å°é€²ä¾†ï¼Œå†åšæª¢æ ¸ã€‚

é€™æ¨£å°±ä¸ç”¨åœ¨ Controller è£¡è§£æ Excelï¼Œä¹Ÿä¸ç”¨å¤šå»ºä¸€å † Modelï¼Œåªè¦ä¸€å€‹ç°¡å–®çš„ ImportResult å°±èƒ½æ‰¿æ¥æˆåŠŸç­†æ•¸èˆ‡éŒ¯èª¤æ¸…å–®ã€‚

â¸»

ğŸŸ¦ æ ¸å¿ƒæ¦‚å¿µ
	1.	Controllerï¼šæ¥æ”¶ä¸Šå‚³æª”æ¡ˆ â†’ å­˜åˆ°ä¼ºæœå™¨ â†’ å‘¼å« f_ap é€²è¡Œ SQL å°å…¥ã€‚
	2.	f_apï¼šçµ„ SQLï¼Œå»ºç«‹ #TEMP_IMPORTï¼Œç”¨ OpenDataSource('Microsoft.ACE.OLEDB.12.0') è®€ Excelï¼Œæª¢æŸ¥å“¡å·¥æ˜¯å¦å­˜åœ¨ã€ç¾¤çµ„æ˜¯å¦é‡è¤‡ï¼ŒéŒ¯èª¤å°±å¡åˆ°éŒ¯èª¤æ¸…å–®ï¼Œæœ€å¾Œå›å‚³ ImportResultã€‚
	3.	Modelï¼šåªè¦ ImportResult + ImportError å°±å¥½ã€‚

â¸»

ğŸŸ¦ Model (Models/ImportResult.cs)

using System.Collections.Generic;

namespace YourProject.Models
{
    public class ImportResult
    {
        public bool IsSuccess { get; set; }
        public int SuccessCount { get; set; }
        public List<ImportError> Errors { get; set; } = new List<ImportError>();
    }

    public class ImportError
    {
        public int RowNumber { get; set; }
        public string EmpNo { get; set; }
        public string Message { get; set; }
    }
}


â¸»

ğŸŸ¦ Controller (UserController.cs)

using System;
using System.IO;
using System.Web;
using System.Web.Mvc;
using YourProject.Services;
using YourProject.Models;

public class UserController : Controller
{
    private readonly f_AP _fap = new f_AP();

    [HttpPost]
    public ActionResult Import(HttpPostedFileBase file, string apgNo)
    {
        if (file == null || file.ContentLength == 0)
            return Json(new { success = false, message = "è«‹é¸æ“‡æª”æ¡ˆ" });

        // ä¸Šå‚³è·¯å¾‘
        string uploadDir = Server.MapPath("~/Upload");
        if (!Directory.Exists(uploadDir)) Directory.CreateDirectory(uploadDir);

        string filePath = Path.Combine(uploadDir, Path.GetFileName(file.FileName));
        file.SaveAs(filePath);

        string sysId = Session["SYS_ID"]?.ToString();
        string creator = User.Identity.Name;

        ImportResult result = _fap.ImportUsers(filePath, sysId, apgNo, creator);

        if (result.IsSuccess)
            return Json(new { success = true, message = $"æˆåŠŸåŒ¯å…¥ {result.SuccessCount} ç­†" });

        return Json(new { success = false, message = "åŒ¯å…¥å®Œæˆï¼Œæœ‰éŒ¯èª¤", errors = result.Errors });
    }
}


â¸»

ğŸŸ¦ f_ap (Services/f_AP.cs)

using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using YourProject.Models;

namespace YourProject.Services
{
    public class f_AP
    {
        private string _conn = ConfigurationManager.ConnectionStrings["ConnDB"].ConnectionString;

        public ImportResult ImportUsers(string filePath, string sysId, string apgNo, string creator)
        {
            ImportResult result = new ImportResult();

            string sql = $@"
            BEGIN TRY
                IF OBJECT_ID('tempdb..#TEMP_IMPORT') IS NOT NULL DROP TABLE #TEMP_IMPORT;
                CREATE TABLE #TEMP_IMPORT (
                    RowNum INT IDENTITY(1,1),
                    EMP_NO VARCHAR(20),
                    IsValid BIT DEFAULT 1,
                    ErrorMsg NVARCHAR(200)
                );

                DECLARE @sql NVARCHAR(MAX) = '
                    INSERT INTO #TEMP_IMPORT(EMP_NO)
                    SELECT LTRIM(RTRIM([å“¡ç·¨]))
                    FROM OpenDataSource(''Microsoft.ACE.OLEDB.12.0'',
                        ''Data Source={filePath};Extended properties=Excel 12.0'')...[DATA$]
                    WHERE [å“¡ç·¨] IS NOT NULL ';
                EXEC(@sql);

                -- å“¡å·¥ä¸å­˜åœ¨
                UPDATE t SET IsValid=0, ErrorMsg=N'å“¡å·¥ä¸å­˜åœ¨'
                FROM #TEMP_IMPORT t
                WHERE NOT EXISTS (SELECT 1 FROM VW_M1EMP_MAST e WHERE e.EMP_NO=t.EMP_NO);

                -- è©²ç¾¤çµ„å·²å­˜åœ¨
                UPDATE t SET IsValid=0, ErrorMsg=N'ç¾¤çµ„å·²å­˜åœ¨æ­¤å“¡å·¥'
                FROM #TEMP_IMPORT t
                WHERE EXISTS (SELECT 1 FROM AP_USER u WHERE u.SYS_ID=@SYS_ID AND u.APG_NO=@APG_NO AND u.U_ID=t.EMP_NO);

                -- æˆåŠŸåŒ¯å…¥
                INSERT INTO AP_USER(SYS_ID,APG_NO,U_ID,U_NAME,CREATOR,CREATE_TIME)
                SELECT @SYS_ID,@APG_NO,e.EMP_NO,e.EMP_NAME,@CREATOR,GETDATE()
                FROM #TEMP_IMPORT t
                JOIN VW_M1EMP_MAST e ON e.EMP_NO=t.EMP_NO
                WHERE t.IsValid=1;

                SELECT COUNT(*) AS SuccessCount FROM #TEMP_IMPORT WHERE IsValid=1;
                SELECT RowNum AS RowNumber, EMP_NO, ErrorMsg FROM #TEMP_IMPORT WHERE IsValid=0;
            END TRY
            BEGIN CATCH
                SELECT -1 AS SuccessCount;
                SELECT 0 AS RowNumber, '' AS EMP_NO, ERROR_MESSAGE() AS ErrorMsg;
            END CATCH;
            ";

            using (var con = new SqlConnection(_conn))
            using (var cmd = new SqlCommand(sql, con))
            {
                cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                cmd.Parameters.AddWithValue("@CREATOR", creator);

                using (var adapter = new SqlDataAdapter(cmd))
                {
                    DataSet ds = new DataSet();
                    adapter.Fill(ds);

                    int successCount = Convert.ToInt32(ds.Tables[0].Rows[0]["SuccessCount"]);
                    result.IsSuccess = successCount >= 0;
                    result.SuccessCount = successCount;

                    if (ds.Tables.Count > 1)
                    {
                        foreach (DataRow row in ds.Tables[1].Rows)
                        {
                            result.Errors.Add(new ImportError
                            {
                                RowNumber = Convert.ToInt32(row["RowNumber"]),
                                EmpNo = row["EMP_NO"].ToString(),
                                Message = row["ErrorMsg"].ToString()
                            });
                        }
                    }
                }
            }

            return result;
        }
    }
}


â¸»

ğŸŸ¦ èªªæ˜
	â€¢	ä½ ä¸éœ€è¦ NPOI / ExcelDataReader
	â€¢	ç›´æ¥é  SQL OpenDataSource æŠŠ Excel [DATA$] å°é€² #TEMP_IMPORT
	â€¢	SQL å…§å°±èƒ½æª¢æŸ¥ å“¡å·¥æ˜¯å¦å­˜åœ¨ã€ç¾¤çµ„æ˜¯å¦é‡è¤‡
	â€¢	å›å‚³æˆåŠŸæ•¸ + éŒ¯èª¤æ¸…å–®çµ¦ Controller

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ View (Modal) ä¹Ÿæ•´ç†ä¸€ä»½ï¼ŸåŒ…æ‹¬éŒ¯èª¤æ¸…å–®è¡¨æ ¼è¼¸å‡ºã€‚


å¥½ ğŸ‘Œ æˆ‘å¹«ä½ è£œ View (å« Modal + åŒ¯å…¥è¡¨å–®)
æ­é…æˆ‘å‰é¢çµ¦çš„ Controller + f_ap + Modelã€‚

â¸»

ğŸŸ¦ View (Razor, ä¾‹å¦‚ Views/User/Import.cshtml)

@{
    ViewBag.Title = "æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…</h2>

<div class="row">
    <div class="col-md-6">
        <form id="importForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>é¸æ“‡ç¾¤çµ„</label>
                <input type="text" id="apgNo" name="apgNo" class="form-control" placeholder="è¼¸å…¥ç¾¤çµ„ä»£è™Ÿ" />
            </div>
            <div class="form-group">
                <label>ä¸Šå‚³ Excel (å¿…é ˆæœ‰ä¸€å€‹è¡¨é ­ã€Œå“¡ç·¨ã€ï¼Œå·¥ä½œè¡¨åç¨±ç‚º DATA)</label>
                <input type="file" name="file" id="file" class="form-control" accept=".xls,.xlsx" />
            </div>
            <button type="submit" class="btn btn-primary">æ‰¹æ¬¡åŒ¯å…¥</button>
            <a href="~/File/ImportTemplate.xlsx" class="btn btn-link">ä¸‹è¼‰ç¯„ä¾‹æª”</a>
        </form>
    </div>
</div>

<hr />

<!-- åŒ¯å…¥éŒ¯èª¤çµæœ Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h4 class="modal-title" id="errorModalLabel">åŒ¯å…¥éŒ¯èª¤æ¸…å–®</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-danger">éƒ¨åˆ†è³‡æ–™åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä»¥ä¸‹éŒ¯èª¤ï¼š</p>
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th style="width: 10%">åˆ—è™Ÿ</th>
                            <th style="width: 20%">å“¡ç·¨</th>
                            <th style="width: 70%">éŒ¯èª¤è¨Šæ¯</th>
                        </tr>
                    </thead>
                    <tbody id="errorTableBody">
                        <!-- JS å¡«å…¥ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts {
<script>
    $(function () {
        $("#importForm").submit(function (e) {
            e.preventDefault();

            var formData = new FormData(this);
            $.ajax({
                url: '@Url.Action("Import", "User")',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (res) {
                    if (res.success) {
                        alert(res.message);
                        if (res.errors && res.errors.length > 0) {
                            showErrors(res.errors);
                        }
                    } else {
                        alert(res.message);
                        if (res.errors && res.errors.length > 0) {
                            showErrors(res.errors);
                        }
                    }
                },
                error: function () {
                    alert("åŒ¯å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤");
                }
            });
        });

        function showErrors(errors) {
            var tbody = $("#errorTableBody");
            tbody.empty();
            $.each(errors, function (i, err) {
                tbody.append("<tr>" +
                    "<td>" + err.RowNumber + "</td>" +
                    "<td>" + err.EmpNo + "</td>" +
                    "<td>" + err.Message + "</td>" +
                    "</tr>");
            });
            $("#errorModal").modal("show");
        }
    });
</script>
}


â¸»

ğŸŸ¦ æµç¨‹èªªæ˜
	1.	ä½¿ç”¨è€…åœ¨é é¢é¸ç¾¤çµ„ (apgNo) â†’ ä¸Šå‚³ Excel (å“¡ç·¨ ä¸€æ¬„)ã€‚
	2.	Controller.Import æœƒå­˜æª” + å‘¼å« f_AP.ImportUsersã€‚
	3.	æˆåŠŸ â†’ alert("æˆåŠŸåŒ¯å…¥ X ç­†")
	â€¢	å¦‚æœæœ‰éŒ¯èª¤ï¼Œæœƒå¸¶ errors â†’ åœ¨ Modal è¡¨æ ¼ é¡¯ç¤ºã€‚
	4.	éŒ¯èª¤æ¸…å–®æ ¼å¼åŒ–è¼¸å‡ºï¼šåˆ—è™Ÿ / å“¡ç·¨ / éŒ¯èª¤è¨Šæ¯ã€‚

â¸»

é€™æ¨£æ•´å€‹æµç¨‹å°±å®Œæ•´äº†ï¼š
âœ… Model â†’ ImportResult
âœ… f_ap â†’ SQL é©—è­‰ + Insert
âœ… Controller â†’ æ¥æª”æ¡ˆã€å›å‚³ JSON
âœ… View â†’ ä¸Šå‚³è¡¨å–® + Modal é¡¯ç¤ºéŒ¯èª¤

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ å†åŠ ä¸€å€‹ ã€ŒåŒ¯å…¥æˆåŠŸæ¸…å–®ã€ çš„ Modalï¼Ÿç¾åœ¨åªæœ‰éŒ¯èª¤è¡¨æ ¼ã€‚