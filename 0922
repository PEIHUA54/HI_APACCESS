明白 👍 你的需求就是要照「匯入 + 下載範本」這個模式來做，像你給的 UpLoadCheckshow 和 DownloadExcelTemplate。我幫你針對「批次匯入使用者」整理一個完整範例：

⸻

1️⃣ Controller (APController.cs)

// 批次匯入使用者
[HttpPost]
public ActionResult UploadUsers(HttpPostedFileBase File, string apg_no)
{
    if (File == null || File.ContentLength == 0)
    {
        return Json(new { success = false, message = "請選擇要匯入的 Excel 檔案" });
    }

    // 檢查副檔名
    string[] allowedExtensions = { ".xlsx", ".xls" };
    string fileExtension = Path.GetExtension(File.FileName).ToLower();
    if (!allowedExtensions.Contains(fileExtension))
    {
        return Json(new
        {
            success = false,
            message = "請上傳 Excel 檔案(.xlsx 或 .xls)",
            errors = new[] {
                new { RowNumber = 0, KeyValue = "檔案格式錯誤", ErrorMessage = "請上傳正確格式" }
            }
        });
    }

    // 檔案存放目錄
    string uploadDir = Server.MapPath("~/File/Upload");
    if (!Directory.Exists(uploadDir))
        Directory.CreateDirectory(uploadDir);

    // 生成安全檔名
    string uniqueFileName = $"Users_{DateTime.Now:yyyyMMddHHmmss}{fileExtension}";
    string uploadPath = Path.Combine(uploadDir, uniqueFileName);

    try
    {
        File.SaveAs(uploadPath);

        // 呼叫 F_AP 方法去處理 Excel
        var result = f_AP.ImportUsersFromExcel(uploadPath, apg_no, this.Emp_NO);

        if (result.IsSuccess)
        {
            return Json(new
            {
                success = true,
                message = $"成功匯入 {result.ValidRows} 筆資料！"
            });
        }
        else
        {
            return Json(new
            {
                success = false,
                message = result.ErrorMessage,
                errors = result.Errors
            });
        }
    }
    catch (Exception ex)
    {
        return Json(new
        {
            success = false,
            message = "匯入錯誤：" + ex.Message
        });
    }
    finally
    {
        if (System.IO.File.Exists(uploadPath))
        {
            System.IO.File.Delete(uploadPath);
        }
    }
}

// 提供下載 Excel 範本
[HttpGet]
public ActionResult DownloadUserTemplate()
{
    try
    {
        string templateFileName = "批次匯入使用者範本.xlsx";
        string templatePath = Server.MapPath($"~/File/{templateFileName}");

        if (!System.IO.File.Exists(templatePath))
        {
            return Json(new { success = false, message = "找不到範本檔案" }, JsonRequestBehavior.AllowGet);
        }

        byte[] fileBytes = System.IO.File.ReadAllBytes(templatePath);
        return File(fileBytes,
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            templateFileName);
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "下載範本失敗：" + ex.Message }, JsonRequestBehavior.AllowGet);
    }
}


⸻

2️⃣ F_AP.cs

public class ImportResult
{
    public bool IsSuccess { get; set; }
    public int ValidRows { get; set; }
    public string ErrorMessage { get; set; }
    public List<object> Errors { get; set; } = new List<object>();
}

public ImportResult ImportUsersFromExcel(string filePath, string apgNo, string creator)
{
    var result = new ImportResult();
    try
    {
        using (var package = new OfficeOpenXml.ExcelPackage(new FileInfo(filePath)))
        {
            var ws = package.Workbook.Worksheets.First();
            var rowCount = ws.Dimension.Rows;
            int successCount = 0;

            for (int row = 2; row <= rowCount; row++)
            {
                string empNo = ws.Cells[row, 1].Text.Trim();
                if (string.IsNullOrEmpty(empNo)) continue;

                // 檢查員工是否存在
                if (!CheckEmployeeExists(empNo))
                {
                    result.Errors.Add(new { RowNumber = row, KeyValue = empNo, ErrorMessage = "不存在於 M1EMP_MAST" });
                    continue;
                }

                // 檢查是否已在群組
                if (CheckUserInGroup(_sysId, apgNo, empNo))
                {
                    result.Errors.Add(new { RowNumber = row, KeyValue = empNo, ErrorMessage = "已存在此群組" });
                    continue;
                }

                // 取得員工資訊
                var emp = GetEmployeeInfo(empNo);
                if (emp == null)
                {
                    result.Errors.Add(new { RowNumber = row, KeyValue = empNo, ErrorMessage = "找不到員工基本資料" });
                    continue;
                }

                // 新增
                var model = new UserModel
                {
                    SYS_ID = _sysId,
                    APG_NO = apgNo,
                    U_ID = emp.EMP_NO,
                    U_NAME = emp.EMP_NAME,
                    CREATOR = creator,
                    CREATE_TIME = DateTime.Now
                };
                InsertUser(model, creator);
                successCount++;
            }

            result.IsSuccess = result.Errors.Count == 0;
            result.ValidRows = successCount;
            if (result.Errors.Count > 0)
            {
                result.ErrorMessage = $"有 {result.Errors.Count} 筆資料錯誤";
            }
        }
    }
    catch (Exception ex)
    {
        result.IsSuccess = false;
        result.ErrorMessage = ex.Message;
    }
    return result;
}


⸻

3️⃣ View (cshtml)

<div>
    <button type="button" class="btn btn-primary" id="btnShowImport">批次匯入</button>
    <button type="button" class="btn btn-success" id="btnDownloadTemplate">下載範本</button>
</div>

<!-- 匯入 Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">批次匯入使用者</h5>
        <button type="button" class="btn-close" data-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="uploadForm" enctype="multipart/form-data" method="post" action="@Url.Action("UploadUsers","AP")">
          <input type="hidden" name="apg_no" value="@ViewBag.APG_NO" />
          <div class="mb-3">
            <input type="file" class="form-control" id="excelFile" name="File" accept=".xls,.xlsx" required />
          </div>
          <button type="submit" class="btn btn-primary" id="btnUpload">匯入</button>
        </form>

        <!-- 錯誤表格 -->
        <div id="errorSection" class="mt-4 d-none">
          <h5>錯誤清單：</h5>
          <table class="table table-bordered" id="errorTable">
            <thead>
              <tr>
                <th>行號</th>
                <th>員編</th>
                <th>錯誤訊息</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- 成功訊息 -->
        <div id="successSection" class="alert alert-success mt-4 d-none"></div>
      </div>
    </div>
  </div>
</div>

@section scripts{
<script>
$(function(){
    $("#btnShowImport").click(function(){
        $("#importModal").modal("show");
    });

    $("#btnDownloadTemplate").click(function(){
        window.location.href='@Url.Action("DownloadUserTemplate","AP")';
    });

    $("#uploadForm").submit(function(e){
        e.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            url: $(this).attr("action"),
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(res){
                if(res.success){
                    $("#successSection").removeClass("d-none").text(res.message);
                    $("#errorSection").addClass("d-none");
                }else{
                    $("#errorSection").removeClass("d-none");
                    $("#errorTable tbody").empty();
                    if(res.errors){
                        $.each(res.errors,function(i,err){
                            $("#errorTable tbody").append(
                                `<tr><td>${err.RowNumber}</td><td>${err.KeyValue}</td><td>${err.ErrorMessage}</td></tr>`
                            );
                        });
                    }
                }
            }
        });
    });
});
</script>
}


⸻

✅ 這樣就有：
	•	「批次匯入」Modal（上傳 Excel）
	•	「下載範本」按鈕（從 ~/File/批次匯入使用者範本.xlsx 下載）
	•	後端會驗證員編是否存在、是否重複，錯誤會以表格顯示

⸻

要不要我幫你直接生一份 Excel 範本檔內容（只有標題列：員編），讓使用者能下載？