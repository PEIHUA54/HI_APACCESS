å¥½ âœ… æˆ‘å¹«ä½ æŠŠ æ–¹æ³• 3ï¼ˆè½‰ CSV â†’ BULK INSERT â†’ æš«å­˜è¡¨ â†’ é©—è­‰ â†’ å¯«å…¥æ­£å¼è¡¨ï¼‰ çš„å®Œæ•´æµç¨‹å¯«å‡ºä¾†ã€‚
é€™æ¨£å®Œå…¨ä¸ç”¨ OLEDBï¼Œä¹Ÿä¸ç”¨è£é©…å‹•ï¼Œç›´æ¥é  SQL Server å…§å»ºåŠŸèƒ½ã€‚

â¸»

ğŸŸ¦ æµç¨‹è¨­è¨ˆ
	1.	ä½¿ç”¨è€…ä¸Šå‚³ Excel (åªæœ‰ã€Œå“¡ç·¨ã€æ¬„ä½)ã€‚
	2.	Controller æ¥æ”¶ â†’ è½‰æˆ CSV å­˜åˆ° Upload è³‡æ–™å¤¾ã€‚
	â€¢	è½‰ CSV å¯ä»¥ç”¨ StringBuilder æ‹¼å­—ä¸² â†’ å­˜æª”ã€‚
	3.	f_ap åŸ·è¡Œ BULK INSERT æŠŠ CSV åŒ¯å…¥ #TEMP_IMPORT æš«å­˜è¡¨ã€‚
	4.	SQL é©—è­‰ï¼š
	â€¢	å“¡å·¥æ˜¯å¦å­˜åœ¨ (VW_M1EMP_MAST)
	â€¢	æ˜¯å¦å·²å­˜åœ¨æ–¼ç¾¤çµ„ (AP_USER)
	5.	éŒ¯èª¤ â†’ å¡åˆ°éŒ¯èª¤æ¸…å–®å›å‚³ï¼›æˆåŠŸ â†’ å¯«å…¥ AP_USERã€‚

â¸»

ğŸŸ¦ Model (Models/ImportResult.cs)

using System.Collections.Generic;

namespace YourProject.Models
{
    public class ImportResult
    {
        public bool IsSuccess { get; set; }
        public int SuccessCount { get; set; }
        public List<ImportError> Errors { get; set; } = new List<ImportError>();
    }

    public class ImportError
    {
        public int RowNumber { get; set; }
        public string EmpNo { get; set; }
        public string Message { get; set; }
    }
}


â¸»

ğŸŸ¦ Controller (Controllers/APController.cs)

using System;
using System.IO;
using System.Text;
using System.Web;
using System.Web.Mvc;
using YourProject.Models;
using YourProject.Services;

public class APController : Controller
{
    private readonly f_AP _fap = new f_AP();

    [HttpPost]
    public ActionResult ImportUsers(HttpPostedFileBase file, string apgNo)
    {
        if (file == null || file.ContentLength == 0)
            return Json(new { success = false, message = "è«‹é¸æ“‡æª”æ¡ˆ" });

        string sysId = Session["SYS_ID"]?.ToString();
        if (string.IsNullOrEmpty(sysId) || string.IsNullOrEmpty(apgNo))
            return Json(new { success = false, message = "ç³»çµ±æˆ–ç¾¤çµ„ä»£è™Ÿéºå¤±" });

        // è®€ Excel â†’ è½‰ CSVï¼ˆé€™è£¡ç°¡åŒ–å‡è¨­åªè¦å“¡ç·¨ï¼‰
        string uploadDir = Server.MapPath("~/Upload");
        if (!Directory.Exists(uploadDir)) Directory.CreateDirectory(uploadDir);

        string csvPath = Path.Combine(uploadDir, $"Import_{DateTime.Now:yyyyMMddHHmmss}.csv");

        using (var reader = new StreamReader(file.InputStream, Encoding.UTF8))
        using (var writer = new StreamWriter(csvPath, false, Encoding.UTF8))
        {
            bool skipHeader = true;
            while (!reader.EndOfStream)
            {
                string line = reader.ReadLine();
                if (skipHeader) { skipHeader = false; continue; } // è·³éè¡¨é ­
                if (!string.IsNullOrWhiteSpace(line))
                    writer.WriteLine(line);
            }
        }

        // å‘¼å« f_ap åš BULK INSERT
        ImportResult result = _fap.ImportUsersFromCsv(csvPath, sysId, apgNo, User.Identity.Name);

        if (result.IsSuccess)
            return Json(new { success = true, message = $"æˆåŠŸåŒ¯å…¥ {result.SuccessCount} ç­†" });
        else
            return Json(new { success = false, message = "åŒ¯å…¥å¤±æ•—", errors = result.Errors });
    }
}


â¸»

ğŸŸ¦ f_ap (Services/f_AP.cs)

using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using YourProject.Models;

namespace YourProject.Services
{
    public class f_AP
    {
        private readonly string _conn = ConfigurationManager.ConnectionStrings["ConnDB"].ConnectionString;

        public ImportResult ImportUsersFromCsv(string csvPath, string sysId, string apgNo, string creator)
        {
            ImportResult result = new ImportResult();

            string sql = $@"
            BEGIN TRY
                IF OBJECT_ID('tempdb..#TEMP_IMPORT') IS NOT NULL DROP TABLE #TEMP_IMPORT;
                CREATE TABLE #TEMP_IMPORT (
                    RowNum INT IDENTITY(1,1),
                    EMP_NO VARCHAR(20),
                    IsValid BIT DEFAULT 1,
                    ErrorMsg NVARCHAR(200)
                );

                BULK INSERT #TEMP_IMPORT (EMP_NO)
                FROM '{csvPath}'
                WITH (
                    FIELDTERMINATOR = ',',
                    ROWTERMINATOR = '0x0a',
                    CODEPAGE = '65001'
                );

                -- å“¡å·¥ä¸å­˜åœ¨
                UPDATE t SET IsValid=0, ErrorMsg=N'å“¡å·¥ä¸å­˜åœ¨'
                FROM #TEMP_IMPORT t
                WHERE NOT EXISTS (
                    SELECT 1 FROM VW_M1EMP_MAST e WHERE e.EMP_NO = t.EMP_NO
                );

                -- å·²å­˜åœ¨æ–¼ç¾¤çµ„
                UPDATE t SET IsValid=0, ErrorMsg=N'ç¾¤çµ„å·²å­˜åœ¨æ­¤å“¡å·¥'
                FROM #TEMP_IMPORT t
                WHERE EXISTS (
                    SELECT 1 FROM AP_USER u 
                    WHERE u.SYS_ID=@SYS_ID AND u.APG_NO=@APG_NO AND u.U_ID=t.EMP_NO
                );

                -- å¯«å…¥æ­£å¼è¡¨
                INSERT INTO AP_USER(SYS_ID,APG_NO,U_ID,U_NAME,CREATOR,CREATE_TIME)
                SELECT @SYS_ID, @APG_NO, e.EMP_NO, e.EMP_NAME, @CREATOR, GETDATE()
                FROM #TEMP_IMPORT t
                JOIN VW_M1EMP_MAST e ON e.EMP_NO=t.EMP_NO
                WHERE t.IsValid=1;

                SELECT COUNT(*) AS SuccessCount FROM #TEMP_IMPORT WHERE IsValid=1;
                SELECT RowNum AS RowNumber, EMP_NO, ErrorMsg FROM #TEMP_IMPORT WHERE IsValid=0;
            END TRY
            BEGIN CATCH
                SELECT -1 AS SuccessCount;
                SELECT 0 AS RowNumber, '' AS EMP_NO, ERROR_MESSAGE() AS ErrorMsg;
            END CATCH;
            ";

            using (var con = new SqlConnection(_conn))
            using (var cmd = new SqlCommand(sql, con))
            {
                cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                cmd.Parameters.AddWithValue("@CREATOR", creator);

                using (var adapter = new SqlDataAdapter(cmd))
                {
                    DataSet ds = new DataSet();
                    adapter.Fill(ds);

                    int successCount = Convert.ToInt32(ds.Tables[0].Rows[0]["SuccessCount"]);
                    result.IsSuccess = successCount >= 0;
                    result.SuccessCount = successCount;

                    if (ds.Tables.Count > 1)
                    {
                        foreach (DataRow row in ds.Tables[1].Rows)
                        {
                            result.Errors.Add(new ImportError
                            {
                                RowNumber = Convert.ToInt32(row["RowNumber"]),
                                EmpNo = row["EMP_NO"].ToString(),
                                Message = row["ErrorMsg"].ToString()
                            });
                        }
                    }
                }
            }

            return result;
        }
    }
}


â¸»

ğŸŸ¦ View (Modal å·²æœ‰ï¼Œé€™è£¡åªè£œéŒ¯èª¤æ¸…å–®)

<div id="errorTableWrapper" class="mt-3" style="display:none;">
    <h6 class="text-danger">åŒ¯å…¥éŒ¯èª¤æ¸…å–®</h6>
    <table class="table table-bordered table-sm">
        <thead>
            <tr>
                <th>åˆ—è™Ÿ</th>
                <th>å“¡ç·¨</th>
                <th>éŒ¯èª¤è¨Šæ¯</th>
            </tr>
        </thead>
        <tbody id="errorTableBody"></tbody>
    </table>
</div>

<script>
    $("#importForm").submit(function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            url: '@Url.Action("ImportUsers", "AP")',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (res) {
                if (res.success) {
                    $("#importResult").html('<div class="alert alert-success">' + res.message + '</div>');
                    $("#errorTableWrapper").hide();
                    loadUsers();
                } else {
                    $("#importResult").html('<div class="alert alert-danger">' + res.message + '</div>');
                    var tbody = $("#errorTableBody");
                    tbody.empty();
                    if (res.errors) {
                        res.errors.forEach(function (err) {
                            tbody.append(`<tr><td>${err.RowNumber}</td><td>${err.EmpNo}</td><td>${err.Message}</td></tr>`);
                        });
                        $("#errorTableWrapper").show();
                    }
                }
            }
        });
    });
</script>


â¸»

âœ… é€™æ¨£åšæœ‰å¹¾å€‹å„ªé»ï¼š
	â€¢	ä¸éœ€è¦ OLEDB â†’ ä¸æœƒå†å‡ºç¾ã€ŒACE é©…å‹•æ²’å®‰è£ã€çš„å•é¡Œã€‚
	â€¢	CSV åŒ¯å…¥å¾ˆå¿«ï¼ŒSQL åŸç”Ÿæ”¯æ´ BULK INSERTã€‚
	â€¢	ä½ åªè¦è™•ç†ã€Œå“¡ç·¨ã€ä¸€æ¬„ï¼Œé‚è¼¯æœ€å–®ç´”ã€‚

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ åŠ ä¸€å€‹ ã€Œè‡ªå‹•æŠŠä¸Šå‚³ Excel è½‰ CSVã€ çš„å°å·¥å…·æ–¹æ³•ï¼ˆæ”¯æ´ .xls / .xlsxï¼‰ï¼Œè®“ä½¿ç”¨è€…ä¸ç”¨è‡ªå·±å­˜ CSVï¼Ÿ