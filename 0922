ğŸ‘Œ å¥½ï¼Œæˆ‘å¹«ä½ æ•´ç†æˆä¸€ä»½ä¹¾æ·¨çš„ã€å®Œæ•´çš„ç¨‹å¼ç¢¼ï¼Œå…¨éƒ¨ä¸²èµ·ä¾†ï¼ˆController / F_AP / View / JS / Modelï¼‰ã€‚
ä¸¦ä¸”æŒ‰ç…§ä½ çš„è¦æ±‚ï¼š
	1.	SYS_IDï¼šå…¨éƒ¨å¾ Session["SYS_ID"] å–ï¼Œä¸å†ç”¨ BaseControllerã€‚
	2.	æ‰¹æ¬¡åŒ¯å…¥ï¼šæª¢æŸ¥å…©å€‹æ¢ä»¶
	â€¢	å“¡ç·¨å¿…é ˆå­˜åœ¨æ–¼ [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST]ã€‚
	â€¢	å“¡ç·¨ä¸èƒ½å·²å­˜åœ¨æ–¼è©²ç¾¤çµ„ (AP_USER)ã€‚
	3.	ä¸‹è¼‰ç¯„ä¾‹æª”ï¼šå¾ ~/File/æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…ç¯„æœ¬.xlsx æŠ“ç¾æˆæª”æ¡ˆã€‚
	4.	View å·²åŒ…å« æ‰¹æ¬¡åŒ¯å…¥ Modalï¼Œçµæœä»¥éŒ¯èª¤æ¸…å–®æ–¹å¼é¡¯ç¤ºã€‚

â¸»

â‘  Model

public class UserModel
{
    public string SYS_ID { get; set; }
    public string APG_NO { get; set; }
    public string U_ID { get; set; }
    public string U_NAME { get; set; }
    public string CREATOR { get; set; }
    public DateTime CREATE_TIME { get; set; }
}


â¸»

â‘¡ Controller (APController.cs)

#region ä½¿ç”¨è€…ç®¡ç†

// æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…
[HttpPost]
public JsonResult ImportUsers(HttpPostedFileBase file, string apg_no)
{
    if (file == null || file.ContentLength == 0)
        return Json(new { success = false, message = "è«‹é¸æ“‡ Excel æª”æ¡ˆ" });

    string sysId = Session["SYS_ID"]?.ToString();
    if (string.IsNullOrEmpty(sysId))
        return Json(new { success = false, message = "ç³»çµ±ä»£è™Ÿä¸å­˜åœ¨ï¼Œè«‹é‡æ–°é€²å…¥ç¾¤çµ„ç®¡ç†" });

    string uploadDir = Server.MapPath("~/File/Upload");
    if (!Directory.Exists(uploadDir)) Directory.CreateDirectory(uploadDir);

    string filePath = Path.Combine(uploadDir, Path.GetFileName(file.FileName));
    file.SaveAs(filePath);

    try
    {
        var service = GetAPService();
        var result = service.ImportUsers(filePath, sysId, apg_no, Emp_NO);
        return Json(result);
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message });
    }
    finally
    {
        if (System.IO.File.Exists(filePath))
            System.IO.File.Delete(filePath);
    }
}

// ä¸‹è¼‰åŒ¯å…¥ç¯„æœ¬
[HttpGet]
public ActionResult DownloadImportTemplate()
{
    string fileName = "æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…ç¯„æœ¬.xlsx";
    string filePath = Server.MapPath("~/File/" + fileName);

    if (!System.IO.File.Exists(filePath))
    {
        return Json(new { success = false, message = "æ‰¾ä¸åˆ°ç¯„æœ¬æª”æ¡ˆ" }, JsonRequestBehavior.AllowGet);
    }

    byte[] fileBytes = System.IO.File.ReadAllBytes(filePath);
    return File(fileBytes,
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        fileName);
}

#endregion


â¸»

â‘¢ F_AP.cs (Service å±¤)

#region æ‰¹æ¬¡åŒ¯å…¥

public object ImportUsers(string filePath, string sysId, string apgNo, string creator)
{
    var errors = new List<string>();
    int successCount = 0;

    string connStr = $@"Provider=Microsoft.ACE.OLEDB.12.0;Data Source={filePath};
                        Extended Properties='Excel 12.0 Xml;HDR=YES;IMEX=1'";

    using (var conn = new OleDbConnection(connStr))
    {
        conn.Open();
        var cmd = new OleDbCommand("SELECT * FROM [Sheet1$]", conn);
        using (var reader = cmd.ExecuteReader())
        {
            int row = 1;
            while (reader.Read())
            {
                row++;
                string empNo = reader["å“¡ç·¨"].ToString().Trim();
                if (string.IsNullOrEmpty(empNo)) continue;

                // 1) æª¢æŸ¥å“¡ç·¨æ˜¯å¦å­˜åœ¨ M1EMP_MAST
                if (!CheckEmployeeExists(empNo))
                {
                    errors.Add($"ç¬¬ {row} è¡Œ {empNo} ä¸å­˜åœ¨æ–¼å“¡å·¥è³‡æ–™è¡¨");
                    continue;
                }

                // 2) æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼ç¾¤çµ„
                if (CheckUserInGroup(sysId, apgNo, empNo))
                {
                    errors.Add($"ç¬¬ {row} è¡Œ {empNo} å·²å­˜åœ¨æ­¤ç¾¤çµ„");
                    continue;
                }

                // 3) å¯«å…¥
                var emp = GetEmployeeInfo(empNo);
                var model = new UserModel
                {
                    SYS_ID = sysId,
                    APG_NO = apgNo,
                    U_ID = emp.EMP_NO,
                    U_NAME = emp.EMP_NAME,
                    CREATOR = creator
                };
                InsertUser(model, creator);
                successCount++;
            }
        }
    }

    if (errors.Any())
        return new { success = false, message = "åŒ¯å…¥å®Œæˆï¼Œä½†æœ‰éŒ¯èª¤", successCount, errors };
    else
        return new { success = true, message = $"æˆåŠŸåŒ¯å…¥ {successCount} ç­†" };
}

// æª¢æŸ¥å“¡ç·¨æ˜¯å¦å­˜åœ¨ M1EMP_MAST
private bool CheckEmployeeExists(string empNo)
{
    string sql = @"SELECT EMP_NO FROM [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST] WHERE EMP_NO=@EMP_NO";
    var dt = SVS_DBmanager.QueryBySQL(sql, new List<SqlParameter> { new SqlParameter("@EMP_NO", empNo) });
    return dt.Rows.Count > 0;
}

// æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼ç¾¤çµ„
private bool CheckUserInGroup(string sysId, string apgNo, string empNo)
{
    string sql = @"SELECT U_ID FROM [HI_TMMAIN].[dbo].[AP_USER]
                   WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID";
    var dt = SVS_DBmanager.QueryBySQL(sql, new List<SqlParameter> {
        new SqlParameter("@SYS_ID", sysId),
        new SqlParameter("@APG_NO", apgNo),
        new SqlParameter("@U_ID", empNo)
    });
    return dt.Rows.Count > 0;
}

#endregion


â¸»

â‘£ View (cshtml ç‰‡æ®µ)

åœ¨ã€Œç®¡ç†ä½¿ç”¨è€…ã€å€å¡Šçš„ header è£¡è£œä¸€å€‹ æ‰¹æ¬¡åŒ¯å…¥æŒ‰éˆ•ï¼š

<button type="button" class="btn btn-primary" onclick="openImportModal()" id="importUserBtn" disabled>
    <i class="fas fa-file-import"></i> æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…
</button>

æ–°å¢ Modalï¼š

<div class="modal fade" id="importModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="importForm" enctype="multipart/form-data" method="post">
          <input type="hidden" name="apg_no" id="importGroupNo" />
          <input type="file" class="form-control mb-2" name="file" accept=".xls,.xlsx" required />
          <div class="d-flex justify-content-between">
              <button type="submit" class="btn btn-primary">åŒ¯å…¥</button>
              <button type="button" class="btn btn-success" onclick="downloadTemplate()">
                  <i class="fas fa-download"></i> ä¸‹è¼‰ç¯„æœ¬
              </button>
          </div>
        </form>
        <div id="importResult" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>


â¸»

â‘¤ JS

function openImportModal() {
    $("#importGroupNo").val($("#groupSelect").val()); // å¸¶ç›®å‰é¸çš„ç¾¤çµ„
    $("#importModal").modal("show");
}

function downloadTemplate() {
    window.location.href = '@Url.Action("DownloadImportTemplate","AP")';
}

$("#importForm").submit(function(e){
    e.preventDefault();
    var formData = new FormData(this);
    $.ajax({
        url: '@Url.Action("ImportUsers", "AP")',
        type: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(res){
            if(res.success){
                $("#importResult").html('<div class="alert alert-success">'+res.message+'</div>');
                loadUsers();
            }else{
                let html = '<div class="alert alert-danger">'+res.message+'</div>';
                if(res.errors){
                    html += '<ul>';
                    res.errors.forEach(err => { html += `<li>${err}</li>`; });
                    html += '</ul>';
                }
                $("#importResult").html(html);
            }
        }
    });
});


â¸»

âœ… é€™æ¨£æ•´ç†å®Œï¼š
	â€¢	Modelï¼šUserModel
	â€¢	Controllerï¼šImportUsers / DownloadImportTemplate
	â€¢	F_APï¼šImportUsers + CheckEmployeeExists + CheckUserInGroup
	â€¢	Viewï¼šæ‰¹æ¬¡åŒ¯å…¥ Modal + æŒ‰éˆ•
	â€¢	JSï¼šAjax ä¸Šå‚³ã€çµæœé¡¯ç¤º

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ åœ¨ æ‰¹æ¬¡åŒ¯å…¥éŒ¯èª¤æ¸…å–® è£¡åŠ ã€Œè¡¨æ ¼æ ¼å¼ã€(è¡Œè™Ÿ / å“¡ç·¨ / éŒ¯èª¤åŸå› )ï¼Œè€Œä¸æ˜¯å–®ç´” <ul>ï¼Ÿé€™æ¨£çœ‹èµ·ä¾†æ›´æ•´é½Šã€‚