äº†è§£ ğŸ‘
æˆ‘å¹«ä½ æŠŠ Controller å’Œ f_ap åˆ†å¾—æ›´ä¹¾æ·¨ã€ç°¡å–®ï¼Œè®“ Controller åªè² è²¬ã€Œæ¥æ”¶è«‹æ±‚ â†’ å‘¼å« f_ap â†’ å›å‚³çµæœã€ï¼Œè³‡æ–™è™•ç†å…¨éƒ¨ä¸Ÿå» f_apã€‚

â¸»

ğŸ”¹ Controller (UserManagementController.cs)

using System;
using System.Collections.Generic;
using System.Web;
using System.Web.Mvc;
using YourProject.Services;
using YourProject.Models;

namespace YourProject.Controllers
{
    public class UserManagementController : Controller
    {
        private readonly f_AP _fap = new f_AP();

        // åŒ¯å…¥ Excel
        [HttpPost]
        public ActionResult ImportUsers(HttpPostedFileBase File, string apgNo)
        {
            if (File == null || File.ContentLength == 0)
                return Json(new { success = false, message = "è«‹é¸æ“‡è¦åŒ¯å…¥çš„ Excel æª”æ¡ˆ" });

            try
            {
                string sysId = Session["SYS_ID"]?.ToString();
                string creator = User.Identity.Name;

                ImportResult result = _fap.ImportUsersFromExcel(File.InputStream, sysId, apgNo, creator);

                if (result.Errors.Count > 0)
                    return Json(new { success = false, message = $"åŒ¯å…¥å®Œæˆï¼Œæœ‰ {result.Errors.Count} ç­†éŒ¯èª¤", errors = result.Errors });

                return Json(new { success = true, message = $"åŒ¯å…¥æˆåŠŸï¼Œå…±æ–°å¢ {result.SuccessCount} ç­†" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š" + ex.Message });
            }
        }

        // ä¸‹è¼‰ç¯„æœ¬
        [HttpGet]
        public ActionResult DownloadTemplate()
        {
            string path = Server.MapPath("~/File/UserImportTemplate.xlsx");
            if (!System.IO.File.Exists(path))
                return Content("æ‰¾ä¸åˆ°ç¯„æœ¬æª”æ¡ˆ");

            byte[] fileBytes = System.IO.File.ReadAllBytes(path);
            return File(fileBytes,
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                "UserImportTemplate.xlsx");
        }
    }
}


â¸»

ğŸ”¹ f_ap (Services/f_AP.cs)

using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.IO;
using ExcelDataReader;
using YourProject.Models;

namespace YourProject.Services
{
    public class f_AP
    {
        private string _conn = ConfigurationManager.ConnectionStrings["ConnDB"].ConnectionString;

        // åŒ¯å…¥ Excel â†’ æª¢æŸ¥ â†’ ä¸€ç­†ç­†æ–°å¢
        public ImportResult ImportUsersFromExcel(Stream fileStream, string sysId, string apgNo, string creator)
        {
            var result = new ImportResult();

            using (var reader = ExcelReaderFactory.CreateReader(fileStream))
            {
                var ds = reader.AsDataSet();
                var table = ds.Tables[0]; // ç¬¬ä¸€å€‹å·¥ä½œè¡¨

                for (int i = 1; i < table.Rows.Count; i++) // å¾ç¬¬2åˆ—é–‹å§‹ (è·³éè¡¨é ­)
                {
                    string empNo = table.Rows[i][0]?.ToString().Trim();
                    if (string.IsNullOrEmpty(empNo)) continue;

                    // æŸ¥å“¡å·¥
                    var emp = GetEmployeeByNo(empNo);
                    if (emp == null)
                    {
                        result.Errors.Add(new ImportError { Row = i + 1, EmpNo = empNo, Message = "å“¡å·¥ä¸å­˜åœ¨" });
                        continue;
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    if (CheckUserExists(sysId, apgNo, emp.EMP_NO))
                    {
                        result.Errors.Add(new ImportError { Row = i + 1, EmpNo = empNo, Message = "è©²ç¾¤çµ„å·²å­˜åœ¨æ­¤å“¡å·¥" });
                        continue;
                    }

                    // æ–°å¢
                    if (InsertUser(sysId, apgNo, emp.EMP_NO, emp.EMP_NAME, creator))
                        result.SuccessCount++;
                    else
                        result.Errors.Add(new ImportError { Row = i + 1, EmpNo = empNo, Message = "å¯«å…¥å¤±æ•—" });
                }
            }

            return result;
        }

        public EmployeeModel GetEmployeeByNo(string empNo)
        {
            string sql = "SELECT EMP_NO, EMP_NAME FROM VW_M1EMP_MAST WHERE EMP_NO=@EMP_NO";
            using (var con = new SqlConnection(_conn))
            using (var cmd = new SqlCommand(sql, con))
            {
                cmd.Parameters.AddWithValue("@EMP_NO", empNo);
                con.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    if (reader.Read())
                    {
                        return new EmployeeModel
                        {
                            EMP_NO = reader["EMP_NO"].ToString(),
                            EMP_NAME = reader["EMP_NAME"].ToString()
                        };
                    }
                }
            }
            return null;
        }

        public bool CheckUserExists(string sysId, string apgNo, string empNo)
        {
            string sql = "SELECT COUNT(1) FROM AP_USER WHERE SYS_ID=@SYS_ID AND APG_NO=@APG_NO AND U_ID=@U_ID";
            using (var con = new SqlConnection(_conn))
            using (var cmd = new SqlCommand(sql, con))
            {
                cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                cmd.Parameters.AddWithValue("@U_ID", empNo);
                con.Open();
                return (int)cmd.ExecuteScalar() > 0;
            }
        }

        public bool InsertUser(string sysId, string apgNo, string empNo, string empName, string creator)
        {
            string sql = @"INSERT INTO AP_USER (SYS_ID, APG_NO, U_ID, U_NAME, CREATOR, CREATE_TIME)
                           VALUES (@SYS_ID, @APG_NO, @U_ID, @U_NAME, @CREATOR, GETDATE())";
            using (var con = new SqlConnection(_conn))
            using (var cmd = new SqlCommand(sql, con))
            {
                cmd.Parameters.AddWithValue("@SYS_ID", sysId);
                cmd.Parameters.AddWithValue("@APG_NO", apgNo);
                cmd.Parameters.AddWithValue("@U_ID", empNo);
                cmd.Parameters.AddWithValue("@U_NAME", empName);
                cmd.Parameters.AddWithValue("@CREATOR", creator);
                con.Open();
                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }
}


â¸»

ğŸ”¹ Model (Models/ImportResult.cs)

using System.Collections.Generic;

namespace YourProject.Models
{
    public class ImportResult
    {
        public int SuccessCount { get; set; } = 0;
        public List<ImportError> Errors { get; set; } = new List<ImportError>();
    }

    public class ImportError
    {
        public int Row { get; set; }
        public string EmpNo { get; set; }
        public string Message { get; set; }
    }

    public class EmployeeModel
    {
        public string EMP_NO { get; set; }
        public string EMP_NAME { get; set; }
    }
}


â¸»

ğŸ”¹ View (Index.cshtml) â€” åŒ¯å…¥ Modal

<button class="btn btn-primary" id="btnShowImport">æ‰¹æ¬¡åŒ¯å…¥</button>
<button class="btn btn-success" onclick="window.location.href='@Url.Action("DownloadTemplate")'">ä¸‹è¼‰ç¯„æœ¬</button>

<div class="modal fade" id="importModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ‰¹æ¬¡åŒ¯å…¥ä½¿ç”¨è€…</h5>
        <button class="btn-close" data-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="importForm" enctype="multipart/form-data">
          <input type="hidden" name="apgNo" value="@ViewBag.APG_NO" />
          <input type="file" name="File" id="excelFile" class="form-control" accept=".xls,.xlsx" />
          <br />
          <button type="submit" class="btn btn-primary">åŒ¯å…¥</button>
        </form>

        <div id="errorSection" class="mt-3 d-none">
          <h5>éŒ¯èª¤æ¸…å–®</h5>
          <table class="table table-bordered">
            <thead><tr><th>è¡Œè™Ÿ</th><th>å“¡ç·¨</th><th>éŒ¯èª¤è¨Šæ¯</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="successSection" class="alert alert-success d-none mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
$("#btnShowImport").click(() => $("#importModal").modal("show"));

$("#importForm").submit(function (e) {
  e.preventDefault();
  var formData = new FormData(this);
  $.ajax({
    url: '@Url.Action("ImportUsers")',
    type: 'POST',
    data: formData,
    contentType: false,
    processData: false,
    success: function (res) {
      if (res.success) {
        $("#successSection").removeClass("d-none").text(res.message);
        $("#errorSection").addClass("d-none");
      } else {
        $("#errorSection").removeClass("d-none");
        $("#errorSection tbody").empty();
        $.each(res.errors, function (i, err) {
          $("#errorSection tbody").append(`<tr><td>${err.Row}</td><td>${err.EmpNo}</td><td>${err.Message}</td></tr>`);
        });
      }
    }
  });
});
</script>


â¸»

é€™æ¨£ Controller è¶…ç°¡æ½”ï¼š
	â€¢	ImportUsers â†’ åªæ¥æª”æ¡ˆï¼Œä¸Ÿçµ¦ f_ap
	â€¢	DownloadTemplate â†’ å›ºå®šå›å‚³ä¸€å€‹ç¯„æœ¬

è€Œ f_ap è² è²¬ï¼š
	â€¢	è®€ Excel â†’ ä¸€ç­†ç­†æª¢æŸ¥å“¡å·¥ â†’ æ–°å¢/éŒ¯èª¤å›å ±

â¸»

è¦ä¸è¦æˆ‘å†å¹«ä½ æŠŠ éŒ¯èª¤è¨Šæ¯è¡¨æ ¼ æ”¹æˆæœ‰é¡è‰²å€åˆ† (æ¯”å¦‚ã€Œå“¡å·¥ä¸å­˜åœ¨ã€ç´…è‰²ã€ã€Œç¾¤çµ„å·²å­˜åœ¨ã€æ©˜è‰²)ï¼Œçœ‹èµ·ä¾†æ›´æ¸…æ¥šï¼Ÿ