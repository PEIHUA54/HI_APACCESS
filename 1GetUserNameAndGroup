å¥½ğŸ‘Œ æˆ‘å¹«ä½ åˆ†å…©å€‹éƒ¨åˆ†ï¼š

â¸»

â‘  ç™»å…¥æµç¨‹åœ– (AD â†’ DLL â†’ ç³»çµ±æ¬Šé™)

[ä½¿ç”¨è€…] 
   â”‚  (è¼¸å…¥ AD/å¯†ç¢¼)
   â–¼
[AD/SSO é©—è­‰ç³»çµ±]  
   â”‚  é©—è­‰é€šé (ä»£è¡¨å¸³è™Ÿå¯†ç¢¼æ­£ç¢º)
   â–¼
[æ‡‰ç”¨ç³»çµ± (HI_POSã€HI_POSIMG...)]
   â”‚  å‘¼å« DLL â†’ GetUserNameAndGroup(SysID, UserAD, Env)
   â–¼
[HI_APACCESS_DLL_CORE / FRAMEWORK]
   â”‚  1. æª¢æŸ¥ Environment (TEST/PROD)
   â”‚  2. æª¢æŸ¥ SysID æ˜¯å¦åœ¨æˆæ¬Šæ¸…å–®
   â”‚  3. æŸ¥ AP_USER + AP_GROUP
   â”‚  4. æŸ¥ç¾¤çµ„çš„æ¯ç¾¤çµ„ã€å­ç¾¤çµ„
   â”‚  5. æŸ¥æ•æ„Ÿè³‡æ–™æ¬Šé™ã€éƒ¨é–€ã€è·ç¨±
   â–¼
[å›å‚³ Response çµ¦æ‡‰ç”¨ç³»çµ±]
   â”‚
   â”œâ”€ æˆåŠŸ â†’ { UserID, UserName, GroupID, GroupName, ParentGroupID[], ChildGroupID[], SensitiveDataAccess, OrganName, PostName }
   â”‚
   â””â”€ å¤±æ•— â†’ { Result_code, Msg }


â¸»

â‘¡ çµ±ä¸€éŒ¯èª¤ä»£ç¢¼ (ErrorCodes.cs)

namespace HI_APACCESS_DLL_CORE.Common
{
    internal static class ErrorCodes
    {
        // ===== æˆåŠŸ =====
        internal const string SUCCESS = "0000";     // æˆåŠŸ

        // ===== ä¸€èˆ¬éŒ¯èª¤ =====
        internal const string NO_PERMISSION = "0001"; // æŸ¥ç„¡æ¬Šé™/æ‰¾ä¸åˆ°å“¡å·¥æˆ–ç¾¤çµ„

        // ===== é©—è­‰éŒ¯èª¤ =====
        internal const string ENV_ERROR = "1003";    // ç’°å¢ƒéŒ¯èª¤ (åªæ¥å— TESTã€PROD)
        internal const string SYS_UNAUTHORIZED = "1004"; // ç³»çµ±æœªæˆæ¬Š (SysID ä¸åœ¨æ¸…å–®å…§)

        // ===== ç³»çµ±éŒ¯èª¤ =====
        internal const string SYSTEM_ERROR = "9999"; // ç³»çµ±å…§éƒ¨éŒ¯èª¤
    }
}


â¸»

â‘¢ ä½¿ç”¨ç¯„ä¾‹ (Factory ä¸­)

if (environment != "TEST" && environment != "PROD")
{
    response.Result_code = ErrorCodes.ENV_ERROR;
    response.Msg = "ç’°å¢ƒéŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD";
    return response;
}

var authorizedSystems = FCommon.GetAuthorizedSystemsList();
if (!authorizedSystems.Contains(sysId))
{
    response.Result_code = ErrorCodes.SYS_UNAUTHORIZED;
    response.Msg = "ç³»çµ±æœªæˆæ¬Š";
    return response;
}

if (!foundUser)
{
    response.Result_code = ErrorCodes.NO_PERMISSION;
    response.Msg = "æŸ¥ç„¡æ¬Šé™";
    return response;
}

response.Result_code = ErrorCodes.SUCCESS;
response.Msg = "æˆåŠŸ";


â¸»

âœ… é€™æ¨£ä»¥å¾Œæ¯å€‹åŠŸèƒ½ (1~6) éƒ½å¯ä»¥çµ±ä¸€ä½¿ç”¨ ErrorCodesï¼Œä¸ç”¨æ¯å€‹ Factory è‡ªå·±ç¡¬å¯« "0001" æˆ– "9999"ã€‚

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ åŠŸèƒ½ 1 (GetUserNameAndGroup) çš„ Factory ç¨‹å¼ç¢¼ï¼Œç›´æ¥æ”¹æˆå¥—ç”¨é€™å€‹ ErrorCodes çš„ç‰ˆæœ¬ï¼Ÿ

å¥½ï¼Œé‚£æˆ‘å¹«ä½ æŠŠ åŠŸèƒ½ 1ï¼šGetUserNameAndGroup çš„ Factory æ”¹æˆå¥—ç”¨ ErrorCodesï¼Œé€™æ¨£æ•´å€‹éŒ¯èª¤ç¢¼ç®¡ç†å°±ä¸€è‡´äº†ã€‚

â¸»

ğŸ“Œ Factoryï¼šFGetUserNameAndGroup.cs

using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using Newtonsoft.Json;
using HI_APACCESS_DLL_CORE.Models;
using HI_APACCESS_DLL_CORE.Common;

namespace HI_APACCESS_DLL_CORE.Factory
{
    internal class FGetUserNameAndGroup
    {
        internal GetUserNameAndGroupModel.GetUserNameAndGroupResponse Execute(string sysId, string userAd, string environment)
        {
            var response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse();

            try
            {
                // 1. ç’°å¢ƒæª¢æŸ¥
                if (environment != "TEST" && environment != "PROD")
                {
                    response.Result_code = ErrorCodes.ENV_ERROR;
                    response.Msg = "ç’°å¢ƒéŒ¯èª¤ï¼Œåªæ¥å— TEST æˆ– PROD";
                    return response;
                }

                // 2. ç³»çµ±æˆæ¬Šæª¢æŸ¥
                var authorizedSystems = FCommon.GetAuthorizedSystemsList();
                if (!authorizedSystems.Contains(sysId))
                {
                    response.Result_code = ErrorCodes.SYS_UNAUTHORIZED;
                    response.Msg = "ç³»çµ±æœªæˆæ¬Š";
                    return response;
                }

                using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString()))
                {
                    conn.Open();

                    // 3. æŸ¥è©¢ä½¿ç”¨è€…èˆ‡ç¾¤çµ„
                    string sqlMain = @"
WITH UserGroups AS (
    SELECT U.APG_NO, U.U_ID, U.U_NAME
    FROM [HI_TMMAIN].[dbo].[AP_USER] U
    WHERE U.SYS_ID=@SysID AND U.U_ID=@UserAD
)
SELECT TOP 1
    UG.U_ID AS UserID,
    UG.U_NAME AS UserName,
    G.APG_NO AS GroupID,
    G.APG_NAME AS GroupName,
    G.SENSITIVE_DATA_ACCESS AS SensitiveDataAccess,
    M.ORGAN_CAP AS OrganName,
    M.POST_NAME AS PostName
FROM UserGroups UG
INNER JOIN [HI_TMMAIN].[dbo].[AP_GROUP] G 
    ON UG.APG_NO = G.APG_NO AND G.SYS_ID=@SysID
LEFT JOIN [VW_M1EMP_MAST] M 
    ON UG.U_ID = M.EMP_NO;
";

                    var result = new GetUserNameAndGroupModel.ResultData();

                    using (SqlCommand cmd = new SqlCommand(sqlMain, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@UserAD", userAd);

                        using (var reader = cmd.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                result.UserID = reader["UserID"].ToString();
                                result.UserName = reader["UserName"].ToString();
                                result.GroupID = reader["GroupID"].ToString();
                                result.GroupName = reader["GroupName"].ToString();
                                result.SensitiveDataAccess = Convert.ToBoolean(reader["SensitiveDataAccess"]);
                                result.OrganName = reader["OrganName"].ToString();
                                result.PostName = reader["PostName"].ToString();
                            }
                            else
                            {
                                response.Result_code = ErrorCodes.NO_PERMISSION;
                                response.Msg = "æŸ¥ç„¡æ¬Šé™";
                                return response;
                            }
                        }
                    }

                    // 4. æ’ˆæ¯ç¾¤çµ„
                    string sqlParent = @"SELECT PARENT_APG_NO FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
                                         WHERE SYS_ID=@SysID AND APG_NO=@GroupID AND PARENT_APG_NO IS NOT NULL";
                    using (SqlCommand cmd = new SqlCommand(sqlParent, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@GroupID", result.GroupID);
                        using (var reader = cmd.ExecuteReader())
                        {
                            result.ParentGroupID = new List<string>();
                            while (reader.Read())
                            {
                                result.ParentGroupID.Add(reader["PARENT_APG_NO"].ToString());
                            }
                        }
                    }

                    // 5. æ’ˆå­ç¾¤çµ„
                    string sqlChild = @"SELECT APG_NO FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
                                        WHERE SYS_ID=@SysID AND PARENT_APG_NO=@GroupID";
                    using (SqlCommand cmd = new SqlCommand(sqlChild, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@GroupID", result.GroupID);
                        using (var reader = cmd.ExecuteReader())
                        {
                            result.ChildGroupID = new List<string>();
                            while (reader.Read())
                            {
                                result.ChildGroupID.Add(reader["APG_NO"].ToString());
                            }
                        }
                    }

                    // 6. æˆåŠŸå›å‚³
                    response.Result_code = ErrorCodes.SUCCESS;
                    response.Msg = "æˆåŠŸ";
                    response.Result = result;
                }
            }
            catch (Exception ex)
            {
                response.Result_code = ErrorCodes.SYSTEM_ERROR;
                response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
            }

            return response;
        }
    }
}


â¸»

ğŸ“Œ ç¾åœ¨çš„æµç¨‹å°±æ˜¯ï¼š
	1.	å…ˆæª¢æŸ¥ ç’°å¢ƒ (Env) â†’ ä¸å°å°±å› 1003ã€‚
	2.	å†æª¢æŸ¥ ç³»çµ±æˆæ¬Š (SysID) â†’ ä¸åœ¨æ¸…å–®å› 1004ã€‚
	3.	å†æŸ¥ä½¿ç”¨è€…/ç¾¤çµ„ â†’ æ‰¾ä¸åˆ°å› 0001ã€‚
	4.	å…¨éƒ¨æ­£ç¢º â†’ å› 0000ï¼Œå¸¶å®Œæ•´è³‡è¨Šã€‚
	5.	ä»»ä½• Exception â†’ 9999ã€‚

â¸»

è¦ä¸è¦æˆ‘å¹«ä½ æŠŠ APACCESS.cs (ä¸»é¡åˆ¥å‘¼å«) ä¹Ÿæ”¹æˆçµ±ä¸€ç”¨ ErrorCodesï¼Œé€™æ¨£å‘¼å«ç«¯å°±ä¸ç”¨åœ¨å¤šå€‹åœ°æ–¹è‡ªå·±ç¡¬å¯«ä»£ç¢¼ï¼Ÿ