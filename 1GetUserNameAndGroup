 å¥½ ğŸ‘Œ æˆ‘å¹«ä½ æŠŠ ParentGroupID / ChildGroupID æ”¹æˆå›å‚³ JSON é™£åˆ—ï¼Œé€™æ¨£ Response å°±è·Ÿä½  API è¦æ ¼ä¸€æ¨£ ([ "003","002" ])ã€‚

â¸»

â‘  SQL æ”¹æ³•ï¼šç”¨ FOR JSON PATH

DECLARE @SysID NVARCHAR(50) = 'HI_POS';
DECLARE @UserAD NVARCHAR(50) = '3A001';

WITH UserGroups AS (
    SELECT U.APG_NO, U.U_ID, U.U_NAME
    FROM [HI_TMMAIN].[dbo].[AP_USER] U
    WHERE U.SYS_ID=@SysID AND U.U_ID=@UserAD
)
SELECT DISTINCT
    UG.U_ID AS UserID,
    UG.U_NAME AS UserName,
    G.APG_NO AS GroupID,
    G.APG_NAME AS GroupName,

    -- æ¯ç¾¤çµ„ï¼šç›´æ¥è¼¸å‡º JSON é™£åˆ—
    (
        SELECT PARENT_APG_NO 
        FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
        WHERE APG_NO = G.APG_NO AND SYS_ID = G.SYS_ID AND PARENT_APG_NO IS NOT NULL
        FOR JSON PATH
    ) AS ParentGroupID,

    -- å­ç¾¤çµ„ï¼šç›´æ¥è¼¸å‡º JSON é™£åˆ—
    (
        SELECT APG_NO 
        FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
        WHERE PARENT_APG_NO = G.APG_NO AND SYS_ID = G.SYS_ID
        FOR JSON PATH
    ) AS ChildGroupID,

    G.SENSITIVE_DATA_ACCESS AS SensitiveDataAccess,
    M.ORGAN_CAP AS OrganName,
    M.POST_NAME AS PostName
FROM UserGroups UG
INNER JOIN [HI_TMMAIN].[dbo].[AP_GROUP] G 
    ON UG.APG_NO = G.APG_NO AND G.SYS_ID=@SysID
LEFT JOIN [VW_M1EMP_MAST] M 
    ON UG.U_ID = M.EMP_NO;

ğŸ‘‰ åŸ·è¡Œçµæœç¯„ä¾‹ï¼š
	â€¢	ParentGroupID = [{"PARENT_APG_NO":"003"},{"PARENT_APG_NO":"002"}]
	â€¢	ChildGroupID = [{"APG_NO":"004"},{"APG_NO":"005"}]

ç¨‹å¼ç«¯å†ç”¨ Model (List<string>) å»è½‰æ›å³å¯ã€‚

â¸»

â‘¡ Model (æ›´æ–°ç‰ˆ)

internal class ResultData
{
    [JsonProperty]
    [DisplayName("ä½¿ç”¨è€…ID")]
    internal string UserID { get; set; }

    [JsonProperty]
    [DisplayName("ä½¿ç”¨è€…åç¨±")]
    internal string UserName { get; set; }

    [JsonProperty]
    [DisplayName("ç¾¤çµ„ID")]
    internal string GroupID { get; set; }

    [JsonProperty]
    [DisplayName("ç¾¤çµ„åç¨±")]
    internal string GroupName { get; set; }

    [JsonProperty]
    [DisplayName("æ¯ç¾¤çµ„IDæ¸…å–®")]
    internal List<string> ParentGroupID { get; set; }

    [JsonProperty]
    [DisplayName("å­ç¾¤çµ„IDæ¸…å–®")]
    internal List<string> ChildGroupID { get; set; }

    [JsonProperty]
    [DisplayName("æ˜¯å¦å¯å­˜å–æ©Ÿæ•è³‡æ–™")]
    internal bool SensitiveDataAccess { get; set; }

    [JsonProperty]
    [DisplayName("éƒ¨é–€åç¨±")]
    internal string OrganName { get; set; }

    [JsonProperty]
    [DisplayName("è·ç¨±åç¨±")]
    internal string PostName { get; set; }
}


â¸»

â‘¢ Factoryï¼šFGetUserNameAndGroup.cs

using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using Newtonsoft.Json;
using HI_APACCESS_DLL_CORE.Models;

namespace HI_APACCESS_DLL_CORE.Factory
{
    internal class FGetUserNameAndGroup
    {
        internal GetUserNameAndGroupModel.GetUserNameAndGroupResponse Execute(string sysId, string userAd, string environment)
        {
            var response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse();

            try
            {
                using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString()))
                {
                    conn.Open();
                    string sql = @"
WITH UserGroups AS (
    SELECT U.APG_NO, U.U_ID, U.U_NAME
    FROM [HI_TMMAIN].[dbo].[AP_USER] U
    WHERE U.SYS_ID=@SysID AND U.U_ID=@UserAD
)
SELECT DISTINCT
    UG.U_ID AS UserID,
    UG.U_NAME AS UserName,
    G.APG_NO AS GroupID,
    G.APG_NAME AS GroupName,
    (
        SELECT PARENT_APG_NO 
        FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
        WHERE APG_NO = G.APG_NO AND SYS_ID = G.SYS_ID AND PARENT_APG_NO IS NOT NULL
        FOR JSON PATH
    ) AS ParentGroupID,
    (
        SELECT APG_NO 
        FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
        WHERE PARENT_APG_NO = G.APG_NO AND SYS_ID = G.SYS_ID
        FOR JSON PATH
    ) AS ChildGroupID,
    G.SENSITIVE_DATA_ACCESS AS SensitiveDataAccess,
    M.ORGAN_CAP AS OrganName,
    M.POST_NAME AS PostName
FROM UserGroups UG
INNER JOIN [HI_TMMAIN].[dbo].[AP_GROUP] G 
    ON UG.APG_NO = G.APG_NO AND G.SYS_ID=@SysID
LEFT JOIN [VW_M1EMP_MAST] M 
    ON UG.U_ID = M.EMP_NO;
";

                    using (SqlCommand cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@SysID", sysId);
                        cmd.Parameters.AddWithValue("@UserAD", userAd);

                        using (var reader = cmd.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                var result = new GetUserNameAndGroupModel.ResultData
                                {
                                    UserID = reader["UserID"].ToString(),
                                    UserName = reader["UserName"].ToString(),
                                    GroupID = reader["GroupID"].ToString(),
                                    GroupName = reader["GroupName"].ToString(),
                                    ParentGroupID = JsonConvert.DeserializeObject<List<string>>(reader["ParentGroupID"].ToString() ?? "[]"),
                                    ChildGroupID = JsonConvert.DeserializeObject<List<string>>(reader["ChildGroupID"].ToString() ?? "[]"),
                                    SensitiveDataAccess = Convert.ToBoolean(reader["SensitiveDataAccess"]),
                                    OrganName = reader["OrganName"].ToString(),
                                    PostName = reader["PostName"].ToString()
                                };

                                response.Result_code = "0000";
                                response.Msg = "æˆåŠŸ";
                                response.Result = result;
                            }
                            else
                            {
                                response.Result_code = "0001";
                                response.Msg = "æŸ¥ç„¡æ¬Šé™";
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                response.Result_code = "9999";
                response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
            }

            return response;
        }
    }
}


â¸»

â‘£ ä¸»é¡åˆ¥å‘¼å« (APACCESS.cs)

using Newtonsoft.Json;
using HI_APACCESS_DLL_CORE.Factory;
using HI_APACCESS_DLL_CORE.Models;

namespace HI_APACCESS_DLL_CORE
{
    public static class APACCESS
    {
        public static string GetUserNameAndGroup(string requestJson)
        {
            var response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse();

            try
            {
                var request = JsonConvert.DeserializeObject<GetUserNameAndGroupModel.GetUserNameAndGroupRequest>(requestJson);

                FGetUserNameAndGroup func = new FGetUserNameAndGroup();
                response = func.Execute(request.SysID, request.UserAD, request.Environment);
            }
            catch (Exception ex)
            {
                response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse
                {
                    Result_code = "9999",
                    Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message
                };
            }

            return JsonConvert.SerializeObject(response);
        }
    }
}


â¸»

ğŸ“Œ é€™æ¨£ç¬¬ä¸€å€‹åŠŸèƒ½å°±å®Œæ•´äº†ï¼š
	â€¢	SQL å·²ç¶“è¼¸å‡º JSON é™£åˆ—
	â€¢	Model æ˜¯ List<string>
	â€¢	Factory æœƒè½‰æˆç‰©ä»¶
	â€¢	ä¸»é¡åˆ¥ APACCESS å¯ç›´æ¥å‘¼å«

è¦ä¸è¦æˆ‘æ¥ä¸‹ä¾†å¹«ä½  æŠŠç¬¬äºŒå€‹åŠŸèƒ½ (GetGroupAllUser) ä¹Ÿåšå®Œæ•´ Factory + Model + å‘¼å«ç¯„ä¾‹ï¼Ÿ

