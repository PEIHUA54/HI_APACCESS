ğŸ‘Œ çœ‹äº†ä½ çµ¦çš„ response ç¯„ä¾‹ï¼Œæˆ‘æ‡‚äº†ã€‚
ä½ çš„ API response æ˜¯é•·é€™æ¨£çš„ï¼š

{
  "Result_code": "0000",
  "Msg": "æˆåŠŸ",
  "Result": {
    "UserID": "3A001",
    "UserName": "ç‹å°æ˜",
    "GroupID": "001",
    "GroupName": "ç®¡ç†å“¡(è³‡è¨Š)",
    "ParentGroupID": [ "003", "002" ],
    "ChildGroupID": [ "004", "005" ],
    "SensitiveDataAccess": false,
    "OrganName": "ç¨‹å¼èª²",
    "PostName": "é«˜ç´šå°ˆå“¡"
  }
}

ğŸ‘‰ æ‰€ä»¥çµè«–æ˜¯ï¼š
	â€¢	ParentGroupID / ChildGroupID å¿…é ˆæ˜¯ çœŸæ­£çš„é™£åˆ— (List<string>)ï¼Œè€Œä¸æ˜¯ JSON æ–‡å­—æˆ– STRING_AGGã€‚
	â€¢	ä¹Ÿå°±æ˜¯èªª SQL ä¸è¦ç”¨ FOR JSON PATHï¼Œè€Œæ˜¯å›å‚³å¤šç­†è¨˜éŒ„ï¼Œç¨‹å¼ç«¯å†è½‰æˆ List<string>ã€‚

â¸»

âœ… æ­£ç¢º SQL å¯«æ³•ï¼ˆæ”¹å›å¤šç­†ï¼‰

-- å…ˆæ‰¾ä½¿ç”¨è€…ç¾¤çµ„
WITH UserGroups AS (
    SELECT U.APG_NO, U.U_ID, U.U_NAME
    FROM [HI_TMMAIN].[dbo].[AP_USER] U
    WHERE U.SYS_ID=@SysID AND U.U_ID=@UserAD
)
SELECT DISTINCT
    UG.U_ID AS UserID,
    UG.U_NAME AS UserName,
    G.APG_NO AS GroupID,
    G.APG_NAME AS GroupName,
    G.PARENT_APG_NO AS ParentGroupID,
    G.SENSITIVE_DATA_ACCESS AS SensitiveDataAccess,
    M.ORGAN_CAP AS OrganName,
    M.POST_NAME AS PostName
FROM UserGroups UG
INNER JOIN [HI_TMMAIN].[dbo].[AP_GROUP] G 
    ON UG.APG_NO = G.APG_NO AND G.SYS_ID=@SysID
LEFT JOIN [VW_M1EMP_MAST] M 
    ON UG.U_ID = M.EMP_NO;

å­ç¾¤çµ„å¦å¤–æŸ¥ï¼š

SELECT APG_NO
FROM [HI_TMMAIN].[dbo].[AP_GROUP]
WHERE SYS_ID=@SysID AND PARENT_APG_NO=@GroupID;

æ¯ç¾¤çµ„å¦å¤–æŸ¥ï¼š

SELECT PARENT_APG_NO
FROM [HI_TMMAIN].[dbo].[AP_GROUP]
WHERE SYS_ID=@SysID AND APG_NO=@GroupID AND PARENT_APG_NO IS NOT NULL;


â¸»

âœ… Modelï¼ˆListï¼‰

internal class ResultData
{
    [JsonProperty]
    [DisplayName("ä½¿ç”¨è€…ID")]
    internal string UserID { get; set; }

    [JsonProperty]
    [DisplayName("ä½¿ç”¨è€…åç¨±")]
    internal string UserName { get; set; }

    [JsonProperty]
    [DisplayName("ç¾¤çµ„ID")]
    internal string GroupID { get; set; }

    [JsonProperty]
    [DisplayName("ç¾¤çµ„åç¨±")]
    internal string GroupName { get; set; }

    [JsonProperty]
    [DisplayName("æ¯ç¾¤çµ„IDæ¸…å–®")]
    internal List<string> ParentGroupID { get; set; }

    [JsonProperty]
    [DisplayName("å­ç¾¤çµ„IDæ¸…å–®")]
    internal List<string> ChildGroupID { get; set; }

    [JsonProperty]
    [DisplayName("æ˜¯å¦å¯å­˜å–æ©Ÿæ•è³‡æ–™")]
    internal bool SensitiveDataAccess { get; set; }

    [JsonProperty]
    [DisplayName("éƒ¨é–€åç¨±")]
    internal string OrganName { get; set; }

    [JsonProperty]
    [DisplayName("è·ç¨±åç¨±")]
    internal string PostName { get; set; }
}


â¸»

âœ… Factoryï¼ˆFGetUserNameAndGroup.csï¼‰

internal class FGetUserNameAndGroup
{
    internal GetUserNameAndGroupModel.GetUserNameAndGroupResponse Execute(string sysId, string userAd, string environment)
    {
        var response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse();

        try
        {
            using (SqlConnection conn = new SqlConnection(FCommon.BuildConnectionString()))
            {
                conn.Open();

                // å…ˆæŠ“ä¸»è¦è³‡è¨Š
                string sqlMain = @"
WITH UserGroups AS (
    SELECT U.APG_NO, U.U_ID, U.U_NAME
    FROM [HI_TMMAIN].[dbo].[AP_USER] U
    WHERE U.SYS_ID=@SysID AND U.U_ID=@UserAD
)
SELECT TOP 1
    UG.U_ID AS UserID,
    UG.U_NAME AS UserName,
    G.APG_NO AS GroupID,
    G.APG_NAME AS GroupName,
    G.SENSITIVE_DATA_ACCESS AS SensitiveDataAccess,
    M.ORGAN_CAP AS OrganName,
    M.POST_NAME AS PostName
FROM UserGroups UG
INNER JOIN [HI_TMMAIN].[dbo].[AP_GROUP] G 
    ON UG.APG_NO = G.APG_NO AND G.SYS_ID=@SysID
LEFT JOIN [VW_M1EMP_MAST] M 
    ON UG.U_ID = M.EMP_NO;
";

                var result = new GetUserNameAndGroupModel.ResultData();

                using (SqlCommand cmd = new SqlCommand(sqlMain, conn))
                {
                    cmd.Parameters.AddWithValue("@SysID", sysId);
                    cmd.Parameters.AddWithValue("@UserAD", userAd);

                    using (var reader = cmd.ExecuteReader())
                    {
                        if (reader.Read())
                        {
                            result.UserID = reader["UserID"].ToString();
                            result.UserName = reader["UserName"].ToString();
                            result.GroupID = reader["GroupID"].ToString();
                            result.GroupName = reader["GroupName"].ToString();
                            result.SensitiveDataAccess = Convert.ToBoolean(reader["SensitiveDataAccess"]);
                            result.OrganName = reader["OrganName"].ToString();
                            result.PostName = reader["PostName"].ToString();
                        }
                        else
                        {
                            response.Result_code = "0001";
                            response.Msg = "æŸ¥ç„¡æ¬Šé™";
                            return response;
                        }
                    }
                }

                // æ’ˆæ¯ç¾¤çµ„
                string sqlParent = @"SELECT PARENT_APG_NO FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
                                     WHERE SYS_ID=@SysID AND APG_NO=@GroupID AND PARENT_APG_NO IS NOT NULL";
                using (SqlCommand cmd = new SqlCommand(sqlParent, conn))
                {
                    cmd.Parameters.AddWithValue("@SysID", sysId);
                    cmd.Parameters.AddWithValue("@GroupID", result.GroupID);
                    using (var reader = cmd.ExecuteReader())
                    {
                        result.ParentGroupID = new List<string>();
                        while (reader.Read())
                        {
                            result.ParentGroupID.Add(reader["PARENT_APG_NO"].ToString());
                        }
                    }
                }

                // æ’ˆå­ç¾¤çµ„
                string sqlChild = @"SELECT APG_NO FROM [HI_TMMAIN].[dbo].[AP_GROUP] 
                                    WHERE SYS_ID=@SysID AND PARENT_APG_NO=@GroupID";
                using (SqlCommand cmd = new SqlCommand(sqlChild, conn))
                {
                    cmd.Parameters.AddWithValue("@SysID", sysId);
                    cmd.Parameters.AddWithValue("@GroupID", result.GroupID);
                    using (var reader = cmd.ExecuteReader())
                    {
                        result.ChildGroupID = new List<string>();
                        while (reader.Read())
                        {
                            result.ChildGroupID.Add(reader["APG_NO"].ToString());
                        }
                    }
                }

                response.Result_code = "0000";
                response.Msg = "æˆåŠŸ";
                response.Result = result;
            }
        }
        catch (Exception ex)
        {
            response.Result_code = "9999";
            response.Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message;
        }

        return response;
    }
}


â¸»

âœ… ä¸»é¡åˆ¥å‘¼å« (APACCESS.cs)

public static string GetUserNameAndGroup(string requestJson)
{
    var response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse();

    try
    {
        var request = JsonConvert.DeserializeObject<GetUserNameAndGroupModel.GetUserNameAndGroupRequest>(requestJson);

        FGetUserNameAndGroup func = new FGetUserNameAndGroup();
        response = func.Execute(request.SysID, request.UserAD, request.Environment);
    }
    catch (Exception ex)
    {
        response = new GetUserNameAndGroupModel.GetUserNameAndGroupResponse
        {
            Result_code = "9999",
            Msg = "ç³»çµ±éŒ¯èª¤ï¼š" + ex.Message
        };
    }

    return JsonConvert.SerializeObject(response);
}


â¸»

âœ… é€™æ¨£ç”¢å‡ºçš„ JSON å°±æœƒè·Ÿä½ åœ–ç‰‡ç¯„ä¾‹ä¸€æ¨£ï¼Œ
ParentGroupID / ChildGroupID éƒ½æ˜¯ çœŸæ­£çš„é™£åˆ—ã€‚

è¦ä¸è¦æˆ‘ä¸‹ä¸€æ­¥å¹«ä½ æŠŠ ç¬¬äºŒå€‹åŠŸèƒ½ GetGroupAllUser ä¹Ÿåšå®Œæ•´ (Model + Factory + å‘¼å«)ï¼Ÿ