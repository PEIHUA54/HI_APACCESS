å®Œç¾ ğŸ‘ æˆ‘æ‡‚ä½ æ„æ€â”€â”€ä¸æƒ³å¤šä¸€å€‹ classï¼Œ
ç›´æ¥æŠŠã€Œç™»å…¥æ™‚åªé©—èº«åˆ†ã€ä¸é©—æ¬Šé™ã€çš„é‚è¼¯ï¼Œ
å¯«é€² SVS_å“¡å·¥åŸºæœ¬è³‡æ–™ è£¡å°±å¥½ã€‚

ä»¥ä¸‹æ˜¯ä½ å®Œæ•´éœ€è¦ä¿®æ”¹ï¼æ–°å¢çš„éƒ¨åˆ†ï¼Œæˆ‘å¹«ä½ æ•´åˆå¥½äº†ï¼ˆåªè¦è²¼é€²å»å³å¯ï¼‰ã€‚

âœ… ä¸€ã€ä¿®æ”¹å¾Œå®Œæ•´çš„ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.cs

ä½ åªè¦ç”¨é€™ä»½è¦†è“‹åŸæœ¬çš„å³å¯ã€‚
ï¼ˆæœ‰æ¨™è¨» ğŸŸ¢ æ–°å¢å€å¡Šï¼‰

using HI_APACCESS_DLL;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Linq;

namespace HI_APACCESS.Service
{
    public class SVS_å“¡å·¥åŸºæœ¬è³‡æ–™
    {
        #region ADã€å“¡ç·¨ã€ åŸºæœ¬è³‡æ–™

        /// <summary>
        /// æ¬Šé™ç®¡ç†-å–å¾—å“¡å·¥AD
        /// </summary>
        /// <returns>AD</returns>
        internal static string Get_å“¡å·¥AD()
        {
            string EMP_DOM_ID = System.Web.HttpContext.Current.User.Identity.Name
                .Substring(System.Web.HttpContext.Current.User.Identity.Name.LastIndexOf("\\") + 1);

            if (String.IsNullOrEmpty(EMP_DOM_ID))
            {
                System.Security.Principal.WindowsPrincipal principal =
                    new System.Security.Principal.WindowsPrincipal(System.Security.Principal.WindowsIdentity.GetCurrent());
                string name = principal.Identity.Name;
                string[] adname = name.Split(new string[] { "\\" }, StringSplitOptions.RemoveEmptyEntries);
                EMP_DOM_ID = adname[1].ToString().ToUpper();
            }

            return EMP_DOM_ID;
        }

        // ğŸŸ¢ æ–°å¢ï¼šå…±ç”¨é€£ç·šå­—ä¸²ï¼ˆè‡ªå‹•åˆ¤åˆ¥æ¸¬è©¦æˆ–æ­£å¼ï¼‰
        private static string GetConnString()
        {
            string env = ConfigurationManager.AppSettings["Environment"] ?? "";
            if (env.Contains("HI_APACCESS_TEST", StringComparison.OrdinalIgnoreCase))
                return ConfigurationManager.ConnectionStrings["ConnDB_TFS_HI-AUTOS"].ConnectionString; // æ¸¬è©¦
            else
                return ConfigurationManager.ConnectionStrings["ConnDB_DBLS_HI-AUTOS"].ConnectionString; // æ­£å¼
        }

        // ğŸŸ¢ æ–°å¢ï¼šåªé©—èº«åˆ†ï¼ˆç™»å…¥ç•«é¢ç”¨ï¼Œä¸æŸ¥æ¬Šé™ï¼‰
        internal static VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨± Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(string adOrEmp)
        {
            if (string.IsNullOrWhiteSpace(adOrEmp))
                return null;

            string empNo = null;
            string empName = null;
            string organ = null;
            string post = null;

            using (SqlConnection conn = new SqlConnection(GetConnString()))
            {
                conn.Open();

                // 1ï¸âƒ£ å…ˆå˜—è©¦æŸ¥ AD â†’ å“¡ç·¨
                string sqlEmp = @"
SELECT TOP 1 E.EMP_ID
FROM [HILIFE_MTS].[HI_APUSER].dbo.[NT_EMP] E
WHERE E.EMP_DOM_ID = @AD
  AND LTRIM(RTRIM(E.EMP_DOM_ID)) <> ''
";
                using (SqlCommand cmd = new SqlCommand(sqlEmp, conn))
                {
                    cmd.Parameters.AddWithValue("@AD", adOrEmp.ToUpper());
                    object result = cmd.ExecuteScalar();
                    if (result != null)
                        empNo = result.ToString();
                }

                // å°ä¸åˆ°å“¡ç·¨æ™‚ï¼Œç›´æ¥ç•¶æˆå“¡ç·¨æŸ¥
                if (string.IsNullOrEmpty(empNo))
                    empNo = adOrEmp.ToUpper();

                // 2ï¸âƒ£ æŸ¥åŸºæœ¬è³‡æ–™ï¼ˆäººäº‹ä¸»æª”ï¼‰
                string sqlMast = @"
SELECT TOP 1
    M.EMP_NO,
    M.EMP_NAME,
    M.ORGAN_CAP,
    M.POST_NAME
FROM [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST] M
WHERE M.EMP_NO = @EMP_NO
  AND (M.END_DT IS NULL OR LTRIM(RTRIM(M.END_DT)) = '')
";
                using (SqlCommand cmd = new SqlCommand(sqlMast, conn))
                {
                    cmd.Parameters.AddWithValue("@EMP_NO", empNo);
                    using (var r = cmd.ExecuteReader())
                    {
                        if (r.Read())
                        {
                            empName = r["EMP_NAME"]?.ToString();
                            organ = r["ORGAN_CAP"]?.ToString();
                            post = r["POST_NAME"]?.ToString();
                        }
                    }
                }
            }

            if (string.IsNullOrEmpty(empName))
                return null;

            return new VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨±
            {
                AD = adOrEmp.ToUpper(),
                EMP_NO = empNo,
                EMP_NAME = empName,
                ORGAN_CAP = organ,
                POST_NAME = post
                // ä¸å« APG_NOï¼Œå› ç‚ºæ²’æŸ¥æ¬Šé™
            };
        }

        /// <summary>
        /// æ¬Šé™ç®¡ç†-å–å¾—å“¡å·¥ç·¨è™Ÿ (å‘¼å« DLL åŠŸèƒ½1)
        /// </summary>
        /// <returns>å“¡ç·¨</returns>
        internal static string Get_å“¡å·¥ç·¨è™Ÿ(string ad = null)
        {
            var req = new Models.M_AP_DLL.GetUserDataRequestModel
            {
                SysID = "HI_APACCESS",
                UserAD = string.IsNullOrEmpty(ad) ? Get_å“¡å·¥AD() : ad,
                Environment = EnvHelper.EnvironmentForDll(),
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetUserData(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetUserDataResponseModel>(response);

            return res?.Result?.UserID ?? req.UserAD;
        }

        /// <summary>
        /// å–å¾—å“¡å·¥åŸºæœ¬è³‡æ–™ (å‘¼å« DLL åŠŸèƒ½1ï¼Œå«æ¬Šé™)
        /// </summary>
        internal static VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨± Get_å“¡å·¥åŸºæœ¬è³‡æ–™(string ad)
        {
            var req = new Models.M_AP_DLL.GetUserDataRequestModel
            {
                SysID = "HI_APACCESS",
                UserAD = ad,
                Environment = EnvHelper.EnvironmentForDll(),
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetUserData(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetUserDataResponseModel>(response);

            if (res?.Result == null) return null;

            return new VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨±
            {
                AD = req.UserAD,
                EMP_NO = res.Result.UserID,
                EMP_NAME = res.Result.UserName,
                POST_NAME = res.Result.PostName,
                ORGAN_CAP = res.Result.OrganName,
                APG_NO = res.Result.GroupID
            };
        }

        #endregion

        #region æ¬Šé™æ¨¹ï¼ˆä¿æŒåŸæ¨£ï¼‰
        internal static List<VM_Employee.WebTree_Node> Get_Tree(string groupId)
        {
            var req = new Models.M_AP_DLL.GetTreeRequestModel
            {
                SysID = "HI_APACCESS",
                GroupID = groupId,
                Environment = EnvHelper.EnvironmentForDll()
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetTree(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetTreeResponseModel>(response);

            if (res?.Result == null) return new List<VM_Employee.WebTree_Node>();

            var allNodes = res.Result.Select(x => new VM_Employee.WebTree_Node
            {
                FUNC_ID = x.FuncID,
                FUNC_NA = x.FuncName,
                PARENT_ID = x.ParentID,
                VIEW_H = x.Controller,
                VIEW_HB = x.Action,
                SORT_NO = x.Sort.ToString(),
                WebTree = new List<VM_Employee.WebTree_Node>()
            }).ToList();

            var dict = allNodes.ToDictionary(x => x.FUNC_ID, x => x);

            List<VM_Employee.WebTree_Node> roots = new List<VM_Employee.WebTree_Node>();
            foreach (var node in allNodes)
            {
                if (string.IsNullOrEmpty(node.PARENT_ID) || node.PARENT_ID == "HOME")
                {
                    roots.Add(node);
                }
                else if (dict.ContainsKey(node.PARENT_ID))
                {
                    dict[node.PARENT_ID].WebTree.Add(node);
                }
            }

            SortTree(roots);

            return roots;
        }

        private static void SortTree(List<VM_Employee.WebTree_Node> nodes)
        {
            nodes.Sort((a, b) => int.Parse(a.SORT_NO).CompareTo(int.Parse(b.SORT_NO)));
            foreach (var node in nodes)
            {
                if (node.WebTree != null && node.WebTree.Count > 0)
                {
                    SortTree(node.WebTree);
                }
            }
        }
        #endregion
    }
}


â¸»

âœ… äºŒã€ä¿®æ”¹ AccountController

(1) Login (GET)

æ”¹æˆå‘¼å«ã€Œåªé©—èº«åˆ†ã€ç‰ˆæœ¬ï¼š

[AllowAnonymous]
[HttpGet]
public ActionResult Login()
{
    Session.RemoveAll();

    string ad = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥AD();
    var login = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(ad);

    if (login == null)
    {
        ModelState.AddModelError("", "æŸ¥ç„¡æœ‰æ•ˆå“¡å·¥æˆ–å·²é›¢è·");
        return View(new VM_å“¡å·¥éƒ¨é–€è·ç¨± { AD = ad });
    }

    login.AD = ad;
    return View(login);
}


â¸»

(2) Login (POST)

ç™»å…¥å¾Œè¦æª¢æŸ¥æ˜¯å¦æœ‰æ¬Šé™å†é€²ç³»çµ±ï¼ˆDLL åŠŸèƒ½1ï¼‰ï¼š

[AllowAnonymous]
[HttpPost]
[ValidateAntiForgeryToken]
public ActionResult Login([Bind] VM_å“¡å·¥éƒ¨é–€è·ç¨± login, string ReturnUrl)
{
    if (!ModelState.IsValid) return View(login);

    string ad = !string.IsNullOrEmpty(login.AD) ? login.AD : SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥AD();

    // Step 1: å…ˆé©—èº«åˆ†ï¼ˆä¸æŸ¥æ¬Šé™ï¼‰
    var basic = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(ad);
    if (basic == null)
    {
        ModelState.AddModelError("", "æŸ¥ç„¡æœ‰æ•ˆå“¡å·¥æˆ–å·²é›¢è·");
        return View(login);
    }

    // Step 2: é©—æ¬Šé™ï¼ˆå‘¼å« DLLï¼‰
    var withGroup = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™(ad);
    if (withGroup == null || string.IsNullOrEmpty(withGroup.APG_NO))
    {
        ModelState.AddModelError("", "æ‚¨æ²’æœ‰ç™»å…¥æ­¤ç³»çµ±çš„æ¬Šé™");
        return View(login);
    }

    // Step 3: é€šéå¾Œå»ºç«‹ç™»å…¥ç¥¨è­‰
    FormsAuthentication.RedirectFromLoginPage(ad, true);
    var encTicket = LoginTicket(ad);
    var authCookie = new HttpCookie(FormsAuthentication.FormsCookieName, encTicket)
    {
        Secure = Request.IsSecureConnection,
        HttpOnly = true
    };
    Response.Cookies.Add(authCookie);

    if (String.IsNullOrEmpty(ReturnUrl) || ReturnUrl == "/")
        return RedirectToAction("Main", "Home");

    if (!Url.IsLocalUrl(ReturnUrl))
        return RedirectToAction("Login", "Account");

    string[] allowedPaths = { "/Main/", "/Home/", "/Account/" };
    if (allowedPaths.Any(path => ReturnUrl.StartsWith(path, StringComparison.OrdinalIgnoreCase)))
        return RedirectToAction("Login", "Account", new { ReturnUrl });

    return RedirectToAction("Login", "Account");
}


â¸»

âœ… ä¸‰ã€é©—è­‰ Attributeï¼ˆå¯é¸ä¿®æ”¹ï¼‰

å¦‚æœä½ æƒ³è¦ç™»å…¥ç•«é¢é©—è­‰å“¡ç·¨æ™‚ä¹Ÿä¸è¢«æ¬Šé™æ“‹æ‰ï¼š
è«‹å°‡ å“¡ç·¨é©—è­‰Attribute æ”¹æˆç”¨æ–°çš„ã€Œåªé©—èº«åˆ†ã€ã€‚

if (SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(EmpNo.ToUpper()) == null)
{
    return false;
}


â¸»

âœ… æœ€çµ‚æ•ˆæœ
	â€¢	ç™»å…¥ç•«é¢æœƒå…ˆç”¨ Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†() â†’ åªæŸ¥äººäº‹è¡¨ã€‚
	â€¢	è‹¥æ‰¾ä¸åˆ°å“¡å·¥ â†’ é¡¯ç¤ºã€ŒæŸ¥ç„¡æœ‰æ•ˆå“¡å·¥æˆ–å·²é›¢è·ã€ã€‚
	â€¢	è‹¥æ‰¾åˆ°å“¡å·¥ä½†ç„¡æ¬Šé™ â†’ é¡¯ç¤ºã€Œæ‚¨æ²’æœ‰ç™»å…¥æ­¤ç³»çµ±çš„æ¬Šé™ã€ã€‚
	â€¢	æœ‰æ¬Šé™çš„ â†’ æ­£å¸¸ç™»å…¥ã€å»ºç«‹ Cookieã€‚
	â€¢	ä¸éœ€ä¿®æ”¹ DLLã€ä¸éœ€å‹•å…¶ä»–ç³»çµ±ã€‚

â¸»

æ˜¯å¦è¦æˆ‘å¹«ä½ è£œä¸Šé€™æ¨£çš„ å“¡ç·¨é©—è­‰Attribute æœ€ä½³åŒ–ç‰ˆæœ¬ï¼ˆç›´æ¥æ”¹å¥½ç”¨ç«™å°ç‰ˆæ–¹æ³•ï¼‰ï¼Ÿ