åˆ‡æ›æŒ‰éˆ•
äº†è§£ï¼ä½ éœ€è¦åœ¨ `GroupManagement` é é¢åˆ¤æ–·æ˜¯å¾å“ªç¨®æ–¹å¼é€²ä¾†çš„ï¼Œåªæœ‰å¾ç«™å°é€²ä¾†æ‰é¡¯ç¤ºã€Œåˆ‡æ›ç³»çµ±ã€æŒ‰éˆ•ã€‚

## è§£æ±ºæ–¹æ¡ˆ

### **åˆ¤æ–·é‚è¼¯**

- **TOKEN é€²ä¾†**ï¼šSession æœ‰ `CurrentSystemId` å’Œ `CurrentEmpNo`ï¼Œä¸”æ˜¯é€é `TokenEntry` é€²ä¾†
- **ç«™å°é€²ä¾†**ï¼šSession æœ‰ `CurrentSystemId`ï¼Œä½†æ˜¯é€é `SYS_PERMISSION_SET` å°å‘éä¾†çš„

æˆ‘å€‘å¯ä»¥åŠ ä¸€å€‹æ¨™è¨˜ä¾†å€åˆ†ï¼

## ä¿®æ”¹æ–¹æ¡ˆ

### **1. ä¿®æ”¹ SYSController.cs - å°å‘æ™‚åŠ ä¸Šæ¨™è¨˜**

```csharp
// å°å‘ç¾¤çµ„ç®¡ç†
[HttpPost]
public JsonResult RedirectToGroupManagement(string sysId)
{
    try
    {
        if (string.IsNullOrEmpty(sysId))
        {
            return Json(new { success = false, message = "è«‹é¸æ“‡ç³»çµ±" });
        }

        // æ›´æ–°Session
        Session["CurrentSystemId"] = sysId;
        Session["FromInternalSite"] = true; // ğŸ‘ˆ åŠ ä¸Šæ¨™è¨˜ï¼Œè¡¨ç¤ºå¾ç«™å°å…§éƒ¨é€²ä¾†

        return Json(new { success = true, redirectUrl = Url.Action("GroupManagement", "AP", new { systemId = sysId }) });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "å°å‘å¤±æ•—ï¼š" + ex.Message });
    }
}

// å°å‘é é¢ç®¡ç†
[HttpPost]
public JsonResult RedirectToPageManagement(string sysId)
{
    try
    {
        if (string.IsNullOrEmpty(sysId))
        {
            return Json(new { success = false, message = "è«‹é¸æ“‡ç³»çµ±" });
        }

        // æ›´æ–°Session
        Session["CurrentSystemId"] = sysId;
        Session["FromInternalSite"] = true; // ğŸ‘ˆ åŠ ä¸Šæ¨™è¨˜

        return Json(new { success = true, redirectUrl = Url.Action("PageManagement", "AP", new { systemId = sysId }) });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "å°å‘å¤±æ•—ï¼š" + ex.Message });
    }
}
```

### **2. ä¿®æ”¹ HomeController.cs - TOKEN é€²ä¾†æ™‚æ¸…é™¤æ¨™è¨˜**

```csharp
[HttpGet]
[TokenAuthorize]
public ActionResult TokenEntry()
{
    var systemId = ((ClaimsPrincipal)User).FindFirst("systemId")?.Value;
    var empNo = ((ClaimsPrincipal)User).FindFirst("empNo")?.Value;

    Session["CurrentSystemId"] = systemId;
    Session["CurrentEmpNo"] = empNo;
    Session["FromInternalSite"] = false; // ğŸ‘ˆ æ¨™è¨˜ç‚º TOKEN é€²ä¾†ï¼Œä¸æ˜¯ç«™å°å…§éƒ¨
    
    // å°å‘åˆ°ç¾¤çµ„ç®¡ç†
    return RedirectToAction("GroupManagement", "AP", new { systemId = systemId });
}

[HttpGet]
[TokenAuthorize]
public ActionResult TokenEntry_FUNC()
{
    var systemId = ((ClaimsPrincipal)User).FindFirst("systemId")?.Value;
    var empNo = ((ClaimsPrincipal)User).FindFirst("empNo")?.Value;

    Session["CurrentSystemId"] = systemId;
    Session["CurrentEmpNo"] = empNo;
    Session["FromInternalSite"] = false; // ğŸ‘ˆ æ¨™è¨˜ç‚º TOKEN é€²ä¾†
    
    // å°å‘åˆ°é é¢ç®¡ç†
    return RedirectToAction("PageManagement", "AP", new { systemId = systemId });
}
```

### **3. ä¿®æ”¹ APController.cs - å‚³éæ¨™è¨˜åˆ° View**

```csharp
// ç¾¤çµ„ç®¡ç†é é¢
public ActionResult GroupManagement(string systemId)
{
    if (string.IsNullOrEmpty(systemId))
    {
        systemId = Session["CurrentSystemId"]?.ToString();
    }
    else
    {
        // åŒæ­¥æ›´æ–° Session
        Session["CurrentSystemId"] = systemId;
    }

    // ğŸ‘‡ åˆ¤æ–·æ˜¯å¦å¾ç«™å°å…§éƒ¨é€²ä¾†
    bool isFromInternalSite = Session["FromInternalSite"] != null && (bool)Session["FromInternalSite"];

    ViewBag.SystemId = systemId;
    ViewBag.Title = "ç¾¤çµ„æ¬Šé™ç®¡ç† - " + systemId;
    ViewBag.ShowSwitchButton = isFromInternalSite; // ğŸ‘ˆ å‚³éçµ¦ View

    return View();
}

// ç³»çµ±é é¢è¨­å®š
public ActionResult PageManagement(string systemId = null)
{
    if (string.IsNullOrEmpty(systemId))
    {
        systemId = Session["CurrentSystemId"]?.ToString();
    }

    if (string.IsNullOrEmpty(systemId))
    {
        return Content("<h3>ç³»çµ±IDéºå¤±ï¼Œè«‹é‡æ–°é€éæ¬Šé™ç®¡ç†é€£çµé€²å…¥</h3>");
    }

    // ğŸ‘‡ åˆ¤æ–·æ˜¯å¦å¾ç«™å°å…§éƒ¨é€²ä¾†
    bool isFromInternalSite = Session["FromInternalSite"] != null && (bool)Session["FromInternalSite"];

    ViewBag.SystemId = systemId;
    ViewBag.Title = "ç³»çµ±é é¢è¨­å®š - " + systemId;
    ViewBag.ShowSwitchButton = isFromInternalSite; // ğŸ‘ˆ å‚³éçµ¦ View

    return View();
}
```

### **4. ä¿®æ”¹ GroupManagement.cshtml - åŠ å…¥åˆ‡æ›æŒ‰éˆ•**

åœ¨é é¢é ‚éƒ¨åŠ å…¥åˆ‡æ›æŒ‰éˆ•ï¼ˆåªæœ‰å¾ç«™å°é€²ä¾†æ‰é¡¯ç¤ºï¼‰ï¼š

```html
@{
    ViewBag.Title = ViewBag.Title ?? "ç¾¤çµ„æ¬Šé™ç®¡ç†";
    var systemId = ViewBag.SystemId as string;
    var showSwitchButton = ViewBag.ShowSwitchButton != null && (bool)ViewBag.ShowSwitchButton;
}

<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">@ViewBag.Title</div>
</section>

<!-- ğŸ‘‡ åªæœ‰å¾ç«™å°é€²ä¾†æ‰é¡¯ç¤ºåˆ‡æ›ç³»çµ±æŒ‰éˆ• -->
@if (showSwitchButton)
{
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-info" id="btnSwitchSystem">
                <i class="fas fa-exchange-alt"></i> åˆ‡æ›ç³»çµ±
            </button>
        </div>
    </div>
}

<!-- åŸæœ¬çš„ç¾¤çµ„ç®¡ç†å…§å®¹ -->
<div class="container-fluid">
    <!-- ... åŸæœ¬çš„å…§å®¹ ... -->
</div>

@section Scripts {
    <script>
        // åŸæœ¬çš„ script...

        @if (showSwitchButton)
        {
            <text>
            // åˆ‡æ›ç³»çµ±æŒ‰éˆ•äº‹ä»¶
            $('#btnSwitchSystem').click(function() {
                if (confirm('ç¢ºå®šè¦åˆ‡æ›ç³»çµ±å—ï¼Ÿ')) {
                    window.location.href = '@Url.Action("SYS_PERMISSION_SET", "SYS")';
                }
            });
            </text>
        }
    </script>
}
```

### **5. åŒæ¨£ä¿®æ”¹ PageManagement.cshtml**

```html
@{
    ViewBag.Title = ViewBag.Title ?? "ç³»çµ±é é¢è¨­å®š";
    var systemId = ViewBag.SystemId as string;
    var showSwitchButton = ViewBag.ShowSwitchButton != null && (bool)ViewBag.ShowSwitchButton;
}

<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">@ViewBag.Title</div>
</section>

<!-- ğŸ‘‡ åªæœ‰å¾ç«™å°é€²ä¾†æ‰é¡¯ç¤ºåˆ‡æ›ç³»çµ±æŒ‰éˆ• -->
@if (showSwitchButton)
{
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-info" id="btnSwitchSystem">
                <i class="fas fa-exchange-alt"></i> åˆ‡æ›ç³»çµ±
            </button>
        </div>
    </div>
}

<!-- åŸæœ¬çš„é é¢ç®¡ç†å…§å®¹ -->
<div class="container-fluid">
    <!-- ... åŸæœ¬çš„å…§å®¹ ... -->
</div>

@section Scripts {
    <script>
        // åŸæœ¬çš„ script...

        @if (showSwitchButton)
        {
            <text>
            // åˆ‡æ›ç³»çµ±æŒ‰éˆ•äº‹ä»¶
            $('#btnSwitchSystem').click(function() {
                if (confirm('ç¢ºå®šè¦åˆ‡æ›ç³»çµ±å—ï¼Ÿ')) {
                    window.location.href = '@Url.Action("SYS_FUNC_SET", "SYS")';
                }
            });
            </text>
        }
    </script>
}
```

## æµç¨‹åœ–

```
ã€TOKEN é€²ä¾†ã€‘
TokenEntry 
  â†“
Session["FromInternalSite"] = false
  â†“
GroupManagement 
  â†“
ViewBag.ShowSwitchButton = false
  â†“
âŒ ä¸é¡¯ç¤ºã€Œåˆ‡æ›ç³»çµ±ã€æŒ‰éˆ•

ã€ç«™å°é€²ä¾†ã€‘
SYS_PERMISSION_SET (é¸æ“‡ç³»çµ±)
  â†“
Session["FromInternalSite"] = true
  â†“
GroupManagement
  â†“
ViewBag.ShowSwitchButton = true
  â†“
âœ… é¡¯ç¤ºã€Œåˆ‡æ›ç³»çµ±ã€æŒ‰éˆ•
  â†“
é»æ“ŠæŒ‰éˆ• â†’ å°å‘å› SYS_PERMISSION_SET
```

## å„ªé»

âœ… **æ¸…æ¥šå€åˆ†ä¾†æº** - ç”¨ Session æ¨™è¨˜å€åˆ†  
âœ… **å®‰å…¨å¯é ** - TOKEN ä½¿ç”¨è€…çœ‹ä¸åˆ°åˆ‡æ›æŒ‰éˆ•  
âœ… **ä½¿ç”¨è€…é«”é©—å¥½** - ç«™å°ä½¿ç”¨è€…å¯ä»¥è¼•é¬†åˆ‡æ›ç³»çµ±  
âœ… **ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½** - TOKEN å°å‘æµç¨‹å®Œå…¨ä¸å—å½±éŸ¿

é€™æ¨£å°±å¯ä»¥å®Œç¾å€åˆ†å…©ç¨®é€²å…¥æ–¹å¼äº†ï¼ğŸ¯â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹