éå¸¸å¥½ ğŸ‘
ä½ çš„æ„æ€æˆ‘å®Œå…¨æ‡‚ï¼š
âœ… è¦ä¿ç•™é€™å€‹æ–°ç‰ˆæ¶æ§‹ï¼ˆç™»å…¥å…ˆé©—èº«åˆ†ã€å†é©—æ¬Šé™ï¼‰
âœ… ä½†ã€ŒSQL æŸ¥è©¢ã€éƒ¨åˆ†è¦æ”¹æˆ ç”¨ä½ å€‘æ…£ç”¨çš„ SVS_DBmanager.QueryBySQL()
âœ… åŒæ™‚ DLL å‘¼å«éƒ¨åˆ†è¦ä¿ç•™ï¼ˆåŠŸèƒ½1ï½GetUserData é‚„æ˜¯ç…§ç”¨ï¼‰

â¸»

ä»¥ä¸‹å°±æ˜¯ æœ€çµ‚æ•´åˆç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥è²¼ä¸Šä½¿ç”¨ ğŸ‘‡
ï¼ˆæˆ‘å¹«ä½ å…¨æ”¹æˆ SVS_DBmanager å¯«æ³•ï¼Œç„¡ SqlConnectionï¼Œé¢¨æ ¼èˆ‡å°ˆæ¡ˆçµ±ä¸€ï¼‰

â¸»

âœ… ä¸€ã€ä¿®æ”¹å¾Œå®Œæ•´çš„ SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.cs

using HI_APACCESS_DLL;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Linq;

namespace HI_APACCESS.Service
{
    public class SVS_å“¡å·¥åŸºæœ¬è³‡æ–™
    {
        #region ADã€å“¡ç·¨ã€ åŸºæœ¬è³‡æ–™

        /// <summary>
        /// æ¬Šé™ç®¡ç†-å–å¾—å“¡å·¥AD
        /// </summary>
        internal static string Get_å“¡å·¥AD()
        {
            string EMP_DOM_ID = System.Web.HttpContext.Current.User.Identity.Name
                .Substring(System.Web.HttpContext.Current.User.Identity.Name.LastIndexOf("\\") + 1);

            if (String.IsNullOrEmpty(EMP_DOM_ID))
            {
                var principal = new System.Security.Principal.WindowsPrincipal(
                    System.Security.Principal.WindowsIdentity.GetCurrent());
                string name = principal.Identity.Name;
                string[] adname = name.Split(new string[] { "\\" }, StringSplitOptions.RemoveEmptyEntries);
                EMP_DOM_ID = adname[1].ToString().ToUpper();
            }

            return EMP_DOM_ID;
        }

        /// <summary>
        /// AD è½‰æ›ç‚ºå“¡ç·¨
        /// </summary>
        private static string GetEmpNoByAD(string AD)
        {
            string EMP_NO = null;
            string sql = @"
SELECT EMP_ID 
FROM [HILIFE_MTS].[HI_APUSER].dbo.[NT_EMP] 
WHERE EMP_ID != EMP_DOM_ID
  AND LTRIM(RTRIM(EMP_DOM_ID)) <> '' 
  AND EMP_ID IN (
        SELECT EMP_NO AS EMP_ID 
        FROM [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST] 
        WHERE END_DT IS NULL
  )
  AND EMP_DOM_ID = @AD ";

            List<SqlParameter> paras = new List<SqlParameter>
            {
                new SqlParameter("@AD", AD)
            };

            DataTable table = new SVS_DBmanager().QueryBySQL(sql, paras);
            if (table.Rows.Count > 0)
                EMP_NO = table.Rows[0]["EMP_ID"].ToString();

            // æ‰¾ä¸åˆ°å°±å›å‚³åŸ ADï¼ˆç›¸å®¹åŸæµç¨‹ï¼‰
            return String.IsNullOrEmpty(EMP_NO) ? AD : EMP_NO;
        }

        /// <summary>
        /// æ¬Šé™ç®¡ç† - å–å¾—å“¡å·¥ç·¨è™Ÿ (èˆŠé‚è¼¯)
        /// </summary>
        internal static string Get_å“¡å·¥ç·¨è™Ÿ(string AD = null)
        {
            string EMP_NO = string.IsNullOrEmpty(AD) ? Get_å“¡å·¥AD() : AD;
            EMP_NO = GetEmpNoByAD(EMP_NO);
            return EMP_NO;
        }

        // ğŸŸ¢ æ–°å¢ï¼šåªé©—èº«åˆ†ï¼ˆç™»å…¥ç•«é¢ç”¨ï¼Œä¸æŸ¥æ¬Šé™ï¼‰
        internal static VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨± Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(string adOrEmp)
        {
            if (string.IsNullOrWhiteSpace(adOrEmp))
                return null;

            // 1ï¸âƒ£ å˜—è©¦ AD â†’ å“¡ç·¨
            string empNo = GetEmpNoByAD(adOrEmp);

            // 2ï¸âƒ£ æŸ¥äººäº‹ä¸»æª”ï¼ˆæœ‰æ•ˆå“¡å·¥ï¼‰
            string sql = @"
SELECT TOP 1
    M.EMP_NO,
    M.EMP_NAME,
    M.ORGAN_CAP,
    M.POST_NAME
FROM [HILIFE_DB3].[DB_SHARE].dbo.[M1EMP_MAST] M
WHERE M.EMP_NO = @EMP_NO
  AND (M.END_DT IS NULL OR LTRIM(RTRIM(M.END_DT)) = '')
";
            List<SqlParameter> paras = new List<SqlParameter>
            {
                new SqlParameter("@EMP_NO", empNo)
            };

            DataTable table = new SVS_DBmanager().QueryBySQL(sql, paras);
            if (table == null || table.Rows.Count == 0)
                return null; // ç„¡æ•ˆå“¡å·¥æˆ–é›¢è·

            var row = table.Rows[0];
            return new VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨±
            {
                AD        = adOrEmp.ToUpper(),
                EMP_NO    = row["EMP_NO"].ToString(),
                EMP_NAME  = row["EMP_NAME"].ToString(),
                ORGAN_CAP = row["ORGAN_CAP"].ToString(),
                POST_NAME = row["POST_NAME"].ToString(),
                // ä¸å« APG_NOï¼ˆä¸æŸ¥æ¬Šé™ï¼‰
            };
        }

        /// <summary>
        /// æ¬Šé™ç®¡ç†-å–å¾—å“¡å·¥ç·¨è™Ÿ (å‘¼å« DLL åŠŸèƒ½1)
        /// </summary>
        internal static string Get_å“¡å·¥ç·¨è™Ÿ_DLL(string ad = null)
        {
            var req = new Models.M_AP_DLL.GetUserDataRequestModel
            {
                SysID = "HI_APACCESS",
                UserAD = string.IsNullOrEmpty(ad) ? Get_å“¡å·¥AD() : ad,
                Environment = EnvHelper.EnvironmentForDll(),
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetUserData(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetUserDataResponseModel>(response);

            return res?.Result?.UserID ?? req.UserAD;
        }

        /// <summary>
        /// å–å¾—å“¡å·¥åŸºæœ¬è³‡æ–™ (å‘¼å« DLL åŠŸèƒ½1ï¼Œå«æ¬Šé™)
        /// </summary>
        internal static VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨± Get_å“¡å·¥åŸºæœ¬è³‡æ–™(string ad)
        {
            var req = new Models.M_AP_DLL.GetUserDataRequestModel
            {
                SysID = "HI_APACCESS",
                UserAD = ad,
                Environment = EnvHelper.EnvironmentForDll(),
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetUserData(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetUserDataResponseModel>(response);

            if (res?.Result == null) return null;

            return new VM_Employee.VM_å“¡å·¥éƒ¨é–€è·ç¨±
            {
                AD = req.UserAD,
                EMP_NO = res.Result.UserID,
                EMP_NAME = res.Result.UserName,
                POST_NAME = res.Result.PostName,
                ORGAN_CAP = res.Result.OrganName,
                APG_NO = res.Result.GroupID
            };
        }

        #endregion

        #region æ¬Šé™æ¨¹ï¼ˆä¿æŒåŸæ¨£ï¼‰
        internal static List<VM_Employee.WebTree_Node> Get_Tree(string groupId)
        {
            var req = new Models.M_AP_DLL.GetTreeRequestModel
            {
                SysID = "HI_APACCESS",
                GroupID = groupId,
                Environment = EnvHelper.EnvironmentForDll()
            };

            string json_input = JsonConvert.SerializeObject(req);
            string response = new APACCESS().GetTree(json_input);
            var res = JsonConvert.DeserializeObject<Models.M_AP_DLL.GetTreeResponseModel>(response);

            if (res?.Result == null) return new List<VM_Employee.WebTree_Node>();

            var allNodes = res.Result.Select(x => new VM_Employee.WebTree_Node
            {
                FUNC_ID = x.FuncID,
                FUNC_NA = x.FuncName,
                PARENT_ID = x.ParentID,
                VIEW_H = x.Controller,
                VIEW_HB = x.Action,
                SORT_NO = x.Sort.ToString(),
                WebTree = new List<VM_Employee.WebTree_Node>()
            }).ToList();

            var dict = allNodes.ToDictionary(x => x.FUNC_ID, x => x);

            List<VM_Employee.WebTree_Node> roots = new List<VM_Employee.WebTree_Node>();
            foreach (var node in allNodes)
            {
                if (string.IsNullOrEmpty(node.PARENT_ID) || node.PARENT_ID == "HOME")
                    roots.Add(node);
                else if (dict.ContainsKey(node.PARENT_ID))
                    dict[node.PARENT_ID].WebTree.Add(node);
            }

            SortTree(roots);
            return roots;
        }

        private static void SortTree(List<VM_Employee.WebTree_Node> nodes)
        {
            nodes.Sort((a, b) => int.Parse(a.SORT_NO).CompareTo(int.Parse(b.SORT_NO)));
            foreach (var node in nodes)
            {
                if (node.WebTree != null && node.WebTree.Count > 0)
                    SortTree(node.WebTree);
            }
        }
        #endregion
    }
}


â¸»

âœ… äºŒã€AccountController ä¿®æ”¹é‡é»ï¼ˆç™»å…¥æµç¨‹ï¼‰

GET /Login

[AllowAnonymous]
[HttpGet]
public ActionResult Login()
{
    Session.RemoveAll();

    string ad = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥AD();
    var login = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(ad);

    if (login == null)
    {
        ModelState.AddModelError("", "æŸ¥ç„¡æœ‰æ•ˆå“¡å·¥æˆ–å·²é›¢è·");
        return View(new VM_å“¡å·¥éƒ¨é–€è·ç¨± { AD = ad });
    }

    login.AD = ad;
    return View(login);
}


â¸»

POST /Login

[AllowAnonymous]
[HttpPost]
[ValidateAntiForgeryToken]
public ActionResult Login([Bind] VM_å“¡å·¥éƒ¨é–€è·ç¨± login, string ReturnUrl)
{
    if (!ModelState.IsValid) return View(login);

    string ad = !string.IsNullOrEmpty(login.AD) ? login.AD : SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥AD();

    // Step 1: å…ˆé©—èº«åˆ†ï¼ˆä¸æŸ¥æ¬Šé™ï¼‰
    var basic = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(ad);
    if (basic == null)
    {
        ModelState.AddModelError("", "æŸ¥ç„¡æœ‰æ•ˆå“¡å·¥æˆ–å·²é›¢è·");
        return View(login);
    }

    // Step 2: é©—æ¬Šé™ï¼ˆå‘¼å« DLLï¼‰
    var withGroup = SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™(ad);
    if (withGroup == null || string.IsNullOrEmpty(withGroup.APG_NO))
    {
        ModelState.AddModelError("", "æ‚¨æ²’æœ‰ç™»å…¥æ­¤ç³»çµ±çš„æ¬Šé™");
        return View(login);
    }

    // Step 3: ç™»å…¥æˆåŠŸ â†’ å»ºç«‹ç¥¨è­‰
    FormsAuthentication.RedirectFromLoginPage(ad, true);
    var encTicket = LoginTicket(ad);
    var authCookie = new HttpCookie(FormsAuthentication.FormsCookieName, encTicket)
    {
        Secure = Request.IsSecureConnection,
        HttpOnly = true
    };
    Response.Cookies.Add(authCookie);

    if (String.IsNullOrEmpty(ReturnUrl) || ReturnUrl == "/")
        return RedirectToAction("Main", "Home");

    if (!Url.IsLocalUrl(ReturnUrl))
        return RedirectToAction("Login", "Account");

    string[] allowedPaths = { "/Main/", "/Home/", "/Account/" };
    if (allowedPaths.Any(path => ReturnUrl.StartsWith(path, StringComparison.OrdinalIgnoreCase)))
        return RedirectToAction("Login", "Account", new { ReturnUrl });

    return RedirectToAction("Login", "Account");
}


â¸»

âœ… ä¸‰ã€å“¡ç·¨é©—è­‰Attributeï¼ˆå¯é¸ï¼‰

å¦‚æœä½ å¸Œæœ›åœ¨è¼¸å…¥å“¡ç·¨æ™‚ä¸è¢«æ¬Šé™å¡ä½ï¼Œåªé©—èº«åˆ†ï¼š

if (SVS_å“¡å·¥åŸºæœ¬è³‡æ–™.Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†(EmpNo.ToUpper()) == null)
{
    return false;
}


â¸»

âœ… æœ€çµ‚æ•ˆæœç¸½çµ

éšæ®µ	æŸ¥è©¢æ–¹å¼	æ˜¯å¦å‘¼å« DLL	èªªæ˜
ç™»å…¥é é¢åˆæ¬¡è¼‰å…¥ (GET)	Get_å“¡å·¥åŸºæœ¬è³‡æ–™_åªé©—èº«åˆ†	âŒ å¦	åªæŸ¥å“¡å·¥ä¸»æª”ï¼Œäººå“¡åœ¨è·å³å¯
ç™»å…¥é€å‡º (POST)	Get_å“¡å·¥åŸºæœ¬è³‡æ–™	âœ… æ˜¯	ç¢ºèªè©²å“¡å·¥æ˜¯å¦å…·ç™»å…¥æ¬Šé™
ç™»å…¥æˆåŠŸå¾Œ	å»ºç«‹ Cookie	â€”	ä¸€åˆ‡èˆ‡åŸæœ¬ç›¸åŒ


â¸»

æ˜¯å¦è¦æˆ‘å¹«ä½ é †ä¾¿åŠ ä¸Š EnvHelper.EnvironmentForDll() çš„å®Œæ•´å…§å®¹ï¼ˆè®“ä»–èƒ½æ­£ç¢ºåˆ¤æ–· TEST/PRODï¼‰ï¼Ÿ