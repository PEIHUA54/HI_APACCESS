切換按鈕
了解！你需要在 `GroupManagement` 頁面判斷是從哪種方式進來的，只有從站台進來才顯示「切換系統」按鈕。

## 解決方案

### **判斷邏輯**

- **TOKEN 進來**：Session 有 `CurrentSystemId` 和 `CurrentEmpNo`，且是透過 `TokenEntry` 進來
- **站台進來**：Session 有 `CurrentSystemId`，但是透過 `SYS_PERMISSION_SET` 導向過來的

我們可以加一個標記來區分！

## 修改方案

### **1. 修改 SYSController.cs - 導向時加上標記**

```csharp
// 導向群組管理
[HttpPost]
public JsonResult RedirectToGroupManagement(string sysId)
{
    try
    {
        if (string.IsNullOrEmpty(sysId))
        {
            return Json(new { success = false, message = "請選擇系統" });
        }

        // 更新Session
        Session["CurrentSystemId"] = sysId;
        Session["FromInternalSite"] = true; // 👈 加上標記，表示從站台內部進來

        return Json(new { success = true, redirectUrl = Url.Action("GroupManagement", "AP", new { systemId = sysId }) });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "導向失敗：" + ex.Message });
    }
}

// 導向頁面管理
[HttpPost]
public JsonResult RedirectToPageManagement(string sysId)
{
    try
    {
        if (string.IsNullOrEmpty(sysId))
        {
            return Json(new { success = false, message = "請選擇系統" });
        }

        // 更新Session
        Session["CurrentSystemId"] = sysId;
        Session["FromInternalSite"] = true; // 👈 加上標記

        return Json(new { success = true, redirectUrl = Url.Action("PageManagement", "AP", new { systemId = sysId }) });
    }
    catch (Exception ex)
    {
        return Json(new { success = false, message = "導向失敗：" + ex.Message });
    }
}
```

### **2. 修改 HomeController.cs - TOKEN 進來時清除標記**

```csharp
[HttpGet]
[TokenAuthorize]
public ActionResult TokenEntry()
{
    var systemId = ((ClaimsPrincipal)User).FindFirst("systemId")?.Value;
    var empNo = ((ClaimsPrincipal)User).FindFirst("empNo")?.Value;

    Session["CurrentSystemId"] = systemId;
    Session["CurrentEmpNo"] = empNo;
    Session["FromInternalSite"] = false; // 👈 標記為 TOKEN 進來，不是站台內部
    
    // 導向到群組管理
    return RedirectToAction("GroupManagement", "AP", new { systemId = systemId });
}

[HttpGet]
[TokenAuthorize]
public ActionResult TokenEntry_FUNC()
{
    var systemId = ((ClaimsPrincipal)User).FindFirst("systemId")?.Value;
    var empNo = ((ClaimsPrincipal)User).FindFirst("empNo")?.Value;

    Session["CurrentSystemId"] = systemId;
    Session["CurrentEmpNo"] = empNo;
    Session["FromInternalSite"] = false; // 👈 標記為 TOKEN 進來
    
    // 導向到頁面管理
    return RedirectToAction("PageManagement", "AP", new { systemId = systemId });
}
```

### **3. 修改 APController.cs - 傳遞標記到 View**

```csharp
// 群組管理頁面
public ActionResult GroupManagement(string systemId)
{
    if (string.IsNullOrEmpty(systemId))
    {
        systemId = Session["CurrentSystemId"]?.ToString();
    }
    else
    {
        // 同步更新 Session
        Session["CurrentSystemId"] = systemId;
    }

    // 👇 判斷是否從站台內部進來
    bool isFromInternalSite = Session["FromInternalSite"] != null && (bool)Session["FromInternalSite"];

    ViewBag.SystemId = systemId;
    ViewBag.Title = "群組權限管理 - " + systemId;
    ViewBag.ShowSwitchButton = isFromInternalSite; // 👈 傳遞給 View

    return View();
}

// 系統頁面設定
public ActionResult PageManagement(string systemId = null)
{
    if (string.IsNullOrEmpty(systemId))
    {
        systemId = Session["CurrentSystemId"]?.ToString();
    }

    if (string.IsNullOrEmpty(systemId))
    {
        return Content("<h3>系統ID遺失，請重新透過權限管理連結進入</h3>");
    }

    // 👇 判斷是否從站台內部進來
    bool isFromInternalSite = Session["FromInternalSite"] != null && (bool)Session["FromInternalSite"];

    ViewBag.SystemId = systemId;
    ViewBag.Title = "系統頁面設定 - " + systemId;
    ViewBag.ShowSwitchButton = isFromInternalSite; // 👈 傳遞給 View

    return View();
}
```

### **4. 修改 GroupManagement.cshtml - 加入切換按鈕**

在頁面頂部加入切換按鈕（只有從站台進來才顯示）：

```html
@{
    ViewBag.Title = ViewBag.Title ?? "群組權限管理";
    var systemId = ViewBag.SystemId as string;
    var showSwitchButton = ViewBag.ShowSwitchButton != null && (bool)ViewBag.ShowSwitchButton;
}

<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">@ViewBag.Title</div>
</section>

<!-- 👇 只有從站台進來才顯示切換系統按鈕 -->
@if (showSwitchButton)
{
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-info" id="btnSwitchSystem">
                <i class="fas fa-exchange-alt"></i> 切換系統
            </button>
        </div>
    </div>
}

<!-- 原本的群組管理內容 -->
<div class="container-fluid">
    <!-- ... 原本的內容 ... -->
</div>

@section Scripts {
    <script>
        // 原本的 script...

        @if (showSwitchButton)
        {
            <text>
            // 切換系統按鈕事件
            $('#btnSwitchSystem').click(function() {
                if (confirm('確定要切換系統嗎？')) {
                    window.location.href = '@Url.Action("SYS_PERMISSION_SET", "SYS")';
                }
            });
            </text>
        }
    </script>
}
```

### **5. 同樣修改 PageManagement.cshtml**

```html
@{
    ViewBag.Title = ViewBag.Title ?? "系統頁面設定";
    var systemId = ViewBag.SystemId as string;
    var showSwitchButton = ViewBag.ShowSwitchButton != null && (bool)ViewBag.ShowSwitchButton;
}

<section class="page-title">
    <div class="triangle"></div>
    <div class="title-text">@ViewBag.Title</div>
</section>

<!-- 👇 只有從站台進來才顯示切換系統按鈕 -->
@if (showSwitchButton)
{
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-info" id="btnSwitchSystem">
                <i class="fas fa-exchange-alt"></i> 切換系統
            </button>
        </div>
    </div>
}

<!-- 原本的頁面管理內容 -->
<div class="container-fluid">
    <!-- ... 原本的內容 ... -->
</div>

@section Scripts {
    <script>
        // 原本的 script...

        @if (showSwitchButton)
        {
            <text>
            // 切換系統按鈕事件
            $('#btnSwitchSystem').click(function() {
                if (confirm('確定要切換系統嗎？')) {
                    window.location.href = '@Url.Action("SYS_FUNC_SET", "SYS")';
                }
            });
            </text>
        }
    </script>
}
```

## 流程圖

```
【TOKEN 進來】
TokenEntry 
  ↓
Session["FromInternalSite"] = false
  ↓
GroupManagement 
  ↓
ViewBag.ShowSwitchButton = false
  ↓
❌ 不顯示「切換系統」按鈕

【站台進來】
SYS_PERMISSION_SET (選擇系統)
  ↓
Session["FromInternalSite"] = true
  ↓
GroupManagement
  ↓
ViewBag.ShowSwitchButton = true
  ↓
✅ 顯示「切換系統」按鈕
  ↓
點擊按鈕 → 導向回 SYS_PERMISSION_SET
```

## 優點

✅ **清楚區分來源** - 用 Session 標記區分  
✅ **安全可靠** - TOKEN 使用者看不到切換按鈕  
✅ **使用者體驗好** - 站台使用者可以輕鬆切換系統  
✅ **不影響現有功能** - TOKEN 導向流程完全不受影響

這樣就可以完美區分兩種進入方式了！🎯​​​​​​​​​​​​​​​​